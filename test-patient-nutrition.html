<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Patient Nutrition Test - DAL Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="data-access-layer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }
        .config-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-info h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .config-info code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        input[type="text"] {
            width: 300px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-right: 10px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Patient Nutrition Test - DAL Integration</h1>
        <p class="subtitle">Patient nutrition panel veri y√ºkleme/kaydetme testleri (Supabase + DAL)</p>

        <!-- Config Info -->
        <div class="config-info">
            <h3>‚öôÔ∏è Mevcut Konfig√ºrasyon</h3>
            <div id="configInfo">Y√ºkleniyor...</div>
        </div>

        <!-- Test 1: Load Patient Data -->
        <div class="test-section">
            <h2>üì• Test 1: Hasta Verisi Y√ºkleme (loadPatientData)</h2>
            <div class="input-group">
                <label>Hasta ID (√∂r: patient_1761489943986):</label>
                <input type="text" id="loadPatientId" value="patient_1761489943986" placeholder="patient_XXXXXXXXX">
                <button onclick="testLoadPatientData()">üîç Hasta Verisi Y√ºkle</button>
            </div>
            <div id="loadResult" class="result" style="display:none;"></div>
        </div>

        <!-- Test 2: Save Patient Data -->
        <div class="test-section">
            <h2>üíæ Test 2: Hasta Verisi Kaydetme (savePatientData)</h2>
            <div class="input-group">
                <label>Hasta ID (√∂r: patient_1761489943986):</label>
                <input type="text" id="savePatientId" value="patient_1761489943986" placeholder="patient_XXXXXXXXX">
            </div>
            <button onclick="testSavePatientData()">üíæ Test Verisi Kaydet</button>
            <button onclick="testUpdateWeeks()">üìÖ Hafta Verisi G√ºncelle</button>
            <div id="saveResult" class="result" style="display:none;"></div>
        </div>

        <!-- Test 3: Full Workflow -->
        <div class="test-section">
            <h2>üîÑ Test 3: Tam ƒ∞≈ü Akƒ±≈üƒ± (Load ‚Üí Modify ‚Üí Save)</h2>
            <div class="input-group">
                <label>Hasta ID (√∂r: patient_1761489943986):</label>
                <input type="text" id="workflowPatientId" value="patient_1761489943986" placeholder="patient_XXXXXXXXX">
            </div>
            <button onclick="testFullWorkflow()">üöÄ Tam ƒ∞≈ü Akƒ±≈üƒ± Test Et</button>
            <div id="workflowResult" class="result" style="display:none;"></div>
        </div>

    </div>

    <script>
        // Config bilgilerini g√∂ster
        window.addEventListener('load', () => {
            const configHtml = `
                <strong>Supabase URL:</strong> <code>${window.CONFIG.supabaseUrl}</code><br>
                <strong>useSupabase:</strong> <code>${window.CONFIG.useSupabase}</code><br>
                <strong>useLocalJSON:</strong> <code>${window.CONFIG.useLocalJSON}</code><br>
                <strong>useGitHub:</strong> <code>${window.CONFIG.useGitHub}</code><br>
                <strong>dualMode:</strong> <code>${window.CONFIG.dualMode}</code>
            `;
            document.getElementById('configInfo').innerHTML = configHtml;
        });

        // Test 1: Load Patient Data
        async function testLoadPatientData() {
            const resultDiv = document.getElementById('loadResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '‚è≥ Hasta verisi y√ºkleniyor...';

            try {
                const patientId = document.getElementById('loadPatientId').value.trim();
                
                if (!patientId) {
                    throw new Error('L√ºtfen hasta ID girin');
                }

                console.log('üîç Hasta verisi y√ºkleniyor:', patientId);
                const fetchedData = await window.DAL.getPatient(patientId);

                if (!fetchedData) {
                    throw new Error('Hasta bulunamadƒ±');
                }

                // data field kontrol√º
                const patientData = fetchedData.data || fetchedData;

                // Ad ve soyad - eski ve yeni format desteƒüi
                const firstName = patientData.firstName || 
                                patientData.personalInfo?.name || 
                                patientData.username || 'N/A';
                const lastName = patientData.lastName || 
                               patientData.personalInfo?.surname || '';

                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Hasta verisi ba≈üarƒ±yla y√ºklendi!

üìã Hasta Bilgileri:
ID: ${patientData.id || patientId}
Ad: ${firstName}
Soyad: ${lastName}
Username: ${patientData.username || 'N/A'}
Hedef Kalori: ${patientData.targetCalories || 'N/A'}
Hafta Sayƒ±sƒ±: ${patientData.weeks?.length || 0}
G√ºncelleme: ${patientData.updatedAt || 'N/A'}

üìä Veri Yapƒ±sƒ±:
${JSON.stringify(patientData, null, 2).substring(0, 500)}...`;

            } catch (error) {
                console.error('‚ùå Hata:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Hata: ${error.message}\n\n${error.stack}`;
            }
        }

        // Test 2: Save Patient Data
        async function testSavePatientData() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '‚è≥ Test verisi kaydediliyor...';

            try {
                const patientId = document.getElementById('savePatientId').value.trim();
                
                if (!patientId) {
                    throw new Error('L√ºtfen hasta ID girin');
                }

                // √ñnce mevcut veriyi y√ºkle
                const existingData = await window.DAL.getPatient(patientId);
                const patientData = existingData?.data || existingData || {};

                // Test verisi ekle
                const testData = {
                    ...patientData,
                    id: patientId,
                    testField: 'DAL_TEST_' + Date.now(),
                    testTimestamp: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                console.log('üíæ Test verisi kaydediliyor:', testData);
                const saved = await window.DAL.savePatient(testData);

                if (saved) {
                    // Kaydƒ± doƒürula
                    const verification = await window.DAL.getPatient(patientId);
                    const verData = verification?.data || verification;

                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Test verisi ba≈üarƒ±yla kaydedildi!

üíæ Kaydedilen Test Alanlarƒ±:
testField: ${verData.testField}
testTimestamp: ${verData.testTimestamp}
updatedAt: ${verData.updatedAt}

‚úì Veri Supabase'e yazƒ±ldƒ± ve geri okundu!`;
                } else {
                    throw new Error('Kaydetme i≈ülemi false d√∂nd√º');
                }

            } catch (error) {
                console.error('‚ùå Hata:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Hata: ${error.message}\n\n${error.stack}`;
            }
        }

        // Test 2b: Update Weeks
        async function testUpdateWeeks() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '‚è≥ Hafta verisi g√ºncelleniyor...';

            try {
                const patientId = document.getElementById('savePatientId').value.trim();
                
                if (!patientId) {
                    throw new Error('L√ºtfen hasta ID girin');
                }

                // √ñnce mevcut veriyi y√ºkle
                const existingData = await window.DAL.getPatient(patientId);
                const patientData = existingData?.data || existingData || {};

                // Weeks array kontrol√º
                if (!patientData.weeks) {
                    patientData.weeks = [];
                }

                // Test week ekle
                const testWeek = {
                    weekNumber: patientData.weeks.length + 1,
                    startDate: new Date().toISOString().split('T')[0],
                    days: [
                        { dayNumber: 1, meals: [], totalCalories: 0 },
                        { dayNumber: 2, meals: [], totalCalories: 0 }
                    ],
                    testUpdate: Date.now()
                };

                patientData.weeks.push(testWeek);
                patientData.updatedAt = new Date().toISOString();

                console.log('üìÖ Hafta verisi kaydediliyor:', patientData);
                const saved = await window.DAL.savePatient(patientData);

                if (saved) {
                    // Kaydƒ± doƒürula
                    const verification = await window.DAL.getPatient(patientId);
                    const verData = verification?.data || verification;

                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Hafta verisi ba≈üarƒ±yla g√ºncellendi!

üìÖ Toplam Hafta Sayƒ±sƒ±: ${verData.weeks?.length || 0}
Son Hafta: Hafta ${testWeek.weekNumber}
G√ºn Sayƒ±sƒ±: ${testWeek.days.length}
G√ºncelleme: ${verData.updatedAt}

‚úì Weeks array Supabase'e yazƒ±ldƒ±!`;
                } else {
                    throw new Error('Kaydetme i≈ülemi false d√∂nd√º');
                }

            } catch (error) {
                console.error('‚ùå Hata:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Hata: ${error.message}\n\n${error.stack}`;
            }
        }

        // Test 3: Full Workflow
        async function testFullWorkflow() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '‚è≥ Tam i≈ü akƒ±≈üƒ± test ediliyor...';

            const logs = [];

            try {
                const patientId = document.getElementById('workflowPatientId').value.trim();
                
                if (!patientId) {
                    throw new Error('L√ºtfen hasta ID girin');
                }

                // Adƒ±m 1: Load
                logs.push('üì• ADIM 1: Hasta verisi y√ºkleniyor...');
                const initialData = await window.DAL.getPatient(patientId);
                const patientData = initialData?.data || initialData || {};
                
                // Ad ve soyad - eski ve yeni format desteƒüi
                const firstName = patientData.firstName || 
                                patientData.personalInfo?.name || 
                                patientData.username || '';
                const lastName = patientData.lastName || 
                               patientData.personalInfo?.surname || '';
                
                logs.push(`‚úì Y√ºklendi: ${firstName} ${lastName}`);
                logs.push(`‚úì Mevcut hafta sayƒ±sƒ±: ${patientData.weeks?.length || 0}`);

                // Adƒ±m 2: Modify
                logs.push('\nüîß ADIM 2: Veri modifikasyonu...');
                const workflowTestData = {
                    ...patientData,
                    id: patientId,
                    workflowTest: 'FULL_WORKFLOW_' + Date.now(),
                    workflowTimestamp: new Date().toISOString()
                };

                // Weeks varsa son haftaya test g√ºn√º ekle
                if (workflowTestData.weeks && workflowTestData.weeks.length > 0) {
                    const lastWeek = workflowTestData.weeks[workflowTestData.weeks.length - 1];
                    if (!lastWeek.days) lastWeek.days = [];
                    lastWeek.days.push({
                        dayNumber: lastWeek.days.length + 1,
                        meals: [{ name: 'Test Yemek', calories: 500 }],
                        totalCalories: 500,
                        workflowTest: true
                    });
                    logs.push(`‚úì Son haftaya test g√ºn√º eklendi (G√ºn ${lastWeek.days.length})`);
                }

                workflowTestData.updatedAt = new Date().toISOString();

                // Adƒ±m 3: Save
                logs.push('\nüíæ ADIM 3: Deƒüi≈üiklikler kaydediliyor...');
                const saved = await window.DAL.savePatient(workflowTestData);
                
                if (!saved) {
                    throw new Error('Kaydetme i≈ülemi false d√∂nd√º');
                }
                logs.push('‚úì Supabase\'e kaydedildi');

                // Adƒ±m 4: Verify
                logs.push('\nüîç ADIM 4: Deƒüi≈üiklikler doƒürulanƒ±yor...');
                const verification = await window.DAL.getPatient(patientId);
                const verData = verification?.data || verification;

                if (verData.workflowTest === workflowTestData.workflowTest) {
                    logs.push('‚úì workflowTest alanƒ± doƒürulandƒ±');
                } else {
                    throw new Error('workflowTest alanƒ± e≈üle≈ümiyor!');
                }

                if (verData.workflowTimestamp === workflowTestData.workflowTimestamp) {
                    logs.push('‚úì workflowTimestamp alanƒ± doƒürulandƒ±');
                } else {
                    throw new Error('workflowTimestamp alanƒ± e≈üle≈ümiyor!');
                }

                logs.push('\n‚úÖ TAM ƒ∞≈û AKI≈ûI BA≈ûARILI!');
                logs.push('\nüìä Sonu√ß √ñzeti:');
                
                // Ad ve soyad - eski ve yeni format desteƒüi
                const verFirstName = verData.firstName || 
                                   verData.personalInfo?.name || 
                                   verData.username || '';
                const verLastName = verData.lastName || 
                                  verData.personalInfo?.surname || '';
                
                logs.push(`Hasta: ${verFirstName} ${verLastName}`);
                logs.push(`Hafta Sayƒ±sƒ±: ${verData.weeks?.length || 0}`);
                logs.push(`Son G√ºncelleme: ${verData.updatedAt}`);
                logs.push(`Test Alanlarƒ±: ${verData.workflowTest}`);

                resultDiv.className = 'result success';
                resultDiv.textContent = logs.join('\n');

            } catch (error) {
                console.error('‚ùå Hata:', error);
                logs.push(`\n‚ùå HATA: ${error.message}`);
                resultDiv.className = 'result error';
                resultDiv.textContent = logs.join('\n') + `\n\n${error.stack}`;
            }
        }
    </script>
</body>
</html>
