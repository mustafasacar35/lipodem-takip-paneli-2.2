<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 🔥 VERSION CONTROL - CACHE KILLER 🔥 -->
    <meta name="version" content="2.1-LEFT-SIDE-2025-11-09-FINAL">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Yemek Alternatif">
    <meta name="application-name" content="Yemek Alternatif">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link id="manifestLink" rel="manifest">
    <!-- iOS (iPhone/iPad) Ana Ekran İkonu -->
    <!-- ✅ İKON GÜNCELLENDİ -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png">
    <!-- / PWA ve Mobil Uygulama Meta Etiketleri -->

    <title>🍽️ Yemek Alternatif Bulucu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
            max-height: 100%;
            width: 100%;
        }
        
        /* Mobil için padding ayarla */
        @media (max-width: 576px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 8px;
                border-radius: 10px;
            }
        }

        /* Başlık kaldırıldı - artık search placeholder'da */

        .search-box {
            position: relative;
            margin-bottom: 8px;
            z-index: 10000;
            flex-shrink: 0;
            transition: all 0.3s ease;
            /* iOS notch için üst padding */
            padding-top: max(0px, env(safe-area-inset-top, 0px));
        }

        #yemekArama {
            width: 100%;
            /* Sağ tarafta sadece ayar ikonu için padding */
            padding: 10px 50px 10px 12px;
            font-size: 14px;
            border: 2px solid #667eea;
            border-radius: 10px;
            transition: all 0.3s ease;
            outline: none;
            /* iOS notch için üst margin */
            margin-top: max(5px, calc(env(safe-area-inset-top, 0px) * 0.5));
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            pointer-events: none;
        }

        /* Ayar ikonu */
        .settings-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            cursor: pointer;
            opacity: 0.9;
            background: rgba(102, 126, 234, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .settings-icon:hover {
            background: rgba(102, 126, 234, 0.2);
            opacity: 1;
        }
        
        .settings-icon:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Admin Düzenleme Butonu */
        .admin-edit-button {
            position: fixed;
            bottom: 20px;
            left: 20px; /* ✅ SOL TARAFA TAŞINDI - "Seçileni Kullan" sağda kalacak */
            background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%);
            color: white;
            border: none;
            padding: 14px 18px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            z-index: 99999 !important;
            transition: all 0.3s;
            width: 56px;
            height: 56px;
            display: none; /* Varsayılan olarak gizli */
            align-items: center;
            justify-content: center;
        }

        .admin-edit-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.6);
        }

        .admin-edit-button:active {
            transform: scale(0.95);
        }

        /* 🚫 Yasak Listesi Butonu (Admin için) */
        .blacklist-button {
            position: fixed;
            bottom: 20px;
            left: 86px; /* Admin edit butonunun yanı */
            background: linear-gradient(135deg, #FF8C42 0%, #FF6B35 100%);
            color: white;
            border: none;
            padding: 14px 18px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            z-index: 99998 !important;
            transition: all 0.3s;
            width: 56px;
            height: 56px;
            display: none; /* Varsayılan olarak gizli */
            align-items: center;
            justify-content: center;
        }

        .blacklist-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.6);
        }

        .blacklist-button:active {
            transform: scale(0.95);
        }
        
        /* Modal açıkken search ve ikonları gizle */
        body.modal-open .search-box {
            display: none;
        }

        .autocomplete-dropdown {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.15s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover, .autocomplete-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .autocomplete-item.active .food-meta-text,
        .autocomplete-item:hover .food-meta-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .autocomplete-item .food-name-text {
            font-weight: 600;
            display: block;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .autocomplete-item .food-meta-text {
            font-size: 10px;
            color: #666;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-section {
            margin: 5px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none; /* Gizlendi - makro butonları mor alanda olacak */
            flex-shrink: 0;
        }

        .filter-section h4 {
            margin: 0 0 4px 0;
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-btn, .checkbox-btn {
            padding: 5px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }

        .filter-btn:hover, .checkbox-btn:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .checkbox-btn {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .checkbox-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .checkbox-btn.active::before {
            content: '✓ ';
        }

        .selected-food {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px;
            border-radius: 8px;
            color: white;
            margin: 8px 0;
            display: none;
            position: relative;
            overflow: hidden;
            max-width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .selected-food.show {
            display: block;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: 3px solid #ffd700;
            color: white;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            width: 40px;
            height: 40px;
            min-width: 40px;
            max-width: 40px;
            min-height: 40px;
            max-height: 40px;
            line-height: 1;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .selected-food h3 {
            margin-bottom: 6px;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .selected-food .recipe-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .selected-food .recipe-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .alternative-food {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 10px 12px;
            border-radius: 8px;
            color: white;
            margin: 8px 0;
            display: none;
            position: relative;
            overflow: hidden;
            max-width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .alternative-food.show {
            display: block;
        }
        
        /* Akordiyon açıkken yeşil alan kaybolsun */
        .alternative-food.hide-on-open {
            display: none !important;
        }

        .alternative-food h3 {
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .alternative-food .recipe-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .alternative-food .recipe-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .selected-macros {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }

        .macro-box {
            background: rgba(255,255,255,0.2);
            padding: 6px 10px;
            border-radius: 6px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 3px;
            flex: 1 1 auto;
            min-width: fit-content;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .macro-box:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .macro-box.active {
            background: linear-gradient(to bottom, #667eea 0%, #764ba2 100%);
            border-color: rgba(102, 126, 234, 0.8);
            transform: scale(1.05);
        }
        
        .macro-box.active strong {
            color: white;
        }
        
        .macro-box.active span {
            color: rgba(255, 255, 255, 0.95);
        }

        .macro-box strong {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .macro-box span {
            font-size: 10px;
            opacity: 0.9;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .selected-info {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
            overflow: hidden;
            max-width: 100%;
            line-height: 1;
            align-items: center;
        }

        .info-tag {
            background: white;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            white-space: nowrap;
            height: 24px;
            box-sizing: border-box;
        }
        
        .clickable-tag {
            transition: all 0.2s;
            cursor: pointer;
            background: white;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: none;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            white-space: nowrap;
            height: 24px;
            box-sizing: border-box;
        }
        
        .clickable-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .clickable-tag.active {
            background: #667eea;
            color: white;
        }

        .result-header {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin: 0;
            padding: 12px 15px;
            display: none;
            cursor: pointer;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
            user-select: none;
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .result-header.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-header:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .result-header .arrow {
            transition: transform 0.3s;
            font-size: 16px;
        }

        .result-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .result-header .count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        #resultsListWrapper {
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
            margin-top: 12px;
            margin-bottom: 0;
        }

        #resultsList {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: opacity 0.3s;
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 8px 12px;
            box-sizing: border-box;
        }

        #resultsList.collapsed {
            flex: 0 0 auto;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .food-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .food-table tbody tr.food-card-row {
            cursor: pointer !important;
            transition: all 0.15s;
        }

        .food-table tbody tr.food-card-row td {
            padding: 0;
            border: none;
        }

        .food-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.15s;
        }

        .food-table tbody tr.food-card-row:hover .food-card {
            background: #f8f9fa;
            border-color: #dee2e6;
            transform: translateX(2px);
        }

        .food-table tbody tr.food-card-row.highlighted .food-card {
            background: rgba(40, 167, 69, 0.15) !important;
            border-color: rgba(40, 167, 69, 0.3);
        }

        .food-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .food-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            line-height: 1.3;
            flex: 1;
        }

        .food-card-macros {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .macro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            flex: 1;
        }

        .macro-label {
            font-size: 10px;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
        }

        .macro-val {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        .food-card-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .similarity-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .macro-diff {
            font-size: 9px;
            color: #666;
            display: block;
            margin-top: 1px;
        }

        .macro-diff.positive {
            color: #dc3545;
        }

        .macro-diff.negative {
            color: #28a745;
        }

        .meta-tag {
            background: white;
            color: #28a745;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            white-space: nowrap;
            height: 24px;
            box-sizing: border-box;
        }

        .meta-tag[style*="cursor: pointer"]:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.6);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 30px rgba(40, 167, 69, 0.9);
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
        }

        .modal-close:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .selected-macros {
                grid-template-columns: repeat(2, 1fr);
            }

            .food-table {
                font-size: 12px;
            }

            .food-table th, .food-table td {
                padding: 8px 4px;
            }

            .food-name {
                max-width: 150px;
            }

            .modal-content {
                max-width: 95%;
                max-height: 85vh;
            }

            .modal-close {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }
        }

        @media (min-width: 577px) and (max-width: 992px) {
            .nav-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                max-width: 36px !important;
                min-height: 36px !important;
                max-height: 36px !important;
                font-size: 16px !important;
                border-radius: 50% !important;
            }
            
            .navigation-buttons {
                gap: 5px !important;
            }
        }

        @media (max-width: 576px) {
            #yemekArama {
                font-size: 16px; 
                padding: 12px 45px 12px 12px;
            }

            .search-icon {
                font-size: 18px;
                right: 15px;
            }

            .filter-section {
                margin-bottom: 8px;
            }
            
            .filter-section > div {
                gap: 4px !important;
            }
            
            .filter-section span {
                display: none; 
            }

            .filter-btn {
                font-size: 10px;
                padding: 4px 8px;
                white-space: nowrap;
            }
            
            .filter-btn[data-score="all"] {
                font-size: 0;
            }
            .filter-btn[data-score="all"]::after {
                content: "Tümü";
                font-size: 10px;
            }
            
            .filter-btn[data-score="carbs"] {
                font-size: 0;
            }
            .filter-btn[data-score="carbs"]::after {
                content: "Karb";
                font-size: 10px;
            }

            .selected-food, .alternative-food {
                padding: 12px;
                margin: 10px 0;
            }

            .selected-food h3, .alternative-food h3 {
                font-size: 16px !important;
                margin-bottom: 10px !important;
            }

            .selected-macros {
                flex-direction: row !important; 
                gap: 4px !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
            }

            .macro-box {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 6px 4px !important;
                text-align: center;
            }

            .macro-box strong {
                font-size: 14px;
                display: block;
            }

            .macro-box span {
                font-size: 9px;
                display: block;
            }
            
            .macro-box > div {
                font-size: 11px !important;
                margin-top: 1px !important;
            }

            .info-tag, .meta-tag, .clickable-tag {
                font-size: 10px !important;
                padding: 3px 10px !important;
                border-radius: 10px !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
                height: 20px !important;
                min-height: 20px !important;
                max-height: 20px !important;
                line-height: 1 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                box-sizing: border-box !important;
            }
            
            .selected-info {
                display: flex !important;
                flex-wrap: wrap !important;
                overflow-x: hidden !important;
                gap: 4px !important;
                padding-bottom: 4px;
                -webkit-overflow-scrolling: touch;
                width: 100% !important;
            }
            
            .selected-food {
                overflow-x: hidden !important;
            }
            
            .selected-food > div[style*="flex"] {
                flex-wrap: nowrap !important;
                overflow-x: hidden !important;
                gap: 4px !important;
                width: 100% !important;
                -webkit-overflow-scrolling: touch;
            }
            
            .selected-food .selected-info {
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            #alternativeTags {
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch;
            }
            
            #alternativeTags > div {
                flex-wrap: wrap !important;
            }

            .recipe-badge {
                font-size: 11px;
                padding: 6px 12px;
            }

            .nav-btn {
                width: 32px !important;
                height: 32px !important;
                min-width: 32px !important;
                max-width: 32px !important;
                min-height: 32px !important;
                max-height: 32px !important;
                font-size: 14px !important;
                flex-shrink: 0 !important;
                border-radius: 50% !important;
            }
            
            .navigation-buttons {
                flex-shrink: 0 !important;
                gap: 4px !important;
            }

            .similarity-badge {
                font-size: 14px !important;
                padding: 4px 8px !important;
            }

            .result-header {
                font-size: 13px;
                padding: 10px 12px;
            }

            .result-header .count {
                font-size: 10px;
                padding: 2px 6px;
            }

            .food-table {
                font-size: 12px;
            }

            .food-table th,
            .food-table td {
                padding: 8px 4px;
                font-size: 11px;
            }

            .food-table th:first-child,
            .food-table td:first-child {
                min-width: 120px;
            }

            .food-table th:not(:first-child),
            .food-table td:not(:first-child) {
                min-width: 45px;
                text-align: center;
            }

            .autocomplete-dropdown {
                font-size: 13px;
            }

            .autocomplete-item {
                padding: 10px 12px;
            }
        }

        @media (min-width: 577px) and (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .selected-macros {
                gap: 6px;
            }

            .macro-box {
                padding: 6px 10px;
            }

            .filter-btn {
                font-size: 11px;
                padding: 5px 10px;
            }

            .nav-btn {
                width: 48px !important;
                height: 48px !important;
                min-width: 48px !important;
                max-width: 48px !important;
                min-height: 48px !important;
                max-height: 48px !important;
                border-radius: 50% !important;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
                padding: 20px;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .filter-btn:active,
            .nav-btn:active,
            .result-header:active {
                transform: scale(0.95);
            }

            button, .clickable-tag {
                min-height: 44px;
                min-width: 44px;
            }

            .food-table tbody tr {
                min-height: 48px;
            }
        }

        @media (prefers-color-scheme: dark) {
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-box">
            <input 
                type="text" 
                id="yemekArama" 
                placeholder="🍽️ Yemek ara (ör: Tavuk)"
                autocomplete="off"
            >
            <span class="settings-icon" id="openUserSettings" title="Hesap ayarları">⚙️</span>
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
        </div>

        <div class="filter-section">
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <span style="font-size: 12px; font-weight: 600; color: #495057;">📊 Benzerlik:</span>
                <button class="filter-btn active" data-score="all">Tüm Makrolar</button>
                <button class="filter-btn" data-score="calories">Kalori</button>
                <button class="filter-btn" data-score="protein">Protein</button>
                <button class="filter-btn" data-score="carbs">Karbonhidrat</button>
                <button class="filter-btn" data-score="fat">Yağ</button>
            </div>
        </div>

        <div class="selected-food" id="selectedFood">
            <h3 id="selectedName"></h3>
            <div class="selected-macros" id="selectedMacros"></div>
            
            <div class="selected-info" id="selectedInfo"></div>
            
            <div style="display: flex; gap: 8px; justify-content: space-between; align-items: center; margin-top: 8px;">
                <div id="selectedTarifler" style="display: flex; gap: 6px; flex-wrap: wrap;">
                </div>
                
                <div class="navigation-buttons" style="display: flex; gap: 6px; overflow: hidden; max-width: 100%; flex-shrink: 0;">
                    <button class="nav-btn" id="prevBtn" title="Önceki Alternatif">◀</button>
                    <button class="nav-btn" id="nextBtn" title="Sonraki Alternatif">▶</button>
                    <button class="nav-btn" id="resetBtn" title="İlk Alternatife Dön">↻</button>
                </div>
            </div>
        </div>

        <!-- Mor Kart: Aranan Yemek -->
        <div class="selected-food" id="selectedFood" style="display: none;">
            <h3 style="margin-bottom: 12px; font-size: 20px; text-align: left;">
                <span style="opacity: 0.7;">Aranan:</span> <span id="selectedName"></span>
            </h3>
            <div class="selected-macros" id="selectedMacros"></div>
            <div class="selected-info" id="selectedTags"></div>
            <div id="selectedTarifler" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;"></div>
        </div>

        <!-- Yeşil Kart: Seçili Alternatif -->
        <div class="alternative-food" id="alternativeFood">
            <h3 style="margin-bottom: 12px; font-size: 20px; text-align: left;">
                <span style="opacity: 0.7;">Alternatif:</span> <span id="alternativeName"></span>
                <span id="similarityBadgeContainer" style="float: right;"></span>
            </h3>
            <div class="selected-macros" id="alternativeMacros"></div>
            <div class="selected-info" id="alternativeTags"></div>
            <div id="alternativeTarifler" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;"></div>
        </div>

        <div id="resultsListWrapper">
            <div class="result-header collapsed" id="resultHeader">
                <span>
                    Benzer Alternatifler<span class="count" id="resultCount">0</span>
                </span>
                <span class="arrow">▼</span>
            </div>
            <div id="resultsList" class="collapsed">
                <div class="no-results">👆 Yukarıdan yemek arayın</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tarifModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <img id="modalImage" class="modal-image" src="" alt="Tarif Kartı">
        </div>
    </div>

    <!-- Hasta Ayarları Modal -->
    <div class="modal-overlay" id="userSettingsModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0; border-radius: 20px; overflow: hidden;">
            <div style="background: rgba(255,255,255,0.95); padding: 24px; border-radius: 20px;">
                <button class="modal-close" onclick="closeUserSettings()" style="background: #dc3545; color: white; border: none; font-size: 28px; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; position: absolute; top: 12px; right: 12px; z-index: 1;">×</button>
                
                <h2 style="margin: 0 0 24px 0; color: #667eea; font-size: 24px; text-align: center; font-weight: 700;">⚙️ Hesap Ayarları</h2>
                
                <form id="userSettingsForm" style="display: flex; flex-direction: column; gap: 16px;">
                    
                    <!-- Ad -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Ad *</label>
                        <input type="text" id="userName" required
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>

                    <!-- Soyad -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Soyad *</label>
                        <input type="text" id="userSurname" required
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>

                    <!-- Yaş -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Yaş *</label>
                        <input type="number" id="userAge" required min="1" max="150"
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>

                    <!-- Cinsiyet -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Cinsiyet *</label>
                        <select id="userGender" required
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none; background: white; cursor: pointer;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            <option value="">Seçiniz</option>
                            <option value="Kadın">Kadın</option>
                            <option value="Erkek">Erkek</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>

                    <!-- Kilo -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Kilo (kg) *</label>
                        <input type="number" id="userWeight" required min="20" max="300" step="0.1" oninput="calculateUserBMI()"
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>

                    <!-- Boy -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Boy (cm) *</label>
                        <input type="number" id="userHeight" required min="50" max="250" oninput="calculateUserBMI()"
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>

                    <!-- BMI (readonly) -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">BMI (otomatik hesaplanan)</label>
                        <input type="text" id="userBMI" readonly
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; background: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>

                    <!-- Aktivite Seviyesi -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Aktivite Seviyesi *</label>
                        <select id="userActivityLevel" required
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none; background: white; cursor: pointer;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            <option value="1">1 - Hareketsiz (Çok az aktivite)</option>
                            <option value="2">2 - Az Hareketli (Haftada 1-2 gün)</option>
                            <option value="3" selected>3 - Orta Hareketli (Haftada 3-5 gün)</option>
                            <option value="4">4 - Hareketli (Haftada 6-7 gün)</option>
                            <option value="5">5 - Çok Hareketli (Günde 2 kez)</option>
                        </select>
                        <small style="color: #6c757d; font-size: 12px;">Günlük fiziksel aktivite seviyeniz (kalori hesaplamasında kullanılır)</small>
                    </div>

                    <!-- Kullanıcı Adı (readonly) -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Kullanıcı Adı (değiştirilemez)</label>
                        <input type="text" id="userUsername" readonly
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; background: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>

                    <!-- Şifre (opsiyonel) -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-weight: 600; color: #495057; font-size: 14px;">Şifre (opsiyonel)</label>
                        <input type="password" id="userPassword" minlength="4" placeholder="Boş bırakılırsa değişmez"
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; outline: none;"
                            onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <small style="color: #6c757d; font-size: 12px;">En az 4 karakter. Boş bırakılırsa mevcut şifreniz korunur.</small>
                    </div>

                    <!-- Butonlar -->
                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                        <button type="button" onclick="closeUserSettings()"
                            style="flex: 1; padding: 14px; background: #6c757d; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                            onmouseover="this.style.background='#5a6268'"
                            onmouseout="this.style.background='#6c757d'">
                            İptal
                        </button>
                        <button type="submit"
                            style="flex: 1; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(102,126,234,0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
                            💾 Kaydet
                        </button>
                    </div>

                    <!-- Mesaj alanı -->
                    <div id="userSettingsMessage" style="display: none; padding: 12px; border-radius: 10px; text-align: center; font-weight: 600;"></div>

                </form>
            </div>
        </div>
    </div>

    <!-- 🚫 YASAK LİSTESİ YÖNETİM MODALI -->
    <div id="blacklistModal" class="modal" style="display: none; position: fixed; z-index: 10003; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85);">
        <div class="modal-content" style="background-color: #fff; margin: 1% auto; padding: 0; border-radius: 12px; width: 96%; max-width: 1100px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); max-height: 96vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #FF8C42 0%, #FF6B35 100%); color: white; padding: 16px 24px; border-radius: 12px 12px 0 0; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 20px;">🚫 Alternatif Yasak Listesi Yönetimi</h3>
                <button onclick="closeBlacklistModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; font-size: 20px; cursor: pointer; border-radius: 6px; transition: all 0.2s;">✖</button>
            </div>
            
            <!-- Body - Scrollable -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <!-- Manuel Ekleme Bölümü -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 24px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 16px; color: #333;">➕ Yeni Yasak Ekle</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <!-- Sol: Hedef Yemek -->
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #dee2e6;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">🎯 Hedef Yemek:</label>
                            <input type="text" id="blacklistMainFood" placeholder="Yemek ara... (ör: Izgara Tavuk)" 
                                style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 6px; font-size: 14px; box-sizing: border-box;" 
                                autocomplete="off">
                            <div id="blacklistMainFoodDropdown" style="position: relative; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; margin-top: -2px; z-index: 1000;"></div>
                            <div id="selectedMainFood" style="margin-top: 8px; padding: 8px; background: #e7f3ff; border-radius: 6px; display: none;">
                                <span style="font-weight: 600; color: #0066cc;"></span>
                                <button onclick="clearMainFood()" style="float: right; background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">✖</button>
                            </div>
                        </div>
                        
                        <!-- Sağ: Yasaklanacak Alternatifler -->
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #dee2e6;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">🚫 Yasaklanacak Alternatifler:</label>
                            <input type="text" id="blacklistAlternatives" placeholder="Alternatif ara... (ör: Tavuk Sote)" 
                                style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 6px; font-size: 14px; box-sizing: border-box;" 
                                autocomplete="off">
                            <div id="blacklistAlternativesDropdown" style="position: relative; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; margin-top: -2px; z-index: 1000;"></div>
                            <div id="selectedAlternatives" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;"></div>
                        </div>
                    </div>

                    <!-- Çift Yönlü Ekleme -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #495057;">
                            <input type="checkbox" id="bidirectionalBan" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>🔄 <strong>Çift Yönlü Yasaklama:</strong> Her iki yemek için de karşılıklı yasak ekle</span>
                        </label>
                        <div style="margin-left: 26px; margin-top: 4px; font-size: 12px; color: #6c757d;">
                            Örnek: "Izgara Tavuk" için "Tavuk Sote" yasaklanırsa, "Tavuk Sote" için de "Izgara Tavuk" yasaklanır.
                        </div>
                    </div>

                    <!-- Kaydet Butonu -->
                    <button onclick="addToBlacklist()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(40,167,69,0.3); transition: all 0.3s;">
                        ✅ Yasak Listesine Ekle
                    </button>
                </div>

                <!-- Mevcut Yasaklar Listesi -->
                <div style="background: #fff; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 16px; color: #333; display: flex; justify-content: space-between; align-items: center;">
                        <span>📋 Mevcut Yasaklar (<span id="blacklistCount">0</span>)</span>
                        <input type="text" id="searchBlacklist" placeholder="🔍 Ara..." style="padding: 6px 12px; border: 2px solid #ced4da; border-radius: 6px; font-size: 13px; width: 250px;">
                    </h4>
                    <div id="currentBlacklistItems" style="max-height: 400px; overflow-y: auto;">
                        <!-- Dinamik olarak doldurulacak -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✏️ YEMEK DÜZENLEME MODALI (patient_nutrition.html'den) -->
    <div id="templateFoodEditModal" class="modal" style="display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 2% auto; padding: 0; border-radius: 12px; width: 95%; max-width: 900px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); max-height: 95vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;">✏️ Yemek Düzenle: <span id="editFoodModalTitle">-</span></h3>
                <button onclick="closeTemplateFoodEditModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; font-size: 18px; cursor: pointer; border-radius: 4px;">✖</button>
            </div>
            
            <!-- Body - Scrollable -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <!-- Yemek Adı + Akıllı Search -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        🍽️ Yemek Adı <span style="color: #FF6B6B;">*</span>
                    </label>
                    <div style="position: relative;">
                        <input type="text" id="editFoodName" placeholder="Yemek adı yazın veya arayın..." oninput="searchFoodForEdit(this.value)" autocomplete="off" style="width: 100%; padding: 12px; font-size: 15px; border: 2px solid #FF6B6B; border-radius: 8px; box-sizing: border-box;">
                        <!-- Arama sonuçları dropdown -->
                        <div id="editFoodSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #FF6B6B; border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    <p style="margin: 6px 0 0 0; font-size: 12px; color: #666;">💡 İsim değiştirerek başka yemek seçebilirsiniz</p>
                </div>
                
                <!-- Makrolar -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">⚡ Kalori (kcal) *</label>
                        <input type="number" id="editFoodCalories" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🥩 Protein (g) *</label>
                        <input type="number" id="editFoodProtein" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🌾 Karbonhidrat (g) *</label>
                        <input type="number" id="editFoodCarbs" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🧈 Yağ (g) *</label>
                        <input type="number" id="editFoodFat" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                </div>
                
                <!-- Kategori & Rol -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">📂 Kategori *</label>
                        <select id="editFoodCategory" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                            <option value="">-- Kategori Seçin --</option>
                            <option value="KAHVALTI">KAHVALTI</option>
                            <option value="ÖĞLEN">ÖĞLEN</option>
                            <option value="AKŞAM">AKŞAM</option>
                            <option value="KURUYEMİŞLER">KURUYEMİŞLER</option>
                            <option value="ÇORBALAR">ÇORBALAR</option>
                            <option value="SALATALAR">SALATALAR</option>
                            <option value="ANA YEMEKLER">ANA YEMEKLER</option>
                            <option value="TOSTLAR">TOSTLAR</option>
                            <option value="TATLILAR">TATLILAR</option>
                            <option value="İÇECEKLER">İÇECEKLER</option>
                            <option value="ATIŞTIRILMALIKLAR">ATIŞTIRILMALIKLAR</option>
                            <option value="EKMEKLER">EKMEKLER</option>
                            <option value="PİLAVLAR">PİLAVLAR</option>
                            <option value="DİĞER">DİĞER</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🎭 Rol *</label>
                        <select id="editFoodRole" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                            <option value="">-- Rol Seçin --</option>
                            <option value="mainDish">Ana Yemek (mainDish)</option>
                            <option value="sideDish">Yan Yemek (sideDish)</option>
                            <option value="drink">İçecek (drink)</option>
                            <option value="supplement">Takviye (supplement)</option>
                            <option value="snack">Atıştırmalık (snack)</option>
                            <option value="soup">Çorba (soup)</option>
                            <option value="salad">Salata (salad)</option>
                            <option value="bread">Ekmek (bread)</option>
                            <option value="dessert">Tatlı (dessert)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Öğün Tipi -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">⏰ Öğün Tipi (Birden fazla seçilebilir)</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_breakfast" value="breakfast" style="width: 18px; height: 18px;">
                            🌅 Kahvaltı
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_lunch" value="lunch" style="width: 18px; height: 18px;">
                            ☀️ Öğle
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_dinner" value="dinner" style="width: 18px; height: 18px;">
                            🌙 Akşam
                        </label>
                    </div>
                </div>
                
                <!-- Porsiyon Çarpanı -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📏 Porsiyon Çarpanı</label>
                    <input type="number" id="editFoodPortion" step="0.1" value="1" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <!-- Diyet Tipleri -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">🥑 Diyet Tipleri (Birden fazla seçilebilir)</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_ketojenik" value="ketojenik" style="width: 18px; height: 18px;">
                            🥗 Ketojenik
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_akdeniz" value="akdeniz" style="width: 18px; height: 18px;">
                            🌊 Akdeniz
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_vegan" value="vegan" style="width: 18px; height: 18px;">
                            🌱 Vegan
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_glutensiz" value="glutensiz" style="width: 18px; height: 18px;">
                            🌾 Glutensiz
                        </label>
                    </div>
                </div>
                
                <!-- Gelişmiş Ayarlar (Collapsible) -->
                <details style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">⚙️ Gelişmiş Ayarlar</summary>
                    
                    <!-- Min/Max/Step -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Min Miktar</label>
                            <input type="number" id="editFoodMin" step="0.1" placeholder="Min porsiyon" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Max Miktar</label>
                            <input type="number" id="editFoodMax" step="0.1" placeholder="Max porsiyon" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Adım (Step)</label>
                            <input type="number" id="editFoodStep" step="0.1" placeholder="Artış miktarı" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <!-- Sezon -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Sezon Başlangıç (Ay)</label>
                            <input type="number" id="editFoodSeasonMin" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Sezon Bitiş (Ay)</label>
                            <input type="number" id="editFoodSeasonMax" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <!-- Özel Özellikler -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #666; font-size: 13px;">🏷️ Özel Özellikler</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodKeto" style="width: 16px; height: 16px;">
                                🥗 Keto
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodLowCarb" style="width: 16px; height: 16px;">
                                📉 Düşük Karb
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodPortionFixed" style="width: 16px; height: 16px;">
                                🔒 Porsiyon Sabit
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodFillerLunch" style="width: 16px; height: 16px;">
                                🍽️ Öğle Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodFillerDinner" style="width: 16px; height: 16px;">
                                🌙 Akşam Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodReversedSeason" style="width: 16px; height: 16px;">
                                🔄 Ters Sezon
                            </label>
                        </div>
                    </div>
                    
                    <!-- Etiketler -->
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">🏷️ Etiketler (Tags) - virgülle ayırın</label>
                        <input type="text" id="editFoodTags" placeholder="ör: domates, meyve, salata" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">✅ Uyumluluk Etiketleri (compatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="editFoodCompat" placeholder="ör: tavuk, zeytinyağı" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">❌ Uyumsuzluk Etiketleri (incompatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="editFoodIncompat" placeholder="ör: süt, peynir" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">📝 Notlar</label>
                        <textarea id="editFoodNotes" placeholder="Ek bilgiler, özel notlar..." style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box; min-height: 60px; resize: vertical;"></textarea>
                    </div>
                </details>
            </div>
            
            <!-- Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px; display: flex; gap: 10px; justify-content: space-between; flex-shrink: 0; border-top: 1px solid #ddd;">
                <button onclick="closeTemplateFoodEditModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    ❌ İptal
                </button>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; cursor: pointer;">
                        <input type="checkbox" id="saveFoodToDatabase" style="width: 16px; height: 16px;">
                        <span>💾 food_list.json'a da kaydet</span>
                    </label>
                    <button onclick="saveEditedTemplateFood()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        ✅ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL DEĞİŞKENLER (Admin modal için) ====================
        var currentAlternatives = [];
        var currentIndex = 0;
        var foodDatabase = [];
        
        // ==================== YASAK LİSTESİ GLOBAL DEĞİŞKENLERİ ====================
        var alternativeBlacklist = []; // GitHub'dan yüklenecek yasak listesi
        var blacklistVersion = '1.0';
        var selectedFoodsForBan = []; // Toplu yasaklama için seçili yemekler
        
        (function() {
            let lastTouchEnd = 0;
            window.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 350) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            window.addEventListener('gesturestart', function(event) {
                event.preventDefault();
            }, { passive: false });
        })();

        // ==================== HASTA AYARLARI FONKSİYONLARI ====================
        
        // Modal Aç
        function openUserSettings() {
            const modal = document.getElementById('userSettingsModal');
            const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
            
            console.log('🔐 Session bilgisi:', session);
            
            if (!session.username) {
                alert('⚠️ Giriş yapılmamış!\n\nLütfen önce giriş yapın.');
                return;
            }

            console.log('👤 Kullanıcı adı:', session.username);
            console.log('🆔 Patient ID:', session.patientId);

            // Modal açıldığında body'ye class ekle (search kutusunu gizlemek için)
            document.body.classList.add('modal-open');
            
            // Modal'ı aç
            modal.style.display = 'flex';

            // patientId'yi kullan (patient_ prefix'i zaten var)
            const patientId = session.patientId || `patient_${session.username}`;
            
            // Modal açıldıktan sonra veriyi çek (DOM elemanları hazır olsun diye setTimeout)
            setTimeout(() => {
                fetchPatientData(patientId);
            }, 100);
        }

        // GitHub'dan hasta verilerini çek
        async function fetchPatientData(patientId) {
            try {
                // patientId zaten "patient_" ile başlıyor, temizle
                const cleanId = patientId.replace(/^patient_/i, '');
                const fileName = `patient_${cleanId}.json`;
                const cachedDataKey = `patient_data_${cleanId}`;
                
                console.log('🔍 Hasta verisi çekiliyor:', fileName);
                
                let patientData;
                
                // ÖNCELİK 1: GitHub'dan çek (HER ZAMAN ÖNCE GITHUB!)
                const timestamp = new Date().getTime();
                const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/hastalar/${fileName}?t=${timestamp}`);
                
                if (response.ok) {
                    // GitHub'dan başarıyla yüklendi
                    patientData = await response.json();
                    localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                    console.log('✅ Hasta verisi GitHub\'dan yüklendi:', patientData);
                } else {
                    // ÖNCELİK 2: GitHub'a erişilemiyorsa localStorage'dan yükle
                    const cachedData = localStorage.getItem(cachedDataKey);
                    if (cachedData) {
                        patientData = JSON.parse(cachedData);
                        console.log('⚠️ GitHub erişilemiyor, localStorage kullanıldı:', patientData);
                    } else {
                        console.error('❌ Dosya bulunamadı:', fileName);
                        throw new Error(`Hasta dosyası bulunamadı: ${fileName}`);
                    }
                }
                
                // Veri yapısını kontrol et (personalInfo içinde mi yoksa direkt mi?)
                const info = patientData.personalInfo || patientData;
                
                // Form alanlarını doldur
                document.getElementById('userName').value = info.name || '';
                document.getElementById('userSurname').value = info.surname || '';
                document.getElementById('userAge').value = info.age || '';
                document.getElementById('userGender').value = info.gender || '';
                document.getElementById('userWeight').value = info.weight || '';
                document.getElementById('userHeight').value = info.height || '';
                document.getElementById('userActivityLevel').value = info.activityLevel || '3'; // Varsayılan: 3 (Orta Hareketli)
                document.getElementById('userUsername').value = cleanId;
                document.getElementById('userPassword').value = ''; // Şifre alanı boş
                
                // BMI hesapla
                calculateUserBMI();
                
                // Modal'ı göster
                document.getElementById('userSettingsModal').style.display = 'flex';
                
            } catch (error) {
                console.error('❌ Hasta verileri yüklenemedi:', error);
                alert('❌ Hasta bilgileri yüklenemedi!\n\nDosya: hastalar/patient_' + patientId.replace(/^patient_/i, '') + '.json\n\nHata: ' + error.message + '\n\nLütfen admin ile iletişime geçin.');
            }
        }

        // Modal Kapat
        function closeUserSettings() {
            // Modal'ı kapat
            document.getElementById('userSettingsModal').style.display = 'none';
            
            // Body'den modal-open class'ını kaldır (search kutusunu tekrar göster)
            document.body.classList.remove('modal-open');
            
            document.getElementById('userSettingsMessage').style.display = 'none';
            document.getElementById('userSettingsForm').reset();
        }

        // BMI Hesaplama
        function calculateUserBMI() {
            const weight = parseFloat(document.getElementById('userWeight').value);
            const height = parseFloat(document.getElementById('userHeight').value);
            
            if (weight > 0 && height > 0) {
                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
                document.getElementById('userBMI').value = bmi;
            } else {
                document.getElementById('userBMI').value = '';
            }
        }

        // Şifre Hash Fonksiyonu (SHA-256)
        async function hashPasswordUser(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Mesaj Göster
        function showUserMessage(message, type = 'success') {
            const messageDiv = document.getElementById('userSettingsMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.background = type === 'success' 
                ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' 
                : 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
            messageDiv.style.color = 'white';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 4000);
        }

        // Form Submit
        document.getElementById('userSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Session'dan patientId al
            const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
            
            const formData = {
                patientId: session.patientId,
                name: document.getElementById('userName').value.trim(),
                surname: document.getElementById('userSurname').value.trim(),
                age: parseInt(document.getElementById('userAge').value),
                gender: document.getElementById('userGender').value,
                weight: parseFloat(document.getElementById('userWeight').value),
                height: parseFloat(document.getElementById('userHeight').value),
                activityLevel: parseInt(document.getElementById('userActivityLevel').value),
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value.trim()
            };

            // Validasyon
            if (!formData.name || !formData.surname || !formData.age || !formData.gender || !formData.weight || !formData.height) {
                showUserMessage('⚠️ Lütfen tüm gerekli alanları doldurun!', 'error');
                return;
            }

            // Şifre varsa hash'le
            if (formData.password && formData.password.length >= 4) {
                try {
                    formData.passwordHash = await hashPasswordUser(formData.password);
                } catch (error) {
                    showUserMessage('❌ Şifre işlenirken hata oluştu!', 'error');
                    return;
                }
            }

            // API'ye gönder
            try {
                // TODO: Buraya Vercel API endpoint'i gelecek
                const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-patient';
                
                showUserMessage('⏳ Kaydediliyor...', 'success');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showUserMessage('✅ Bilgiler başarıyla güncellendi!', 'success');
                    
                    // LocalStorage session'ı güncelle
                    const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                    session.name = formData.name;
                    session.surname = formData.surname;
                    localStorage.setItem('patient_session', JSON.stringify(session));
                    
                    // Hasta verilerini localStorage'a kaydet
                    const cleanId = formData.patientId.replace(/^patient_/i, '');
                    const cachedDataKey = `patient_data_${cleanId}`;
                    
                    // Mevcut veriyi al veya yeni oluştur
                    let patientData = {};
                    try {
                        const existingData = localStorage.getItem(cachedDataKey);
                        if (existingData) {
                            patientData = JSON.parse(existingData);
                        }
                    } catch (e) {
                        console.warn('Mevcut veri okunamadı, yeni oluşturuluyor');
                    }
                    
                    // personalInfo'yu güncelle
                    patientData.personalInfo = {
                        name: formData.name,
                        surname: formData.surname,
                        age: formData.age,
                        gender: formData.gender,
                        weight: formData.weight,
                        height: formData.height,
                        activityLevel: formData.activityLevel
                    };
                    
                    // Şifre hash'i varsa ekle
                    if (formData.passwordHash) {
                        patientData.passwordHash = formData.passwordHash;
                    }
                    
                    // localStorage'a kaydet
                    localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                    console.log('💾 Hasta verileri localStorage\'a kaydedildi');
                    
                    setTimeout(() => {
                        closeUserSettings();
                        // Sayfayı yenile (görüntüyü güncellemek için)
                        location.reload();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Güncelleme başarısız');
                }

            } catch (error) {
                console.error('Kayıt hatası:', error);
                showUserMessage('❌ Kayıt başarısız: ' + error.message, 'error');
            }
        });

        // Ayarlar ikonuna tıklama event'i
        const settingsIcon = document.getElementById('openUserSettings');
        if (settingsIcon) {
            settingsIcon.addEventListener('click', openUserSettings);
            console.log('✅ Ayarlar ikonu event listener eklendi');
        } else {
            console.error('❌ Ayarlar ikonu bulunamadı!');
        }

        // ==================== HASTA AYARLARI FONKSİYONLARI BİTİŞ ====================

        // PWA Install Prompt - Otomatik Yükleme Önerisi
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                showInstallPrompt();
            }, 3000); // 3 saniye sonra göster
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const installBtn = confirm('🍽️ Yemek Alternatif Bulucu uygulamasını telefonunuza yüklemek ister misiniz?\n\n✓ Ana ekranınıza eklenecek\n✓ Uygulama gibi çalışacak\n✓ Offline çalışabilir\n✓ Daha hızlı erişim');
            
            if (installBtn) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('✅ Kullanıcı uygulamayı yükledi');
                    }
                    deferredPrompt = null;
                });
            }
        }

        window.addEventListener('appinstalled', () => {
            console.log('✅ Uygulama başarıyla yüklendi!');
            deferredPrompt = null;
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // 🔍 URL parametrelerini kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            const initialFood = urlParams.get('food');
            const selectorMode = urlParams.get('mode') === 'selector';
            const excludeCategoriesParam = urlParams.get('excludeCategories');
            const macrosParam = urlParams.get('macros');
            
            // Renderdaki makroları parse et
            let renderMacros = null;
            if (macrosParam) {
                try {
                    renderMacros = JSON.parse(decodeURIComponent(macrosParam));
                    console.log('📊 Renderdaki makrolar yüklendi:', renderMacros);
                } catch (e) {
                    console.warn('⚠️ Makro parse hatası:', e);
                }
            }
            
            // Global değişkene kaydet - findAlternatives içinde kullanılacak
            window.excludedCategories = excludeCategoriesParam 
                ? excludeCategoriesParam.split(',').filter(c => c.trim()) 
                : [];
            window.renderMacros = renderMacros; // Global'e kaydet
            
            console.log('🚫 Hariç tutulacak kategoriler:', window.excludedCategories);
            
            // Selector modunda ise özel buton ekle
            if (selectorMode) {
                console.log('🔍 Selector mode aktif - Buton oluşturuluyor');
                
                const useButton = document.createElement('button');
                useButton.className = 'btn-use-selected';
                useButton.textContent = '✅ Seçileni Kullan';
                useButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    border: 2px solid white;
                    padding: 15px 30px;
                    border-radius: 50px;
                    font-size: 18px;
                    font-weight: bold;
                    box-shadow: 0 4px 20px rgba(40, 167, 69, 0.6);
                    cursor: pointer;
                    z-index: 99999;
                    display: block;
                    animation: pulse 2s infinite;
                `;
                useButton.onclick = function() {
                    const selectedFood = currentAlternatives[currentIndex];
                    console.log('🎯 Seçileni Kullan tıklandı:', selectedFood);
                    if (selectedFood) {
                        // 📨 postMessage ile parent window'a gönder (CORS güvenli)
                        if (window.parent && window.parent !== window) {
                            console.log('📤 Parent window\'a postMessage ile gönderiliyor:', selectedFood.name);
                            window.parent.postMessage({
                                type: 'REPLACE_FOOD',
                                food: selectedFood
                            }, '*');
                        } 
                        // Yoksa opener kullan (yeni sekme mode)
                        else if (window.opener) {
                            console.log('📤 Opener window\'a postMessage ile gönderiliyor:', selectedFood.name);
                            window.opener.postMessage({
                                type: 'REPLACE_FOOD',
                                food: selectedFood
                            }, '*');
                            // Birkaç ms sonra pencereyi kapat
                            setTimeout(() => window.close(), 100);
                        }
                        else {
                            alert('❌ Parent window bulunamadı!');
                        }
                    } else {
                        alert('❌ Lütfen önce bir yemek seçin!');
                    }
                };
                document.body.appendChild(useButton);
                console.log('✅ Buton eklendi ve görünür');
                
                // Yemek seçildiğinde butonu göster
                window.showUseButton = function() {
                    useButton.style.display = 'block';
                    console.log('👁️ Buton gösterildi');
                };
            } else {
                console.log('ℹ️ Normal mod - Selector mode değil');
            }
            
            // PWA'yı etkinleştiren Service Worker ve Manifest kodları
            if ('serviceWorker' in navigator) {
                const isSecureOrigin = ['https:', 'http:'].includes(window.location.protocol) || window.location.protocol === 'chrome-extension:';
                if (!isSecureOrigin) {
                    console.warn('⚠️ Service Worker yalnızca güvenli originlerde (http/https) kayıt edilir.');
                } else {
                    const CACHE_NAME = 'yemek-alternatif-v12'; // Kart tasarımı + Buton navigasyonda aktif yemek akordiyon başlığı altında tam hizalı
                const manifest = {
                    "short_name": "Yemek Alternatif",
                    "name": "Yemek Alternatif Bulucu",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#667eea",
                    "theme_color": "#764ba2",
                    "icons": [
                        // Android Ana Ekran İkonu
                        // ✅ İKON GÜNCELLENDİ
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "192x192",
                            "type": "image/png",
                            "purpose": "any maskable"
                        },
                        // Android Açılış Ekranı ve Diğerleri İçin
                        // ✅ İKON GÜNCELLENDİ
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "512x512",
                            "type": "image/png",
                            "purpose": "any maskable"
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifestLink').setAttribute('href', manifestURL);

                const serviceWorkerContent = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const urlsToCache = [
                        '.',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli
                        
                        /main/food_list.json',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('Opened cache');
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.open(CACHE_NAME).then(cache => {
                                return fetch(event.request)
                                    .then(response => {
                                        if (response.status === 200) {
                                            cache.put(event.request.url, response.clone());
                                        }
                                        return response;
                                    })
                                    .catch(() => {
                                        return cache.match(event.request);
                                    });
                            })
                        );
                    });
                `;
                // GitHub Pages blob: URL desteklemiyor, ServiceWorker'ı devre dışı bırak
                console.log('ℹ️ ServiceWorker GitHub Pages için devre dışı (blob: URL desteklenmiyor)');
                
                // const swBlob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
                // const swURL = URL.createObjectURL(swBlob);
                // navigator.serviceWorker.register(swURL)
                //     .then(registration => {
                //         console.log('ServiceWorker registration successful with scope: ', registration.scope);
                //     })
                //     .catch(err => {
                //         console.log('ServiceWorker registration failed: ', err);
                //     });
                }
            }

            // --- Uygulama Mantığı Başlangıcı ---
            
            function fixTurkishChars(text) {
                if (!text || typeof text !== 'string') return text;
                let fixed = text;
                for (let i = 0; i < 2; i++) {
                    try {
                        const decoded = decodeURIComponent(escape(fixed));
                        if (decoded === fixed) break;
                        fixed = decoded;
                    } catch (err) {
                        break;
                    }
                }

                const charMap = {
                    'Ä±':'ı','ä±':'ı','Ã':'Ç','Ã§':'ç','ã‡':'Ç','ã§':'ç','ÅŸ':'ş','åŸ':'ş','Åž':'Ş','åž':'Ş',
                    'Ä°':'İ','ä°':'İ','Ã¶':'ö','ã¶':'ö','Ã–':'Ö','ã–':'Ö','Ã¼':'ü','ã¼':'ü','Ãœ':'Ü','ãœ':'Ü',
                    'ÄŸ':'ğ','äŸ':'ğ','Äž':'Ğ','äž':'Ğ','ÃÂ±':'ı','ÃÂ°':'İ','ÃÂ':'ğ','ÃÂ':'Ğ','ÃÂŸ':'ş','ÃÂ':'Ş',
                    'ÃÂ§':'ç','ÃÂ':'Ç','ÃÂ¶':'ö','ÃÂ':'Ö','ÃÂ¼':'ü','ÃÂ':'Ü','ÃÂ±':'ñ','ÃÂ½':'ı','ÃÂ':'İ','ÃÂ':'ß',
                    '×':'','Ã':'','Â':' '
                };
                let previous;
                do {
                    previous = fixed;
                    for (const [wrong, correct] of Object.entries(charMap)) {
                        fixed = fixed.replace(new RegExp(wrong, 'g'), correct);
                    }
                } while (fixed !== previous);

                return fixed;
            }
            
            // Global değişkenler (script başında tanımlı - burada sadece lokaller)
            // var currentAlternatives = []; // GLOBAL
            // var currentIndex = 0; // GLOBAL
            // var foodDatabase = []; // GLOBAL
            
            let selectedFood = null;
            let scoreBy = ['protein', 'fat']; // Default: Protein ve Yağ aktif
            let matchCriteria = {}; // Boş başlat - applySettings() içinde config'den doldurulacak
            let tarifKartlari = [];
            let originalSelectedFood = null;
            let manuelEslestirmeler = {};
            let yemekVeritabaniEslestirme = {}; // Yemek veritabanı manuel eşleştirme
            let eslesmemeKurallari = {};
            let totalAlternativesForSelected = 0;

            const REPO_OWNER = 'mustafasacar35';
            const REPO_NAME = 'lipodem-takip-paneli';
            const SETTINGS_PATH = 'settings/config.json';
            const SETTINGS_BRANCH = 'main';

            let appSettings = {
                version: 1,
                updatedAt: new Date().toISOString(),
                defaultAlternativeCount: 3,
                enableTagFilter: true,
                tagExclusions: [],
                tagExemptions: {
                    roles: [],
                    categories: []
                },
                rotation: {
                    enabled: true,
                    chunkSize: 3
                }
            };

            let settingsSha = null;
            let settingsLoaded = false;
            let rotationStorageKey = 'altRotationState_v1';
            let rotationChunkSize = 3;
            let tagExclusionSet = new Set();
            let tagExemptRoleSet = new Set();
            let tagExemptCategorySet = new Set();
            const availableRoles = new Set();
            const availableCategories = new Set();
            const ROLE_DISPLAY_MAP = {
                maindish: 'Ana Yemek',
                sidedish: 'Yan Yemek',
                bread: 'Ekmek',
                dessert: 'Tatlı',
                drink: 'İçecek',
                fruit: 'Meyve',
                snack: 'Atıştırmalık',
                soup: 'Çorba',
                supplement: 'Takviye'
            };

            function getRoleDisplayName(role) {
                if (!role || typeof role !== 'string') return role;
                const normalized = role.toLowerCase();
                return ROLE_DISPLAY_MAP[normalized] || role;
            }
            
            // Aktif makrolar için global değişken (Protein ve Yağ default)
            window.activeMacros = ['protein', 'fat'];

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentAlternatives.length === 0) return;
                currentIndex--;
                if (currentIndex < 0) currentIndex = 0;
                navigateToFood(currentIndex);
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentAlternatives.length === 0) return;
                currentIndex++;
                if (currentIndex >= currentAlternatives.length) currentIndex = currentAlternatives.length - 1;
                navigateToFood(currentIndex);
            });

            document.getElementById('resetBtn').addEventListener('click', () => {
                if (currentAlternatives.length === 0) return;
                currentIndex = 0;
                navigateToFood(0); 
            });

            function navigateToFood(index) {
                if (!currentAlternatives[index]) return;
                currentIndex = index;
                const food = currentAlternatives[index];
                selectedFood = food;
                showAlternativeFood(food);
                highlightTableRow(index);
                
                // Selector modunda "Seçileni Kullan" butonunu göster
                if (window.showUseButton) {
                    window.showUseButton();
                }
                
                // Aktif yemeği akordiyon başlığının TAM ALTINA hizala
                const resultsList = document.getElementById('resultsList');
                const rows = document.querySelectorAll('.food-table tbody tr.food-card-row');
                if (rows[index] && resultsList) {
                    requestAnimationFrame(() => {
                        // Seçili kartın container içindeki pozisyonunu al
                        const cardElement = rows[index];
                        const containerRect = resultsList.getBoundingClientRect();
                        const cardRect = cardElement.getBoundingClientRect();
                        
                        // Mevcut scroll pozisyonu + kartın container içindeki relatif pozisyonu
                        const scrollOffset = resultsList.scrollTop;
                        const cardTopRelativeToContainer = cardRect.top - containerRect.top;
                        
                        // Kartı tam üste hizala (padding/margin'i kompanse et)
                        const targetScrollTop = scrollOffset + cardTopRelativeToContainer;
                        
                        resultsList.scrollTo({
                            top: Math.max(0, targetScrollTop),
                            behavior: 'smooth'
                        });
                    });
                }
            }

            function showAlternativeFood(food) {
                const alternativeFood = document.getElementById('alternativeFood');
                const alternativeName = document.getElementById('alternativeName');
                const alternativeMacros = document.getElementById('alternativeMacros');
                const alternativeTags = document.getElementById('alternativeTags');
                const similarityBadgeContainer = document.getElementById('similarityBadgeContainer');

                if (food.similarity !== undefined) {
                    similarityBadgeContainer.innerHTML = `<span class="similarity-badge" style="font-size: 16px; padding: 6px 12px;">${food.similarity}%</span>`;
                } else {
                    similarityBadgeContainer.innerHTML = '';
                }

                const tarifKartlari = findTarifKartlari(food.name);
                const tarifBadges = tarifKartlari.map((tarif, index) => {
                    const imageUrl = tarif.download_url || `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${tarif.name}`;
                    const tarifLabel = tarifKartlari.length > 1 ? `Tarif ${index + 1}` : 'Tarif';
                    return `<span class="recipe-badge" onclick="openModal('${imageUrl}')" style="cursor: pointer;">📖 ${tarifLabel} 👆</span>`;
                });

                alternativeName.textContent = food.name;
                
                const refFood = originalSelectedFood || food;
                const calorieDiff = Math.round((food.calories || 0) - (refFood.calories || 0));
                const carbDiff = Math.round((food.carbs || 0) - (refFood.carbs || 0));
                const proteinDiff = Math.round((food.protein || 0) - (refFood.protein || 0));
                const fatDiff = Math.round((food.fat || 0) - (refFood.fat || 0));
                
                const formatDiff = (diff) => diff === 0 ? '' : `<div style="font-size: 14px; color: white; margin-top: 2px; font-weight: normal;">(${(diff > 0 ? '+' : '')}${diff})</div>`;
                
                alternativeMacros.innerHTML = `
                    <div class="macro-box"><strong>${Math.round(food.calories || 0)}</strong><span>Kalori</span>${formatDiff(calorieDiff)}</div>
                    <div class="macro-box"><strong>${Math.round(food.carbs || 0)}g</strong><span>Karb</span>${formatDiff(carbDiff)}</div>
                    <div class="macro-box"><strong>${Math.round(food.protein || 0)}g</strong><span>Protein</span>${formatDiff(proteinDiff)}</div>
                    <div class="macro-box"><strong>${Math.round(food.fat || 0)}g</strong><span>Yağ</span>${formatDiff(fatDiff)}</div>`;

                const tags = [];
                if (food.role) {
                    const roleDisplay = getRoleDisplayName(food.role);
                    tags.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Yemek türü:</span>');
                    tags.push(`<span class="meta-tag">${roleDisplay}</span>`);
                }
                tags.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-left: 8px; margin-right: 6px;">Diyet türü:</span>');
                if (food.keto) tags.push(`<span class="meta-tag keto">Ketojenik</span>`);
                else if (food.lowcarb) tags.push(`<span class="meta-tag lowcarb">Düşük Karb</span>`);
                else tags.push(`<span class="meta-tag" style="background: rgba(255,255,255,0.15);">Genel</span>`);

                alternativeTags.innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center; line-height: 1;">${tags.join('')}</div>`;
                document.getElementById('alternativeTarifler').innerHTML = tarifBadges.join('');
                alternativeFood.classList.add('show');
            }

            // 🆕 Mor kartta aranan yemeği göster
            function showSelectedFood(food) {
                console.log('🟣 showSelectedFood() çağrıldı:', food.name, '| Kalori:', food.calories);
                
                const selectedFood = document.getElementById('selectedFood');
                const selectedName = document.getElementById('selectedName');
                const selectedMacros = document.getElementById('selectedMacros');
                const selectedTags = document.getElementById('selectedTags');

                const tarifKartlari = findTarifKartlari(food.name);
                const tarifBadges = tarifKartlari.map((tarif, index) => {
                    const imageUrl = tarif.download_url || `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${tarif.name}`;
                    const tarifLabel = tarifKartlari.length > 1 ? `Tarif ${index + 1}` : 'Tarif';
                    return `<span class="recipe-badge" onclick="openModal('${imageUrl}')" style="cursor: pointer;">📖 ${tarifLabel} 👆</span>`;
                });

                selectedName.textContent = food.name;
                
                selectedMacros.innerHTML = `
                    <div class="macro-box"><strong>${Math.round(food.calories || 0)}</strong><span>Kalori</span></div>
                    <div class="macro-box"><strong>${Math.round(food.carbs || 0)}g</strong><span>Karb</span></div>
                    <div class="macro-box"><strong>${Math.round(food.protein || 0)}g</strong><span>Protein</span></div>
                    <div class="macro-box"><strong>${Math.round(food.fat || 0)}g</strong><span>Yağ</span></div>`;

                const tags = [];
                if (food.role) {
                    const roleDisplay = getRoleDisplayName(food.role);
                    tags.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Yemek türü:</span>');
                    tags.push(`<span class="meta-tag">${roleDisplay}</span>`);
                }
                tags.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-left: 8px; margin-right: 6px;">Diyet türü:</span>');
                if (food.keto) tags.push(`<span class="meta-tag keto">Ketojenik</span>`);
                else if (food.lowcarb) tags.push(`<span class="meta-tag lowcarb">Düşük Karb</span>`);
                else tags.push(`<span class="meta-tag" style="background: rgba(255,255,255,0.15);">Genel</span>`);

                selectedTags.innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center; line-height: 1;">${tags.join('')}</div>`;
                document.getElementById('selectedTarifler').innerHTML = tarifBadges.join('');
                selectedFood.style.display = 'block';
            }

            function highlightTableRow(index) {
                document.querySelectorAll('.food-table tbody tr').forEach((row, i) => {
                    row.classList.toggle('highlighted', i === index);
                });
            }

            window.openModal = function(imageUrl) {
                const modal = document.getElementById('tarifModal');
                document.getElementById('modalImage').src = imageUrl;
                modal.classList.add('active');
            }

            window.closeModal = function() {
                document.getElementById('tarifModal').classList.remove('active');
            }

            document.getElementById('tarifModal').addEventListener('click', (e) => {
                if (e.target.id === 'tarifModal') closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

            async function loadFoodData() {
                try {
                    document.getElementById('resultsList').innerHTML = '<div class="loading">Yemek veritabanı yükleniyor...</div>';
                    const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/food_list.json');
                    const data = await response.json();
                    foodDatabase = [];
                    if (data.categories && Array.isArray(data.categories)) {
                        data.categories.forEach(category => {
                            if (category.items && Array.isArray(category.items)) {
                                category.items.forEach(item => {
                                    if (item.name) item.name = fixTurkishChars(item.name);
                                    if (item.category) item.category = fixTurkishChars(item.category);
                                    if (item.role) item.role = fixTurkishChars(item.role);
                                    if (item.mealType) item.mealType = fixTurkishChars(item.mealType);
                                    if (Array.isArray(item.tags)) {
                                        item.tags = item.tags.map(tag => typeof tag === 'string' ? fixTurkishChars(tag) : tag);
                                    } else if (typeof item.tags === 'string') {
                                        item.tags = fixTurkishChars(item.tags);
                                    }
                                    if (Array.isArray(item.compatibilityTags)) {
                                        item.compatibilityTags = item.compatibilityTags.map(tag => typeof tag === 'string' ? fixTurkishChars(tag) : tag);
                                    }
                                    foodDatabase.push(item);
                                    if (item.role) availableRoles.add(item.role);
                                    if (item.category) availableCategories.add(item.category);
                                });
                            }
                        });
                    }
                console.log('✅ Yemek veritabanı yüklendi:', foodDatabase.length);
                await loadTarifKartlari();
                await loadManuelEslestirmeler();
                document.getElementById('resultsList').innerHTML = '<div class="no-results">👆 Yukarıdan yemek arayın</div>';
            } catch (error) {
                console.error('❌ Veritabanı hatası:', error);
                document.getElementById('resultsList').innerHTML = '<div class="no-results">❌ Veritabanı yüklenemedi</div>';
            }
        }            async function loadManuelEslestirmeler() {
                try {
                    const manuelResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json');
                    if (manuelResp.ok) {
                        const manuelData = await manuelResp.json();
                        manuelEslestirmeler = manuelData.eslestirmeler || manuelData;
                        console.log('✅ Manuel eşleştirmeler yüklendi:', Object.keys(manuelEslestirmeler).length);
                    }
                    
                    // 🆕 Yemek veritabanı eşleştirmelerini yükle
                    const dbEslestirmeResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_eslestirme.json');
                    if (dbEslestirmeResp.ok) {
                        const dbData = await dbEslestirmeResp.json();
                        yemekVeritabaniEslestirme = dbData.eslestirmeler || dbData;
                        console.log('✅ Yemek veritabanı eşleştirmeleri yüklendi:', Object.keys(yemekVeritabaniEslestirme).length);
                    }
                    
                    const yasakResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json');
                    if (yasakResp.ok) {
                        const yasakData = await yasakResp.json();
                        console.log('🔍 Yasak data yapısı:', yasakData);
                        
                        // JSON yapısına göre doğru path'i bul
                        if (yasakData.kurallar && yasakData.kurallar.eslesmemeKurallari) {
                            // İç içe yapı: { kurallar: { eslesmemeKurallari: {...} } }
                            eslesmemeKurallari = yasakData.kurallar.eslesmemeKurallari;
                            
                            // Dış seviyedeki ekstra kuralları da ekle
                            Object.keys(yasakData.kurallar).forEach(key => {
                                if (key !== 'version' && key !== 'sonGuncelleme' && key !== 'eslesmemeKurallari' && typeof yasakData.kurallar[key] === 'object') {
                                    eslesmemeKurallari[key] = yasakData.kurallar[key];
                                }
                            });
                        } else if (yasakData.eslesmemeKurallari) {
                            eslesmemeKurallari = yasakData.eslesmemeKurallari;
                        } else if (yasakData.kurallar) {
                            eslesmemeKurallari = yasakData.kurallar;
                        } else if (Array.isArray(yasakData)) {
                            // Array ise object'e çevir
                            eslesmemeKurallari = {};
                            yasakData.forEach(kural => {
                                if (kural.yemek && kural.yasaklar) {
                                    eslesmemeKurallari[kural.yemek] = kural.yasaklar;
                                }
                            });
                        } else {
                            eslesmemeKurallari = yasakData;
                        }
                        
                        console.log('✅ Eşleşme yasakları yüklendi:', Object.keys(eslesmemeKurallari).length, 'yemek');
                        console.log('📋 Yasak listesi:', Object.keys(eslesmemeKurallari));
                    }
                } catch (error) {
                    console.error('❌ Manuel data yükleme hatası:', error);
                }
            }
            
            async function loadTarifKartlari() {
                try {
                    let response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            tarifKartlari = data.map(item => (typeof item === 'string' ? item : item.name || item.filename || item.file || null)).filter(name => name && name.match(/\.(jpg|jpeg|png)$/i)).map(name => ({ name: name, type: 'file', download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` }));
                            console.log('✅ Tarif kartları list.json ile yüklendi:', tarifKartlari.length);
                            return;
                        }
                    }
                    throw new Error('list.json yüklenemedi');
                } catch (error) {
                    console.error('❌ Tarif kartları yüklenemedi, fallback deneniyor:', error.message);
                    await loadManuelEslestirmeler();
                    const uniqueTarifler = new Set();
                    Object.values(manuelEslestirmeler).forEach(eslestirme => {
                        const kartlar = (typeof eslestirme === 'object' && eslestirme.kartlar) ? eslestirme.kartlar : (typeof eslestirme === 'string' ? [eslestirme] : []);
                        kartlar.forEach(kart => uniqueTarifler.add(kart));
                    });
                    tarifKartlari = [...uniqueTarifler].map(name => ({ name: name, type: 'file', download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` }));
                    console.log('✅ Fallback tarif kartları yüklendi:', tarifKartlari.length);
                }
            }

            function normalizeText(str) {
                if (!str) return '';
                return str.toLowerCase().replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ı/g,'i').replace(/i̇/g,'i').replace(/ö/g,'o').replace(/ş/g,'s').replace(/ü/g,'u').replace(/[^a-z0-9]/g,'');
            }

            function getISOWeekKey(date) {
                const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNumber = target.getUTCDay() || 7;
                target.setUTCDate(target.getUTCDate() + 4 - dayNumber);
                const yearStart = new Date(Date.UTC(target.getUTCFullYear(), 0, 1));
                const weekNumber = Math.ceil((((target - yearStart) / 86400000) + 1) / 7);
                return `${target.getUTCFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
            }

            function getRotationCycleKey(date) {
                const resetDay = typeof appSettings.rotation?.resetDay === 'number' && appSettings.rotation.resetDay >= 0 && appSettings.rotation.resetDay <= 6
                    ? appSettings.rotation.resetDay
                    : null;
                if (resetDay === null) {
                    return `iso-${getISOWeekKey(date)}`;
                }
                const cycleDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const jsDay = cycleDate.getDay();
                const mondayBasedDay = (jsDay + 6) % 7;
                let diff = mondayBasedDay - resetDay;
                if (diff < 0) diff += 7;
                cycleDate.setDate(cycleDate.getDate() - diff);
                return `cycle-${cycleDate.getFullYear()}-${String(cycleDate.getMonth() + 1).padStart(2, '0')}-${String(cycleDate.getDate()).padStart(2, '0')}-${resetDay}`;
            }

            function loadRotationState() {
                try {
                    const stored = window.localStorage ? window.localStorage.getItem(rotationStorageKey) : null;
                    return stored ? JSON.parse(stored) : {};
                } catch (error) {
                    console.warn('⚠️ Alternatif rotasyon durumu okunamadı:', error);
                    return {};
                }
            }

            function saveRotationState(state) {
                try {
                    if (window.localStorage) {
                        window.localStorage.setItem(rotationStorageKey, JSON.stringify(state));
                    }
                } catch (error) {
                    console.warn('⚠️ Alternatif rotasyon durumu kaydedilemedi:', error);
                }
            }

            function getDefaultChunkIndices(total) {
                const limit = Math.min(rotationChunkSize, total);
                return Array.from({ length: limit }, (_, index) => index);
            }

            function getRotatedAlternativeIndices(refFood, totalAlternatives) {
                if (!totalAlternatives || totalAlternatives <= 0) return [];
                if (!appSettings.rotation?.enabled) {
                    return getDefaultChunkIndices(totalAlternatives);
                }
                const normalizedName = normalizeText(refFood?.name || '');
                if (!normalizedName || !window.localStorage) {
                    return getDefaultChunkIndices(totalAlternatives);
                }

                const now = new Date();
                const cycleKey = getRotationCycleKey(now);
                const dayKey = now.toISOString().slice(0, 10);

                const state = loadRotationState();
                let foodState = state[normalizedName];

                if (!foodState || (foodState.weekKey && foodState.weekKey !== cycleKey) || foodState.cycleKey !== cycleKey) {
                    foodState = {
                        cycleKey,
                        pointer: 0,
                        servedDays: {}
                    };
                }

                if (!foodState.servedDays) foodState.servedDays = {};
                foodState.cycleKey = cycleKey;
                delete foodState.weekKey;

                let startIndex;
                if (foodState.servedDays[dayKey] !== undefined) {
                    startIndex = foodState.servedDays[dayKey] % totalAlternatives;
                } else {
                    startIndex = foodState.pointer % totalAlternatives;
                    foodState.servedDays[dayKey] = startIndex;
                    foodState.pointer = (startIndex + rotationChunkSize) % totalAlternatives;
                }

                state[normalizedName] = foodState;
                saveRotationState(state);

                const limit = Math.min(rotationChunkSize, totalAlternatives);
                const indices = [];
                for (let i = 0; i < limit; i++) {
                    indices.push((startIndex + i) % totalAlternatives);
                    if (indices.length === totalAlternatives) break;
                }
                return indices;
            }

            function applySettings() {
                // 🆕 Hasta bazlı alternatif sayısını kontrol et
                let patientAlternativeCount = null;
                try {
                    // Session'dan patient ID'yi al
                    const sessionData = localStorage.getItem('patient_session');
                    if (sessionData) {
                        const session = JSON.parse(sessionData);
                        if (session && session.patientId) {
                            // Hasta detay bilgisini localStorage'dan al (auth.js tarafından login sırasında kaydedilir)
                            const patientDetailsKey = `patientDetails_${session.patientId}`;
                            const patientDetailsData = localStorage.getItem(patientDetailsKey);
                            if (patientDetailsData) {
                                const patientDetails = JSON.parse(patientDetailsData);
                                // alternativeCount varsa kullan (null veya undefined kontrolü)
                                if (patientDetails.alternativeCount != null && patientDetails.alternativeCount > 0) {
                                    patientAlternativeCount = patientDetails.alternativeCount;
                                    console.log(`✅ Hasta bazlı alternatif sayısı kullanılıyor: ${patientAlternativeCount}`);
                                } else {
                                    console.log('ℹ️ Hasta için özel alternatif sayısı ayarlanmamış, admin default kullanılacak');
                                }
                            } else {
                                console.warn('⚠️ Hasta detayları localStorage\'da bulunamadı');
                            }
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Hasta bilgisi alınamadı:', error.message);
                }

                const desiredChunk = parseInt(appSettings.rotation?.chunkSize, 10);
                const desiredDefault = parseInt(appSettings.defaultAlternativeCount, 10);
                
                // 🔥 ÖNCELİK SIRASI: Hasta ayarı > Admin chunkSize > Admin default > 3
                // ⚠️ HASTA AYARI VARSA, ROTATION CHUNSIZE'I GÖRMEZDEN GEL!
                
                if (patientAlternativeCount && patientAlternativeCount > 0) {
                    // Hasta özel ayarı varsa, SADECE onu kullan
                    rotationChunkSize = patientAlternativeCount;
                    console.log(`✅ HASTA ÖZEL AYARI KULLANILIYOR: ${rotationChunkSize}`);
                } else if (appSettings.rotation?.enabled && !isNaN(desiredChunk) && desiredChunk > 0) {
                    // Hasta ayarı yoksa ve rotation aktifse, chunkSize kullan
                    rotationChunkSize = desiredChunk;
                    console.log(`🔄 Rotation chunkSize kullanılıyor: ${rotationChunkSize}`);
                } else if (!isNaN(desiredDefault) && desiredDefault > 0) {
                    // Rotation kapalı veya chunkSize yoksa, admin default kullan
                    rotationChunkSize = desiredDefault;
                    console.log(`📋 Admin default kullanılıyor: ${rotationChunkSize}`);
                } else {
                    // Hiçbiri yoksa varsayılan
                    rotationChunkSize = 3;
                    console.log(`⚠️ Varsayılan kullanılıyor: ${rotationChunkSize}`);
                }
                
                console.log(`🎯 SON KARAR - ALTERNATİF SAYISI: ${rotationChunkSize}`);
                const resetDayPart = typeof appSettings.rotation?.resetDay === 'number' && appSettings.rotation.resetDay >= 0 && appSettings.rotation.resetDay <= 6
                    ? `_d${appSettings.rotation.resetDay}`
                    : '';
                rotationStorageKey = `altRotationState_v1_${appSettings.rotation?.enabled ? 'on' : 'off'}_${rotationChunkSize}${resetDayPart}`;
                tagExclusionSet = new Set((appSettings.tagExclusions || []).map(normalizeText));
                tagExemptRoleSet = new Set((appSettings.tagExemptions?.roles || []).map(normalizeText));
                tagExemptCategorySet = new Set((appSettings.tagExemptions?.categories || []).map(normalizeText));

                // Filtreleme Kriterlerini Ayarla
                const filterCrit = appSettings.filterCriteria || {};
                
                // Role filtresi
                if (filterCrit.role?.visible) {
                    // Visible ise: zorunlu mu opsiyonel mi kontrol et
                    if (filterCrit.role.mode === 'required') {
                        matchCriteria.role = true; // Zorunlu - arka planda çalışır
                    } else {
                        // Opsiyonel - kullanıcı karar verir, defaultState'den başlangıç değerini al
                        if (!matchCriteria.hasOwnProperty('role')) {
                            matchCriteria.role = filterCrit.role.defaultState === 'active';
                        }
                    }
                } else {
                    // Visible değilse tamamen kaldır
                    delete matchCriteria.role;
                }
                
                // DietType filtresi
                if (filterCrit.dietType?.visible) {
                    if (filterCrit.dietType.mode === 'required') {
                        matchCriteria.dietType = true;
                    } else {
                        if (!matchCriteria.hasOwnProperty('dietType')) {
                            matchCriteria.dietType = filterCrit.dietType.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.dietType;
                }
                
                // Category filtresi
                if (filterCrit.category?.visible) {
                    if (filterCrit.category.mode === 'required') {
                        matchCriteria.category = true; // Zorunlu
                    } else {
                        if (!matchCriteria.hasOwnProperty('category')) {
                            matchCriteria.category = filterCrit.category.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.category;
                }
                
                // Season filtresi
                if (filterCrit.season?.visible) {
                    if (filterCrit.season.mode === 'required') {
                        matchCriteria.season = true;
                    } else {
                        if (!matchCriteria.hasOwnProperty('season')) {
                            matchCriteria.season = filterCrit.season.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.season;
                }
                
                // MealType filtresi
                if (filterCrit.mealType?.visible) {
                    if (filterCrit.mealType.mode === 'required') {
                        matchCriteria.mealType = true;
                    } else {
                        if (!matchCriteria.hasOwnProperty('mealType')) {
                            matchCriteria.mealType = filterCrit.mealType.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.mealType;
                }
                
                // 📊 Benzerlik Skoru Kriterleri - Admin settings'den yükle
                if (appSettings.scoreCriteria && Array.isArray(appSettings.scoreCriteria.activeByDefault)) {
                    scoreBy = [...appSettings.scoreCriteria.activeByDefault];
                    window.activeMacros = [...appSettings.scoreCriteria.activeByDefault];
                    console.log('✅ Benzerlik skoru kriterleri yüklendi:', scoreBy);
                } else {
                    // Varsayılan: protein ve fat
                    scoreBy = ['protein', 'fat'];
                    window.activeMacros = ['protein', 'fat'];
                    console.log('⚠️ Varsayılan skoru kriterleri kullanılıyor:', scoreBy);
                }
                
                // Butonları güncelle (sayfa hazırsa)
                updateScoreButtons();
            }

            async function loadSettings() {
                try {
                    const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${SETTINGS_PATH}?ref=${SETTINGS_BRANCH}`);
                    if (!response.ok) throw new Error(`Ayarlar yüklenemedi: ${response.status}`);
                    const data = await response.json();
                    settingsSha = data.sha;
                    const decoded = atob((data.content || '').replace(/\n/g, ''));
                    const parsed = JSON.parse(decoded);
                    appSettings = { ...appSettings, ...parsed };
                    settingsLoaded = true;
                } catch (error) {
                    console.warn('⚠️ Ayarlar yüklenemedi, varsayılanlar kullanılacak:', error.message);
                    if (!settingsLoaded) {
                        try {
                            const fallback = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${SETTINGS_BRANCH}/${SETTINGS_PATH}`);
                            if (fallback.ok) {
                                appSettings = { ...appSettings, ...(await fallback.json()) };
                                settingsLoaded = true;
                            }
                        } catch (fallbackError) {
                            console.warn('⚠️ Ayarların ham dosyası da alınamadı:', fallbackError.message);
                        }
                    }
                }
                applySettings();
            }

            // ==================== YASAK LİSTESİ YÜKLEME FONKSİYONU ====================
            async function loadBlacklist() {
                try {
                    console.log('🚫 Yasak listesi yükleniyor...');
                    const timestamp = new Date().getTime();
                    const blacklistUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/alternative_blacklist.json?t=${timestamp}`;
                    
                    const response = await fetch(blacklistUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        alternativeBlacklist = data.blacklist || [];
                        blacklistVersion = data.version || '1.0';
                        
                        // localStorage'a da kaydet (offline için)
                        localStorage.setItem('alternative_blacklist_cache', JSON.stringify(data));
                        
                        console.log(`✅ Yasak listesi yüklendi (${alternativeBlacklist.length} kural, v${blacklistVersion})`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.warn('⚠️ Yasak listesi GitHub\'dan yüklenemedi, cache kullanılıyor:', error.message);
                    
                    // Fallback: localStorage'dan yükle
                    const cached = localStorage.getItem('alternative_blacklist_cache');
                    if (cached) {
                        try {
                            const data = JSON.parse(cached);
                            alternativeBlacklist = data.blacklist || [];
                            blacklistVersion = data.version || '1.0';
                            console.log(`📦 Yasak listesi cache'den yüklendi (${alternativeBlacklist.length} kural)`);
                        } catch (e) {
                            console.error('❌ Cache parse hatası:', e);
                            alternativeBlacklist = [];
                        }
                    } else {
                        console.log('ℹ️ Henüz yasak listesi yok, boş başlatıldı');
                        alternativeBlacklist = [];
                    }
                }
            }

            // ==================== YASAK LİSTESİ MODAL FONKSİYONLARI ====================
            
            let selectedMainFoodForBan = null;
            let selectedAlternativesForBan = [];
            
            // Modal aç/kapat
            window.openBlacklistModal = function() {
                document.getElementById('blacklistModal').style.display = 'block';
                document.body.classList.add('modal-open');
                refreshBlacklistDisplay();
                setupBlacklistSearch();
            };
            
            window.closeBlacklistModal = function() {
                document.getElementById('blacklistModal').style.display = 'none';
                document.body.classList.remove('modal-open');
                clearBlacklistForm();
            };
            
            // Form temizle
            function clearBlacklistForm() {
                selectedMainFoodForBan = null;
                selectedAlternativesForBan = [];
                document.getElementById('blacklistMainFood').value = '';
                document.getElementById('blacklistAlternatives').value = '';
                document.getElementById('selectedMainFood').style.display = 'none';
                document.getElementById('selectedAlternatives').innerHTML = '';
                document.getElementById('blacklistMainFoodDropdown').style.display = 'none';
                document.getElementById('blacklistAlternativesDropdown').style.display = 'none';
                document.getElementById('bidirectionalBan').checked = false;
            }
            
            window.clearMainFood = function() {
                selectedMainFoodForBan = null;
                document.getElementById('selectedMainFood').style.display = 'none';
                document.getElementById('blacklistMainFood').value = '';
            };
            
            // Akıllı search kurulumu
            function setupBlacklistSearch() {
                const mainInput = document.getElementById('blacklistMainFood');
                const mainDropdown = document.getElementById('blacklistMainFoodDropdown');
                const altInput = document.getElementById('blacklistAlternatives');
                const altDropdown = document.getElementById('blacklistAlternativesDropdown');
                
                // Hedef yemek search
                mainInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim().toLowerCase();
                    if (query.length < 2) {
                        mainDropdown.style.display = 'none';
                        return;
                    }
                    
                    const matches = foodDatabase.filter(food => 
                        normalizeText(food.name).includes(normalizeText(query))
                    ).slice(0, 10);
                    
                    if (matches.length > 0) {
                        mainDropdown.innerHTML = matches.map(food => `
                            <div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;" 
                                 onclick="selectMainFoodForBan('${food.name.replace(/'/g, "\\'")}')">
                                <div style="font-weight: 600;">${food.name}</div>
                                <div style="font-size: 11px; color: #666;">
                                    🔥 ${Math.round(food.calories || 0)} kcal • 
                                    🍞 ${Math.round(food.carbs || 0)}g • 
                                    🥩 ${Math.round(food.protein || 0)}g • 
                                    🥑 ${Math.round(food.fat || 0)}g
                                </div>
                            </div>
                        `).join('');
                        mainDropdown.style.display = 'block';
                    } else {
                        mainDropdown.style.display = 'none';
                    }
                });
                
                // Alternatif search
                altInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim().toLowerCase();
                    if (query.length < 2) {
                        altDropdown.style.display = 'none';
                        return;
                    }
                    
                    const matches = foodDatabase.filter(food => 
                        normalizeText(food.name).includes(normalizeText(query)) &&
                        !selectedAlternativesForBan.includes(food.name)
                    ).slice(0, 10);
                    
                    if (matches.length > 0) {
                        altDropdown.innerHTML = matches.map(food => `
                            <div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;" 
                                 onclick="addAlternativeForBan('${food.name.replace(/'/g, "\\'")}')">
                                <div style="font-weight: 600;">${food.name}</div>
                                <div style="font-size: 11px; color: #666;">
                                    🔥 ${Math.round(food.calories || 0)} kcal • 
                                    🍞 ${Math.round(food.carbs || 0)}g • 
                                    🥩 ${Math.round(food.protein || 0)}g • 
                                    🥑 ${Math.round(food.fat || 0)}g
                                </div>
                            </div>
                        `).join('');
                        altDropdown.style.display = 'block';
                    } else {
                        altDropdown.style.display = 'none';
                    }
                });
                
                // Arama listesi filtreleme
                const searchInput = document.getElementById('searchBlacklist');
                searchInput.addEventListener('input', (e) => {
                    refreshBlacklistDisplay(e.target.value.toLowerCase());
                });
            }
            
            window.selectMainFoodForBan = function(foodName) {
                selectedMainFoodForBan = foodName;
                document.getElementById('blacklistMainFood').value = '';
                document.getElementById('blacklistMainFoodDropdown').style.display = 'none';
                
                const container = document.getElementById('selectedMainFood');
                container.querySelector('span').textContent = foodName;
                container.style.display = 'block';
            };
            
            window.addAlternativeForBan = function(foodName) {
                if (!selectedAlternativesForBan.includes(foodName)) {
                    selectedAlternativesForBan.push(foodName);
                    updateAlternativesDisplay();
                }
                document.getElementById('blacklistAlternatives').value = '';
                document.getElementById('blacklistAlternativesDropdown').style.display = 'none';
            };
            
            window.removeAlternativeForBan = function(foodName) {
                selectedAlternativesForBan = selectedAlternativesForBan.filter(f => f !== foodName);
                updateAlternativesDisplay();
            };
            
            function updateAlternativesDisplay() {
                const container = document.getElementById('selectedAlternatives');
                container.innerHTML = selectedAlternativesForBan.map(name => `
                    <span style="background: #ff6b6b; color: white; padding: 6px 12px; border-radius: 16px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                        ${name}
                        <button onclick="removeAlternativeForBan('${name.replace(/'/g, "\\'")}')" 
                                style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">✖</button>
                    </span>
                `).join('');
            }
            
            // Yasak listesine ekle
            window.addToBlacklist = async function() {
                if (!selectedMainFoodForBan) {
                    alert('⚠️ Lütfen hedef yemeği seçin!');
                    return;
                }
                
                if (selectedAlternativesForBan.length === 0) {
                    alert('⚠️ Lütfen en az bir alternatif seçin!');
                    return;
                }
                
                const isBidirectional = document.getElementById('bidirectionalBan').checked;
                
                try {
                    const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                    const username = session.username || 'admin';
                    
                    // Mevcut blacklist'i kopyala
                    const updatedBlacklist = [...alternativeBlacklist];
                    
                    // Ana yemek için yasak ekle/güncelle
                    let mainEntry = updatedBlacklist.find(item => item.mainFood === selectedMainFoodForBan);
                    if (mainEntry) {
                        // Var olan entry'yi güncelle - yeni yasakları ekle (tekrar olmaması için Set kullan)
                        const combined = new Set([...mainEntry.bannedAlternatives, ...selectedAlternativesForBan]);
                        mainEntry.bannedAlternatives = Array.from(combined);
                        mainEntry.lastUpdated = new Date().toISOString();
                        mainEntry.lastUpdatedBy = username;
                    } else {
                        // Yeni entry oluştur
                        updatedBlacklist.push({
                            id: `bl_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            mainFood: selectedMainFoodForBan,
                            bannedAlternatives: [...selectedAlternativesForBan],
                            addedBy: username,
                            addedDate: new Date().toISOString().split('T')[0],
                            lastUpdated: new Date().toISOString()
                        });
                    }
                    
                    // Çift yönlü ise
                    if (isBidirectional) {
                        selectedAlternativesForBan.forEach(altFood => {
                            let altEntry = updatedBlacklist.find(item => item.mainFood === altFood);
                            if (altEntry) {
                                const combined = new Set([...altEntry.bannedAlternatives, selectedMainFoodForBan]);
                                altEntry.bannedAlternatives = Array.from(combined);
                                altEntry.lastUpdated = new Date().toISOString();
                                altEntry.lastUpdatedBy = username;
                            } else {
                                updatedBlacklist.push({
                                    id: `bl_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    mainFood: altFood,
                                    bannedAlternatives: [selectedMainFoodForBan],
                                    addedBy: username,
                                    addedDate: new Date().toISOString().split('T')[0],
                                    lastUpdated: new Date().toISOString(),
                                    bidirectional: true
                                });
                            }
                        });
                    }
                    
                    // GitHub'a kaydet
                    const blacklistData = {
                        version: blacklistVersion,
                        lastUpdated: new Date().toISOString(),
                        blacklist: updatedBlacklist
                    };
                    
                    await saveBlacklistToGitHub(blacklistData);
                    
                    // Global değişkeni güncelle
                    alternativeBlacklist = updatedBlacklist;
                    
                    alert(`✅ Yasak listesi güncellendi!\n\n${selectedMainFoodForBan} için ${selectedAlternativesForBan.length} alternatif yasaklandı.${isBidirectional ? '\n(Çift yönlü)' : ''}`);
                    
                    clearBlacklistForm();
                    refreshBlacklistDisplay();
                    
                    // Eğer halihazırda alternatif gösteriliyorsa yenile
                    if (originalSelectedFood) {
                        findAlternatives(originalSelectedFood);
                    }
                    
                } catch (error) {
                    console.error('❌ Yasak listesi kaydetme hatası:', error);
                    alert('❌ Yasak listesi kaydedilemedi!\n\n' + error.message);
                }
            };
            
            // GitHub'a kaydet
            async function saveBlacklistToGitHub(data) {
                const jsonContent = JSON.stringify(data, null, 2);
                const filePath = 'data/alternative_blacklist.json';
                const commitMessage = `Yasak listesi güncellendi - ${new Date().toISOString()}`;
                
                await updateGithubFile(filePath, jsonContent, commitMessage);
                
                console.log('✅ Yasak listesi GitHub\'a kaydedildi');
            }
            
            // Yasak listesini göster
            function refreshBlacklistDisplay(searchQuery = '') {
                const container = document.getElementById('currentBlacklistItems');
                const countEl = document.getElementById('blacklistCount');
                
                let filtered = alternativeBlacklist;
                
                if (searchQuery) {
                    filtered = alternativeBlacklist.filter(item => 
                        normalizeText(item.mainFood).includes(normalizeText(searchQuery)) ||
                        item.bannedAlternatives.some(alt => normalizeText(alt).includes(normalizeText(searchQuery)))
                    );
                }
                
                countEl.textContent = filtered.length;
                
                if (filtered.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Henüz yasak kuralı yok</div>';
                    return;
                }
                
                container.innerHTML = filtered.map(item => `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ff6b6b;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 15px; color: #333; margin-bottom: 4px;">
                                    📋 ${item.mainFood}
                                </div>
                                <div style="font-size: 12px; color: #6c757d;">
                                    Ekleyen: ${item.addedBy || 'admin'} • ${item.addedDate || 'Tarih yok'}
                                    ${item.bidirectional ? ' • <span style="color: #0066cc;">🔄 Çift Yönlü</span>' : ''}
                                </div>
                            </div>
                            <button onclick="deleteBlacklistEntry('${item.mainFood.replace(/'/g, "\\'")}', '${item.id}')" 
                                    style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                🗑️ Sil
                            </button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                            ${item.bannedAlternatives.map(alt => `
                                <span style="background: white; border: 2px solid #ff6b6b; color: #ff6b6b; padding: 4px 10px; border-radius: 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;">
                                    🚫 ${alt}
                                    <button onclick="removeSingleBan('${item.mainFood.replace(/'/g, "\\'")}', '${alt.replace(/'/g, "\\'")}', '${item.id}')" 
                                            style="background: rgba(255,107,107,0.2); border: none; color: #ff6b6b; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 11px; padding: 0;">✖</button>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            // Tek bir yasağı kaldır
            window.removeSingleBan = async function(mainFood, bannedFood, entryId) {
                if (!confirm(`"${mainFood}" için "${bannedFood}" yasağını kaldırmak istediğinizden emin misiniz?`)) {
                    return;
                }
                
                try {
                    const entry = alternativeBlacklist.find(item => item.mainFood === mainFood);
                    if (!entry) return;
                    
                    entry.bannedAlternatives = entry.bannedAlternatives.filter(f => f !== bannedFood);
                    
                    // Eğer boş kaldıysa entry'yi sil
                    if (entry.bannedAlternatives.length === 0) {
                        alternativeBlacklist = alternativeBlacklist.filter(item => item.mainFood !== mainFood);
                    }
                    
                    await saveBlacklistToGitHub({
                        version: blacklistVersion,
                        lastUpdated: new Date().toISOString(),
                        blacklist: alternativeBlacklist
                    });
                    
                    refreshBlacklistDisplay();
                    
                    // Eğer halihazırda alternatif gösteriliyorsa yenile
                    if (originalSelectedFood) {
                        findAlternatives(originalSelectedFood);
                    }
                    
                } catch (error) {
                    alert('❌ Yasak kaldırılamadı: ' + error.message);
                }
            };
            
            // Tüm entry'yi sil
            window.deleteBlacklistEntry = async function(mainFood, entryId) {
                const entry = alternativeBlacklist.find(item => item.mainFood === mainFood);
                if (!entry) return;
                
                const count = entry.bannedAlternatives.length;
                
                if (!confirm(`"${mainFood}" için tüm yasakları kaldırmak istediğinizden emin misiniz?\n\n(${count} adet yasak silinecek)`)) {
                    return;
                }
                
                try {
                    alternativeBlacklist = alternativeBlacklist.filter(item => item.mainFood !== mainFood);
                    
                    await saveBlacklistToGitHub({
                        version: blacklistVersion,
                        lastUpdated: new Date().toISOString(),
                        blacklist: alternativeBlacklist
                    });
                    
                    refreshBlacklistDisplay();
                    
                    // Eğer halihazırda alternatif gösteriliyorsa yenile
                    if (originalSelectedFood) {
                        findAlternatives(originalSelectedFood);
                    }
                    
                } catch (error) {
                    alert('❌ Yasak silinemedi: ' + error.message);
                }
            };

            // Hızlı yasaklama (alternatif kartından)
            window.banAlternativeQuick = async function(foodName) {
                if (!originalSelectedFood) {
                    alert('⚠️ Hedef yemek bulunamadı!');
                    return;
                }
                
                const mainFood = originalSelectedFood.name;
                
                if (!confirm(`"${foodName}" yemeğini "${mainFood}" için alternatif olmaktan çıkarmak istediğinizden emin misiniz?`)) {
                    return;
                }
                
                try {
                    const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                    const username = session.username || 'admin';
                    
                    const updatedBlacklist = [...alternativeBlacklist];
                    
                    let entry = updatedBlacklist.find(item => item.mainFood === mainFood);
                    if (entry) {
                        if (!entry.bannedAlternatives.includes(foodName)) {
                            entry.bannedAlternatives.push(foodName);
                            entry.lastUpdated = new Date().toISOString();
                            entry.lastUpdatedBy = username;
                        }
                    } else {
                        updatedBlacklist.push({
                            id: `bl_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            mainFood: mainFood,
                            bannedAlternatives: [foodName],
                            addedBy: username,
                            addedDate: new Date().toISOString().split('T')[0],
                            lastUpdated: new Date().toISOString()
                        });
                    }
                    
                    await saveBlacklistToGitHub({
                        version: blacklistVersion,
                        lastUpdated: new Date().toISOString(),
                        blacklist: updatedBlacklist
                    });
                    
                    alternativeBlacklist = updatedBlacklist;
                    
                    alert(`✅ "${foodName}" yasaklandı!`);
                    
                    // Alternatifleri yenile
                    findAlternatives(originalSelectedFood);
                    
                } catch (error) {
                    console.error('❌ Hızlı yasaklama hatası:', error);
                    alert('❌ Yasaklama başarısız: ' + error.message);
                }
            };

            function findTarifKartlari(yemekAdi) {
                if (!tarifKartlari.length) return [];
                
                // Yemek adını temizle (parantez içi, miktar vs.)
                let cleanedYemekAdi = yemekAdi
                    .replace(/\([^)]*\)/g,'')
                    .replace(/^\d+\.\s*|^\d+\s*adet\s*|^\d+\s*dilim\s*|^\d+\s*gram\s*|^\d+\s*g\s*|^\d+\s*ml\s*|^\d+\s*porsiyon\s*|^\d+\s*su bardağı\s*|^\d+\s*(tatlı|çorba|yemek)\s*kaşığı\s*|^\d+\s*kase\s*/i, '')
                    .trim();
                const normalizedCleaned = normalizeText(cleanedYemekAdi);
                
                // 1. Manuel eşleştirmelere bak
                let manuelData = manuelEslestirmeler[yemekAdi] || Object.keys(manuelEslestirmeler).find(key => normalizeText(key) === normalizedCleaned);
                if (manuelData && manuelEslestirmeler[manuelData]) {
                    manuelData = manuelEslestirmeler[manuelData];
                }

                if (manuelData) {
                    const manuelTarifAdlari = (typeof manuelData === 'object' && manuelData.kartlar) 
                        ? manuelData.kartlar 
                        : (typeof manuelData === 'string' ? [manuelData] : []);
                    
                    const bulunanKartlar = manuelTarifAdlari.map(manuelTarifAdi => {
                        const foundTarif = tarifKartlari.find(tarif => {
                            const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                            const manuelName = (typeof manuelTarifAdi === 'string' ? manuelTarifAdi : '').replace(/\.(jpg|jpeg|png)$/i, '');
                            return normalizeText(tarifName) === normalizeText(manuelName) || tarifName === manuelName;
                        });
                        
                        // ✅ DÜZELTME: Eğer tarifKartlari string array ise, dosya adını direkt kullan
                        if (foundTarif) {
                            return foundTarif;
                        } else {
                            // Manuel eşleştirmede dosya adı varsa, onu kullan
                            const fileName = manuelTarifAdi.includes('.jpg') || manuelTarifAdi.includes('.png') 
                                ? manuelTarifAdi 
                                : `${manuelTarifAdi}.jpg`;
                            return {
                                file: fileName,
                                name: fileName.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' '),
                                type: 'file',
                                download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${fileName}`
                            };
                        }
                    }).filter(Boolean);
                    
                    if (bulunanKartlar.length > 0) {
                        console.log('✅ Manuel eşleştirme bulundu:', bulunanKartlar.map(k => k.file || k.name));
                        return bulunanKartlar;
                    }
                }

                // 2. Otomatik eşleştirme (fuzzy matching)
                const potansiyelTarif = tarifKartlari.find(tarif => {
                    const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                    const tarifNormalized = normalizeText(tarifName);
                    return tarifNormalized === normalizedCleaned || tarifNormalized.replace(/_/g, '') === normalizedCleaned;
                }) || tarifKartlari.find(tarif => {
                    const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                    const tarifNormalized = normalizeText(tarifName);
                    return tarifNormalized.includes(normalizedCleaned) || normalizedCleaned.includes(tarifNormalized);
                });
                
                // 3. Yasak kurallarını kontrol et
                if (potansiyelTarif) {
                    const tarifFile = potansiyelTarif.file || potansiyelTarif.name || '';
                    
                    // Yasak kurallarını al
                    let yasakData = eslesmemeKurallari[yemekAdi] 
                        || eslesmemeKurallari[cleanedYemekAdi];
                    
                    // Object formatından array'e çevir
                    let yasakListesi = [];
                    if (yasakData && typeof yasakData === 'object' && !Array.isArray(yasakData)) {
                        yasakListesi = yasakData.yasakliKartlar || yasakData.kartlar || [];
                    } else if (Array.isArray(yasakData)) {
                        yasakListesi = yasakData;
                    }
                    
                    // Yasak listesinde var mı kontrol et
                    const isYasakli = yasakListesi.includes(tarifFile);
                    
                    if (isYasakli) {
                        console.log('⛔ Yasak kural nedeniyle kart gösterilmedi:', yemekAdi, '->', tarifFile);
                        return [];
                    }
                    
                    console.log('✅ Otomatik eşleştirme bulundu:', tarifFile);
                    return [potansiyelTarif];
                }
                
                return [];
            }

            function getDietType(food) {
                return food.keto ? 'keto' : (food.lowcarb ? 'lowcarb' : 'other');
            }

            function extractTagKeywords(food) {
                const keywords = new Set();
                if (!food) return keywords;
                const sources = [];
                if (Array.isArray(food.tags)) sources.push(...food.tags);
                else if (typeof food.tags === 'string') sources.push(food.tags);

                sources.forEach(text => {
                    if (!text) return;
                    let value = '';
                    if (typeof text === 'string') {
                        value = fixTurkishChars(text);
                    } else if (typeof text === 'number') {
                        value = String(text);
                    } else if (text && typeof text === 'object') {
                        if (typeof text.name === 'string') value = fixTurkishChars(text.name);
                        else if (typeof text.label === 'string') value = fixTurkishChars(text.label);
                        else return;
                    } else {
                        return;
                    }

                    const normalized = value.toLowerCase()
                        .replace(/ç/g, 'c')
                        .replace(/ğ/g, 'g')
                        .replace(/ı/g, 'i')
                        .replace(/i̇/g, 'i')
                        .replace(/ö/g, 'o')
                        .replace(/ş/g, 's')
                        .replace(/ü/g, 'u');
                    normalized.split(/[^a-z0-9]+/).forEach(token => {
                        const cleaned = normalizeText(token);
                        if (cleaned && cleaned.length > 2 && !tagExclusionSet.has(cleaned)) {
                            keywords.add(cleaned);
                        }
                    });
                });

                return keywords;
            }

            function shouldSkipTagFilter(food) {
                if (!food || !appSettings.enableTagFilter) return true;
                const roleNormalized = normalizeText(food.role || '');
                if (roleNormalized && tagExemptRoleSet.has(roleNormalized)) return true;
                const categoryNormalized = normalizeText(food.category || '');
                if (categoryNormalized && tagExemptCategorySet.has(categoryNormalized)) return true;
                return false;
            }

            // Season helper fonksiyonları
            function getCurrentMonthNumber() {
                return new Date().getMonth() + 1; // 1-12
            }

            function parseSeasonRange(seasonRange) {
                if (!seasonRange) return null;
                try {
                    // "[1,12]" formatından parse et
                    const parsed = JSON.parse(seasonRange);
                    if (Array.isArray(parsed) && parsed.length === 2) {
                        return { start: parsed[0], end: parsed[1] };
                    }
                } catch (e) {
                    console.warn('Season range parse hatası:', seasonRange, e);
                }
                return null;
            }

            function isInSeason(seasonRange) {
                const range = parseSeasonRange(seasonRange);
                if (!range) return false;
                
                const currentMonth = getCurrentMonthNumber();
                const { start, end } = range;
                
                // Eğer range yıl içinde dönüyorsa (ör: [11,2] = Kasım-Şubat)
                if (start > end) {
                    return currentMonth >= start || currentMonth <= end;
                }
                // Normal range (ör: [3,8] = Mart-Ağustos)
                return currentMonth >= start && currentMonth <= end;
            }

            function getSeasonName(seasonRange) {
                const range = parseSeasonRange(seasonRange);
                if (!range) return 'Tüm Sezon';
                
                const { start, end } = range;
                const months = ['', 'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                               'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                
                if (start === 1 && end === 12) return 'Tüm Sezon';
                if (start === end) return months[start];
                return `${months[start]}-${months[end]}`;
            }

            // MealType helper fonksiyonları
            function parseMealTypes(mealType) {
                if (!mealType) return [];
                // "breakfast,lunch" veya "lunch" formatı
                if (typeof mealType === 'string') {
                    return mealType.split(',').map(m => m.trim().toLowerCase()).filter(Boolean);
                }
                if (Array.isArray(mealType)) {
                    return mealType.map(m => String(m).trim().toLowerCase()).filter(Boolean);
                }
                return [];
            }

            function hasMealTypeOverlap(refMealTypes, foodMealTypes) {
                // VEYA mantığı: En az bir öğün ortak olmalı
                if (!refMealTypes.length || !foodMealTypes.length) return false;
                return refMealTypes.some(refType => foodMealTypes.includes(refType));
            }

            function getMealTypeDisplay(mealType) {
                const types = parseMealTypes(mealType);
                const displayMap = {
                    'breakfast': 'Sabah',
                    'lunch': 'Öğlen',
                    'dinner': 'Akşam',
                    'snack': 'Ara Öğün'
                };
                return types.map(t => displayMap[t] || t).join(', ') || 'Belirtilmemiş';
            }

            const searchInput = document.getElementById('yemekArama');
            const dropdown = document.getElementById('autocompleteDropdown');
            let currentFocusIndex = -1;
            let dropdownMatches = [];

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                currentFocusIndex = -1;
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }
                const queryWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
                dropdownMatches = foodDatabase.filter(food => queryWords.every(word => normalizeText(food.name).includes(normalizeText(word)))).slice(0, 10);
                if (dropdownMatches.length > 0) {
                    dropdown.innerHTML = dropdownMatches.map((food, index) => `
                        <div class="autocomplete-item" data-index="${index}" onclick="selectFoodFromDropdown('${food.name.replace(/'/g, "\\'")}')">
                            <div class="food-name-text">${food.name}</div>
                            <div class="food-meta-text" style="display: flex; gap: 12px; margin-top: 4px; font-size: 11px; color: #666;">
                                <span>🔥 ${Math.round(food.calories || 0)} kcal</span><span>🍞 ${Math.round(food.carbs || 0)}g</span><span>🥩 ${Math.round(food.protein || 0)}g</span><span>🥑 ${Math.round(food.fat || 0)}g</span>
                            </div>
                        </div>`).join('');
                    const rect = searchInput.getBoundingClientRect();
                    Object.assign(dropdown.style, { top: `${rect.bottom}px`, left: `${rect.left}px`, width: `${rect.width}px` });
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') { e.preventDefault(); currentFocusIndex = (currentFocusIndex + 1) % items.length; } 
                else if (e.key === 'ArrowUp') { e.preventDefault(); currentFocusIndex = (currentFocusIndex - 1 + items.length) % items.length; } 
                else if (e.key === 'Enter') { e.preventDefault(); if (items[currentFocusIndex]) items[currentFocusIndex].click(); }
                else if (e.key === 'Escape') { dropdown.classList.remove('show'); }
                items.forEach((item, i) => item.classList.toggle('active', i === currentFocusIndex));
                if(items[currentFocusIndex]) items[currentFocusIndex].scrollIntoView({ block: 'nearest' });
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-box')) dropdown.classList.remove('show');
            });

            window.selectFoodFromDropdown = function(foodName) {
                const food = foodDatabase.find(f => f.name === foodName);
                if (food) {
                    selectedFood = food;
                    searchInput.value = food.name;
                    dropdown.classList.remove('show');
                    showSelectedFood(food);
                    findAlternatives(food);
                }
            }

            function showSelectedFood(food) {
                document.getElementById('selectedName').textContent = food.name;
                
                // Makro butonlarını oluştur - Protein ve Yağ default olarak aktif
                const activeMacros = window.activeMacros || ['protein', 'fat'];
                document.getElementById('selectedMacros').innerHTML = `
                    <div class="macro-box ${activeMacros.includes('calories') ? 'active' : ''}" data-macro="calories" onclick="toggleMacro('calories')">
                        <strong>${Math.round(food.calories || 0)}</strong><span>Kalori</span>
                    </div>
                    <div class="macro-box ${activeMacros.includes('carbs') ? 'active' : ''}" data-macro="carbs" onclick="toggleMacro('carbs')">
                        <strong>${Math.round(food.carbs || 0)}g</strong><span>Karb</span>
                    </div>
                    <div class="macro-box ${activeMacros.includes('protein') ? 'active' : ''}" data-macro="protein" onclick="toggleMacro('protein')">
                        <strong>${Math.round(food.protein || 0)}g</strong><span>Protein</span>
                    </div>
                    <div class="macro-box ${activeMacros.includes('fat') ? 'active' : ''}" data-macro="fat" onclick="toggleMacro('fat')">
                        <strong>${Math.round(food.fat || 0)}g</strong><span>Yağ</span>
                    </div>`;
                
                const tarifKartlari = findTarifKartlari(food.name);
                const tarifButtons = tarifKartlari.map((tarif, index) => `<span class="info-tag" onclick="openModal('${tarif.download_url}')" style="cursor: pointer; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">📖${tarifKartlari.length > 1 ? `Tarif ${index+1}` : 'Tarif'}👆</span>`).join('');
                
                const createTag = (criterion, icon, text) => `<span class="info-tag clickable-tag ${matchCriteria[criterion] ? 'active' : ''}" onclick="toggleCriterion('${criterion}')" style="cursor: pointer;">${icon}${text}</span>`;
                const dietType = food.keto ? 'Ketojenik' : food.lowcarb ? 'Düşük Karb' : 'Genel';

                // Filtreleme kriterlerine göre rozetleri oluştur
                const filterCrit = appSettings.filterCriteria || {};
                const tagsParts = [];
                
                // Role rozeti - SADECE opsiyonel ve visible ise göster
                if (food.role && filterCrit.role?.visible === true && filterCrit.role?.mode === 'optional') {
                    const roleDisplay = getRoleDisplayName(food.role);
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Yemek türü:</span>');
                    tagsParts.push(createTag('role', '', roleDisplay));
                }
                
                // DietType rozeti - SADECE opsiyonel ve visible ise göster
                if (filterCrit.dietType?.visible === true && filterCrit.dietType?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Diyet türü:</span>');
                    tagsParts.push(createTag('dietType', '', dietType));
                }
                
                // Category rozeti - SADECE opsiyonel ve visible ise göster
                if (food.category && filterCrit.category?.visible === true && filterCrit.category?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Kategori:</span>');
                    tagsParts.push(createTag('category', '', food.category));
                }
                
                // Season rozeti - SADECE opsiyonel ve visible ise göster
                if (food.seasonRange && filterCrit.season?.visible === true && filterCrit.season?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    const seasonName = getSeasonName(food.seasonRange);
                    const inSeason = isInSeason(food.seasonRange);
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Sezon:</span>');
                    tagsParts.push(createTag('season', inSeason ? '🟢 ' : '🔴 ', seasonName));
                }
                
                // MealType rozeti - SADECE opsiyonel ve visible ise göster
                if (food.mealType && filterCrit.mealType?.visible === true && filterCrit.mealType?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    const mealTypeDisplay = getMealTypeDisplay(food.mealType);
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Öğün:</span>');
                    tagsParts.push(createTag('mealType', '', mealTypeDisplay));
                }

                document.getElementById('selectedInfo').innerHTML = tagsParts.join('');
                document.getElementById('selectedTarifler').innerHTML = tarifButtons;
                document.getElementById('selectedFood').classList.add('show');
            }
            
            // Makro butonlarını toggle etme fonksiyonu
            window.toggleMacro = function(macro) {
                if (!window.activeMacros) {
                    window.activeMacros = ['protein', 'fat']; // Default
                }
                
                const index = window.activeMacros.indexOf(macro);
                if (index > -1) {
                    window.activeMacros.splice(index, 1);
                } else {
                    window.activeMacros.push(macro);
                }
                
                // En az bir makro seçili olmalı
                if (window.activeMacros.length === 0) {
                    window.activeMacros = [macro];
                }
                
                // scoreBy değişkenini güncelle
                scoreBy = window.activeMacros;
                
                if (originalSelectedFood) {
                    showSelectedFood(originalSelectedFood);
                    findAlternatives(originalSelectedFood);
                }
            }
            
            window.toggleCriterion = function(criterion) {
                matchCriteria[criterion] = !matchCriteria[criterion];
                if (originalSelectedFood) {
                    showSelectedFood(originalSelectedFood);
                    findAlternatives(originalSelectedFood);
                }
            }

            function findAlternatives(refFood) {
                console.log('🔍 findAlternatives() çağrıldı - Referans yemek:', refFood.name, '| Kalori:', refFood.calories);
                console.log('📊 Referans role:', refFood.role, '| category:', refFood.category, '| mealType:', refFood.mealType);
                console.log('⚙️ matchCriteria:', JSON.stringify(matchCriteria));
                console.log('🔍 Selector Mode:', selectorMode ? 'AKTIF (sadece role filtresi)' : 'KAPALI (tüm filtreler)');
                
                originalSelectedFood = refFood;
                currentIndex = 0;
                const selectedDietType = getDietType(refFood);
                console.log('🍴 Referans Diet Type:', selectedDietType, '| keto:', refFood.keto, '| lowcarb:', refFood.lowcarb);
                
                const selectedTagKeywords = appSettings.enableTagFilter ? extractTagKeywords(refFood) : new Set();
                const refMealTypes = parseMealTypes(refFood.mealType);

                let alternatives = foodDatabase.filter(food => {
                    if (food.name === refFood.name) return false;
                    
                    // 🚫 Selector modda: Öğünde mevcut kategorileri hariç tut
                    if (selectorMode && window.excludedCategories && window.excludedCategories.length > 0) {
                        if (food.category && window.excludedCategories.includes(food.category)) {
                            return false; // Bu kategoriden zaten var, gösterme
                        }
                    }
                    
                    // Selector modda sadece role filtresi, normal modda tüm filtreler
                    if (selectorMode) {
                        // Sadece role kontrolü
                        if (food.role !== refFood.role) return false;
                        
                        // ⚠️ ÖZEL: DietType kontrolü - her modda çalışmalı!
                        const foodDietType = getDietType(food);
                        if (selectedDietType === 'keto' && foodDietType !== 'keto') {
                            return false; // Ketojenik yemek için sadece ketojenik alternatifler
                        }
                        if (selectedDietType === 'lowcarb' && !['keto', 'lowcarb'].includes(foodDietType)) {
                            return false; // Lowcarb için ketojenik veya lowcarb
                        }
                    } else {
                        // Normal mod - tüm filtreler
                        if (matchCriteria.role && food.role !== refFood.role) return false;
                        if (matchCriteria.category && food.category !== refFood.category) return false;
                        
                        // Season kontrolü - seasonRange ile
                        if (matchCriteria.season) {
                            // İkisi de mevsimlik ise aynı mevsim olmalı
                            if (refFood.seasonRange && food.seasonRange) {
                                if (refFood.seasonRange !== food.seasonRange) {
                                    return false;
                                }
                            }
                        }
                        
                        // MealType kontrolü - VEYA mantığı ile
                        if (matchCriteria.mealType && refFood.mealType) {
                            const foodMealTypes = parseMealTypes(food.mealType);
                            // En az bir öğün ortak olmalı
                            if (!hasMealTypeOverlap(refMealTypes, foodMealTypes)) {
                                return false;
                            }
                        }
                        
                        if (matchCriteria.dietType) {
                            const foodDietType = getDietType(food);
                            if (selectedDietType === 'keto' && foodDietType !== 'keto') return false;
                            if (selectedDietType === 'lowcarb' && !['keto', 'lowcarb'].includes(foodDietType)) return false;
                        }
                    }
                    return true;
                });

                console.log('✅ İlk filtrelemeden sonra alternatif sayısı:', alternatives.length);

                // 🚫 YASAK LİSTESİ FİLTRESİ - Yasaklı alternatifleri çıkar
                if (alternativeBlacklist && alternativeBlacklist.length > 0) {
                    const beforeBlacklist = alternatives.length;
                    
                    alternatives = alternatives.filter(food => {
                        // Bu yemek için yasak kuralı var mı?
                        const blacklistEntry = alternativeBlacklist.find(
                            item => item.mainFood === refFood.name
                        );
                        
                        if (blacklistEntry && blacklistEntry.bannedAlternatives) {
                            // Bu alternatif yasaklı mı?
                            const isBanned = blacklistEntry.bannedAlternatives.includes(food.name);
                            if (isBanned) {
                                console.log(`🚫 Yasaklı alternatif filtrelendi: ${food.name} (${refFood.name} için yasaklı)`);
                            }
                            return !isBanned; // Yasaklı değilse geç
                        }
                        
                        return true; // Yasak kuralı yoksa göster
                    });
                    
                    const filtered = beforeBlacklist - alternatives.length;
                    if (filtered > 0) {
                        console.log(`🚫 ${filtered} adet yasaklı alternatif çıkarıldı`);
                    }
                }

                if (appSettings.enableTagFilter && selectedTagKeywords.size > 0 && !shouldSkipTagFilter(refFood)) {
                    const filteredByTags = alternatives.filter(food => {
                        if (shouldSkipTagFilter(food)) return true;
                        const alternativeKeywords = extractTagKeywords(food);
                        for (const keyword of alternativeKeywords) {
                            if (selectedTagKeywords.has(keyword)) return false;
                        }
                        return true;
                    });
                    if (filteredByTags.length > 0) {
                        alternatives = filteredByTags;
                    }
                }

                alternatives = alternatives.map(food => {
                    let totalDiff = 0, count = 0;
                    const criteria = scoreBy.length > 0 ? scoreBy : ['calories', 'protein', 'carbs', 'fat'];
                    
                    // Scoring mode ve sensitivity divider al
                    const scoringMode = appSettings?.scoringMode || 'simple';
                    const sensitivityDivider = appSettings?.sensitivityDivider || 10;
                    
                    // MOD SEÇİMİ: Basit veya Gelişmiş
                    if (scoringMode === 'advanced') {
                        // 🎯 GELİŞMİŞ MOD: Oran bazlı + Kalori ağırlıklı
                        if (criteria.includes('protein')) {
                            const gramDiff = Math.abs((food.protein || 0) - (refFood.protein || 0));
                            const percentDiff = refFood.protein > 0 ? (gramDiff / refFood.protein) * 100 : 0;
                            totalDiff += percentDiff * (4 / sensitivityDivider);
                            count++;
                        }
                        if (criteria.includes('carbs')) {
                            const gramDiff = Math.abs((food.carbs || 0) - (refFood.carbs || 0));
                            const percentDiff = refFood.carbs > 0 ? (gramDiff / refFood.carbs) * 100 : 0;
                            totalDiff += percentDiff * (4 / sensitivityDivider);
                            count++;
                        }
                        if (criteria.includes('fat')) {
                            const gramDiff = Math.abs((food.fat || 0) - (refFood.fat || 0));
                            const percentDiff = refFood.fat > 0 ? (gramDiff / refFood.fat) * 100 : 0;
                            totalDiff += percentDiff * (9 / sensitivityDivider);
                            count++;
                        }
                        if (criteria.includes('calories')) {
                            const calDiff = Math.abs((food.calories || 0) - (refFood.calories || 0));
                            const percentDiff = refFood.calories > 0 ? (calDiff / refFood.calories) * 100 : 0;
                            totalDiff += percentDiff / (sensitivityDivider / 10);
                            count++;
                        }
                        const avgLoss = count > 0 ? totalDiff / count : 0;
                        const similarity = Math.round(Math.max(0, 100 - avgLoss));
                        return { ...food, similarity };
                    } else {
                        // 📊 BASİT MOD: Kalori bazlı
                        if (criteria.includes('protein')) { totalDiff += Math.abs((food.protein || 0) - (refFood.protein || 0)) * 4; count++; }
                        if (criteria.includes('carbs')) { totalDiff += Math.abs((food.carbs || 0) - (refFood.carbs || 0)) * 4; count++; }
                        if (criteria.includes('fat')) { totalDiff += Math.abs((food.fat || 0) - (refFood.fat || 0)) * 9; count++; }
                        if (criteria.includes('calories')) { totalDiff += Math.abs((food.calories || 0) - (refFood.calories || 0)) / 5; count++; }
                        const avgCalDiff = count > 0 ? totalDiff / count : 0;
                        const similarity = Math.round(Math.max(0, 100 - (avgCalDiff / 10)));
                        return { ...food, similarity };
                    }
                }).sort((a, b) => b.similarity - a.similarity);

                totalAlternativesForSelected = alternatives.length;

                const rotationIndices = getRotatedAlternativeIndices(refFood, alternatives.length);
                const displayedAlternatives = (rotationIndices.length > 0 ? rotationIndices : getDefaultChunkIndices(alternatives.length))
                    .map(index => alternatives[index])
                    .filter(Boolean);

                console.log('🎯 displayedAlternatives sayısı:', displayedAlternatives.length);

                currentAlternatives = displayedAlternatives;
                displayResults(displayedAlternatives);
                
                if (displayedAlternatives.length > 0) navigateToFood(0);
                else {
                    document.getElementById('alternativeFood').classList.remove('show');
                    highlightTableRow(-1);
                }
            }

            function displayResults(foods) {
                const resultHeader = document.getElementById('resultHeader');
                const resultsList = document.getElementById('resultsList');
                const resultCount = document.getElementById('resultCount');

                if (foods.length === 0) {
                    resultHeader.classList.remove('show');
                    resultsList.innerHTML = '<div class="no-results">😕 Alternatif bulunamadı</div>';
                    return;
                }

                const totalText = totalAlternativesForSelected > foods.length
                    ? `${foods.length}/${totalAlternativesForSelected}`
                    : `${foods.length}`;
                resultCount.textContent = totalText;
                resultHeader.classList.add('show');
                
                const formatDiff = (val, refVal) => {
                    const diff = Math.round((val || 0) - (refVal || 0));
                    if (diff === 0) return '';
                    return `<span class="macro-diff ${diff > 0 ? 'positive' : 'negative'}">${diff > 0 ? '+' : ''}${diff}</span>`;
                };

                const tableHTML = `
                    <table class="food-table">
                        <tbody>${foods.map(food => {
                            const ref = originalSelectedFood || food;
                            const tarifKartlari = findTarifKartlari(food.name);
                            const tarifBadges = tarifKartlari.map((tarif, index) => `<span class="meta-tag" onclick="event.stopPropagation(); openModal('${tarif.download_url}');" style="cursor: pointer; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">📖 ${tarifKartlari.length > 1 ? `Tarif ${index+1}` : 'Tarif'} 👆</span>`).join('');
                            const dietType = food.keto ? 'Keto' : food.lowcarb ? 'LowCarb' : '';
                            
                            // Admin için yasakla butonu
                            const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                            const isAdmin = session.isAdmin === true || session.role === 'admin' || session.role === 'ADMIN';
                            const banButton = isAdmin ? `<span class="meta-tag admin-ban-btn" onclick="event.stopPropagation(); banAlternativeQuick('${food.name.replace(/'/g, "\\'")}');" style="cursor: pointer; background: linear-gradient(135deg, #FF6B35 0%, #C92A2A 100%); color: white;">🚫 Yasakla</span>` : '';
                            
                            return `
                                <tr class="food-card-row" data-food-name="${food.name.replace(/"/g, '&quot;')}" onclick="selectFood(this.dataset.foodName)" style="cursor: pointer;">
                                    <td colspan="100%">
                                        <div class="food-card">
                                            <div class="food-card-header">
                                                <div class="food-name">${food.name}</div>
                                                <span class="similarity-badge">${food.similarity}%</span>
                                            </div>
                                            <div class="food-card-macros">
                                                <div class="macro-item">
                                                    <div class="macro-label">Kalori</div>
                                                    <div class="macro-val">${Math.round(food.calories || 0)}${formatDiff(food.calories, ref.calories)}</div>
                                                </div>
                                                <div class="macro-item">
                                                    <div class="macro-label">Karb</div>
                                                    <div class="macro-val">${Math.round(food.carbs || 0)}g${formatDiff(food.carbs, ref.carbs)}</div>
                                                </div>
                                                <div class="macro-item">
                                                    <div class="macro-label">Protein</div>
                                                    <div class="macro-val">${Math.round(food.protein || 0)}g${formatDiff(food.protein, ref.protein)}</div>
                                                </div>
                                                <div class="macro-item">
                                                    <div class="macro-label">Yağ</div>
                                                    <div class="macro-val">${Math.round(food.fat || 0)}g${formatDiff(food.fat, ref.fat)}</div>
                                                </div>
                                            </div>
                                            <div class="food-card-badges">
                                                ${food.role ? `<span class="meta-tag">${getRoleDisplayName(food.role)}</span>` : ''}
                                                ${food.mealType ? `<span class="meta-tag">${food.mealType}</span>` : ''}
                                                ${dietType ? `<span class="meta-tag">${dietType}</span>` : ''}
                                                ${tarifBadges}
                                                ${banButton}
                                            </div>
                                        </div>
                                    </td>
                                </tr>`;
                        }).join('')}</tbody>
                    </table>`;
                resultsList.innerHTML = tableHTML;
            }

            window.selectFood = function(foodName) {
                const food = currentAlternatives.find(f => f.name === foodName);
                if (food) {
                    const index = currentAlternatives.indexOf(food);
                    navigateToFood(index);
                }
            }
            
            // 📊 Butonları güncelleyen fonksiyon
            function updateScoreButtons() {
                const buttons = document.querySelectorAll('[data-score]');
                if (!buttons || buttons.length === 0) {
                    console.warn('⚠️ Score butonları henüz yüklenmedi');
                    return;
                }
                
                buttons.forEach(btn => {
                    const scoreValue = btn.dataset.score;
                    if (scoreValue === 'all') {
                        // "Tüm Makrolar" butonu: scoreBy tam doluysa aktif
                        btn.classList.toggle('active', scoreBy.length === 4);
                    } else {
                        // Tekil butonlar: scoreBy içinde varsa aktif
                        btn.classList.toggle('active', scoreBy.includes(scoreValue));
                    }
                });
                
                console.log('✅ Score butonları güncellendi:', scoreBy);
            }

            document.querySelector('[data-score]').parentElement.addEventListener('click', (e) => {
                if (e.target.dataset.score) {
                    const score = e.target.dataset.score;
                    if (score === 'all') {
                        scoreBy = (scoreBy.length === 4) ? [] : ['calories', 'protein', 'carbs', 'fat'];
                    } else {
                        const index = scoreBy.indexOf(score);
                        if (index > -1) scoreBy.splice(index, 1);
                        else scoreBy.push(score);
                    }
                    
                    // window.activeMacros'u da güncelle
                    window.activeMacros = [...scoreBy];
                    
                    // Butonları güncelle
                    updateScoreButtons();
                    
                    // Alternatifleri yeniden hesapla
                    if (originalSelectedFood) findAlternatives(originalSelectedFood);
                }
            });

            document.getElementById('resultHeader').addEventListener('click', function() {
                this.classList.toggle('collapsed');
                document.getElementById('resultsList').classList.toggle('collapsed');
                
                // Akordiyon açıkken yeşil alanı gizle
                const alternativeFood = document.getElementById('alternativeFood');
                const resultsList = document.getElementById('resultsList');
                const isCollapsed = this.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Akordiyon kapalı - yeşil alanı göster
                    alternativeFood.classList.remove('hide-on-open');
                } else {
                    // Akordiyon açık - yeşil alanı gizle ve scroll'u en üste al
                    alternativeFood.classList.add('hide-on-open');
                    
                    // İlk yemek tam görünsün - scroll'u en üste kaydır
                    if (resultsList && currentAlternatives.length > 0) {
                        setTimeout(() => {
                            resultsList.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                }
            });

            function updatePlaceholder() {
                const width = window.innerWidth;
                const placeholder = width <= 576 ? '🍽️ Yemek ara (ör: Tavuk)' : (width <= 768 ? '🍽️ Yemek Alternatif Bulucu - Ara' : '🍽️ Yemek Alternatif Bulucu - Yemek adı yazın (ör: Izgara Tavuk)');
                document.getElementById('yemekArama').placeholder = placeholder;
            }

            window.addEventListener('resize', updatePlaceholder);
            await loadSettings();
            updatePlaceholder();
            await loadFoodData();
            await loadBlacklist(); // Yasak listesini yükle
            
            // � Sayfa yüklendiğinde butonları güncelle
            updateScoreButtons();
            
            // �🔍 DEBUG: URL parametrelerini kontrol et
            console.log('🔍 DEBUG - initialFood değeri:', initialFood);
            console.log('🔍 DEBUG - selectorMode değeri:', selectorMode);
            console.log('🔍 DEBUG - URL:', window.location.href);
            
            // 🔍 URL'den gelen yemek varsa otomatik ara (loadFoodData SONRASINDA)
            if (initialFood) {
                const searchInput = document.getElementById('yemekArama');
                if (searchInput) {
                    const decodedFood = decodeURIComponent(initialFood);
                    
                    // Parantez içi miktar bilgisini temizle (ör: "tahin ekmeği (1 dilim)" → "tahin ekmeği")
                    const cleanedFood = decodedFood.replace(/\s*\([^)]*\)\s*/g, '').trim();
                    
                    searchInput.value = decodedFood; // Arama kutusunda orijinali göster
                    console.log(`🔍 URL'den yemek yüklendi: "${decodedFood}"`);
                    console.log(`🧹 Temizlenmiş arama: "${cleanedFood}"`);
                    
                    // Arama kutusuna focus ver
                    setTimeout(() => searchInput.focus(), 100);
                    
                    // Tüm eşleşmeleri topla ve en iyisini seç
                    const cleanedLower = cleanedFood.toLowerCase();
                    const decodedLower = decodedFood.toLowerCase();
                    
                    // 1️⃣ Önce TAM eşleşme dene (hem orijinal hem temizlenmiş ile)
                    let foundFood = foodDatabase.find(f => 
                        f.name.toLowerCase() === decodedLower || 
                        f.name.toLowerCase() === cleanedLower
                    );
                    console.log('1️⃣ Tam eşleşme:', foundFood ? foundFood.name : 'yok');
                    
                    // 2️⃣ Bulamazsa BAŞTAN eşleşme dene ve EN KISA olanı seç
                    if (!foundFood) {
                        const startsWithMatches = foodDatabase.filter(f => f.name.toLowerCase().startsWith(cleanedLower));
                        if (startsWithMatches.length > 0) {
                            // Önce uzunluğa göre sırala, eşitlerde alfabetik
                            startsWithMatches.sort((a, b) => {
                                const lenDiff = a.name.length - b.name.length;
                                if (lenDiff !== 0) return lenDiff;
                                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                            });
                            foundFood = startsWithMatches[0];
                            console.log('2️⃣ Baştan eşleşme (en kısa):', foundFood.name, '| Tüm eşleşmeler:', startsWithMatches.map(f => `${f.name} (${f.name.length})`));
                        } else {
                            console.log('2️⃣ Baştan eşleşme: yok');
                        }
                    }
                    
                    // 3️⃣ Bulamazsa KELİME sınırında eşleşme dene (whole word)
                    if (!foundFood) {
                        const wordRegex = new RegExp(`\\b${cleanedFood.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                        const wordMatches = foodDatabase.filter(f => wordRegex.test(f.name));
                        if (wordMatches.length > 0) {
                            // Önce uzunluğa göre sırala
                            wordMatches.sort((a, b) => {
                                const lenDiff = a.name.length - b.name.length;
                                if (lenDiff !== 0) return lenDiff;
                                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                            });
                            foundFood = wordMatches[0];
                            console.log('3️⃣ Kelime eşleşme (en kısa):', foundFood.name, '| Tüm eşleşmeler:', wordMatches.map(f => `${f.name} (${f.name.length})`));
                        } else {
                            console.log('3️⃣ Kelime eşleşme: yok');
                        }
                    }
                    
                    // 4️⃣ Son çare: İÇERME eşleşmesi (ama en kısa olanı seç)
                    if (!foundFood) {
                        const includesMatches = foodDatabase.filter(f => f.name.toLowerCase().includes(cleanedLower));
                        if (includesMatches.length > 0) {
                            includesMatches.sort((a, b) => {
                                const lenDiff = a.name.length - b.name.length;
                                if (lenDiff !== 0) return lenDiff;
                                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                            });
                            foundFood = includesMatches[0];
                            console.log('4️⃣ İçerme eşleşme (en kısa):', foundFood.name, '| Tüm eşleşmeler:', includesMatches.map(f => `${f.name} (${f.name.length})`));
                        } else {
                            console.log('4️⃣ İçerme eşleşme: yok');
                        }
                    }
                    
                    if (foundFood) {
                        console.log(`✅ Yemek bulundu, alternatifler aranıyor: "${foundFood.name}"`);
                        
                        // Mor kartta aranan yemeği göster
                        showSelectedFood(foundFood);
                        
                        // Alternatifleri bul ve yeşil kartta ilkini göster
                        findAlternatives(foundFood);
                    } else {
                        console.warn(`⚠️ Yemek veritabanında bulunamadı: "${cleanedFood}" (orijinal: "${decodedFood}")`);
                        
                        // 🔍 1. ÖNCELİK: YEMEK VERİTABANI EŞLEŞTİRMESİ KONTROLÜ
                        const normalizedSearch = cleanedFood.toLowerCase()
                            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                            .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
                            .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
                            .trim();
                        
                        console.log('🔍 Veritabanı eşleştirme kontrolü yapılıyor:', normalizedSearch);
                        
                        // Veritabanı eşleştirmelerinde ara
                        let dbKey = Object.keys(yemekVeritabaniEslestirme).find(key => {
                            const normalizedKey = key.toLowerCase()
                                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                                .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
                                .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
                                .trim();
                            return normalizedKey === normalizedSearch;
                        });
                        
                        if (dbKey) {
                            console.log('✅ Veritabanı eşleştirmesi bulundu:', dbKey);
                            const dbData = yemekVeritabaniEslestirme[dbKey];
                            const hedefYemekler = dbData.hedefYemekler || [dbData.hedefYemek];
                            
                            console.log('🎯 Hedef yemekler:', hedefYemekler);
                            
                            // İlk hedef yemeği veritabanında bul
                            let mappedFood = null;
                            for (const hedefYemek of hedefYemekler) {
                                mappedFood = foodDatabase.find(f => {
                                    const foodNameNorm = f.name.toLowerCase().trim();
                                    const hedefNorm = hedefYemek.toLowerCase().trim();
                                    return foodNameNorm === hedefNorm || 
                                           normalizeText(foodNameNorm) === normalizeText(hedefNorm);
                                });
                                if (mappedFood) {
                                    console.log('✅ Veritabanında eşleşen yemek bulundu:', mappedFood.name);
                                    break;
                                }
                            }
                            
                            if (mappedFood) {
                                // Sahte food objesi oluştur - MOR KARTTA ORİJİNAL YEMEĞİ GÖSTER
                                const useMacros = window.renderMacros || {
                                    calories: 0,
                                    protein: 0,
                                    carbs: 0,
                                    fat: 0
                                };
                                
                                const pseudoFood = {
                                    name: decodedFood, // Orijinal yemek adı
                                    category: mappedFood.category,
                                    calories: useMacros.calories,
                                    protein: useMacros.protein,
                                    carbs: useMacros.carbs,
                                    fat: useMacros.fat,
                                    isDatabaseMapping: true
                                };
                                
                                console.log('📊 Mor kartta gösterilecek makrolar (DB eşleştirmesi):', useMacros);
                                
                                // Mor kartta sahte yemeği göster
                                showSelectedFood(pseudoFood);
                                
                                // Tüm hedef yemeklerin alternatiflerini birleştir
                                findAlternatives(mappedFood);
                                
                                return; // İşlem tamamlandı, devam etme
                            } else {
                                console.warn('⚠️ Veritabanı eşleştirmesi var ama hedef yemek veritabanında bulunamadı');
                            }
                        }
                        
                        // 🔍 2. ÖNCELİK: MANUEL EŞLEŞTIRME KONTROLÜ (Tarif kartları)
                        const normalizedSearchManuel = normalizeText(cleanedFood);
                        console.log('🔍 Manuel eşleştirme kontrolü yapılıyor:', normalizedSearchManuel);
                        
                        // Manuel eşleştirmelerde ara
                        let manuelKey = Object.keys(manuelEslestirmeler).find(key => 
                            normalizeText(key) === normalizedSearchManuel || 
                            key.toLowerCase() === cleanedFood.toLowerCase()
                        );
                        
                        if (manuelKey) {
                            console.log('✅ Manuel eşleştirme bulundu:', manuelKey);
                            const manuelData = manuelEslestirmeler[manuelKey];
                            
                            // Manuel eşleştirilen tarif kartlarını al
                            const tarifAdlari = Array.isArray(manuelData.kartlar) ? manuelData.kartlar : [manuelData];
                            const tarifKartlariList = tarifAdlari.map(dosyaAdi => {
                                const fileName = dosyaAdi.includes('.jpg') || dosyaAdi.includes('.png') 
                                    ? dosyaAdi 
                                    : `${dosyaAdi}.jpg`;
                                return {
                                    file: fileName,
                                    name: fileName.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' '),
                                    type: 'file',
                                    download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${fileName}`,
                                    isManualMapping: true
                                };
                            });
                            
                            console.log('✅ Manuel eşleştirmeden tarif kartları yüklendi:', tarifKartlariList);
                            
                            // 🔍 Tarif kartından yemek adını çıkar ve veritabanında ara
                            let mappedFood = null;
                            if (tarifKartlariList.length > 0) {
                                const firstTarif = tarifKartlariList[0];
                                // Tarif adını normalize et (ör: "keto_kofte.jpg" → "keto kofte")
                                const tarifBaseName = firstTarif.name.toLowerCase().trim();
                                
                                console.log('🔍 Tarif kartından yemek aranıyor:', tarifBaseName);
                                
                                // Veritabanında bu tarif adına uygun yemek ara
                                // 1. Tam eşleşme
                                mappedFood = foodDatabase.find(f => {
                                    const foodNameNorm = f.name.toLowerCase().trim();
                                    return foodNameNorm === tarifBaseName || 
                                           normalizeText(foodNameNorm) === normalizeText(tarifBaseName);
                                });
                                
                                // 2. "keto" → "ketojenik" dönüşümü ile ara
                                if (!mappedFood) {
                                    const expandedSearch = tarifBaseName
                                        .replace(/\bketo\b/gi, 'ketojenik')
                                        .replace(/\bketogenic\b/gi, 'ketojenik');
                                    
                                    console.log('🔍 Genişletilmiş arama:', expandedSearch);
                                    
                                    mappedFood = foodDatabase.find(f => {
                                        const foodNameNorm = f.name.toLowerCase().trim();
                                        return foodNameNorm === expandedSearch || 
                                               normalizeText(foodNameNorm) === normalizeText(expandedSearch) ||
                                               foodNameNorm.includes(expandedSearch) ||
                                               expandedSearch.includes(foodNameNorm);
                                    });
                                }
                                
                                // 3. Kelime kelime eşleşme (en az 2 kelime ortak)
                                if (!mappedFood) {
                                    const searchWords = tarifBaseName.split(/\s+/).filter(w => w.length > 2);
                                    
                                    mappedFood = foodDatabase.find(f => {
                                        const foodNameNorm = f.name.toLowerCase().trim();
                                        const foodWords = foodNameNorm.split(/\s+/).filter(w => w.length > 2);
                                        const commonWords = searchWords.filter(sw => 
                                            foodWords.some(fw => fw.includes(sw) || sw.includes(fw))
                                        );
                                        return commonWords.length >= Math.min(2, searchWords.length);
                                    });
                                }
                                
                                if (mappedFood) {
                                    console.log('✅ Tarif kartı ile eşleşen yemek bulundu:', mappedFood.name);
                                    console.log('🔍 Bu yemeğin alternatifleri aranıyor...');
                                    
                                    // Sahte food objesi oluştur - MOR KARTTA ORİJİNAL YEMEĞİ GÖSTER
                                    // Renderdaki makroları kullan (varsa)
                                    const useMacros = window.renderMacros || {
                                        calories: 0,
                                        protein: 0,
                                        carbs: 0,
                                        fat: 0
                                    };
                                    
                                    const pseudoFood = {
                                        name: decodedFood, // Orijinal yemek adı
                                        category: mappedFood.category, // Eşleşen yemeğin kategorisi
                                        calories: useMacros.calories, // Renderdaki kalori
                                        protein: useMacros.protein, // Renderdaki protein
                                        carbs: useMacros.carbs, // Renderdaki karb
                                        fat: useMacros.fat, // Renderdaki yağ
                                        isManualMapping: true
                                    };
                                    
                                    console.log('📊 Mor kartta gösterilecek makrolar:', useMacros);
                                    
                                    // Mor kartta sahte yemeği göster
                                    showSelectedFood(pseudoFood);
                                    
                                    // ALTERNATİFLER: Eşleşen yemeğin alternatiflerini bul
                                    // ❌ İlk alternatif eşleşen yemek olmasın (zaten eşleştirilmiş)
                                    findAlternatives(mappedFood);
                                } else {
                                    console.warn('⚠️ Tarif kartı için veritabanında eşleşen yemek bulunamadı:', tarifBaseName);
                                    
                                    // Sahte food objesi oluştur (veritabanında olmadığı için)
                                    const pseudoFood = {
                                        name: decodedFood,
                                        category: 'unknown',
                                        calories: 0,
                                        protein: 0,
                                        carbs: 0,
                                        fat: 0,
                                        isManualMapping: true
                                    };
                                    
                                    // Mor kartta göster
                                    showSelectedFood(pseudoFood);
                                    
                                    // Sadece tarif kartını göster
                                    showAlternativeFood({ ...pseudoFood, tarifKartlari: tarifKartlariList });
                                }
                            } else {
                                console.warn('❌ Manuel eşleştirmede tarif kartı yok');
                            }
                        } else {
                            console.warn('❌ Manuel eşleştirme de bulunamadı');
                            // Kullanıcıya bilgi göster
                            const morKart = document.querySelector('.selected-food-card');
                            if (morKart) {
                                morKart.innerHTML = `
                                    <div style="text-align: center; padding: 20px;">
                                        <h3 style="color: #dc3545; margin-bottom: 10px;">⚠️ Yemek Bulunamadı</h3>
                                        <p style="color: #666; margin-bottom: 10px;">"${decodedFood}"</p>
                                        <p style="font-size: 14px; color: #888;">Bu yemek veritabanında bulunmuyor. Lütfen admin panelinden ekleyin veya manuel eşleştirme yapın.</p>
                                    </div>
                                `;
                            }
                        }
                    }
                } else {
                    console.error('❌ yemekArama elementi bulunamadı!');
                }
            }
        });

        /* ------------------ Hasta Ayarları Modalı ------------------ */
        // Modal markup (hidden by default)
        const modalHtml = `
        <div id="userSettingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
            <div style="background:#fff; max-width:520px; width:92%; border-radius:10px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,0.2);">
                <h3 style="margin:0 0 8px 0;">Hesap Ayarları</h3>
                <div style="max-height:60vh; overflow:auto; padding-right:8px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <label>Ad *<input id="us_name" type="text" required style="width:100%;"></label>
                        <label>Demo<input id="us_demo" type="text" style="width:100%;"></label>
                        <label>Soyad *<input id="us_surname" type="text" required style="width:100%;"></label>
                        <label>Rol<input id="us_role" type="text" value="Hasta" style="width:100%;"></label>
                        <label>Yaş *<input id="us_age" type="number" min="0" style="width:100%;"></label>
                        <label>Cinsiyet *<select id="us_gender" style="width:100%;"><option value="Erkek">Erkek</option><option value="Kadin">Kadın</option><option value="Diger">Diğer</option></select></label>
                        <label>Kilo (kg) *<input id="us_weight" type="number" min="0" step="0.1" style="width:100%;"></label>
                        <label>Boy (cm) *<input id="us_height" type="number" min="0" step="0.1" style="width:100%;"></label>
                        <label>BMI<input id="us_bmi" type="text" readonly style="width:100%; background:#f6f6f6;"></label>
                        <label>Kullanıcı Adı *<input id="us_username" type="text" required style="width:100%;"></label>
                        <label>Şifre (değiştirmek için yeni şifre girin)<input id="us_password" type="password" style="width:100%;"></label>
                    </div>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                    <button id="us_cancel" style="padding:8px 12px;">İptal</button>
                    <button id="us_save" style="padding:8px 12px; background:#667eea; color:#fff; border:none; border-radius:6px;">Kaydet</button>
                </div>
            </div>
        </div>`;

        // Ekle
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Modal event listeners
        document.getElementById('us_cancel').addEventListener('click', () => {
            document.getElementById('userSettingsModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        });
        
        // Modal dışına tıklanınca kapat
        document.getElementById('userSettingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'userSettingsModal') {
                document.getElementById('userSettingsModal').style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        });

        // Yardımcı: SHA-256 hash (aynı algoritma auth.js ile uyumlu)

        // ===== YEMEK DÜZENLEME FONKSİYONLARI (Admin) =====
        
        /**
         * Mobil versiyondan yemek düzenleme modalını aç
         * Alternatif listesindeki seçili yemeği düzenler
         */
        window.openFoodEditModalFromMobile = function() {
            // Mobil versiyonda currentAlternatives[currentIndex] kullan
            if (!currentAlternatives || currentAlternatives.length === 0) {
                alert('⚠️ Önce bir yemek arayın ve alternatifler görüntüleyin!');
                return;
            }

            const food = currentAlternatives[currentIndex];
            if (!food) {
                alert('⚠️ Geçerli bir alternatif yemek bulunamadı!');
                return;
            }

            const foodName = food.name;
            
            // Modal başlığını güncelle
            document.getElementById('editFoodModalTitle').textContent = foodName;
            
            // Formları doldur
            document.getElementById('editFoodName').value = foodName;
            document.getElementById('editFoodCalories').value = food.calories || 0;
            document.getElementById('editFoodProtein').value = food.protein || 0;
            document.getElementById('editFoodCarbs').value = food.carbs || 0;
            document.getElementById('editFoodFat').value = food.fat || 0;
            document.getElementById('editFoodCategory').value = food.category || '';
            document.getElementById('editFoodRole').value = food.role || '';
            
            // Öğün tipleri
            const mealTypes = food.mealType || food.mealTypes || [];
            document.getElementById('editMealType_breakfast').checked = mealTypes.includes('breakfast');
            document.getElementById('editMealType_lunch').checked = mealTypes.includes('lunch');
            document.getElementById('editMealType_dinner').checked = mealTypes.includes('dinner');
            
            // Porsiyon
            document.getElementById('editFoodPortion').value = food.portionMultiplier || food.multiplier || 1;
            
            // Diyet tipleri
            const dietTypes = food.dietTypes || [];
            document.getElementById('editDietType_ketojenik').checked = dietTypes.includes('ketojenik');
            document.getElementById('editDietType_akdeniz').checked = dietTypes.includes('akdeniz');
            document.getElementById('editDietType_vegan').checked = dietTypes.includes('vegan');
            document.getElementById('editDietType_glutensiz').checked = dietTypes.includes('glutensiz');
            
            // Gelişmiş ayarlar
            document.getElementById('editFoodMin').value = food.minQuantity || '';
            document.getElementById('editFoodMax').value = food.maxQuantity || '';
            document.getElementById('editFoodStep').value = food.step || '';
            
            // Sezon
            if (food.seasonRange) {
                try {
                    const season = JSON.parse(food.seasonRange);
                    document.getElementById('editFoodSeasonMin').value = season[0] || '';
                    document.getElementById('editFoodSeasonMax').value = season[1] || '';
                } catch (e) {
                    document.getElementById('editFoodSeasonMin').value = '';
                    document.getElementById('editFoodSeasonMax').value = '';
                }
            } else {
                document.getElementById('editFoodSeasonMin').value = '';
                document.getElementById('editFoodSeasonMax').value = '';
            }
            
            // Özel özellikler
            document.getElementById('editFoodKeto').checked = food.keto || false;
            document.getElementById('editFoodLowCarb').checked = food.lowcarb || false;
            document.getElementById('editFoodPortionFixed').checked = food.portionFixed || false;
            document.getElementById('editFoodFillerLunch').checked = food.fillerLunch || false;
            document.getElementById('editFoodFillerDinner').checked = food.fillerDinner || false;
            document.getElementById('editFoodReversedSeason').checked = food.isReversedSeason || false;
            
            // Etiketler
            document.getElementById('editFoodTags').value = (food.tags || []).join(', ');
            document.getElementById('editFoodCompat').value = (food.compatibilityTags || []).join(', ');
            document.getElementById('editFoodIncompat').value = (food.incompatibilityTags || []).join(', ');
            
            // Notlar
            document.getElementById('editFoodNotes').value = food.notes || '';
            
            // food_list.json kaydetme checkbox'ı varsayılan kapalı
            document.getElementById('saveFoodToDatabase').checked = false;
            
            // Modalı göster
            document.getElementById('templateFoodEditModal').style.display = 'block';
        };
        
        /**
         * Yemek düzenleme modalını kapat
         */
        window.closeTemplateFoodEditModal = function() {
            document.getElementById('templateFoodEditModal').style.display = 'none';
            document.getElementById('editFoodSearchResults').style.display = 'none';
        };
        
        /**
         * Yemek arama (akıllı search - dropdown)
         */
        window.searchFoodForEdit = function(query) {
            const resultsContainer = document.getElementById('editFoodSearchResults');
            if (!resultsContainer) return;
            
            if (!query || query.trim().length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const normalizedQuery = normalizeTr(query);
            const tokens = tokenize(query);
            
            let matches = foodDatabase.filter(food => {
                const normalizedName = normalizeTr(food.name);
                if (normalizedName === normalizedQuery) return true;
                if (normalizedName.includes(normalizedQuery)) return true;
                const foodTokens = tokenize(food.name);
                return tokens.some(t => foodTokens.some(ft => ft.includes(t) || t.includes(ft)));
            });
            
            matches = matches.slice(0, 10);
            
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">Sonuç bulunamadı</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let html = '';
            matches.forEach(food => {
                html += `
                    <div onclick="selectFoodForEdit('${food.name.replace(/'/g, "\\'")}')" style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; margin-bottom: 4px;">${food.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${Math.round(food.calories || 0)} kcal | 
                            P: ${Math.round(food.protein || 0)}g | 
                            K: ${Math.round(food.carbs || 0)}g | 
                            Y: ${Math.round(food.fat || 0)}g
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        };
        
        /**
         * Arama sonucundan yemek seç
         */
        window.selectFoodForEdit = function(foodName) {
            const dbFood = foodDatabase.find(f => f.name === foodName);
            
            if (dbFood) {
                document.getElementById('editFoodName').value = dbFood.name;
                document.getElementById('editFoodCalories').value = dbFood.calories || 0;
                document.getElementById('editFoodProtein').value = dbFood.protein || 0;
                document.getElementById('editFoodCarbs').value = dbFood.carbs || 0;
                document.getElementById('editFoodFat').value = dbFood.fat || 0;
                document.getElementById('editFoodCategory').value = dbFood.category || '';
                document.getElementById('editFoodRole').value = dbFood.role || '';
                
                const mealTypes = dbFood.mealType || dbFood.mealTypes || [];
                document.getElementById('editMealType_breakfast').checked = mealTypes.includes('breakfast');
                document.getElementById('editMealType_lunch').checked = mealTypes.includes('lunch');
                document.getElementById('editMealType_dinner').checked = mealTypes.includes('dinner');
                
                document.getElementById('editFoodPortion').value = dbFood.portionMultiplier || dbFood.multiplier || 1;
                
                const dietTypes = dbFood.dietTypes || [];
                document.getElementById('editDietType_ketojenik').checked = dietTypes.includes('ketojenik');
                document.getElementById('editDietType_akdeniz').checked = dietTypes.includes('akdeniz');
                document.getElementById('editDietType_vegan').checked = dietTypes.includes('vegan');
                document.getElementById('editDietType_glutensiz').checked = dietTypes.includes('glutensiz');
                
                document.getElementById('editFoodMin').value = dbFood.minQuantity || '';
                document.getElementById('editFoodMax').value = dbFood.maxQuantity || '';
                document.getElementById('editFoodStep').value = dbFood.step || '';
                
                if (dbFood.seasonRange) {
                    try {
                        const season = JSON.parse(dbFood.seasonRange);
                        document.getElementById('editFoodSeasonMin').value = season[0] || '';
                        document.getElementById('editFoodSeasonMax').value = season[1] || '';
                    } catch (e) {
                        document.getElementById('editFoodSeasonMin').value = '';
                        document.getElementById('editFoodSeasonMax').value = '';
                    }
                } else {
                    document.getElementById('editFoodSeasonMin').value = '';
                    document.getElementById('editFoodSeasonMax').value = '';
                }
                
                document.getElementById('editFoodKeto').checked = dbFood.keto || false;
                document.getElementById('editFoodLowCarb').checked = dbFood.lowcarb || false;
                document.getElementById('editFoodPortionFixed').checked = dbFood.portionFixed || false;
                document.getElementById('editFoodFillerLunch').checked = dbFood.fillerLunch || false;
                document.getElementById('editFoodFillerDinner').checked = dbFood.fillerDinner || false;
                document.getElementById('editFoodReversedSeason').checked = dbFood.isReversedSeason || false;
                
                document.getElementById('editFoodTags').value = (dbFood.tags || []).join(', ');
                document.getElementById('editFoodCompat').value = (dbFood.compatibilityTags || []).join(', ');
                document.getElementById('editFoodIncompat').value = (dbFood.incompatibilityTags || []).join(', ');
                
                document.getElementById('editFoodNotes').value = dbFood.notes || '';
            }
            
            document.getElementById('editFoodSearchResults').style.display = 'none';
        };
        
        /**
         * Düzenlenen yemeği kaydet (sadece food_list.json'a)
         */
        window.saveEditedTemplateFood = async function() {
            const saveToDB = document.getElementById('saveFoodToDatabase').checked;
            
            if (!saveToDB) {
                alert('ℹ️ food_list.json\'a kaydetmek için checkbox\'ı işaretleyin.');
                return;
            }
            
            const newFoodName = document.getElementById('editFoodName').value.trim();
            const newCalories = parseFloat(document.getElementById('editFoodCalories').value) || 0;
            const newProtein = parseFloat(document.getElementById('editFoodProtein').value) || 0;
            const newCarbs = parseFloat(document.getElementById('editFoodCarbs').value) || 0;
            const newFat = parseFloat(document.getElementById('editFoodFat').value) || 0;
            const newCategory = document.getElementById('editFoodCategory').value.trim();
            const newRole = document.getElementById('editFoodRole').value.trim();
            
            if (!newFoodName) {
                alert('⚠️ Yemek adı boş olamaz!');
                return;
            }
            
            // Öğün tipleri
            const newMealTypes = [];
            if (document.getElementById('editMealType_breakfast').checked) newMealTypes.push('breakfast');
            if (document.getElementById('editMealType_lunch').checked) newMealTypes.push('lunch');
            if (document.getElementById('editMealType_dinner').checked) newMealTypes.push('dinner');
            
            const newPortion = parseFloat(document.getElementById('editFoodPortion').value) || 1;
            
            // Diyet tipleri
            const newDietTypes = [];
            if (document.getElementById('editDietType_ketojenik').checked) newDietTypes.push('ketojenik');
            if (document.getElementById('editDietType_akdeniz').checked) newDietTypes.push('akdeniz');
            if (document.getElementById('editDietType_vegan').checked) newDietTypes.push('vegan');
            if (document.getElementById('editDietType_glutensiz').checked) newDietTypes.push('glutensiz');
            
            const newMin = document.getElementById('editFoodMin').value.trim();
            const newMax = document.getElementById('editFoodMax').value.trim();
            const newStep = document.getElementById('editFoodStep').value.trim();
            
            const newSeasonMin = document.getElementById('editFoodSeasonMin').value.trim();
            const newSeasonMax = document.getElementById('editFoodSeasonMax').value.trim();
            const newSeasonRange = (newSeasonMin && newSeasonMax) ? JSON.stringify([parseInt(newSeasonMin), parseInt(newSeasonMax)]) : '';
            
            const newKeto = document.getElementById('editFoodKeto').checked;
            const newLowCarb = document.getElementById('editFoodLowCarb').checked;
            const newPortionFixed = document.getElementById('editFoodPortionFixed').checked;
            const newFillerLunch = document.getElementById('editFoodFillerLunch').checked;
            const newFillerDinner = document.getElementById('editFoodFillerDinner').checked;
            const newReversedSeason = document.getElementById('editFoodReversedSeason').checked;
            
            const newTags = document.getElementById('editFoodTags').value.split(',').map(t => t.trim()).filter(t => t);
            const newCompat = document.getElementById('editFoodCompat').value.split(',').map(t => t.trim()).filter(t => t);
            const newIncompat = document.getElementById('editFoodIncompat').value.split(',').map(t => t.trim()).filter(t => t);
            
            const newNotes = document.getElementById('editFoodNotes').value.trim();
            
            // Token kontrolü
            const token = localStorage.getItem('github_token');
            if (!token) {
                alert('❌ GitHub token bulunamadı!\n\nDeğişiklikler kaybolacak.\n\nAdmin Settings sayfasından GitHub token girin.');
                return;
            }
            
            // Güncellenmiş yemek objesi
            const updatedFood = {
                name: newFoodName,
                calories: newCalories,
                protein: newProtein,
                carbs: newCarbs,
                fat: newFat,
                category: newCategory,
                role: newRole,
                mealType: newMealTypes,
                portion: newPortion,
                dietType: newDietTypes,
                min: newMin,
                max: newMax,
                step: newStep,
                keto: newKeto,
                lowcarb: newLowCarb,
                portionFixed: newPortionFixed,
                fillerLunch: newFillerLunch,
                fillerDinner: newFillerDinner,
                tags: newTags,
                compatibilityTags: newCompat,
                incompatibilityTags: newIncompat,
                notes: newNotes
            };
            
            // Sezon bilgisi varsa ekle
            if (newSeasonMin && newSeasonMax) {
                updatedFood.season = [parseInt(newSeasonMin), parseInt(newSeasonMax)];
                updatedFood.isReversedSeason = newReversedSeason;
            }
            
            // Loading göster
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10001; text-align: center;">
                    <div style="font-size: 18px; font-weight: 600; color: #28a745;">GitHub'a kaydediliyor...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 10px;">Lütfen bekleyin</div>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;"></div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Mevcut yemeği bul ve güncelle
                const currentFood = currentAlternatives[currentIndex];
                const originalName = currentFood.name;
                
                const index = foodDatabase.findIndex(f => f.name === originalName);
                if (index !== -1) {
                    foodDatabase[index] = updatedFood;
                } else {
                    // Yeni yemek olarak ekle
                    foodDatabase.push(updatedFood);
                }

                // GitHub'a kaydet - saveFoodListToGithub fonksiyonunu çağır
                await saveFoodListToGithub(foodDatabase, `Yemek güncellendi: ${newFoodName}`);

                // Loading'i kaldır
                document.body.removeChild(loadingDiv);
                
                console.log('✅ Yemek GitHub\'a kaydedildi:', newFoodName);
                alert(`✅ Başarılı!\n\n"${newFoodName}" yemeği GitHub'a kaydedildi.\n\nDeğişiklik food_list.json dosyasına yazıldı.`);
                
                closeTemplateFoodEditModal();
                
                // Sayfayı yenile (güncel verileri görmek için)
                setTimeout(() => location.reload(), 1000);

            } catch (error) {
                // Loading'i kaldır
                if (document.body.contains(loadingDiv)) {
                    document.body.removeChild(loadingDiv);
                }

                console.error('GitHub kaydetme hatası:', error);
                alert(`❌ GitHub'a kaydedilemedi!\n\nHata: ${error.message}`);
            }
        };
        
        /**
         * GitHub'a dosya kaydet (generic)
         */
        async function updateGithubFile(filePath, content, commitMessage) {
            const token = localStorage.getItem('github_token');
            if (!token) {
                throw new Error('GitHub token bulunamadı!');
            }

            const GITHUB_OWNER = 'mustafasacar35';
            const GITHUB_REPO = 'lipodem-takip-paneli';
            const GITHUB_BRANCH = 'main';

            // 1. Mevcut dosyanın SHA'sını al
            const getUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}?ref=${GITHUB_BRANCH}`;
            
            let sha = null;
            const getResponse = await fetch(getUrl, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (getResponse.ok) {
                const data = await getResponse.json();
                sha = data.sha;
            }

            // 2. Dosyayı güncelle
            const putUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}`;
            
            // Base64 encode
            const encoder = new TextEncoder();
            const uint8Array = encoder.encode(content);
            
            let binaryString = '';
            const chunkSize = 8192;
            
            for (let i = 0; i < uint8Array.length; i += chunkSize) {
                const chunk = uint8Array.slice(i, i + chunkSize);
                const chunkArray = Array.from(chunk);
                binaryString += String.fromCharCode(...chunkArray);
            }
            
            const base64Content = btoa(binaryString);
            
            const putResponse = await fetch(putUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: base64Content,
                    sha: sha,
                    branch: GITHUB_BRANCH
                })
            });

            if (!putResponse.ok) {
                const error = await putResponse.json();
                throw new Error(error.message || 'GitHub API hatası');
            }

            return await putResponse.json();
        }

        /**
         * food_list.json'u GitHub'a kaydet
         */
        async function saveFoodListToGithub(updatedDatabase, commitMessage) {
            // Kategorilere göre grupla
            const categories = {};
            
            updatedDatabase.forEach(food => {
                const categoryName = food.category || 'Diğer';
                if (!categories[categoryName]) {
                    categories[categoryName] = {
                        name: categoryName,
                        items: []
                    };
                }
                categories[categoryName].items.push(food);
            });

            const jsonData = {
                version: "3.0",
                lastUpdated: new Date().toISOString(),
                categories: Object.values(categories)
            };
            
            const jsonContent = JSON.stringify(jsonData, null, 2);
            
            console.log(`📊 JSON boyutu: ${(jsonContent.length / 1024).toFixed(1)} KB`);

            // GitHub'a kaydet
            await updateGithubFile('food_list.json', jsonContent, commitMessage);
            
            console.log(`✅ GitHub'a başarıyla kaydedildi: food_list.json`);
        }
        
        // ============================================================
        // 🔥 ADMIN EDIT BUTTON v2.1 - LEFT SIDE - 2025-11-09 FINAL
        // ============================================================
        console.log('🚀 ADMIN MODULE v2.1 LOADED - LEFT SIDE - BUILD: 2025-11-09-22:00');
        console.log('� Key: patient_session | Position: BOTTOM-LEFT');
        
        // Admin butonunu göster/gizle (localStorage'dan kontrol)
        window.checkAdminStatus = function() {
            // 🎯 IFRAME KONTROLÜ: Eğer iframe içindeyse parent'tan oku
            const storage = (window.parent !== window) ? window.parent.localStorage : localStorage;
            const isInIframe = window.parent !== window;
            
            if (isInIframe) {
                console.log('🖼️ IFRAME içinde çalışıyor - parent localStorage kullanılıyor');
            }
            
            // 🔑 DOĞRU KEY: patient_session (auth.js ile aynı)
            const sessionRaw = storage.getItem('patient_session');
            console.log('📦 RAW patient_session:', sessionRaw);
            
            let isAdmin = false;
            
            if (sessionRaw) {
                try {
                    const session = JSON.parse(sessionRaw);
                    console.log('📦 Parsed session:', session);
                    console.log('📦 Session keys:', Object.keys(session));
                    
                    //  Admin yetkisi kontrolü (patient_nutrition.html ile aynı mantık)
                    isAdmin = session.isAdmin === true || 
                             session.role === 'admin' || 
                             session.role === 'ADMIN' || 
                             session.userRole === 'admin' || 
                             session.userRole === 'ADMIN';
                    
                    // 🔧 DEBUG MODE: URL'de ?admin=true varsa admin yetkisi ver
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('admin') === 'true') {
                        isAdmin = true;
                        console.log('🔧 DEBUG MODE: Admin yetkisi URL parametresi ile aktif edildi');
                    }
                    
                    if (isAdmin) {
                        console.log(' Admin yetkili kullanıcı tespit edildi:', session.username || session.fullName || 'Admin');
                    }
                    
                    console.log('🔍 Admin Status:', {
                        isInIframe: isInIframe,
                        session: session,
                        role: session.role,
                        userRole: session.userRole,
                        isAdmin: session.isAdmin,
                        finalIsAdmin: isAdmin
                    });
                } catch (e) {
                    console.warn('⚠️ patient_session parse hatası:', e);
                }
            }
            
            // Fallback: lipodemUserData'yı da kontrol et
            if (!isAdmin) {
                const userDataRaw = localStorage.getItem('lipodemUserData');
                if (userDataRaw) {
                    try {
                        const userData = JSON.parse(userDataRaw);
                        isAdmin = userData.role === 'admin' || userData.userRole === 'admin' || userData.type === 'admin';
                        console.log('🔍 Admin Status (lipodemUserData):', { userData, isAdmin });
                    } catch (e) {
                        console.warn('⚠️ lipodemUserData parse hatası:', e);
                    }
                }
            }
            
            // 🔥 DEBUG: URL parametresinden admin modu (test için)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                console.log('🔥 DEBUG MODE: Admin butonu zorla açıldı (URL: ?admin=true)');
                isAdmin = true;
            }
            
            const adminButton = document.getElementById('adminEditButton');
            if (adminButton) {
                adminButton.style.display = isAdmin ? 'flex' : 'none';
                console.log('✅ Admin butonu durumu:', isAdmin ? '🟢 GÖSTER' : '🔴 GİZLE');
            } else {
                console.warn('⚠️ adminEditButton elementi bulunamadı!');
            }

            // 🚫 Yasak listesi butonunu da kontrol et
            const blacklistButton = document.getElementById('blacklistButton');
            if (blacklistButton) {
                blacklistButton.style.display = isAdmin ? 'flex' : 'none';
                console.log('✅ Yasak listesi butonu durumu:', isAdmin ? '🟢 GÖSTER' : '🔴 GİZLE');
            }
        };
        
        // 🚀 HEMEN BUTONU EKLE (DOMContentLoaded beklemeden)
        (function addAdminButton() {
            console.log('🔧 Admin butonu ekleniyor (HEMEN)...');
            
            // Zaten varsa ekleme
            if (document.getElementById('adminEditButton')) {
                console.log('⚠️ Admin butonu zaten var, tekrar eklenmedi');
                return;
            }
            
            // Butonu oluştur
            const adminBtn = document.createElement('button');
            adminBtn.id = 'adminEditButton';
            adminBtn.className = 'admin-edit-button';
            adminBtn.onclick = function() {
                if (typeof openFoodEditModalFromMobile === 'function') {
                    openFoodEditModalFromMobile();
                } else {
                    console.error('❌ openFoodEditModalFromMobile fonksiyonu tanımlı değil');
                }
            };
            adminBtn.title = 'Yemek Düzenle';
            adminBtn.innerHTML = '✏️';
            adminBtn.style.display = 'none';
            
            // Body'yi interval ile kontrol et (garanti eklemek için)
            const addButtonInterval = setInterval(function() {
                if (document.body) {
                    clearInterval(addButtonInterval);
                    document.body.appendChild(adminBtn);
                    console.log('✅ Admin butonu DOM\'a eklendi:', adminBtn);
                    
                    // Hemen admin kontrolü yap
                    setTimeout(checkAdminStatus, 50);
                }
            }, 10); // Her 10ms kontrol et
            
            // 1 saniye sonra hala eklenemediyse zorla ekle
            setTimeout(function() {
                if (!document.getElementById('adminEditButton') && document.body) {
                    document.body.appendChild(adminBtn);
                    console.log('✅ Admin butonu DOM\'a eklendi (FALLBACK):', adminBtn);
                    checkAdminStatus();
                }
            }, 1000);
        })();

        // 🚫 YASAK LİSTESİ BUTONU EKLE
        (function addBlacklistButton() {
            console.log('🔧 Yasak listesi butonu ekleniyor...');
            
            // Zaten varsa ekleme
            if (document.getElementById('blacklistButton')) {
                console.log('⚠️ Yasak listesi butonu zaten var');
                return;
            }
            
            // Butonu oluştur
            const blacklistBtn = document.createElement('button');
            blacklistBtn.id = 'blacklistButton';
            blacklistBtn.className = 'blacklist-button';
            blacklistBtn.onclick = function() {
                if (typeof openBlacklistModal === 'function') {
                    openBlacklistModal();
                } else {
                    console.error('❌ openBlacklistModal fonksiyonu tanımlı değil');
                }
            };
            blacklistBtn.title = 'Yasak Listesi Yönetimi';
            blacklistBtn.innerHTML = '🚫';
            blacklistBtn.style.display = 'none';
            
            // Body'yi interval ile kontrol et
            const addBlacklistInterval = setInterval(function() {
                if (document.body) {
                    clearInterval(addBlacklistInterval);
                    document.body.appendChild(blacklistBtn);
                    console.log('✅ Yasak listesi butonu DOM\'a eklendi:', blacklistBtn);
                    setTimeout(checkAdminStatus, 60);
                }
            }, 10);
            
            // Fallback
            setTimeout(function() {
                if (!document.getElementById('blacklistButton') && document.body) {
                    document.body.appendChild(blacklistBtn);
                    console.log('✅ Yasak listesi butonu DOM\'a eklendi (FALLBACK)');
                    checkAdminStatus();
                }
            }, 1000);
        })();
        
        // Sayfa yüklendiğinde admin kontrolü yap (birden fazla event ile garanti)
        window.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 DOMContentLoaded - Admin kontrolü yapılıyor...');
            checkAdminStatus();
        });
        
        window.addEventListener('load', function() {
            console.log('🔍 Load - Admin kontrolü yapılıyor...');
            checkAdminStatus();
        });
        
        // Hemen de çalıştır (100ms sonra)
        setTimeout(function() {
            console.log('🔍 Timeout - Admin kontrolü yapılıyor...');
            checkAdminStatus();
        }, 100);


    </script>
</body>
</html>


