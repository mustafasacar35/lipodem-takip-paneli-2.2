<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Yönetici Ayarlarý">
    <meta name="application-name" content="Yönetici Ayarlarý">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest-admin-settings.json">
    <link rel="apple-touch-icon" href="/logo2.png">
    <!-- / PWA ve Mobil Uygulama Meta Etiketleri -->

    <title>Yönetici Ayarlarý</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-wrapper {
            width: min(760px, 100%);
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 30px 65px rgba(15, 23, 42, 0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .settings-header {
            padding: 22px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .admin-nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .admin-nav-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .admin-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .admin-nav-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            font-weight: 700;
        }

        .settings-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .settings-header p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .settings-body {
            padding: 26px 28px 24px;
            display: flex;
            flex-direction: column;
            gap: 22px;
            max-height: 78vh;
            overflow-y: auto;
        }

        .settings-section {
            border: 1px solid #e0e7ff;
            border-radius: 14px;
            padding: 18px;
            background: #f8fafc;
        }

        .settings-section h2 {
            margin: 0 0 14px 0;
            font-size: 16px;
            color: #4338ca;
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }

        label {
            font-size: 13px;
            color: #475569;
            font-weight: 600;
        }

        input[type="number"],
        input[type="text"],
        input[type="password"],
        textarea {
            padding: 11px 13px;
            border: 1px solid #cbd5f5;
            border-radius: 9px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        input.disabled {
            background: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .settings-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 12px;
            border-radius: 999px;
            background: rgba(102, 126, 234, 0.12);
            color: #4338ca;
            font-size: 12px;
        }

        .settings-chip button {
            border: none;
            background: transparent;
            cursor: pointer;
            color: inherit;
            font-size: 15px;
            line-height: 1;
        }

        .empty-hint {
            font-size: 12px;
            color: #94a3b8;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 20px 28px;
            border-top: 1px solid #e0e7ff;
            background: #f8fafc;
        }

        .actions-right {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap; /* Butonlarý asla alt satýra geçirme */
        }

        .actions-right button {
            white-space: nowrap; /* Buton metnini kýrma */
            flex-shrink: 1; /* Gerekirse butonlarý küçült */
            min-width: 0; /* Butonlarýn minimum geniþliðini kaldýr */
        }

        button {
            padding: 11px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-primary {
            background: linear-gradient(135deg, #22d3ee 0%, #3b82f6 100%);
            color: #ffffff;
            box-shadow: 0 14px 28px rgba(59, 130, 246, 0.30);
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .status-text {
            font-size: 13px;
            color: #64748b;
        }

        .status-text strong {
            font-weight: 700;
        }

        .info-banner {
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.35);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 13px;
            color: #0f172a;
            margin-top: 4px;
        }

        .info-banner code {
            background: rgba(15, 23, 42, 0.08);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 12px;
        }

        .suggestion-hint {
            font-size: 11px;
            color: #94a3b8;
        }

        details {
            background: #e0f2fe;
            border-radius: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(14, 165, 233, 0.35);
            font-size: 12px;
            color: #0369a1;
        }

        details summary {
            cursor: pointer;
            font-weight: 600;
        }

        .suggestions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .suggestions-grid span {
            background: rgba(14, 165, 233, 0.15);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Filtreleme Kriterleri Grid Layout */
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
        }

        .criteria-item {
            border: 1px solid #e0e7ff;
            border-radius: 10px;
            padding: 14px;
            background: white;
            transition: box-shadow 0.2s ease;
        }

        .criteria-item:hover {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .criteria-header {
            margin-bottom: 10px;
        }

        .criteria-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            cursor: pointer;
        }

        .criteria-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .criteria-label {
            user-select: none;
        }

        .criteria-body {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-left: 26px;
        }

        .criteria-select,
        select {
            padding: 9px 11px;
            border: 1px solid #cbd5f5;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            cursor: pointer;
        }

        .criteria-select:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .criteria-select:disabled,
        select:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .info-hint ul {
            list-style-type: disc;
        }

        .info-hint li {
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .criteria-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
            }

            .settings-wrapper {
                border-radius: 14px;
            }

            .settings-header, .settings-body, .actions-row {
                padding-left: 18px;
                padding-right: 18px;
            }

            .settings-header h1 {
                font-size: 21px;
            }

            .settings-section {
                padding: 16px;
            }

            .actions-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .actions-right {
                width: 100%;
                justify-content: flex-end; /* Butonlarý saða hizala */
                gap: 8px; /* Mobilde daha küçük gap */
            }

            .actions-right button {
                font-size: 13px; /* Mobilde biraz daha küçük font */
                padding: 10px 14px; /* Mobilde daha kompakt padding */
            }
        }
    </style>
    <!-- Admins config removed - using Supabase only -->
    
    <!-- Supabase & Data Access Layer -->
    <!-- 1. Load Supabase Library (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 2. Initialize Supabase Client (Robust Fallback) -->
    <script>
        (function() {
            const supabaseUrl = 'https://qvpeqxzaprgesgrgzmuo.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2cGVxeHphcHJnZXNncmd6bXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjAzNjYsImV4cCI6MjA3OTAzNjM2Nn0.4Mo-9pgAk9vBHT48yVunuijSzqQX6cX07fCfDF48hLk';
            
            console.log('[Init] Checking Supabase Library...');
            
            // Fallback Shim if CDN failed
            if (!window.supabase || !window.supabase.createClient) {
                console.warn('[Init] Supabase CDN not loaded. Using FULL Shim.');
                
                class SupabaseShim {
                    constructor(url, key) {
                        this.url = url;
                        this.key = key;
                        this.headers = { 'apikey': key, 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };
                    }
                    from(table) { return new QueryBuilder(this, table); }
                }

                class QueryBuilder {
                    constructor(client, table) {
                        this.client = client;
                        this.table = table;
                        this.queryParams = new URLSearchParams();
                    }
                    select(cols = '*') {
                        this.queryParams.set('select', cols);
                        this._selected = true;
                        return this;
                    }
                    eq(col, val) { this.queryParams.append(col, `eq.${val}`); return this; }
                    order(col, opts) {
                        this.queryParams.append('order', `${col}.${opts?.ascending ? 'asc' : 'desc'}`);
                        return this;
                    }
                    
                    async then(resolve, reject) {
                        try {
                            let res;
                            let data;
                            // If we have a pending upsert, perform POST
                            if (this._pendingType === 'upsert' && this._pendingUpsert) {
                                const { data: upData, opts } = this._pendingUpsert;
                                const headers = { ...this.client.headers, 'Prefer': 'return=representation' };
                                if (opts?.onConflict) headers['Prefer'] += `,resolution=merge-duplicates`;
                                res = await fetch(`${this.client.url}/rest/v1/${this.table}?${this.queryParams}`, {
                                    method: 'POST',
                                    headers,
                                    body: JSON.stringify(upData)
                                });
                                data = await res.json();
                            } else if (this._pendingType === 'update' && this._pendingUpdate) {
                                // Perform PATCH (update)
                                res = await fetch(`${this.client.url}/rest/v1/${this.table}?${this.queryParams}`, {
                                    method: 'PATCH',
                                    headers: { ...this.client.headers, 'Prefer': 'return=representation' },
                                    body: JSON.stringify(this._pendingUpdate)
                                });
                                data = await res.json();
                            } else if (this._pendingType === 'insert' && this._pendingInsert) {
                                // Perform POST (insert)
                                res = await fetch(`${this.client.url}/rest/v1/${this.table}?${this.queryParams}`, {
                                    method: 'POST',
                                    headers: { ...this.client.headers, 'Prefer': 'return=representation' },
                                    body: JSON.stringify(this._pendingInsert)
                                });
                                data = await res.json();
                            } else if (this._pendingType === 'delete') {
                                // Perform DELETE
                                res = await fetch(`${this.client.url}/rest/v1/${this.table}?${this.queryParams}`, {
                                    method: 'DELETE',
                                    headers: { ...this.client.headers, 'Prefer': 'return=representation' }
                                });
                                data = res.status === 204 ? null : await res.json();
                            } else {
                                // Default: SELECT
                                res = await fetch(`${this.client.url}/rest/v1/${this.table}?${this.queryParams}`, {
                                    headers: this.client.headers
                                });
                                data = await res.json();
                            }
                            
                            if (res.ok) {
                                resolve({ data, error: null });
                            } else {
                                resolve({ data: null, error: data });
                            }
                        } catch (error) {
                            reject({ data: null, error });
                        }
                    }
                    
                    upsert(data, opts) {
                        this._pendingType = 'upsert';
                        this._pendingUpsert = { data, opts };
                        return this;
                    }
                    
                    update(data) {
                        this._pendingType = 'update';
                        this._pendingUpdate = data;
                        return this;
                    }
                    
                    insert(data) {
                        this._pendingType = 'insert';
                        this._pendingInsert = data;
                        return this;
                    }
                    
                    delete() {
                        this._pendingType = 'delete';
                        return this;
                    }
                }

                window.supabase = { createClient: (url, key) => new SupabaseShim(url, key) };
                console.log('[Shim] Created SupabaseShim with CRUD methods');
            } else {
                console.log('[Init] ? Supabase library loaded from CDN');
            }
            
            // Create global Supabase client
            try {
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                // DAL expects window.supabase to be the client instance
                window.supabase = window.supabaseClient;
                console.log('[Init] ? Global supabaseClient created and assigned to window.supabase');
            } catch (error) {
                console.error('[Init] ? Failed to create Supabase client:', error);
            }
        })();
    </script>
    <script src="config.js"></script>
    <script src="data-access-layer.js"></script>
    
    <!-- Patient auth (for patientAdmins support when served over http/https) -->
    <script src="auth.js"></script>
    <script>
        // Expose PatientAuth on window for AdminAuth delegation (in case auth.js didn't attach it)
        console.info('[Shim] Checking PatientAuth. typeof PatientAuth:', typeof PatientAuth, 'window.PatientAuth:', !!window.PatientAuth);
        try {
            if (typeof PatientAuth !== 'undefined' && !window.PatientAuth) {
                window.PatientAuth = PatientAuth;
                console.info('[Shim] window.PatientAuth was assigned from global lexical binding');
            } else if (!window.PatientAuth) {
                console.warn('[Shim] PatientAuth not available in global scope, creating emergency shim');
                // Emergency shim for patientAdmins login when auth.js doesn't expose PatientAuth to window
                window.PatientAuth = {
                    async hashPassword(password) {
                        if (window.crypto && crypto.subtle) {
                            const encoder = new TextEncoder();
                            const data = encoder.encode(password);
                            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        }
                        throw new Error('Web Crypto API not available');
                    },
                    async loadPatientIndex() {
                        // ? SUPABASE: DAL üzerinden hasta listesi çek
                        console.log('?? [PatientAuth] Supabase\'den hasta listesi çekiliyor...');
                        const patients = await window.DAL.getPatientList();
                        return { patients: patients || [] };
                    },
                    async loadPatientDetails(patientId) {
                        // ? SUPABASE: DAL üzerinden hasta detayý çek
                        console.log('?? [PatientAuth] Supabase\'den hasta detayý çekiliyor:', patientId);
                        const patient = await window.DAL.getPatient(patientId);
                        if (!patient) throw new Error('Patient details not found');
                        return patient;
                    },
                    async login(username, password, rememberMe = false) {
                        try {
                            console.log('?? [PatientAuth] Supabase login baþlýyor:', username);
                            const index = await this.loadPatientIndex();
                            const norm = (v) => (v || '').toString().trim().toLowerCase();
                            const patient = index.patients.find(p => norm(p.username) === norm(username));
                            if (!patient) {
                                console.warn('? [PatientAuth] Kullanýcý bulunamadý:', username);
                                return { success: false, error: 'Kullanýcý adý veya þifre hatalý' };
                            }
                            if (patient.status === 'archived') {
                                console.warn('?? [PatientAuth] Arþivlenmiþ hesap:', username);
                                return { success: false, error: 'Bu hesap arþivlenmiþtir' };
                            }
                            
                            const inputHash = await this.hashPassword(password);
                            let effectiveHash = patient.passwordHash || '';
                            
                            try {
                                const details = await this.loadPatientDetails(patient.id);
                                const detailsHash = details?.passwordHash || details?.personalInfo?.passwordHash;
                                if (detailsHash && typeof detailsHash === 'string') {
                                    effectiveHash = detailsHash;
                                }
                            } catch (e) {
                                console.warn('[PatientAuth] Supabase\'den detay alýnamadý, index hash kullanýlýyor');
                            }
                            
                            if (inputHash !== effectiveHash) {
                                console.warn('? [PatientAuth] Þifre hatalý');
                                return { success: false, error: 'Kullanýcý adý veya þifre hatalý' };
                            }
                            
                            console.log('? [PatientAuth] Supabase login baþarýlý:', username);
                            return { success: true, patient: { username: patient.username, patientId: patient.id } };
                        } catch (error) {
                            console.error('? [PatientAuth] Supabase login hatasý:', error);
                            return { success: false, error: 'Giriþ sýrasýnda bir hata oluþtu' };
                        }
                    }
                };
                console.info('[Shim] Emergency PatientAuth created on window');
            }
        } catch(e) { 
            console.error('[Shim] Error:', e); 
        }
        console.info('[Shim] Final check - window.PatientAuth:', !!window.PatientAuth);
    </script>
    <!-- Page init moved to end of body -->
    <!-- Define page functions in head so they're available immediately -->
    <script>
        function addLogoutButton(){
            try {
                const header = document.querySelector('.settings-header');
                if (!header || document.getElementById('adminLogoutBtn')) return;
                const btn = document.createElement('button');
                btn.id = 'adminLogoutBtn';
                btn.textContent = '?? Çýkýþ';
                btn.style.cssText = 'margin-left:auto; align-self:flex-end; padding:8px 12px; border:none; border-radius:9px; background:linear-gradient(135deg,#ef4444 0%, #dc2626 100%); color:#fff; font-weight:700; cursor:pointer;';
                btn.onclick = () => { if (window.AdminAuth) { AdminAuth.clearSession(); location.reload(); } };
                header.appendChild(btn);
            } catch(e) { console.error('addLogoutButton error:', e); }
        }
        window.addLogoutButton = addLogoutButton;

        function init() {
            if (typeof registerInputHandlers === 'function') registerInputHandlers();
            if (typeof attachActionHandlers === 'function') attachActionHandlers();
            if (typeof fetchSuggestions === 'function') fetchSuggestions();
            if (typeof loadSettings === 'function') loadSettings();
            // Admins UI
            if (typeof loadAdminsRuntime === 'function') loadAdminsRuntime();
            if (typeof renderAdminsList === 'function') renderAdminsList();
            if (typeof renderPatientAdmins === 'function') renderPatientAdmins();
            if (typeof attachAdminsUIHandlers === 'function') attachAdminsUIHandlers();
            // GitHub admin functions removed - using Supabase only
            if (typeof renderActiveAdmin === 'function') renderActiveAdmin();
        }
        window.init = init;
        
        console.info('[Head] Functions defined. addLogoutButton:', typeof addLogoutButton, 'init:', typeof init);
    </script>
    <!-- Admin auth gate (hard cache-busting, load after GH_ADMINS scripts) -->
    <script src="admin_auth.js"></script>
</head>
<body>
    <div class="settings-wrapper">
        <header class="settings-header">
            <div>
                <h1>Yönetici Ayarlarý</h1>
                <p>Bu panelden sistem ayarlarýný düzenleyebilirsiniz. Tüm ayarlar Supabase veritabanýna kaydedilir.</p>
            </div>
            
            <!-- Admin Navigasyon Butonlarý -->
            <div class="admin-nav-buttons">
                <a href="admin_settings.html" class="admin-nav-btn active">
                    ?? Ayarlar
                </a>
                <a href="admin_patients.html" class="admin-nav-btn">
                    ?? Hasta Listesi
                </a>
                <a href="admin_chat.html" class="admin-nav-btn">
                    ?? Sohbet Yönetimi
                </a>
            </div>
            
            <div class="info-banner">
                Tüm ayarlar <strong>Supabase veritabanýna</strong> kaydedilir ve anýnda aktif olur. Deðiþiklikler tüm kullanýcýlar için geçerli olacaktýr.
            </div>
        </header>

        <main class="settings-body">
            <section class="settings-section">
                <h2>Aktif Admin</h2>
                <div class="settings-row">
                    <span id="activeAdminBadge" style="display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:700;font-size:13px;">—</span>
                    <span class="suggestion-hint">Bu oturumla iþlem yapýyorsunuz.</span>
                </div>
                <div class="settings-row">
                    <button type="button" class="btn-secondary" id="forceReloginBtn">Yeniden Giriþ Ýste</button>
                </div>
            </section>
            <section class="settings-section">
                <h2>Genel</h2>
                <div class="settings-row">
                    <label for="defaultAlternativeCountInput">Varsayýlan alternatif sayýsý</label>
                    <input type="number" id="defaultAlternativeCountInput" min="1" max="10">
                </div>
                <div class="settings-row checkbox-row">
                    <label for="enableTagFilterInput">
                        <input type="checkbox" id="enableTagFilterInput"> Tag filtrelemesini aktifleþtir
                    </label>
                </div>
                <div class="settings-row">
                    <label for="calorieToleranceInput">
                        Kalori toleransý (%)
                        <span style="color: #666; font-size: 12px; display: block;">Þablon filtrelemede ±% sapma oraný (örn: 5 = ±%5)</span>
                    </label>
                    <input type="number" id="calorieToleranceInput" min="0" max="50" step="1" value="5">
                </div>
                <div class="settings-row">
                    <label for="templateReuseWeeksInput">
                        Þablon tekrar kullaným süresi (hafta)
                        <span style="color: #666; font-size: 12px; display: block;">Bir þablon kaç hafta sonra tekrar kullanýlabilir (örn: 4 = 4 hafta sonra)</span>
                    </label>
                    <input type="number" id="templateReuseWeeksInput" min="1" max="12" step="1" value="4">
                </div>
            </section>

            <!-- Diyet Formülleri Bölümü -->
            <section class="settings-section">
                <h2>?? Diyet Formülleri ve Makro Hesaplama</h2>
                
                <div style="margin-bottom: 20px; padding: 12px; background: #e0e7ff; border-radius: 8px;">
                    <strong>?? Formül Yapýsý:</strong><br>
                    • Karbonhidrat = Kilo × Çarpan (gram)<br>
                    • Protein = Kilo × Çarpan (gram)<br>
                    • Yað = Kilo × Çarpan (gram)<br>
                    • Kalori = (Karb×4) + (Protein×4) + (Yað×9)<br>
                    • Final Kalori = Kalori × Aktivite Çarpaný
                </div>

                <!-- Ketojenik Diyet -->
                <div style="border: 2px solid #4ade80; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #15803d;">Ketojenik Diyet</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>Karbonhidrat Çarpaný</label>
                            <input type="number" id="ketoCarb" step="0.1" min="0" value="0.3">
                        </div>
                        <div class="settings-row">
                            <label>Protein Çarpaný</label>
                            <input type="number" id="ketoProtein" step="0.1" min="0" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>Yað Çarpaný</label>
                            <input type="number" id="ketoFat" step="0.1" min="0" value="1.2">
                        </div>
                    </div>
                </div>

                <!-- Lowcarb Diyet -->
                <div style="border: 2px solid #60a5fa; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #1e40af;">Lowcarb Diyet</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>Karbonhidrat Çarpaný</label>
                            <input type="number" id="lowcarbCarb" step="0.1" min="0" value="0.6">
                        </div>
                        <div class="settings-row">
                            <label>Protein Çarpaný</label>
                            <input type="number" id="lowcarbProtein" step="0.1" min="0" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>Yað Çarpaný</label>
                            <input type="number" id="lowcarbFat" step="0.1" min="0" value="1.0">
                        </div>
                    </div>
                </div>

                <!-- Akdeniz Diyeti -->
                <div style="border: 2px solid #14b8a6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #0f766e;">Akdeniz Diyeti</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>Karbonhidrat Çarpaný</label>
                            <input type="number" id="akdenizCarb" step="0.1" min="0" value="0.6">
                        </div>
                        <div class="settings-row">
                            <label>Protein Çarpaný</label>
                            <input type="number" id="akdenizProtein" step="0.1" min="0" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>Yað Çarpaný</label>
                            <input type="number" id="akdenizFat" step="0.1" min="0" value="1.0">
                        </div>
                    </div>
                </div>

                <!-- Aktivite Çarpanlarý -->
                <div style="border: 2px solid #f59e0b; border-radius: 12px; padding: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #92400e;">Aktivite Seviyesi Çarpanlarý</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>1 - Hareketsiz</label>
                            <input type="number" id="activity1" step="0.1" min="0" max="2" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>2 - Az Aktif</label>
                            <input type="number" id="activity2" step="0.1" min="0" max="2" value="0.9">
                        </div>
                        <div class="settings-row">
                            <label>3 - Orta Aktif</label>
                            <input type="number" id="activity3" step="0.1" min="0" max="2" value="1.0">
                        </div>
                        <div class="settings-row">
                            <label>4 - Çok Aktif</label>
                            <input type="number" id="activity4" step="0.1" min="0" max="2" value="1.1">
                        </div>
                        <div class="settings-row">
                            <label>5 - Süper Aktif</label>
                            <input type="number" id="activity5" step="0.1" min="0" max="2" value="1.2">
                        </div>
                    </div>
                </div>
            </section>

            <section class="settings-section">
                <h2>Tag Ýstisnalarý</h2>
                <div class="settings-row">
                    <label for="tagExclusionInput">Yeni istisna tagý ekle</label>
                    <input type="text" id="tagExclusionInput" placeholder="Örn: mevsim" autocomplete="off">
                    <span class="suggestion-hint">Enter veya odak dýþýnda býrakmak listedeki yeni tag'ý ekler.</span>
                </div>
                <div class="settings-chip-list" id="tagExclusionList"></div>
            </section>

            <section class="settings-section">
                <h2>Yöneticiler (admins.js)</h2>
                <div class="settings-row">
                    <div id="adminsList"></div>
                </div>
                <div class="settings-row">
                    <details>
                        <summary>Yeni / Düzenle</summary>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px;">
                            <div>
                                <label>Kullanýcý Adý</label>
                                <input type="text" id="adminEditUsername" placeholder="admin"/>
                            </div>
                            <div>
                                <label>Yeni Þifre (opsiyonel)</label>
                                <input type="password" id="adminEditPassword" placeholder="Yeni þifre (boþsa deðiþmez)"/>
                            </div>
                            <div>
                                <label>Roller</label>
                                <input type="text" id="adminEditRoles" placeholder="virgülle: admin,editor"/>
                            </div>
                        </div>
                        <div style="margin-top:10px;display:flex;gap:8px;">
                            <button type="button" class="btn-primary" id="adminSaveBtn">Kaydet / Güncelle</button>
                            <button type="button" class="btn-secondary" id="adminClearBtn">Temizle</button>
                        </div>
                    </details>
                </div>
                <div class="settings-row">
                    <label>Hasta bazlý admin yetkisi (patientAdmins)</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <input type="text" id="patientAdminInput" placeholder="hastaKullaniciAdi" style="max-width:260px;"/>
                        <button type="button" class="btn-secondary" id="patientAdminAddBtn">Ekle</button>
                    </div>
                    <div class="settings-chip-list" id="patientAdminsList"></div>
                </div>
                <div class="settings-row">
                    <button type="button" class="btn-primary" id="saveAdminsFileBtn">Admins Dosyasýný Kaydet</button>
                </div>
            </section>

            <section class="settings-section">
                <h2>Muaf Rol ve Kategoriler</h2>
                <div class="settings-row">
                    <label for="roleExclusionInput">Rol istisnasý ekle</label>
                    <input type="text" id="roleExclusionInput" placeholder="Örn: Diyetisyen" list="rolesDatalist" autocomplete="off">
                    <datalist id="rolesDatalist"></datalist>
                </div>
                <div class="settings-chip-list" id="roleExclusionList"></div>

                <div class="settings-row">
                    <label for="categoryExclusionInput">Kategori istisnasý ekle</label>
                    <input type="text" id="categoryExclusionInput" placeholder="Örn: Atýþtýrmalýk" list="categoriesDatalist" autocomplete="off">
                    <datalist id="categoriesDatalist"></datalist>
                </div>
                <div class="settings-chip-list" id="categoryExclusionList"></div>

                <details id="suggestionsPanel" hidden>
                    <summary>?? Önerilen rol/kategori listesi</summary>
                    <div class="suggestions-grid" id="roleSuggestions"></div>
                    <div class="suggestions-grid" id="categorySuggestions"></div>
                </details>
            </section>

            <section class="settings-section">
                <h2>Rotasyon</h2>
                <div class="settings-row checkbox-row">
                    <label for="rotationEnabledInput">
                        <input type="checkbox" id="rotationEnabledInput"> Rotasyonu aktifleþtir
                    </label>
                </div>
                <div class="settings-row">
                    <label for="rotationChunkSizeInput">Günlük alternatif sayýsý</label>
                    <input type="number" id="rotationChunkSizeInput" min="1" max="10">
                </div>
                <div class="settings-row">
                    <label for="rotationResetDayInput">Rotasyon sýfýrlama günü (0 = Pazartesi)</label>
                    <input type="number" id="rotationResetDayInput" min="0" max="6" placeholder="Boþ býrakýlýrsa ISO haftasý baz alýnýr">
                </div>
            </section>

            <section class="settings-section">
                <h2>?? Filtreleme Kriterleri</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Kullanýcý panelinde hangi filtreleme kriterlerinin gösterileceðini ve zorunlu/opsiyonel olduðunu ayarlayýn.
                </p>
                
                <div class="criteria-grid">
                    <!-- Role (Yemek Türü) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaRoleVisible" checked>
                                <span class="criteria-label">????? Yemek Türü (Role)</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaRoleMode" style="font-size: 12px; color: #64748b;">Kullanýcý için:</label>
                            <select id="criteriaRoleMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (Kullanýcý açýp kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaRoleDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa açýldýðýnda:</label>
                            <select id="criteriaRoleDefault" class="criteria-select">
                                <option value="active" selected>Aktif (Filtre açýk)</option>
                                <option value="inactive">Pasif (Filtre kapalý)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Diet Type (Diyet Türü) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaDietTypeVisible" checked>
                                <span class="criteria-label">?? Diyet Türü</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaDietTypeMode" style="font-size: 12px; color: #64748b;">Kullanýcý için:</label>
                            <select id="criteriaDietTypeMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (Kullanýcý açýp kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaDietTypeDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa açýldýðýnda:</label>
                            <select id="criteriaDietTypeDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre açýk)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalý)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Category (Kategori) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaCategoryVisible">
                                <span class="criteria-label">?? Kategori</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaCategoryMode" style="font-size: 12px; color: #64748b;">Kullanýcý için:</label>
                            <select id="criteriaCategoryMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (Kullanýcý açýp kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaCategoryDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa açýldýðýnda:</label>
                            <select id="criteriaCategoryDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre açýk)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalý)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Season (Sezon) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaSeasonVisible">
                                <span class="criteria-label">??? Sezon</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaSeasonMode" style="font-size: 12px; color: #64748b;">Kullanýcý için:</label>
                            <select id="criteriaSeasonMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (Kullanýcý açýp kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaSeasonDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa açýldýðýnda:</label>
                            <select id="criteriaSeasonDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre açýk)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalý)</option>
                            </select>
                        </div>
                    </div>

                    <!-- MealType (Öðün) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaMealTypeVisible">
                                <span class="criteria-label">??? Öðün</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaMealTypeMode" style="font-size: 12px; color: #64748b;">Kullanýcý için:</label>
                            <select id="criteriaMealTypeMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (Kullanýcý açýp kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaMealTypeDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa açýldýðýnda:</label>
                            <select id="criteriaMealTypeDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre açýk)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalý)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>?? Ýpucu:</strong> 
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li><strong>Opsiyonel:</strong> Kullanýcý panelinde rozet gösterilir, kullanýcý týklayarak aktif/pasif edebilir.</li>
                        <li><strong>Zorunlu:</strong> Filtreleme her zaman aktiftir, kullanýcý deðiþtiremez (rozet gizlidir).</li>
                        <li><strong>Sayfa açýldýðýnda:</strong> Ýlk açýlýþta filtrenin aktif mi pasif mi olacaðýný belirler (sadece opsiyoneller için geçerli).</li>
                        <li>Checkbox iþaretsizse kriter tamamen gizlenir ve kullanýlmaz.</li>
                    </ul>
                </div>
            </section>

            <section class="settings-section">
                <h2>?? Benzerlik Skoru Kriterleri</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Alternatif yemek benzerliði hesaplanýrken hangi makrolarýn dikkate alýnacaðýný belirleyin. 
                    Seçili kriterler kullanýlarak benzerlik skoru hesaplanýr.
                </p>
                
                <div class="criteria-grid">
                    <!-- Kalori -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaCalories">
                            <span class="criteria-label">?? Kalori</span>
                        </label>
                    </div>

                    <!-- Protein -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaProtein" checked>
                            <span class="criteria-label">?? Protein</span>
                        </label>
                    </div>

                    <!-- Karbonhidrat -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaCarbs">
                            <span class="criteria-label">?? Karbonhidrat</span>
                        </label>
                    </div>

                    <!-- Yað -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaFat" checked>
                            <span class="criteria-label">?? Yað</span>
                        </label>
                    </div>
                </div>
            </section>

            <section class="settings-section">
                <h2>?? Benzerlik Hesaplama Modu</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Alternatif yemek benzerliði nasýl hesaplansýn? Basit mod sadece kalori aðýrlýðýna bakar, 
                    Geliþmiþ mod hem kalori hem de oransal farký dikkate alýr.
                </p>
                
                <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                    <!-- Basit Mod -->
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="scoringMode" value="simple" id="scoringModeSimple" 
                               style="margin-right: 8px;" checked>
                        <div style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; transition: all 0.2s;">
                            <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #1e293b;">?? Basit Mod</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0;">
                                Makro farklarý kalori eþdeðeriyle hesaplanýr.<br>
                                <strong>Protein/Karb:</strong> ×4 kcal/g<br>
                                <strong>Yað:</strong> ×9 kcal/g
                            </p>
                        </div>
                    </label>
                    
                    <!-- Geliþmiþ Mod -->
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="scoringMode" value="advanced" id="scoringModeAdvanced" 
                               style="margin-right: 8px;">
                        <div style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; transition: all 0.2s;">
                            <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #1e293b;">?? Geliþmiþ Mod</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0;">
                                Hem kalori hem oran bazlý hesaplama.<br>
                                <strong>Örnek:</strong> 20g'dan 3g ? 40g'dan 3g<br>
                                <strong>Daha hassas</strong> skorlama
                            </p>
                        </div>
                    </label>
                </div>
                
                <!-- Sensitivity Slider (sadece Geliþmiþ Mod için) -->
                <div id="sensitivityContainer" style="display: none; margin-top: 20px; padding: 16px; background: rgba(99, 102, 241, 0.05); border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #4338ca;">
                        ??? Hassasiyet Ayarý (Geliþmiþ Mod)
                    </label>
                    <p style="font-size: 12px; color: #64748b; margin: 0 0 12px 0;">
                        Skorlama ne kadar hassas olsun? Düþük deðer = daha sert puanlama, Yüksek deðer = daha yumuþak puanlama.
                    </p>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span style="font-size: 12px; color: #64748b; min-width: 80px;">Sert (5)</span>
                        <input type="range" id="sensitivityDivider" min="5" max="20" step="1" value="10" 
                               style="flex: 1; height: 6px; border-radius: 5px; outline: none; 
                                      background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);">
                        <span style="font-size: 12px; color: #64748b; min-width: 80px;">Yumuþak (20)</span>
                    </div>
                    <div style="margin-top: 12px; text-align: center;">
                        <span style="font-size: 14px; font-weight: 600; color: #4338ca;">
                            Mevcut Deðer: <span id="sensitivityValue">10</span>
                        </span>
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; font-size: 11px; color: #475569;">
                        <strong>Örnek Etki (Protein 20g › 17g, %15 fark):</strong><br>
                        Deðer 5: Skor ~88% | Deðer 10: Skor ~94% | Deðer 20: Skor ~97%
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>?? Ýpucu:</strong><br>
                    <strong>Basit Mod:</strong> Her makronun kalori deðeri baz alýnýr. Protein ve karb ×4 kcal/g, Yað ×9 kcal/g ile aðýrlýklandýrýlýr.<br>
                    <strong>Geliþmiþ Mod:</strong> Ayný gram farký bile oransal olarak deðerlendirilir. 20g'dan 3g eksik (%15) ile 40g'dan 3g eksik (%7.5) farklý skorlar alýr.
                </div>
            </section>

            <section class="settings-section">
                <h2>??? Rozet Gösterimi</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Hasta panelindeki yemek satýrlarýnda hangi bilgi rozetlerinin gösterileceðini seçin.
                </p>
                
                <div class="criteria-grid">
                    <!-- Role Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeRoleVisible" checked>
                            <span class="criteria-label">????? Rol Rozeti (Ana yemek, Ekmek, vb.)</span>
                        </label>
                    </div>

                    <!-- DietType Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeDietTypeVisible" checked>
                            <span class="criteria-label">?? Diyet Tipi Rozeti (Keto, Lowcarb)</span>
                        </label>
                    </div>

                    <!-- Category Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeCategoryVisible">
                            <span class="criteria-label">?? Kategori Rozeti (ÖÐLEN, AKÞAM, vb.)</span>
                        </label>
                    </div>

                    <!-- Season Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeSeasonVisible">
                            <span class="criteria-label">?? Mevsim Rozeti</span>
                        </label>
                    </div>

                    <!-- MealType Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeMealTypeVisible">
                            <span class="criteria-label">??? Öðün Tipi Rozeti (Sabah, Öðle, Akþam)</span>
                        </label>
                    </div>

                    <!-- Tags Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeTagsVisible">
                            <span class="criteria-label">??? Tag Rozeti (tavuk, yumurta, vb.)</span>
                        </label>
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>?? Ýpucu:</strong> 
                    Seçilen rozetler hasta panelindeki yemek satýrlarýnda görünür. Çok fazla rozet ekraný karmaþýklaþtýrabilir.
                </div>
            </section>
            
            <!-- Özellik Görünürlüðü Ayarlarý -->
            <section class="settings-section">
                <h2 class="section-title">??? Özellik Görünürlüðü</h2>
                <p class="section-description">Hasta panelindeki buton ve özelliklerin görünürlüðünü yönetin</p>
                
                <div class="criteria-grid">
                    <!-- PDF Export Butonu -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="pdfExportVisible" checked>
                            <span class="criteria-label">?? PDF Ýndir Butonu</span>
                        </label>
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>?? Ýpucu:</strong> 
                    PDF butonu haftalýk beslenme planýný indirmek için kullanýlýr. Varsayýlan olarak açýktýr.
                </div>
            </section>

            <section class="settings-section">
                <h2>?? Þablon Yükleme</h2>
                <div class="settings-row">
                    <label for="templateFileInput">Gün Þablonlarý JSON Dosyasý (Çoklu seçim yapabilirsiniz)</label>
                    <input type="file" id="templateFileInput" accept=".json" multiple style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 13px;">
                </div>
                <div class="settings-row">
                    <button class="btn-primary" id="uploadTemplatesButton" type="button" style="width: fit-content;">?? Þablonlarý Yükle ve Birleþtir</button>
                </div>
                <div class="settings-row">
                    <p style="font-size: 12px; color: #64748b; margin: 0;">
                        <strong>Not:</strong> Yüklenen þablonlar mevcut þablonlarla birleþtirilecek. Ayný ID'ye sahip þablonlar atlanacak, yeni þablonlar eklenecek. Türkçe karakterler korunacak.
                    </p>
                </div>
            </section>

            <!-- GitHub Token Section - Kaldýrýldý, Supabase kullanýlýyor -->
        </main>

        <footer class="actions-row">
            <p class="status-text" id="statusText"><strong>Hazýr.</strong></p>
            <div class="actions-right">
                <button class="btn-secondary" id="reloadButton" type="button">Ayarlarý Yükle</button>
                <button class="btn-primary" id="saveSettingsButton" type="button">Kaydet</button>
            </div>
        </footer>
    </div>

    <script>
        // GitHub constants removed - using Supabase only

        const defaultSettings = {
            version: 1,
            updatedAt: new Date().toISOString(),
            defaultAlternativeCount: 3,
            enableTagFilter: true,
            calorieTolerancePercent: 5,
            templateReuseWeeks: 4,
            tagExclusions: [],
            tagExemptions: {
                roles: [],
                categories: []
            },
            rotation: {
                enabled: true,
                chunkSize: 3
            },
            filterCriteria: {
                role: {
                    visible: true,
                    mode: 'optional',
                    defaultState: 'active'
                },
                dietType: {
                    visible: true,
                    mode: 'optional',
                    defaultState: 'inactive'
                },
                category: {
                    visible: false,
                    mode: 'optional',
                    defaultState: 'inactive'
                },
                season: {
                    visible: false,
                    mode: 'optional',
                    defaultState: 'inactive'
                },
                mealType: {
                    visible: false,
                    mode: 'optional',
                    defaultState: 'inactive'
                }
            },
            badgeVisibility: {
                role: false,
                dietType: false,
                category: false,
                season: false,
                mealType: false,
                tags: false
            },
            featureVisibility: {
                pdfExportButton: true
            },
            scoreCriteria: {
                activeByDefault: ['protein', 'fat']
            },
            dietFormulas: {
                ketojenik: {
                    carb: 0.3,
                    protein: 0.8,
                    fat: 1.2
                },
                lowcarb: {
                    carb: 0.6,
                    protein: 0.8,
                    fat: 1.0
                },
                akdeniz: {
                    carb: 0.6,
                    protein: 0.8,
                    fat: 1.0
                },
                activityMultipliers: {
                    1: 0.8,
                    2: 0.9,
                    3: 1.0,
                    4: 1.1,
                    5: 1.2
                }
            }
        };

        let appSettings = { ...defaultSettings };
        // settingsSha removed - not needed for Supabase
        let settingsDraft = null;
        let isSaving = false;
        let isLoading = false;
        let availableRoles = new Set();
        let availableCategories = new Set();

        const statusText = document.getElementById('statusText');
        const defaultAlternativeCountInput = document.getElementById('defaultAlternativeCountInput');
        const enableTagFilterInput = document.getElementById('enableTagFilterInput');
        const calorieToleranceInput = document.getElementById('calorieToleranceInput');
        const tagExclusionInput = document.getElementById('tagExclusionInput');
        const roleExclusionInput = document.getElementById('roleExclusionInput');
        const categoryExclusionInput = document.getElementById('categoryExclusionInput');
        const rotationEnabledInput = document.getElementById('rotationEnabledInput');
        
        // Diyet Formülü Input Elementleri
        const ketoCarb = document.getElementById('ketoCarb');
        const ketoProtein = document.getElementById('ketoProtein');
        const ketoFat = document.getElementById('ketoFat');
        const lowcarbCarb = document.getElementById('lowcarbCarb');
        const lowcarbProtein = document.getElementById('lowcarbProtein');
        const lowcarbFat = document.getElementById('lowcarbFat');
        const akdenizCarb = document.getElementById('akdenizCarb');
        const akdenizProtein = document.getElementById('akdenizProtein');
        const akdenizFat = document.getElementById('akdenizFat');
        const activity1 = document.getElementById('activity1');
        const activity2 = document.getElementById('activity2');
        const activity3 = document.getElementById('activity3');
        const activity4 = document.getElementById('activity4');
        const activity5 = document.getElementById('activity5');
        const rotationChunkSizeInput = document.getElementById('rotationChunkSizeInput');
        const rotationResetDayInput = document.getElementById('rotationResetDayInput');
        // GitHub inputs removed - using Supabase only
        const reloadButton = document.getElementById('reloadButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const tagExclusionList = document.getElementById('tagExclusionList');
        const roleExclusionList = document.getElementById('roleExclusionList');
        const categoryExclusionList = document.getElementById('categoryExclusionList');
        const rolesDatalist = document.getElementById('rolesDatalist');
        const categoriesDatalist = document.getElementById('categoriesDatalist');
        const suggestionsPanel = document.getElementById('suggestionsPanel');
        const roleSuggestions = document.getElementById('roleSuggestions');
        const categorySuggestions = document.getElementById('categorySuggestions');
        const templateFileInput = document.getElementById('templateFileInput');
        const uploadTemplatesButton = document.getElementById('uploadTemplatesButton');

    // Admins UI refs
    const adminsListDiv = document.getElementById('adminsList');
    const adminEditUsername = document.getElementById('adminEditUsername');
    const adminEditPassword = document.getElementById('adminEditPassword');
    const adminEditRoles = document.getElementById('adminEditRoles');
    const adminSaveBtn = document.getElementById('adminSaveBtn');
    const adminClearBtn = document.getElementById('adminClearBtn');
    const patientAdminInput = document.getElementById('patientAdminInput');
    const patientAdminAddBtn = document.getElementById('patientAdminAddBtn');
    const patientAdminsList = document.getElementById('patientAdminsList');
    const saveAdminsFileBtn = document.getElementById('saveAdminsFileBtn');
    const forceReloginBtn = document.getElementById('forceReloginBtn');

        // Filtreleme Kriterleri Input Referanslarý
        const criteriaRoleVisible = document.getElementById('criteriaRoleVisible');
        const criteriaRoleMode = document.getElementById('criteriaRoleMode');
        const criteriaRoleDefault = document.getElementById('criteriaRoleDefault');
        const criteriaDietTypeVisible = document.getElementById('criteriaDietTypeVisible');
        const criteriaDietTypeMode = document.getElementById('criteriaDietTypeMode');
        const criteriaDietTypeDefault = document.getElementById('criteriaDietTypeDefault');
        const criteriaCategoryVisible = document.getElementById('criteriaCategoryVisible');
        const criteriaCategoryMode = document.getElementById('criteriaCategoryMode');
        const criteriaCategoryDefault = document.getElementById('criteriaCategoryDefault');
        const criteriaSeasonVisible = document.getElementById('criteriaSeasonVisible');
        const criteriaSeasonMode = document.getElementById('criteriaSeasonMode');
        const criteriaSeasonDefault = document.getElementById('criteriaSeasonDefault');
        const criteriaMealTypeVisible = document.getElementById('criteriaMealTypeVisible');
        const criteriaMealTypeMode = document.getElementById('criteriaMealTypeMode');
        const criteriaMealTypeDefault = document.getElementById('criteriaMealTypeDefault');

        // Benzerlik Skoru Kriterleri Input Referanslarý
        const scoreCriteriaCalories = document.getElementById('scoreCriteriaCalories');
        const scoreCriteriaProtein = document.getElementById('scoreCriteriaProtein');
        const scoreCriteriaCarbs = document.getElementById('scoreCriteriaCarbs');
        const scoreCriteriaFat = document.getElementById('scoreCriteriaFat');

        function fixTurkishChars(text) {
            if (!text || typeof text !== 'string') return text;
            let fixed = text;
            for (let i = 0; i < 2; i++) {
                try {
                    const decoded = decodeURIComponent(escape(fixed));
                    if (decoded === fixed) break;
                    fixed = decoded;
                } catch (error) {
                    break;
                }
            }

            const charMap = {
                'Ä±': 'ý', 'ä±': 'ý', 'Ã?': 'Ç', 'Ã§': 'ç', 'ã‡': 'Ç', 'ã§': 'ç', 'ÅŸ': 'þ', 'åŸ': 'þ',
                'Åz': 'Þ', 'åz': 'Þ', 'Ä°': 'Ý', 'ä°': 'Ý', 'Ã¶': 'ö', 'ã¶': 'ö', 'Ã–': 'Ö', 'ã–': 'Ö',
                'Ã¼': 'ü', 'ã¼': 'ü', 'Ãœ': 'Ü', 'ãœ': 'Ü', 'ÄŸ': 'ð', 'äŸ': 'ð', 'Äz': 'Ð', 'äz': 'Ð',
                'Ã?Â±': 'ý', 'Ã?Â°': 'Ý', 'Ã?Â?': 'ð', 'Ã?Âž': 'Ð', 'Ã?ÂŸ': 'þ', 'Ã?Âž': 'Þ', 'Ã?Â§': 'ç',
                'Ã?Â?': 'Ç', 'Ã?Â¶': 'ö', 'Ã?Â?': 'Ö', 'Ã?Â¼': 'ü', 'Ã?Â?': 'Ü', 'Ã?Â½': 'ý', 'Ã?Â': 'Ý',
                'Ã?Â±': 'ñ', 'Ã?Â?': 'ß', 'Ã?Â¿': 'ÿ', 'Ã?': '', '×': '', 'Â': ' '
            };

            let previous;
            do {
                previous = fixed;
                for (const [wrong, correct] of Object.entries(charMap)) {
                    fixed = fixed.replace(new RegExp(wrong, 'g'), correct);
                }
            } while (fixed !== previous);

            return fixed;
        }

        function normalizeText(str) {
            if (!str) return '';
            const cleaned = fixTurkishChars(str);
            return cleaned
                .toLowerCase()
                .replace(/ç/g, 'c')
                .replace(/ð/g, 'g')
                .replace(/ý/g, 'i')
                .replace(/i·/g, 'i')
                .replace(/ö/g, 'o')
                .replace(/þ/g, 's')
                .replace(/ü/g, 'u')
                .replace(/[^a-z0-9]/g, '');
        }

        function sanitizeString(value) {
            if (typeof value !== 'string') return '';
            return fixTurkishChars(value).trim();
        }

        function sanitizeStringList(values) {
            if (!Array.isArray(values)) return [];
            const unique = new Set();
            const result = [];
            values.forEach(item => {
                const cleaned = sanitizeString(item);
                const normalized = normalizeText(cleaned);
                if (!cleaned || !normalized || unique.has(normalized)) return;
                unique.add(normalized);
                result.push(cleaned);
            });
            return result;
        }

        function showStatus(message, tone = 'info') {
            const palette = {
                success: '#059669',
                error: '#dc2626',
                info: '#475569'
            };
            statusText.textContent = message;
            statusText.style.color = palette[tone] || palette.info;
        }
        // ---------- Admins helpers ----------
        function getActiveAdminName(){
            try { return (window.AdminAuth && AdminAuth.getSession && AdminAuth.getSession()) ? (AdminAuth.getSession().username) : ''; }
            catch(_) { return ''; }
        }
        function renderActiveAdmin(){
            const u = getActiveAdminName();
            const el = document.getElementById('activeAdminBadge');
            if (el) el.textContent = u ? `Admin: ${u}` : '—';
        }

        // ---------- Admins state ----------
        // ADMINS_PATH removed - using Supabase only
        let ghAdmins = { admins: [], patientAdmins: [] };
        // adminsSha removed - not needed for Supabase
        let editingAdminIndex = -1; // -1 => create, >=0 => edit

        function clone(obj){ return JSON.parse(JSON.stringify(obj || {})); }
        function toRolesArray(val){
            if (Array.isArray(val)) return val.map(v=>sanitizeString(v)).filter(Boolean);
            if (typeof val === 'string') return val.split(',').map(v=>sanitizeString(v)).filter(Boolean);
            return [];
        }
        function usernamesEqual(a,b){ return normalizeText(a) === normalizeText(b); }
        function findAdminIndexByUsername(username){
            const n = normalizeText(username);
            return (ghAdmins.admins||[]).findIndex(a => normalizeText(a.username) === n);
        }
        function ensureGhAdminsShape(){
            if (!ghAdmins || typeof ghAdmins !== 'object') ghAdmins = { admins: [], patientAdmins: [] };
            if (!Array.isArray(ghAdmins.admins)) ghAdmins.admins = [];
            if (!Array.isArray(ghAdmins.patientAdmins)) ghAdmins.patientAdmins = [];
        }
        function loadAdminsRuntime(){
            // Load from Supabase instead of window.GH_ADMINS
            loadAdmins().catch(() => {
                ghAdmins = { admins: [], patientAdmins: [] };
                ensureGhAdminsShape();
            });
        }
        // GitHub admin fetch functions removed - using Supabase only
        function renderAdminsList(){
            adminsListDiv.innerHTML = '';
            ensureGhAdminsShape();
            const list = ghAdmins.admins;
            if (!list.length){
                adminsListDiv.innerHTML = '<span class="empty-hint">Henüz yönetici yok.</span>';
                return;
            }
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="text-align:left;padding:6px;">Kullanýcý</th>
                        <th style="text-align:left;padding:6px;">Roller</th>
                        <th style="text-align:right;padding:6px;">Ýþlemler</th>
                    </tr>
                </thead>
                <tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            list.forEach((a, idx)=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:6px;border-top:1px solid #e5e7eb;">${a.username}</td>
                    <td style="padding:6px;border-top:1px solid #e5e7eb;">${(a.roles||[]).join(', ')}</td>
                    <td style="padding:6px;border-top:1px solid #e5e7eb;text-align:right;">
                        <button type="button" class="btn-secondary" data-action="edit">Düzenle</button>
                        <button type="button" class="btn-secondary" data-action="delete">Sil</button>
                    </td>`;
                tr.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
                    editAdminAt(idx);
                });
                tr.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
                    if (confirm(`${a.username} silinsin mi?`)){
                        ghAdmins.admins.splice(idx,1);
                        renderAdminsList();
                    }
                });
                tbody.appendChild(tr);
            });
            adminsListDiv.appendChild(table);
        }
        function renderPatientAdmins(){
            ensureGhAdminsShape();
            renderChipList(patientAdminsList, ghAdmins.patientAdmins, (value)=>{
                ghAdmins.patientAdmins = ghAdmins.patientAdmins.filter(v => normalizeText(v) !== normalizeText(value));
                renderPatientAdmins();
            });
        }
        function clearAdminForm(){
            editingAdminIndex = -1;
            adminEditUsername.value = '';
            adminEditPassword.value = '';
            adminEditRoles.value = '';
        }
        function editAdminAt(index){
            ensureGhAdminsShape();
            const a = ghAdmins.admins[index];
            if (!a) return;
            editingAdminIndex = index;
            adminEditUsername.value = a.username || '';
            adminEditPassword.value = '';
            adminEditRoles.value = (a.roles||[]).join(', ');
        }
        async function computeSha256Hex(val){
            if (!val) return '';
            try{
                if (window.AdminAuth && typeof AdminAuth.sha256Hex === 'function'){
                    return await AdminAuth.sha256Hex(val);
                }
            }catch(_){/* ignore */}
            if (window.crypto && crypto.subtle && window.TextEncoder){
                const enc = new TextEncoder();
                const buf = await crypto.subtle.digest('SHA-256', enc.encode(val));
                return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
            }
            throw new Error('Þifre karmasý için uygun bir yöntem bulunamadý. Lütfen AdminAuth skripti yüklü olsun.');
        }
        function upsertAdminFromForm(){
            ensureGhAdminsShape();
            const username = sanitizeString(adminEditUsername.value);
            const roles = toRolesArray(adminEditRoles.value);
            const newPassword = adminEditPassword.value;
            if (!username){ showStatus('Kullanýcý adý girin.', 'error'); return; }

            // Duplicate check (case/diacritics insensitive)
            const existingIdx = findAdminIndexByUsername(username);
            if (editingAdminIndex === -1 && existingIdx !== -1){
                showStatus('Bu kullanýcý zaten mevcut.', 'error');
                return;
            }
            if (editingAdminIndex >= 0){
                const otherIdx = existingIdx;
                if (otherIdx !== -1 && otherIdx !== editingAdminIndex){
                    showStatus('Bu kullanýcý adý baþka bir kayýtta var.', 'error');
                    return;
                }
            }

            const apply = async ()=>{
                if (editingAdminIndex === -1){
                    const admin = { username, roles };
                    if (newPassword){ admin.passwordHash = await computeSha256Hex(newPassword); }
                    else { showStatus('Yeni admin için þifre girilmeli.', 'error'); return; }
                    ghAdmins.admins.push(admin);
                } else {
                    const target = ghAdmins.admins[editingAdminIndex];
                    target.username = username;
                    target.roles = roles;
                    if (newPassword){ target.passwordHash = await computeSha256Hex(newPassword); }
                }
                clearAdminForm();
                renderAdminsList();
                showStatus('Admin kaydý hazýrlandý (henüz kaydetmediniz).', 'success');
            };
            apply().catch(err=> showStatus(err.message || 'Ýþlem baþarýsýz.', 'error'));
        }
        function addPatientAdmin(){
            ensureGhAdminsShape();
            const val = sanitizeString(patientAdminInput.value);
            if (!val) return;
            const exists = ghAdmins.patientAdmins.some(v => normalizeText(v) === normalizeText(val));
            if (!exists){ ghAdmins.patientAdmins.push(val); renderPatientAdmins(); showStatus('Hasta admin eklendi (henüz kaydetmediniz).', 'success'); }
            patientAdminInput.value = '';
        }
        // reloadRemoteAdminsConfig removed - using Supabase only
        // ensureAdminsSha removed - not needed for Supabase
        async function saveAdmins(){
            ensureGhAdminsShape();
            
            try{
                saveAdminsFileBtn.disabled = true;
                saveAdminsFileBtn.textContent = 'Kaydediliyor...';
                showStatus('Adminler Supabase\'e kaydediliyor...', 'info');
                
                // ?? Save all admins to Supabase
                let savedAdmins = 0;
                for (const admin of ghAdmins.admins) {
                    const success = await DAL.saveAdmin({
                        username: admin.username,
                        password_hash: admin.password,
                        roles: admin.roles || ['admin'],
                        is_active: true
                    });
                    if (success) savedAdmins++;
                }
                
                // ?? Save all patient admins to Supabase
                let savedPatientAdmins = 0;
                for (const patientUsername of ghAdmins.patientAdmins) {
                    const success = await DAL.savePatientAdmin(patientUsername);
                    if (success) savedPatientAdmins++;
                }
                
                showStatus(`? ${savedAdmins} admin ve ${savedPatientAdmins} hasta admin kaydedildi.`, 'success');
                
                // Reload admin list from Supabase
                await loadAdmins();
                renderAdminsList();
                renderPatientAdmins();
                
            }catch(err){
                showStatus(err.message || 'Adminler kaydedilemedi.', 'error');
            } finally {
                saveAdminsFileBtn.disabled = false;
                saveAdminsFileBtn.textContent = 'Admins Dosyasýný Kaydet';
            }
        }
        
        async function loadAdmins(){
            try {
                const admins = await DAL.getAdmins();
                const patientAdmins = await DAL.getPatientAdmins();
                
                ghAdmins = {
                    admins: admins.map(a => ({
                        username: a.username,
                        password: a.password_hash,
                        roles: a.roles
                    })),
                    patientAdmins: patientAdmins
                };
                
                console.log('? Admins loaded from Supabase:', ghAdmins);
            } catch (error) {
                console.error('? Failed to load admins from Supabase:', error);
            }
        }
        function attachAdminsUIHandlers(){
            if (adminSaveBtn) adminSaveBtn.addEventListener('click', upsertAdminFromForm);
            if (adminClearBtn) adminClearBtn.addEventListener('click', clearAdminForm);
            if (patientAdminAddBtn) patientAdminAddBtn.addEventListener('click', addPatientAdmin);
            if (patientAdminInput) patientAdminInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); addPatientAdmin(); } });
            if (saveAdminsFileBtn) saveAdminsFileBtn.addEventListener('click', saveAdmins);
            if (forceReloginBtn) forceReloginBtn.addEventListener('click', ()=>{
                const u = new URL(location.href);
                u.searchParams.set('relogin','1');
                location.href = u.toString();
            });
        }

        function setLoadingState(active) {
            isLoading = active;
            const disabled = active || isSaving;
            [defaultAlternativeCountInput, enableTagFilterInput, tagExclusionInput,
                roleExclusionInput, categoryExclusionInput, rotationEnabledInput,
                rotationChunkSizeInput, rotationResetDayInput,
                saveSettingsButton, reloadButton]
                .forEach(element => {
                    element.disabled = !!disabled;
                    if (element.tagName === 'INPUT' && element.type !== 'checkbox') {
                        element.classList.toggle('disabled', !!disabled);
                    }
                });
        }

        function setSavingState(active) {
            isSaving = active;
            const disabled = active || isLoading;
            saveSettingsButton.disabled = !!disabled;
            reloadButton.disabled = !!disabled;
        }

        function ensureSorted(values) {
            return values.sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
        }

        function renderChipList(container, values, onRemove) {
            container.innerHTML = '';
            if (!values || values.length === 0) {
                const hint = document.createElement('span');
                hint.className = 'empty-hint';
                hint.textContent = 'Henüz eklenmedi.';
                container.appendChild(hint);
                return;
            }
            const sanitized = sanitizeStringList(values);
            ensureSorted(sanitized);
            sanitized.forEach(value => {
                const chip = document.createElement('span');
                chip.className = 'settings-chip';
                chip.textContent = value;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '×';
                removeBtn.setAttribute('aria-label', `${value} kaydýný sil`);
                removeBtn.addEventListener('click', () => onRemove(value));
                chip.appendChild(removeBtn);
                container.appendChild(chip);
            });
        }

        function addValueToList(list, rawValue) {
            if (!rawValue) return false;
            const trimmed = sanitizeString(rawValue);
            if (!trimmed) return false;
            const normalized = normalizeText(trimmed);
            if (!normalized) return false;
            const exists = list.some(item => normalizeText(item) === normalized);
            if (exists) return false;
            list.push(trimmed);
            return true;
        }

        function buildSettingsDraft() {
            const rotation = appSettings.rotation || {};
            const filterCriteria = appSettings.filterCriteria || {};
            
            return {
                defaultAlternativeCount: Number.isFinite(appSettings.defaultAlternativeCount) ? appSettings.defaultAlternativeCount : 3,
                enableTagFilter: !!appSettings.enableTagFilter,
                calorieTolerancePercent: Number.isFinite(appSettings.calorieTolerancePercent) ? appSettings.calorieTolerancePercent : 5,
                templateReuseWeeks: Number.isFinite(appSettings.templateReuseWeeks) ? appSettings.templateReuseWeeks : 4,
                tagExclusions: sanitizeStringList(Array.isArray(appSettings.tagExclusions) ? appSettings.tagExclusions : []),
                tagExemptions: {
                    roles: sanitizeStringList(Array.isArray(appSettings.tagExemptions?.roles) ? appSettings.tagExemptions.roles : []),
                    categories: sanitizeStringList(Array.isArray(appSettings.tagExemptions?.categories) ? appSettings.tagExemptions.categories : [])
                },
                rotation: {
                    enabled: rotation.enabled !== undefined ? !!rotation.enabled : true,
                    chunkSize: Number.isFinite(rotation.chunkSize) && rotation.chunkSize > 0 ? rotation.chunkSize : 3,
                    resetDay: Number.isFinite(rotation.resetDay) ? rotation.resetDay : ''
                },
                filterCriteria: {
                    role: {
                        visible: filterCriteria.role?.visible !== undefined ? !!filterCriteria.role.visible : true,
                        mode: filterCriteria.role?.mode || 'optional',
                        defaultState: filterCriteria.role?.defaultState || 'active'
                    },
                    dietType: {
                        visible: filterCriteria.dietType?.visible !== undefined ? !!filterCriteria.dietType.visible : true,
                        mode: filterCriteria.dietType?.mode || 'optional',
                        defaultState: filterCriteria.dietType?.defaultState || 'inactive'
                    },
                    category: {
                        visible: filterCriteria.category?.visible !== undefined ? !!filterCriteria.category.visible : false,
                        mode: filterCriteria.category?.mode || 'optional',
                        defaultState: filterCriteria.category?.defaultState || 'inactive'
                    },
                    season: {
                        visible: filterCriteria.season?.visible !== undefined ? !!filterCriteria.season.visible : false,
                        mode: filterCriteria.season?.mode || 'optional',
                        defaultState: filterCriteria.season?.defaultState || 'inactive'
                    },
                    mealType: {
                        visible: filterCriteria.mealType?.visible !== undefined ? !!filterCriteria.mealType.visible : false,
                        mode: filterCriteria.mealType?.mode || 'optional',
                        defaultState: filterCriteria.mealType?.defaultState || 'inactive'
                    }
                },
                badgeVisibility: {
                    role: appSettings.badgeVisibility?.role !== undefined ? appSettings.badgeVisibility.role : true,
                    dietType: appSettings.badgeVisibility?.dietType !== undefined ? appSettings.badgeVisibility.dietType : true,
                    category: appSettings.badgeVisibility?.category !== undefined ? appSettings.badgeVisibility.category : false,
                    season: appSettings.badgeVisibility?.season !== undefined ? appSettings.badgeVisibility.season : false,
                    mealType: appSettings.badgeVisibility?.mealType !== undefined ? appSettings.badgeVisibility.mealType : false,
                    tags: appSettings.badgeVisibility?.tags !== undefined ? appSettings.badgeVisibility.tags : false
                },
                featureVisibility: {
                    pdfExportButton: appSettings.featureVisibility?.pdfExportButton !== undefined ? appSettings.featureVisibility.pdfExportButton : true
                },
                scoreCriteria: {
                    activeByDefault: appSettings.scoreCriteria?.activeByDefault ?? ['protein', 'fat']
                },
                scoringMode: appSettings.scoringMode || 'simple',
                sensitivityDivider: appSettings.sensitivityDivider || 10,
                dietFormulas: {
                    ketojenik: {
                        carb: appSettings.dietFormulas?.ketojenik?.carb ?? 0.3,
                        protein: appSettings.dietFormulas?.ketojenik?.protein ?? 0.8,
                        fat: appSettings.dietFormulas?.ketojenik?.fat ?? 1.2
                    },
                    lowcarb: {
                        carb: appSettings.dietFormulas?.lowcarb?.carb ?? 0.6,
                        protein: appSettings.dietFormulas?.lowcarb?.protein ?? 0.8,
                        fat: appSettings.dietFormulas?.lowcarb?.fat ?? 1.0
                    },
                    akdeniz: {
                        carb: appSettings.dietFormulas?.akdeniz?.carb ?? 0.6,
                        protein: appSettings.dietFormulas?.akdeniz?.protein ?? 0.8,
                        fat: appSettings.dietFormulas?.akdeniz?.fat ?? 1.0
                    },
                    activityMultipliers: {
                        1: appSettings.dietFormulas?.activityMultipliers?.[1] ?? 0.8,
                        2: appSettings.dietFormulas?.activityMultipliers?.[2] ?? 0.9,
                        3: appSettings.dietFormulas?.activityMultipliers?.[3] ?? 1.0,
                        4: appSettings.dietFormulas?.activityMultipliers?.[4] ?? 1.1,
                        5: appSettings.dietFormulas?.activityMultipliers?.[5] ?? 1.2
                    }
                }
            };
        }

        function populateSettingsForm() {
            // GitHub'dan yüklenen appSettings'i kullan
            console.log('?? populateSettingsForm - appSettings:', appSettings);
            settingsDraft = buildSettingsDraft(); // appSettings'den oluþtur
            
            console.log('? settingsDraft oluþturuldu:', {
                scoringMode: settingsDraft.scoringMode,
                badgeVisibility: settingsDraft.badgeVisibility,
                scoreCriteria: settingsDraft.scoreCriteria
            });
            
            defaultAlternativeCountInput.value = settingsDraft.defaultAlternativeCount;
            enableTagFilterInput.checked = settingsDraft.enableTagFilter;
            calorieToleranceInput.value = settingsDraft.calorieTolerancePercent;
            const templateReuseInput = document.getElementById('templateReuseWeeksInput');
            if (templateReuseInput) templateReuseInput.value = settingsDraft.templateReuseWeeks;
            rotationEnabledInput.checked = settingsDraft.rotation.enabled;
            rotationChunkSizeInput.value = settingsDraft.rotation.chunkSize;
            rotationResetDayInput.value = settingsDraft.rotation.resetDay === '' ? '' : settingsDraft.rotation.resetDay;
            // githubTokenInput removed - using Supabase only

            // Diyet Formül Ayarlarýný Doldur
            if (settingsDraft.dietFormulas) {
                ketoCarb.value = settingsDraft.dietFormulas.ketojenik.carb;
                ketoProtein.value = settingsDraft.dietFormulas.ketojenik.protein;
                ketoFat.value = settingsDraft.dietFormulas.ketojenik.fat;
                lowcarbCarb.value = settingsDraft.dietFormulas.lowcarb.carb;
                lowcarbProtein.value = settingsDraft.dietFormulas.lowcarb.protein;
                lowcarbFat.value = settingsDraft.dietFormulas.lowcarb.fat;
                akdenizCarb.value = settingsDraft.dietFormulas.akdeniz?.carb ?? 0.6;
                akdenizProtein.value = settingsDraft.dietFormulas.akdeniz?.protein ?? 0.8;
                akdenizFat.value = settingsDraft.dietFormulas.akdeniz?.fat ?? 1.0;
                activity1.value = settingsDraft.dietFormulas.activityMultipliers[1];
                activity2.value = settingsDraft.dietFormulas.activityMultipliers[2];
                activity3.value = settingsDraft.dietFormulas.activityMultipliers[3];
                activity4.value = settingsDraft.dietFormulas.activityMultipliers[4];
                activity5.value = settingsDraft.dietFormulas.activityMultipliers[5];
            }

            // Filtreleme Kriterleri Ayarlarýný Doldur
            if (settingsDraft.filterCriteria) {
                criteriaRoleVisible.checked = settingsDraft.filterCriteria.role?.visible ?? true;
                criteriaRoleMode.value = settingsDraft.filterCriteria.role?.mode ?? 'optional';
                criteriaRoleDefault.value = settingsDraft.filterCriteria.role?.defaultState ?? 'active';
                
                criteriaDietTypeVisible.checked = settingsDraft.filterCriteria.dietType?.visible ?? true;
                criteriaDietTypeMode.value = settingsDraft.filterCriteria.dietType?.mode ?? 'optional';
                criteriaDietTypeDefault.value = settingsDraft.filterCriteria.dietType?.defaultState ?? 'inactive';
                
                criteriaCategoryVisible.checked = settingsDraft.filterCriteria.category?.visible ?? false;
                criteriaCategoryMode.value = settingsDraft.filterCriteria.category?.mode ?? 'optional';
                criteriaCategoryDefault.value = settingsDraft.filterCriteria.category?.defaultState ?? 'inactive';
                
                criteriaSeasonVisible.checked = settingsDraft.filterCriteria.season?.visible ?? false;
                criteriaSeasonMode.value = settingsDraft.filterCriteria.season?.mode ?? 'optional';
                criteriaSeasonDefault.value = settingsDraft.filterCriteria.season?.defaultState ?? 'inactive';
                
                criteriaMealTypeVisible.checked = settingsDraft.filterCriteria.mealType?.visible ?? false;
                criteriaMealTypeMode.value = settingsDraft.filterCriteria.mealType?.mode ?? 'optional';
                criteriaMealTypeDefault.value = settingsDraft.filterCriteria.mealType?.defaultState ?? 'inactive';
            }

            // Rozet Gösterimi Ayarlarýný Doldur - GitHub'dan gelen deðerleri kullan
            if (settingsDraft.badgeVisibility) {
                // Nullish coalescing kullanma - GitHub'daki false deðerleri korumak için
                document.getElementById('badgeRoleVisible').checked = settingsDraft.badgeVisibility.role === true;
                document.getElementById('badgeDietTypeVisible').checked = settingsDraft.badgeVisibility.dietType === true;
                document.getElementById('badgeCategoryVisible').checked = settingsDraft.badgeVisibility.category === true;
                document.getElementById('badgeSeasonVisible').checked = settingsDraft.badgeVisibility.season === true;
                document.getElementById('badgeMealTypeVisible').checked = settingsDraft.badgeVisibility.mealType === true;
                document.getElementById('badgeTagsVisible').checked = settingsDraft.badgeVisibility.tags === true;
            } else {
                // badgeVisibility yoksa tüm rozetleri kapat
                document.getElementById('badgeRoleVisible').checked = false;
                document.getElementById('badgeDietTypeVisible').checked = false;
                document.getElementById('badgeCategoryVisible').checked = false;
                document.getElementById('badgeSeasonVisible').checked = false;
                document.getElementById('badgeMealTypeVisible').checked = false;
                document.getElementById('badgeTagsVisible').checked = false;
            }
            
            // Özellik Görünürlüðü Ayarlarýný Doldur
            if (settingsDraft.featureVisibility) {
                document.getElementById('pdfExportVisible').checked = settingsDraft.featureVisibility.pdfExportButton === true;
            } else {
                document.getElementById('pdfExportVisible').checked = true; // Varsayýlan açýk
            }

            // Benzerlik Skoru Kriterleri Ayarlarýný Doldur
            if (settingsDraft.scoreCriteria && Array.isArray(settingsDraft.scoreCriteria.activeByDefault)) {
                const activeScoreCriteria = settingsDraft.scoreCriteria.activeByDefault;
                scoreCriteriaCalories.checked = activeScoreCriteria.includes('calories');
                scoreCriteriaProtein.checked = activeScoreCriteria.includes('protein');
                scoreCriteriaCarbs.checked = activeScoreCriteria.includes('carbs');
                scoreCriteriaFat.checked = activeScoreCriteria.includes('fat');
            } else {
                // Varsayýlan: protein ve fat aktif
                scoreCriteriaCalories.checked = false;
                scoreCriteriaProtein.checked = true;
                scoreCriteriaCarbs.checked = false;
                scoreCriteriaFat.checked = true;
            }
            
            // Benzerlik Hesaplama Modu Ayarlarýný Doldur
            const scoringModeSimple = document.getElementById('scoringModeSimple');
            const scoringModeAdvanced = document.getElementById('scoringModeAdvanced');
            const sensitivitySlider = document.getElementById('sensitivityDivider');
            const sensitivityValueSpan = document.getElementById('sensitivityValue');
            
            const mode = settingsDraft.scoringMode || 'simple';
            if (scoringModeSimple && scoringModeAdvanced) {
                if (mode === 'advanced') {
                    scoringModeAdvanced.checked = true;
                } else {
                    scoringModeSimple.checked = true;
                }
            }
            
            if (sensitivitySlider && sensitivityValueSpan) {
                const dividerValue = settingsDraft.sensitivityDivider || 10;
                sensitivitySlider.value = dividerValue;
                sensitivityValueSpan.textContent = dividerValue;
            }
            
            // Sensitivity container görünürlüðünü güncelle
            const sensitivityContainer = document.getElementById('sensitivityContainer');
            if (sensitivityContainer) {
                sensitivityContainer.style.display = mode === 'advanced' ? 'block' : 'none';
            }

            renderChipList(tagExclusionList, settingsDraft.tagExclusions, removeTagExclusion);
            renderChipList(roleExclusionList, settingsDraft.tagExemptions.roles, removeRoleExclusion);
            renderChipList(categoryExclusionList, settingsDraft.tagExemptions.categories, removeCategoryExclusion);

            updateRotationFieldStates();
        }

        function removeTagExclusion(value) {
            if (!settingsDraft) return;
            settingsDraft.tagExclusions = settingsDraft.tagExclusions.filter(item => normalizeText(item) !== normalizeText(value));
            renderChipList(tagExclusionList, settingsDraft.tagExclusions, removeTagExclusion);
        }

        function removeRoleExclusion(value) {
            if (!settingsDraft) return;
            settingsDraft.tagExemptions.roles = settingsDraft.tagExemptions.roles.filter(item => normalizeText(item) !== normalizeText(value));
            renderChipList(roleExclusionList, settingsDraft.tagExemptions.roles, removeRoleExclusion);
        }

        function removeCategoryExclusion(value) {
            if (!settingsDraft) return;
            settingsDraft.tagExemptions.categories = settingsDraft.tagExemptions.categories.filter(item => normalizeText(item) !== normalizeText(value));
            renderChipList(categoryExclusionList, settingsDraft.tagExemptions.categories, removeCategoryExclusion);
        }

        function collectPayloadFromForm() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const parsedDefault = parseInt(defaultAlternativeCountInput.value, 10);
            const parsedChunk = parseInt(rotationChunkSizeInput.value, 10);
            const parsedReset = rotationResetDayInput.value === '' ? '' : parseInt(rotationResetDayInput.value, 10);
            const parsedTolerance = parseInt(calorieToleranceInput.value, 10);
            const templateReuseInput = document.getElementById('templateReuseWeeksInput');
            const parsedTemplateReuse = parseInt(templateReuseInput?.value, 10);

            settingsDraft.defaultAlternativeCount = Number.isFinite(parsedDefault) && parsedDefault > 0 ? parsedDefault : 3;
            settingsDraft.enableTagFilter = enableTagFilterInput.checked;
            settingsDraft.calorieTolerancePercent = Number.isFinite(parsedTolerance) && parsedTolerance >= 0 ? parsedTolerance : 5;
            settingsDraft.templateReuseWeeks = Number.isFinite(parsedTemplateReuse) && parsedTemplateReuse >= 1 ? parsedTemplateReuse : 4;
            settingsDraft.rotation.enabled = rotationEnabledInput.checked;
            settingsDraft.rotation.chunkSize = Number.isFinite(parsedChunk) && parsedChunk > 0 ? parsedChunk : settingsDraft.defaultAlternativeCount;
            settingsDraft.rotation.resetDay = Number.isFinite(parsedReset) && parsedReset >= 0 && parsedReset <= 6 ? parsedReset : '';

            // Filtreleme Kriterleri Güncelle
            settingsDraft.filterCriteria.role.visible = criteriaRoleVisible.checked;
            settingsDraft.filterCriteria.role.mode = criteriaRoleMode.value;
            settingsDraft.filterCriteria.role.defaultState = criteriaRoleDefault.value;
            
            settingsDraft.filterCriteria.dietType.visible = criteriaDietTypeVisible.checked;
            settingsDraft.filterCriteria.dietType.mode = criteriaDietTypeMode.value;
            settingsDraft.filterCriteria.dietType.defaultState = criteriaDietTypeDefault.value;
            
            settingsDraft.filterCriteria.category.visible = criteriaCategoryVisible.checked;
            settingsDraft.filterCriteria.category.mode = criteriaCategoryMode.value;
            settingsDraft.filterCriteria.category.defaultState = criteriaCategoryDefault.value;
            
            settingsDraft.filterCriteria.season.visible = criteriaSeasonVisible.checked;
            settingsDraft.filterCriteria.season.mode = criteriaSeasonMode.value;
            settingsDraft.filterCriteria.season.defaultState = criteriaSeasonDefault.value;
            
            settingsDraft.filterCriteria.mealType.visible = criteriaMealTypeVisible.checked;
            settingsDraft.filterCriteria.mealType.mode = criteriaMealTypeMode.value;
            settingsDraft.filterCriteria.mealType.defaultState = criteriaMealTypeDefault.value;

            // Benzerlik Skoru Kriterleri Güncelle
            const activeScoreCriteria = [];
            if (scoreCriteriaCalories.checked) activeScoreCriteria.push('calories');
            if (scoreCriteriaProtein.checked) activeScoreCriteria.push('protein');
            if (scoreCriteriaCarbs.checked) activeScoreCriteria.push('carbs');
            if (scoreCriteriaFat.checked) activeScoreCriteria.push('fat');
            settingsDraft.scoreCriteria = {
                activeByDefault: activeScoreCriteria
            };
            
            // Benzerlik Hesaplama Modu Güncelle
            const scoringModeSimple = document.getElementById('scoringModeSimple');
            const scoringModeAdvanced = document.getElementById('scoringModeAdvanced');
            const sensitivitySlider = document.getElementById('sensitivityDivider');
            
            settingsDraft.scoringMode = scoringModeAdvanced && scoringModeAdvanced.checked ? 'advanced' : 'simple';
            settingsDraft.sensitivityDivider = sensitivitySlider ? parseInt(sensitivitySlider.value, 10) : 10;

            // Diyet Formülleri Güncelle
            settingsDraft.dietFormulas.ketojenik.carb = parseFloat(ketoCarb.value) || 0.3;
            settingsDraft.dietFormulas.ketojenik.protein = parseFloat(ketoProtein.value) || 0.8;
            settingsDraft.dietFormulas.ketojenik.fat = parseFloat(ketoFat.value) || 1.2;
            settingsDraft.dietFormulas.lowcarb.carb = parseFloat(lowcarbCarb.value) || 0.6;
            settingsDraft.dietFormulas.lowcarb.protein = parseFloat(lowcarbProtein.value) || 0.8;
            settingsDraft.dietFormulas.lowcarb.fat = parseFloat(lowcarbFat.value) || 1.0;
            settingsDraft.dietFormulas.akdeniz.carb = parseFloat(akdenizCarb.value) || 0.6;
            settingsDraft.dietFormulas.akdeniz.protein = parseFloat(akdenizProtein.value) || 0.8;
            settingsDraft.dietFormulas.akdeniz.fat = parseFloat(akdenizFat.value) || 1.0;
            settingsDraft.dietFormulas.activityMultipliers[1] = parseFloat(activity1.value) || 0.8;
            settingsDraft.dietFormulas.activityMultipliers[2] = parseFloat(activity2.value) || 0.9;
            settingsDraft.dietFormulas.activityMultipliers[3] = parseFloat(activity3.value) || 1.0;
            settingsDraft.dietFormulas.activityMultipliers[4] = parseFloat(activity4.value) || 1.1;
            settingsDraft.dietFormulas.activityMultipliers[5] = parseFloat(activity5.value) || 1.2;

            const rotationPayload = {
                enabled: settingsDraft.rotation.enabled,
                chunkSize: settingsDraft.rotation.chunkSize
            };
            if (settingsDraft.rotation.resetDay !== '') {
                rotationPayload.resetDay = settingsDraft.rotation.resetDay;
            }

            // Rozet Görünürlük Ayarlarýný Topla
            const badgeVisibilityPayload = {
                role: document.getElementById('badgeRoleVisible')?.checked ?? true,
                dietType: document.getElementById('badgeDietTypeVisible')?.checked ?? true,
                category: document.getElementById('badgeCategoryVisible')?.checked ?? false,
                season: document.getElementById('badgeSeasonVisible')?.checked ?? false,
                mealType: document.getElementById('badgeMealTypeVisible')?.checked ?? false,
                tags: document.getElementById('badgeTagsVisible')?.checked ?? false
            };

            return {
                defaultAlternatives: settingsDraft.defaultAlternativeCount,
                defaultAlternativeCount: settingsDraft.defaultAlternativeCount,  // Both formats for compatibility
                enableTagFilter: settingsDraft.enableTagFilter,
                calorieTolerance: settingsDraft.calorieTolerancePercent,
                calorieTolerancePercent: settingsDraft.calorieTolerancePercent,  // Both formats
                templateReuseWeeks: settingsDraft.templateReuseWeeks,
                tagExclusions: sanitizeStringList(settingsDraft.tagExclusions),
                tagExemptions: {
                    roles: sanitizeStringList(settingsDraft.tagExemptions.roles),
                    categories: sanitizeStringList(settingsDraft.tagExemptions.categories)
                },
                rotationEnabled: rotationPayload.enabled,
                rotationDailyAlternatives: rotationPayload.chunkSize,
                rotationResetDay: rotationPayload.resetDay,
                rotation: rotationPayload,  // Keep nested object too
                filterCriteria: settingsDraft.filterCriteria,
                scoreCriteria: settingsDraft.scoreCriteria,
                scoringMode: settingsDraft.scoringMode || 'simple',
                sensitivityDivider: settingsDraft.sensitivityDivider || 10,
                dietFormulas: settingsDraft.dietFormulas,
                activityMultipliers: settingsDraft.dietFormulas.activityMultipliers,
                badgeVisibility: badgeVisibilityPayload,
                featureVisibility: appSettings.featureVisibility || { pdfButton: true },  // Keep existing feature visibility
                updatedAt: new Date().toISOString()
            };
        }

        // GitHub token functions removed - using Supabase only

        function updateRotationFieldStates() {
            const isEnabled = rotationEnabledInput.checked;
            rotationChunkSizeInput.disabled = !isEnabled;
            rotationResetDayInput.disabled = !isEnabled;
            rotationChunkSizeInput.classList.toggle('disabled', !isEnabled);
            rotationResetDayInput.classList.toggle('disabled', !isEnabled);
        }

        function registerInputHandlers() {
            tagExclusionInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    tryAddTagExclusion();
                }
            });
            tagExclusionInput.addEventListener('blur', tryAddTagExclusion);

            roleExclusionInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    tryAddRoleExclusion();
                }
            });
            roleExclusionInput.addEventListener('blur', tryAddRoleExclusion);

            categoryExclusionInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    tryAddCategoryExclusion();
                }
            });
            categoryExclusionInput.addEventListener('blur', tryAddCategoryExclusion);

            rotationEnabledInput.addEventListener('change', updateRotationFieldStates);
            
            // Scoring Mode ve Sensitivity Event Listeners
            const scoringModeSimple = document.getElementById('scoringModeSimple');
            const scoringModeAdvanced = document.getElementById('scoringModeAdvanced');
            const sensitivityContainer = document.getElementById('sensitivityContainer');
            const sensitivitySlider = document.getElementById('sensitivityDivider');
            const sensitivityValueSpan = document.getElementById('sensitivityValue');
            
            // Mode deðiþince sensitivity container'ý göster/gizle
            function updateSensitivityVisibility() {
                if (scoringModeAdvanced && scoringModeAdvanced.checked) {
                    sensitivityContainer.style.display = 'block';
                } else {
                    sensitivityContainer.style.display = 'none';
                }
            }
            
            if (scoringModeSimple) {
                scoringModeSimple.addEventListener('change', updateSensitivityVisibility);
            }
            if (scoringModeAdvanced) {
                scoringModeAdvanced.addEventListener('change', updateSensitivityVisibility);
            }
            
            // Slider deðeri deðiþince göster
            if (sensitivitySlider && sensitivityValueSpan) {
                sensitivitySlider.addEventListener('input', () => {
                    sensitivityValueSpan.textContent = sensitivitySlider.value;
                });
            }
            
            // Ýlk yükleme
            updateSensitivityVisibility();
        }

        function tryAddTagExclusion() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const added = addValueToList(settingsDraft.tagExclusions, tagExclusionInput.value);
            if (added) {
                renderChipList(tagExclusionList, settingsDraft.tagExclusions, removeTagExclusion);
                tagExclusionInput.value = '';
                showStatus('Tag listesine eklendi.', 'success');
            }
        }

        function tryAddRoleExclusion() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const added = addValueToList(settingsDraft.tagExemptions.roles, roleExclusionInput.value);
            if (added) {
                renderChipList(roleExclusionList, settingsDraft.tagExemptions.roles, removeRoleExclusion);
                roleExclusionInput.value = '';
                showStatus('Rol listesine eklendi.', 'success');
            }
        }

        function tryAddCategoryExclusion() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const added = addValueToList(settingsDraft.tagExemptions.categories, categoryExclusionInput.value);
            if (added) {
                renderChipList(categoryExclusionList, settingsDraft.tagExemptions.categories, removeCategoryExclusion);
                categoryExclusionInput.value = '';
                showStatus('Kategori listesine eklendi.', 'success');
            }
        }

        async function loadSettings() {
            setLoadingState(true);
            showStatus('Ayarlar yükleniyor...', 'info');
            
            try {
                // ?? Supabase'den ayarlarý yükle
                const supabaseSettings = await DAL.getSettings();
                
                if (supabaseSettings && Object.keys(supabaseSettings).length > 0) {
                    // Check if it's already in camelCase format (from localStorage)
                    // or needs conversion from snake_case (from Supabase columns)
                    const hasSnakeCase = 'default_alternatives' in supabaseSettings || 
                                        'enable_tag_filter' in supabaseSettings;
                    
                    if (hasSnakeCase) {
                        // Convert from snake_case (Supabase columns)
                        appSettings = {
                            defaultAlternatives: supabaseSettings.default_alternatives,
                            defaultAlternativeCount: supabaseSettings.default_alternatives,  // Both names for compatibility
                            enableTagFilter: supabaseSettings.enable_tag_filter,
                            calorieTolerance: supabaseSettings.calorie_tolerance,
                            calorieTolerancePercent: supabaseSettings.calorie_tolerance,  // Both names
                            templateReuseWeeks: supabaseSettings.template_reuse_weeks,
                            dietFormulas: supabaseSettings.diet_formulas,
                            activityMultipliers: supabaseSettings.activity_multipliers,
                            tagExclusions: supabaseSettings.tag_exclusions,
                            tagExemptions: supabaseSettings.tag_exemptions,
                            rotationEnabled: supabaseSettings.rotation_enabled,
                            rotationDailyAlternatives: supabaseSettings.rotation_daily_alternatives,
                            rotationResetDay: supabaseSettings.rotation_reset_day,
                            filterCriteria: supabaseSettings.filter_criteria,
                            scoreCriteria: supabaseSettings.score_criteria,
                            scoringMode: supabaseSettings.scoring_mode,
                            sensitivityDivider: supabaseSettings.sensitivity_divider,
                            badgeVisibility: supabaseSettings.badge_visibility,
                            featureVisibility: supabaseSettings.feature_visibility
                        };
                    } else {
                        // Already in camelCase (from localStorage), use as-is
                        appSettings = supabaseSettings;
                        
                        // Ensure both property name variants exist for compatibility
                        appSettings.defaultAlternativeCount = appSettings.defaultAlternativeCount || appSettings.defaultAlternatives || 3;
                        appSettings.defaultAlternatives = appSettings.defaultAlternatives || appSettings.defaultAlternativeCount || 3;
                        appSettings.calorieTolerancePercent = appSettings.calorieTolerancePercent || appSettings.calorieTolerance || 5;
                        appSettings.calorieTolerance = appSettings.calorieTolerance || appSettings.calorieTolerancePercent || 5;
                    }
                    
                    // ?? DEBUG: Supabase'den yüklenen veri
                    console.log('?? Supabase settings loaded:', {
                        defaultAlternatives: appSettings.defaultAlternatives,
                        scoringMode: appSettings.scoringMode,
                        sensitivityDivider: appSettings.sensitivityDivider,
                        badgeVisibility: appSettings.badgeVisibility,
                        scoreCriteria: appSettings.scoreCriteria
                    });
                    
                    // Sanitize lists
                    appSettings.tagExclusions = sanitizeStringList(appSettings.tagExclusions);
                    appSettings.tagExemptions = {
                        roles: sanitizeStringList(appSettings.tagExemptions?.roles),
                        categories: sanitizeStringList(appSettings.tagExemptions?.categories)
                    };
                    
                    showStatus('? Ayarlar Supabase\'den yüklendi.', 'success');
                } else {
                    // Fallback to defaults
                    appSettings = { ...defaultSettings };
                    showStatus('?? Ayarlar bulunamadý. Varsayýlanlar kullanýlýyor.', 'info');
                }
            } catch (error) {
                console.error('? Ayarlar yüklenirken hata:', error);
                appSettings = { ...defaultSettings };
                showStatus('? Ayarlar yüklenemedi. Varsayýlan deðerler kullanýlýyor.', 'error');
            } finally {
                setLoadingState(false);
                populateSettingsForm();
            }
        }

        async function saveSettings(payload) {
            // ?? Supabase'e kaydet
            // payload'u Supabase formatýna dönüþtür
            const supabasePayload = {
                default_alternatives: payload.defaultAlternatives,
                enable_tag_filter: payload.enableTagFilter,
                calorie_tolerance: payload.calorieTolerance,
                template_reuse_weeks: payload.templateReuseWeeks,
                diet_formulas: payload.dietFormulas,
                activity_multipliers: payload.activityMultipliers,
                tag_exclusions: payload.tagExclusions,
                tag_exemptions: payload.tagExemptions,
                rotation_enabled: payload.rotationEnabled,
                rotation_daily_alternatives: payload.rotationDailyAlternatives,
                rotation_reset_day: payload.rotationResetDay,
                filter_criteria: payload.filterCriteria,
                score_criteria: payload.scoreCriteria,
                scoring_mode: payload.scoringMode,
                sensitivity_divider: payload.sensitivityDivider,
                badge_visibility: payload.badgeVisibility,
                feature_visibility: payload.featureVisibility
            };
            
            const success = await DAL.saveSettings(supabasePayload);
            
            if (!success) {
                throw new Error('Ayarlar Supabase\'e kaydedilemedi');
            }
            
            return { success: true, message: 'Ayarlar Supabase\'e kaydedildi' };
        }

        // Local dosyayý güncelle (File System Access API - sadece modern tarayýcýlarda çalýþýr)
        async function saveSettingsLocally(payload) {
            // Not: Bu sadece kullanýcý dosya eriþimi verirse çalýþýr
            // Otomatik çalýþmaz, bu yüzden hata olursa JSON indirme yoluna geçeriz
            
            const jsonString = JSON.stringify(payload, null, 4);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // Dosyayý kaydetmek için handle oluþtur
            if ('showSaveFilePicker' in window) {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'config.json',
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                console.log('? Local dosya güncellendi');
            } else {
                throw new Error('File System Access API desteklenmiyor');
            }
        }

        // JSON dosyasýný indir
        function downloadConfigJSON(payload) {
            const jsonString = JSON.stringify(payload, null, 4);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('?? config.json indirildi - lütfen settings/ klasörüne kopyalayýn');
        }

        async function fetchSuggestions() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-2.2/main/food_list.json');
                if (!response.ok) return;
                const data = await response.json();
                availableRoles = new Set();
                availableCategories = new Set();
                if (Array.isArray(data.categories)) {
                    data.categories.forEach(category => {
                        if (Array.isArray(category.items)) {
                            category.items.forEach(item => {
                                const roleValue = sanitizeString(item.role);
                                const categoryValue = sanitizeString(item.category);
                                if (roleValue) availableRoles.add(roleValue);
                                if (categoryValue) availableCategories.add(categoryValue);
                            });
                        }
                    });
                }
                updateSuggestionPanels();
            } catch (error) {
                console.warn('?? Rol/kategori önerileri alýnamadý:', error.message);
            }
        }

        function updateSuggestionPanels() {
            const roleValues = ensureSorted(Array.from(availableRoles));
            const categoryValues = ensureSorted(Array.from(availableCategories));

            rolesDatalist.innerHTML = roleValues.map(value => `<option value="${value}"></option>`).join('');
            categoriesDatalist.innerHTML = categoryValues.map(value => `<option value="${value}"></option>`).join('');

            if (roleValues.length || categoryValues.length) {
                suggestionsPanel.hidden = false;
                roleSuggestions.innerHTML = roleValues.slice(0, 40).map(value => `<span>${value}</span>`).join('');
                categorySuggestions.innerHTML = categoryValues.slice(0, 40).map(value => `<span>${value}</span>`).join('');
            }
        }

        function attachActionHandlers() {
            saveSettingsButton.addEventListener('click', async () => {
                if (isSaving) return;
                const payload = collectPayloadFromForm();
                console.log('?? AYARLAR KAYDEDÝLÝYOR:');
                console.log('   ?? Badge Visibility:', payload.badgeVisibility);
                console.log('   ?? Filter Criteria:', payload.filterCriteria);
                console.log('   ?? Tam Payload:', payload);
                try {
                    setSavingState(true);
                    saveSettingsButton.textContent = 'Kaydediliyor...';
                    showStatus('Supabase veritabanýna kaydediliyor...', 'info');
                    
                    // Supabase'e kaydet
                    const result = await saveSettings(payload);
                    console.log('? Supabase\'e baþarýyla kaydedildi!');
                    console.log('   ??? Rozet Ayarlarý:', payload.badgeVisibility);
                    
                    // Rozet ayarlarýnýn durumunu göster
                    const enabledBadges = Object.entries(payload.badgeVisibility)
                        .filter(([key, value]) => value)
                        .map(([key]) => key);
                    const disabledBadges = Object.entries(payload.badgeVisibility)
                        .filter(([key, value]) => !value)
                        .map(([key]) => key);
                    
                    console.log('   ? Aktif Rozetler:', enabledBadges);
                    console.log('   ? Kapalý Rozetler:', disabledBadges);
                    appSettings = payload;
                    
                    // ? Supabase'e kaydedildi
                    showStatus('Ayarlar Supabase veritabanýna kaydedildi.', 'success');
                    
                } catch (error) {
                    console.error('? Ayarlar kaydedilemedi:', error);
                    showStatus(error.message || 'Ayarlar kaydedilemedi.', 'error');
                } finally {
                    setSavingState(false);
                    saveSettingsButton.textContent = 'Kaydet';
                }
            });

            reloadButton.addEventListener('click', () => {
                if (isSaving) return;
                loadSettings();
            });

            // clearTokenButton - Artýk Supabase kullanýldýðý için devre dýþý
            // Token yönetimi artýk gerekli deðil

            // Template Upload Functionality
            uploadTemplatesButton.addEventListener('click', async () => {
                const files = templateFileInput.files;
                if (!files || files.length === 0) {
                    showStatus('? Lütfen en az bir JSON dosyasý seçin.', 'error');
                    return;
                }

                // Validate all files are JSON
                for (let file of files) {
                    if (!file.name.endsWith('.json')) {
                        showStatus(`? "${file.name}" JSON dosyasý deðil. Lütfen sadece .json dosyalarý yükleyin.`, 'error');
                        return;
                    }
                }

                try {
                    uploadTemplatesButton.disabled = true;
                    uploadTemplatesButton.textContent = `? ${files.length} dosya yükleniyor...`;
                    showStatus(`?? ${files.length} dosya okunuyor...`, 'info');

                    let allTemplates = [];

                    // Read all files
                    for (let file of files) {
                        const fileContent = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = () => reject(new Error(`Dosya okunamadý: ${file.name}`));
                            reader.readAsText(file, 'UTF-8');
                        });

                        const parsedData = JSON.parse(fileContent);
                        
                        // Handle different JSON structures
                        if (Array.isArray(parsedData)) {
                            allTemplates.push(...parsedData);
                        } else if (parsedData.templates && Array.isArray(parsedData.templates)) {
                            allTemplates.push(...parsedData.templates);
                        } else if (parsedData.id && parsedData.ogunler) {
                            allTemplates.push(parsedData);
                        } else {
                            console.warn(`[Upload] "${file.name}" beklenmeyen format, atlanýyor`);
                        }
                    }

                    showStatus('?? Þablonlar Supabase\'e kaydediliyor...', 'info');

                    // ?? Bulk save templates to Supabase
                    const result = await DAL.bulkSaveTemplates(allTemplates);
                    
                    // Show detailed success message
                    let message = `? Þablon yükleme iþlemi baþarýyla tamamlandý!<br><br>?? ÖZET:<br>`;
                    message += `?? ${files.length} dosya okundu<br>`;
                    message += `?? ${allTemplates.length} þablon bulundu<br>`;
                    message += `? ${result.added} yeni þablon eklendi<br>`;
                    message += `?? ${result.skipped} þablon (zaten mevcut) atlandý<br>`;
                    
                    if (result.errors && result.errors.length > 0) {
                        message += `?? ${result.errors.length} þablonda hata oluþtu<br>`;
                        console.error('Template upload errors:', result.errors);
                    }
                    
                    showStatus(message, 'success');
                    
                    // Clear file input
                    templateFileInput.value = '';

                } catch (error) {
                    console.error('? Þablon yükleme hatasý:', error);
                    showStatus(`? Hata: ${error.message}`, 'error');
                } finally {
                    uploadTemplatesButton.disabled = false;
                    uploadTemplatesButton.textContent = '?? Þablonlarý Yükle ve Birleþtir';
                }
            });
        }

        // init and addLogoutButton already defined in <head>

        // PWA Service Worker ve Manifest Kaydý
        if ('serviceWorker' in navigator) {
            const isSecureOrigin = ['https:', 'http:'].includes(window.location.protocol) || window.location.protocol === 'chrome-extension:';
            const isGitHubPages = /\.github\.io$/i.test(window.location.hostname);
            if (isSecureOrigin && !isGitHubPages) {
                const CACHE_NAME = 'admin-settings-v1';
                const manifest = {
                    "short_name": "Yönetici Ayarlarý",
                    "name": "Yönetici Ayarlarý Paneli",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#667eea",
                    "theme_color": "#764ba2",
                    "icons": [
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-2.2/main/logo.png",
                            "sizes": "192x192",
                            "type": "image/png",
                            "purpose": "any maskable"
                        },
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-2.2/main/logo.png",
                            "sizes": "512x512",
                            "type": "image/png",
                            "purpose": "any maskable"
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                const manifestLink = document.querySelector('#manifestLink') || document.querySelector('link[rel="manifest"]');
                if (manifestLink) {
                    manifestLink.setAttribute('href', manifestURL);
                }

                const serviceWorkerContent = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const urlsToCache = ['.'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.open(CACHE_NAME).then(cache => {
                                return fetch(event.request)
                                    .then(response => {
                                        if (response.status === 200) {
                                            cache.put(event.request.url, response.clone());
                                        }
                                        return response;
                                    })
                                    .catch(() => cache.match(event.request));
                            })
                        );
                    });
                `;
                const swBlob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);

                /*
                navigator.serviceWorker.register(swURL)
                    .then(registration => console.log('ServiceWorker registered:', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed:', err));
                */
               console.log('ServiceWorker registration disabled in admin_settings.html');
            }
        }

        // Zoom ve dokunmatik engelleyici
        (function preventZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 350) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            document.addEventListener('gesturestart', function(event) {
                event.preventDefault();
            });

            document.addEventListener('dblclick', function(event) {
                event.preventDefault();
            });
        })();
    </script>
    
    <!-- Page initialization - runs after all scripts loaded -->
    <script>
        // Initialize page after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.info('[Init] DOMContentLoaded - calling init()');
                if (typeof window.init === 'function') {
                    window.init();
                } else {
                    console.error('[Init] window.init is not defined!');
                }
            });
        } else {
            // DOM already loaded
            console.info('[Init] DOM already loaded - calling init()');
            if (typeof window.init === 'function') {
                window.init();
            } else {
                console.error('[Init] window.init is not defined!');
            }
        }
    </script>
</body>
</html>

