<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="YÃ¶netici AyarlarÄ±">
    <meta name="application-name" content="YÃ¶netici AyarlarÄ±">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest-admin-settings.json">
    <link rel="apple-touch-icon" href="/logo2.png">
    <!-- / PWA ve Mobil Uygulama Meta Etiketleri -->

    <title>YÃ¶netici AyarlarÄ±</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-wrapper {
            width: min(760px, 100%);
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 30px 65px rgba(15, 23, 42, 0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .settings-header {
            padding: 22px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .admin-nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .admin-nav-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .admin-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .admin-nav-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            font-weight: 700;
        }

        .settings-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .settings-header p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .settings-body {
            padding: 26px 28px 24px;
            display: flex;
            flex-direction: column;
            gap: 22px;
            max-height: 78vh;
            overflow-y: auto;
        }

        .settings-section {
            border: 1px solid #e0e7ff;
            border-radius: 14px;
            padding: 18px;
            background: #f8fafc;
        }

        .settings-section h2 {
            margin: 0 0 14px 0;
            font-size: 16px;
            color: #4338ca;
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }

        label {
            font-size: 13px;
            color: #475569;
            font-weight: 600;
        }

        input[type="number"],
        input[type="text"],
        input[type="password"],
        textarea {
            padding: 11px 13px;
            border: 1px solid #cbd5f5;
            border-radius: 9px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        input.disabled {
            background: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .settings-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 12px;
            border-radius: 999px;
            background: rgba(102, 126, 234, 0.12);
            color: #4338ca;
            font-size: 12px;
        }

        .settings-chip button {
            border: none;
            background: transparent;
            cursor: pointer;
            color: inherit;
            font-size: 15px;
            line-height: 1;
        }

        .empty-hint {
            font-size: 12px;
            color: #94a3b8;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 20px 28px;
            border-top: 1px solid #e0e7ff;
            background: #f8fafc;
        }

        .actions-right {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap; /* ButonlarÄ± asla alt satÄ±ra geÃ§irme */
        }

        .actions-right button {
            white-space: nowrap; /* Buton metnini kÄ±rma */
            flex-shrink: 1; /* Gerekirse butonlarÄ± kÃ¼Ã§Ã¼lt */
            min-width: 0; /* ButonlarÄ±n minimum geniÅŸliÄŸini kaldÄ±r */
        }

        button {
            padding: 11px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-primary {
            background: linear-gradient(135deg, #22d3ee 0%, #3b82f6 100%);
            color: #ffffff;
            box-shadow: 0 14px 28px rgba(59, 130, 246, 0.30);
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .status-text {
            font-size: 13px;
            color: #64748b;
        }

        .status-text strong {
            font-weight: 700;
        }

        .info-banner {
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.35);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 13px;
            color: #0f172a;
            margin-top: 4px;
        }

        .info-banner code {
            background: rgba(15, 23, 42, 0.08);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 12px;
        }

        .suggestion-hint {
            font-size: 11px;
            color: #94a3b8;
        }

        details {
            background: #e0f2fe;
            border-radius: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(14, 165, 233, 0.35);
            font-size: 12px;
            color: #0369a1;
        }

        details summary {
            cursor: pointer;
            font-weight: 600;
        }

        .suggestions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .suggestions-grid span {
            background: rgba(14, 165, 233, 0.15);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Filtreleme Kriterleri Grid Layout */
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
        }

        .criteria-item {
            border: 1px solid #e0e7ff;
            border-radius: 10px;
            padding: 14px;
            background: white;
            transition: box-shadow 0.2s ease;
        }

        .criteria-item:hover {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .criteria-header {
            margin-bottom: 10px;
        }

        .criteria-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            cursor: pointer;
        }

        .criteria-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .criteria-label {
            user-select: none;
        }

        .criteria-body {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-left: 26px;
        }

        .criteria-select,
        select {
            padding: 9px 11px;
            border: 1px solid #cbd5f5;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            cursor: pointer;
        }

        .criteria-select:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .criteria-select:disabled,
        select:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .info-hint ul {
            list-style-type: disc;
        }

        .info-hint li {
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .criteria-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
            }

            .settings-wrapper {
                border-radius: 14px;
            }

            .settings-header, .settings-body, .actions-row {
                padding-left: 18px;
                padding-right: 18px;
            }

            .settings-header h1 {
                font-size: 21px;
            }

            .settings-section {
                padding: 16px;
            }

            .actions-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .actions-right {
                width: 100%;
                justify-content: flex-end; /* ButonlarÄ± saÄŸa hizala */
                gap: 8px; /* Mobilde daha kÃ¼Ã§Ã¼k gap */
            }

            .actions-right button {
                font-size: 13px; /* Mobilde biraz daha kÃ¼Ã§Ã¼k font */
                padding: 10px 14px; /* Mobilde daha kompakt padding */
            }
        }
    </style>
    <!-- Admins config: local fallback first, then remote authoritative override -->
    <script src="settings/admins.js"></script>
    <script>
        // Remote admins.js with hard cache-busting, loaded synchronously to preserve order
        document.write('<script src="https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/settings/admins.js?t=' + Date.now() + '"><\\/scr' + 'ipt>');
    </script>
    <!-- Patient auth (for patientAdmins support when served over http/https) -->
    <script src="auth.js"></script>
    <script>
        // Expose PatientAuth on window for AdminAuth delegation (in case auth.js didn't attach it)
        console.info('[Shim] Checking PatientAuth. typeof PatientAuth:', typeof PatientAuth, 'window.PatientAuth:', !!window.PatientAuth);
        try {
            if (typeof PatientAuth !== 'undefined' && !window.PatientAuth) {
                window.PatientAuth = PatientAuth;
                console.info('[Shim] window.PatientAuth was assigned from global lexical binding');
            } else if (!window.PatientAuth) {
                console.warn('[Shim] PatientAuth not available in global scope, creating emergency shim');
                // Emergency shim for patientAdmins login when auth.js doesn't expose PatientAuth to window
                window.PatientAuth = {
                    async hashPassword(password) {
                        if (window.crypto && crypto.subtle) {
                            const encoder = new TextEncoder();
                            const data = encoder.encode(password);
                            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        }
                        throw new Error('Web Crypto API not available');
                    },
                    async loadPatientIndex() {
                        const ts = Date.now();
                        const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/hastalar/index.json?t=${ts}`, { cache: 'no-store' });
                        if (response.ok) return await response.json();
                        throw new Error('Patient index not found');
                    },
                    async loadPatientDetails(patientId) {
                        const ts = Date.now();
                        const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/hastalar/${patientId}.json?t=${ts}`, { cache: 'no-store' });
                        if (response.ok) return await response.json();
                        throw new Error('Patient details not found');
                    },
                    async login(username, password, rememberMe = false) {
                        try {
                            const index = await this.loadPatientIndex();
                            const norm = (v) => (v || '').toString().trim().toLowerCase();
                            const patient = index.patients.find(p => norm(p.username) === norm(username));
                            if (!patient) return { success: false, error: 'KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±' };
                            if (patient.status === 'archived') return { success: false, error: 'Bu hesap arÅŸivlenmiÅŸtir' };
                            
                            const inputHash = await this.hashPassword(password);
                            let effectiveHash = patient.passwordHash || '';
                            
                            try {
                                const details = await this.loadPatientDetails(patient.id);
                                const detailsHash = details?.passwordHash || details?.personalInfo?.passwordHash;
                                if (detailsHash && typeof detailsHash === 'string') {
                                    effectiveHash = detailsHash;
                                }
                            } catch (e) {
                                console.warn('[Shim PatientAuth] Details not loaded, using index hash');
                            }
                            
                            if (inputHash !== effectiveHash) return { success: false, error: 'KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±' };
                            
                            return { success: true, patient: { username: patient.username, patientId: patient.id } };
                        } catch (error) {
                            console.error('[Shim PatientAuth] Login error:', error);
                            return { success: false, error: 'GiriÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu' };
                        }
                    }
                };
                console.info('[Shim] Emergency PatientAuth created on window');
            }
        } catch(e) { 
            console.error('[Shim] Error:', e); 
        }
        console.info('[Shim] Final check - window.PatientAuth:', !!window.PatientAuth);
    </script>
    <!-- Page init moved to end of body -->
    <!-- Define page functions in head so they're available immediately -->
    <script>
        function addLogoutButton(){
            try {
                const header = document.querySelector('.settings-header');
                if (!header || document.getElementById('adminLogoutBtn')) return;
                const btn = document.createElement('button');
                btn.id = 'adminLogoutBtn';
                btn.textContent = 'ğŸšª Ã‡Ä±kÄ±ÅŸ';
                btn.style.cssText = 'margin-left:auto; align-self:flex-end; padding:8px 12px; border:none; border-radius:9px; background:linear-gradient(135deg,#ef4444 0%, #dc2626 100%); color:#fff; font-weight:700; cursor:pointer;';
                btn.onclick = () => { if (window.AdminAuth) { AdminAuth.clearSession(); location.reload(); } };
                header.appendChild(btn);
            } catch(e) { console.error('addLogoutButton error:', e); }
        }
        window.addLogoutButton = addLogoutButton;

        function init() {
            if (typeof registerInputHandlers === 'function') registerInputHandlers();
            if (typeof attachActionHandlers === 'function') attachActionHandlers();
            if (typeof fetchSuggestions === 'function') fetchSuggestions();
            if (typeof loadSettingsFromGitHub === 'function') loadSettingsFromGitHub();
            // Admins UI
            if (typeof loadAdminsRuntime === 'function') loadAdminsRuntime();
            if (typeof renderAdminsList === 'function') renderAdminsList();
            if (typeof renderPatientAdmins === 'function') renderPatientAdmins();
            if (typeof attachAdminsUIHandlers === 'function') attachAdminsUIHandlers();
            if (typeof fetchAdminsSha === 'function') fetchAdminsSha();
            if (typeof renderActiveAdmin === 'function') renderActiveAdmin();
            // If only local fallback is present (e.g., only 'admin'), try to reload remote admins.js to override
            try {
                if (typeof window.ghAdmins !== 'undefined' && (!window.ghAdmins || !Array.isArray(window.ghAdmins.admins) || window.ghAdmins.admins.length <= 1)) {
                    if (typeof reloadRemoteAdminsConfig === 'function') reloadRemoteAdminsConfig();
                }
            } catch(_) { /* noop */ }
            // Additionally, fetch and parse raw admins.js as authoritative source and apply it
            if (typeof fetchRemoteAdminsObject === 'function') {
                fetchRemoteAdminsObject().then(obj => {
                    if (obj && Array.isArray(obj.admins)){
                        window.ghAdmins = obj;
                        if (typeof ensureGhAdminsShape === 'function') ensureGhAdminsShape();
                        if (typeof renderAdminsList === 'function') renderAdminsList();
                        if (typeof renderPatientAdmins === 'function') renderPatientAdmins();
                        if (typeof showStatus === 'function') showStatus('Uzaktan admins.js iÃ§eriÄŸi uygulandÄ±.', 'info');
                    }
                }).catch(()=>{});
            }
        }
        window.init = init;
        
        console.info('[Head] Functions defined. addLogoutButton:', typeof addLogoutButton, 'init:', typeof init);
    </script>
    <!-- Admin auth gate (hard cache-busting, load after GH_ADMINS scripts) -->
    <script src="admin_auth.js"></script>
</head>
<body>
    <div class="settings-wrapper">
        <header class="settings-header">
            <div>
                <h1>YÃ¶netici AyarlarÄ±</h1>
                <p>Bu panelden <code>settings/config.json</code> dosyasÄ±nÄ± dÃ¼zenleyebilirsiniz. Kaydetmek iÃ§in repo yazma yetkisi olan bir GitHub token'Ä± gerekir.</p>
            </div>
            
            <!-- Admin Navigasyon ButonlarÄ± -->
            <div class="admin-nav-buttons">
                <a href="admin_settings.html" class="admin-nav-btn active">
                    âš™ï¸ Ayarlar
                </a>
                <a href="admin_patients.html" class="admin-nav-btn">
                    ğŸ‘¥ Hasta Listesi
                </a>
                <a href="admin_chat.html" class="admin-nav-btn">
                    ğŸ’¬ Sohbet YÃ¶netimi
                </a>
            </div>
            
            <div class="info-banner">
                Token'Ä± tarayÄ±cÄ±da tutmak iÃ§in <strong>Yerel depolama</strong> kullanÄ±lÄ±r. Ortak cihazlarda <em>Kaydet</em> iÅŸleminden sonra <strong>token'Ä± temizlemeyi</strong> unutmayÄ±n.
            </div>
        </header>

        <main class="settings-body">
            <section class="settings-section">
                <h2>Aktif Admin</h2>
                <div class="settings-row">
                    <span id="activeAdminBadge" style="display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:700;font-size:13px;">â€”</span>
                    <span class="suggestion-hint">Bu oturumla iÅŸlem yapÄ±yorsunuz.</span>
                </div>
                <div class="settings-row">
                    <button type="button" class="btn-secondary" id="forceReloginBtn">Yeniden GiriÅŸ Ä°ste</button>
                </div>
            </section>
            <section class="settings-section">
                <h2>Genel</h2>
                <div class="settings-row">
                    <label for="defaultAlternativeCountInput">VarsayÄ±lan alternatif sayÄ±sÄ±</label>
                    <input type="number" id="defaultAlternativeCountInput" min="1" max="10">
                </div>
                <div class="settings-row checkbox-row">
                    <label for="enableTagFilterInput">
                        <input type="checkbox" id="enableTagFilterInput"> Tag filtrelemesini aktifleÅŸtir
                    </label>
                </div>
                <div class="settings-row">
                    <label for="calorieToleranceInput">
                        Kalori toleransÄ± (%)
                        <span style="color: #666; font-size: 12px; display: block;">Åablon filtrelemede Â±% sapma oranÄ± (Ã¶rn: 5 = Â±%5)</span>
                    </label>
                    <input type="number" id="calorieToleranceInput" min="0" max="50" step="1" value="5">
                </div>
                <div class="settings-row">
                    <label for="templateReuseWeeksInput">
                        Åablon tekrar kullanÄ±m sÃ¼resi (hafta)
                        <span style="color: #666; font-size: 12px; display: block;">Bir ÅŸablon kaÃ§ hafta sonra tekrar kullanÄ±labilir (Ã¶rn: 4 = 4 hafta sonra)</span>
                    </label>
                    <input type="number" id="templateReuseWeeksInput" min="1" max="12" step="1" value="4">
                </div>
            </section>

            <!-- Diyet FormÃ¼lleri BÃ¶lÃ¼mÃ¼ -->
            <section class="settings-section">
                <h2>ğŸ¥— Diyet FormÃ¼lleri ve Makro Hesaplama</h2>
                
                <div style="margin-bottom: 20px; padding: 12px; background: #e0e7ff; border-radius: 8px;">
                    <strong>ğŸ“Œ FormÃ¼l YapÄ±sÄ±:</strong><br>
                    â€¢ Karbonhidrat = Kilo Ã— Ã‡arpan (gram)<br>
                    â€¢ Protein = Kilo Ã— Ã‡arpan (gram)<br>
                    â€¢ YaÄŸ = Kilo Ã— Ã‡arpan (gram)<br>
                    â€¢ Kalori = (KarbÃ—4) + (ProteinÃ—4) + (YaÄŸÃ—9)<br>
                    â€¢ Final Kalori = Kalori Ã— Aktivite Ã‡arpanÄ±
                </div>

                <!-- Ketojenik Diyet -->
                <div style="border: 2px solid #4ade80; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #15803d;">Ketojenik Diyet</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>Karbonhidrat Ã‡arpanÄ±</label>
                            <input type="number" id="ketoCarb" step="0.1" min="0" value="0.3">
                        </div>
                        <div class="settings-row">
                            <label>Protein Ã‡arpanÄ±</label>
                            <input type="number" id="ketoProtein" step="0.1" min="0" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>YaÄŸ Ã‡arpanÄ±</label>
                            <input type="number" id="ketoFat" step="0.1" min="0" value="1.2">
                        </div>
                    </div>
                </div>

                <!-- Lowcarb Diyet -->
                <div style="border: 2px solid #60a5fa; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #1e40af;">Lowcarb Diyet</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>Karbonhidrat Ã‡arpanÄ±</label>
                            <input type="number" id="lowcarbCarb" step="0.1" min="0" value="0.6">
                        </div>
                        <div class="settings-row">
                            <label>Protein Ã‡arpanÄ±</label>
                            <input type="number" id="lowcarbProtein" step="0.1" min="0" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>YaÄŸ Ã‡arpanÄ±</label>
                            <input type="number" id="lowcarbFat" step="0.1" min="0" value="1.0">
                        </div>
                    </div>
                </div>

                <!-- Akdeniz Diyeti -->
                <div style="border: 2px solid #14b8a6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #0f766e;">Akdeniz Diyeti</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>Karbonhidrat Ã‡arpanÄ±</label>
                            <input type="number" id="akdenizCarb" step="0.1" min="0" value="0.6">
                        </div>
                        <div class="settings-row">
                            <label>Protein Ã‡arpanÄ±</label>
                            <input type="number" id="akdenizProtein" step="0.1" min="0" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>YaÄŸ Ã‡arpanÄ±</label>
                            <input type="number" id="akdenizFat" step="0.1" min="0" value="1.0">
                        </div>
                    </div>
                </div>

                <!-- Aktivite Ã‡arpanlarÄ± -->
                <div style="border: 2px solid #f59e0b; border-radius: 12px; padding: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #92400e;">Aktivite Seviyesi Ã‡arpanlarÄ±</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div class="settings-row">
                            <label>1 - Hareketsiz</label>
                            <input type="number" id="activity1" step="0.1" min="0" max="2" value="0.8">
                        </div>
                        <div class="settings-row">
                            <label>2 - Az Aktif</label>
                            <input type="number" id="activity2" step="0.1" min="0" max="2" value="0.9">
                        </div>
                        <div class="settings-row">
                            <label>3 - Orta Aktif</label>
                            <input type="number" id="activity3" step="0.1" min="0" max="2" value="1.0">
                        </div>
                        <div class="settings-row">
                            <label>4 - Ã‡ok Aktif</label>
                            <input type="number" id="activity4" step="0.1" min="0" max="2" value="1.1">
                        </div>
                        <div class="settings-row">
                            <label>5 - SÃ¼per Aktif</label>
                            <input type="number" id="activity5" step="0.1" min="0" max="2" value="1.2">
                        </div>
                    </div>
                </div>
            </section>

            <section class="settings-section">
                <h2>Tag Ä°stisnalarÄ±</h2>
                <div class="settings-row">
                    <label for="tagExclusionInput">Yeni istisna tagÄ± ekle</label>
                    <input type="text" id="tagExclusionInput" placeholder="Ã–rn: mevsim" autocomplete="off">
                    <span class="suggestion-hint">Enter veya odak dÄ±ÅŸÄ±nda bÄ±rakmak listedeki yeni tag'Ä± ekler.</span>
                </div>
                <div class="settings-chip-list" id="tagExclusionList"></div>
            </section>

            <section class="settings-section">
                <h2>YÃ¶neticiler (admins.js)</h2>
                <div class="settings-row">
                    <div id="adminsList"></div>
                </div>
                <div class="settings-row">
                    <details>
                        <summary>Yeni / DÃ¼zenle</summary>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px;">
                            <div>
                                <label>KullanÄ±cÄ± AdÄ±</label>
                                <input type="text" id="adminEditUsername" placeholder="admin"/>
                            </div>
                            <div>
                                <label>Yeni Åifre (opsiyonel)</label>
                                <input type="password" id="adminEditPassword" placeholder="Yeni ÅŸifre (boÅŸsa deÄŸiÅŸmez)"/>
                            </div>
                            <div>
                                <label>Roller</label>
                                <input type="text" id="adminEditRoles" placeholder="virgÃ¼lle: admin,editor"/>
                            </div>
                        </div>
                        <div style="margin-top:10px;display:flex;gap:8px;">
                            <button type="button" class="btn-primary" id="adminSaveBtn">Kaydet / GÃ¼ncelle</button>
                            <button type="button" class="btn-secondary" id="adminClearBtn">Temizle</button>
                        </div>
                    </details>
                </div>
                <div class="settings-row">
                    <label>Hasta bazlÄ± admin yetkisi (patientAdmins)</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <input type="text" id="patientAdminInput" placeholder="hastaKullaniciAdi" style="max-width:260px;"/>
                        <button type="button" class="btn-secondary" id="patientAdminAddBtn">Ekle</button>
                    </div>
                    <div class="settings-chip-list" id="patientAdminsList"></div>
                </div>
                <div class="settings-row">
                    <button type="button" class="btn-primary" id="saveAdminsFileBtn">Admins DosyasÄ±nÄ± Kaydet</button>
                </div>
            </section>

            <section class="settings-section">
                <h2>Muaf Rol ve Kategoriler</h2>
                <div class="settings-row">
                    <label for="roleExclusionInput">Rol istisnasÄ± ekle</label>
                    <input type="text" id="roleExclusionInput" placeholder="Ã–rn: Diyetisyen" list="rolesDatalist" autocomplete="off">
                    <datalist id="rolesDatalist"></datalist>
                </div>
                <div class="settings-chip-list" id="roleExclusionList"></div>

                <div class="settings-row">
                    <label for="categoryExclusionInput">Kategori istisnasÄ± ekle</label>
                    <input type="text" id="categoryExclusionInput" placeholder="Ã–rn: AtÄ±ÅŸtÄ±rmalÄ±k" list="categoriesDatalist" autocomplete="off">
                    <datalist id="categoriesDatalist"></datalist>
                </div>
                <div class="settings-chip-list" id="categoryExclusionList"></div>

                <details id="suggestionsPanel" hidden>
                    <summary>âš™ï¸ Ã–nerilen rol/kategori listesi</summary>
                    <div class="suggestions-grid" id="roleSuggestions"></div>
                    <div class="suggestions-grid" id="categorySuggestions"></div>
                </details>
            </section>

            <section class="settings-section">
                <h2>Rotasyon</h2>
                <div class="settings-row checkbox-row">
                    <label for="rotationEnabledInput">
                        <input type="checkbox" id="rotationEnabledInput"> Rotasyonu aktifleÅŸtir
                    </label>
                </div>
                <div class="settings-row">
                    <label for="rotationChunkSizeInput">GÃ¼nlÃ¼k alternatif sayÄ±sÄ±</label>
                    <input type="number" id="rotationChunkSizeInput" min="1" max="10">
                </div>
                <div class="settings-row">
                    <label for="rotationResetDayInput">Rotasyon sÄ±fÄ±rlama gÃ¼nÃ¼ (0 = Pazartesi)</label>
                    <input type="number" id="rotationResetDayInput" min="0" max="6" placeholder="BoÅŸ bÄ±rakÄ±lÄ±rsa ISO haftasÄ± baz alÄ±nÄ±r">
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ” Filtreleme Kriterleri</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    KullanÄ±cÄ± panelinde hangi filtreleme kriterlerinin gÃ¶sterileceÄŸini ve zorunlu/opsiyonel olduÄŸunu ayarlayÄ±n.
                </p>
                
                <div class="criteria-grid">
                    <!-- Role (Yemek TÃ¼rÃ¼) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaRoleVisible" checked>
                                <span class="criteria-label">ğŸ‘¨â€ğŸ³ Yemek TÃ¼rÃ¼ (Role)</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaRoleMode" style="font-size: 12px; color: #64748b;">KullanÄ±cÄ± iÃ§in:</label>
                            <select id="criteriaRoleMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (KullanÄ±cÄ± aÃ§Ä±p kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaRoleDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda:</label>
                            <select id="criteriaRoleDefault" class="criteria-select">
                                <option value="active" selected>Aktif (Filtre aÃ§Ä±k)</option>
                                <option value="inactive">Pasif (Filtre kapalÄ±)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Diet Type (Diyet TÃ¼rÃ¼) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaDietTypeVisible" checked>
                                <span class="criteria-label">ğŸ¥— Diyet TÃ¼rÃ¼</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaDietTypeMode" style="font-size: 12px; color: #64748b;">KullanÄ±cÄ± iÃ§in:</label>
                            <select id="criteriaDietTypeMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (KullanÄ±cÄ± aÃ§Ä±p kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaDietTypeDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda:</label>
                            <select id="criteriaDietTypeDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre aÃ§Ä±k)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalÄ±)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Category (Kategori) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaCategoryVisible">
                                <span class="criteria-label">ğŸ“‚ Kategori</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaCategoryMode" style="font-size: 12px; color: #64748b;">KullanÄ±cÄ± iÃ§in:</label>
                            <select id="criteriaCategoryMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (KullanÄ±cÄ± aÃ§Ä±p kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaCategoryDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda:</label>
                            <select id="criteriaCategoryDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre aÃ§Ä±k)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalÄ±)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Season (Sezon) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaSeasonVisible">
                                <span class="criteria-label">ğŸŒ¤ï¸ Sezon</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaSeasonMode" style="font-size: 12px; color: #64748b;">KullanÄ±cÄ± iÃ§in:</label>
                            <select id="criteriaSeasonMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (KullanÄ±cÄ± aÃ§Ä±p kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaSeasonDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda:</label>
                            <select id="criteriaSeasonDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre aÃ§Ä±k)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalÄ±)</option>
                            </select>
                        </div>
                    </div>

                    <!-- MealType (Ã–ÄŸÃ¼n) -->
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <label class="criteria-checkbox">
                                <input type="checkbox" id="criteriaMealTypeVisible">
                                <span class="criteria-label">ğŸ½ï¸ Ã–ÄŸÃ¼n</span>
                            </label>
                        </div>
                        <div class="criteria-body">
                            <label for="criteriaMealTypeMode" style="font-size: 12px; color: #64748b;">KullanÄ±cÄ± iÃ§in:</label>
                            <select id="criteriaMealTypeMode" class="criteria-select">
                                <option value="optional" selected>Opsiyonel (KullanÄ±cÄ± aÃ§Ä±p kapayabilir)</option>
                                <option value="required">Zorunlu (Her zaman aktif)</option>
                            </select>
                            <label for="criteriaMealTypeDefault" style="font-size: 12px; color: #64748b; margin-top: 6px;">Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda:</label>
                            <select id="criteriaMealTypeDefault" class="criteria-select">
                                <option value="active">Aktif (Filtre aÃ§Ä±k)</option>
                                <option value="inactive" selected>Pasif (Filtre kapalÄ±)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>ğŸ’¡ Ä°pucu:</strong> 
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li><strong>Opsiyonel:</strong> KullanÄ±cÄ± panelinde rozet gÃ¶sterilir, kullanÄ±cÄ± tÄ±klayarak aktif/pasif edebilir.</li>
                        <li><strong>Zorunlu:</strong> Filtreleme her zaman aktiftir, kullanÄ±cÄ± deÄŸiÅŸtiremez (rozet gizlidir).</li>
                        <li><strong>Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda:</strong> Ä°lk aÃ§Ä±lÄ±ÅŸta filtrenin aktif mi pasif mi olacaÄŸÄ±nÄ± belirler (sadece opsiyoneller iÃ§in geÃ§erli).</li>
                        <li>Checkbox iÅŸaretsizse kriter tamamen gizlenir ve kullanÄ±lmaz.</li>
                    </ul>
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ“Š Benzerlik Skoru Kriterleri</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Alternatif yemek benzerliÄŸi hesaplanÄ±rken hangi makrolarÄ±n dikkate alÄ±nacaÄŸÄ±nÄ± belirleyin. 
                    SeÃ§ili kriterler kullanÄ±larak benzerlik skoru hesaplanÄ±r.
                </p>
                
                <div class="criteria-grid">
                    <!-- Kalori -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaCalories">
                            <span class="criteria-label">ğŸ”¥ Kalori</span>
                        </label>
                    </div>

                    <!-- Protein -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaProtein" checked>
                            <span class="criteria-label">ğŸ¥© Protein</span>
                        </label>
                    </div>

                    <!-- Karbonhidrat -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaCarbs">
                            <span class="criteria-label">ğŸ Karbonhidrat</span>
                        </label>
                    </div>

                    <!-- YaÄŸ -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="scoreCriteriaFat" checked>
                            <span class="criteria-label">ğŸ§ˆ YaÄŸ</span>
                        </label>
                    </div>
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ§® Benzerlik Hesaplama Modu</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Alternatif yemek benzerliÄŸi nasÄ±l hesaplansÄ±n? Basit mod sadece kalori aÄŸÄ±rlÄ±ÄŸÄ±na bakar, 
                    GeliÅŸmiÅŸ mod hem kalori hem de oransal farkÄ± dikkate alÄ±r.
                </p>
                
                <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                    <!-- Basit Mod -->
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="scoringMode" value="simple" id="scoringModeSimple" 
                               style="margin-right: 8px;" checked>
                        <div style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; transition: all 0.2s;">
                            <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #1e293b;">ğŸ“Š Basit Mod</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0;">
                                Makro farklarÄ± kalori eÅŸdeÄŸeriyle hesaplanÄ±r.<br>
                                <strong>Protein/Karb:</strong> Ã—4 kcal/g<br>
                                <strong>YaÄŸ:</strong> Ã—9 kcal/g
                            </p>
                        </div>
                    </label>
                    
                    <!-- GeliÅŸmiÅŸ Mod -->
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="scoringMode" value="advanced" id="scoringModeAdvanced" 
                               style="margin-right: 8px;">
                        <div style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; transition: all 0.2s;">
                            <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #1e293b;">ğŸ¯ GeliÅŸmiÅŸ Mod</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0;">
                                Hem kalori hem oran bazlÄ± hesaplama.<br>
                                <strong>Ã–rnek:</strong> 20g'dan 3g â‰  40g'dan 3g<br>
                                <strong>Daha hassas</strong> skorlama
                            </p>
                        </div>
                    </label>
                </div>
                
                <!-- Sensitivity Slider (sadece GeliÅŸmiÅŸ Mod iÃ§in) -->
                <div id="sensitivityContainer" style="display: none; margin-top: 20px; padding: 16px; background: rgba(99, 102, 241, 0.05); border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #4338ca;">
                        ğŸšï¸ Hassasiyet AyarÄ± (GeliÅŸmiÅŸ Mod)
                    </label>
                    <p style="font-size: 12px; color: #64748b; margin: 0 0 12px 0;">
                        Skorlama ne kadar hassas olsun? DÃ¼ÅŸÃ¼k deÄŸer = daha sert puanlama, YÃ¼ksek deÄŸer = daha yumuÅŸak puanlama.
                    </p>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span style="font-size: 12px; color: #64748b; min-width: 80px;">Sert (5)</span>
                        <input type="range" id="sensitivityDivider" min="5" max="20" step="1" value="10" 
                               style="flex: 1; height: 6px; border-radius: 5px; outline: none; 
                                      background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);">
                        <span style="font-size: 12px; color: #64748b; min-width: 80px;">YumuÅŸak (20)</span>
                    </div>
                    <div style="margin-top: 12px; text-align: center;">
                        <span style="font-size: 14px; font-weight: 600; color: #4338ca;">
                            Mevcut DeÄŸer: <span id="sensitivityValue">10</span>
                        </span>
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; font-size: 11px; color: #475569;">
                        <strong>Ã–rnek Etki (Protein 20g â†’ 17g, %15 fark):</strong><br>
                        DeÄŸer 5: Skor ~88% | DeÄŸer 10: Skor ~94% | DeÄŸer 20: Skor ~97%
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>ğŸ’¡ Ä°pucu:</strong><br>
                    <strong>Basit Mod:</strong> Her makronun kalori deÄŸeri baz alÄ±nÄ±r. Protein ve karb Ã—4 kcal/g, YaÄŸ Ã—9 kcal/g ile aÄŸÄ±rlÄ±klandÄ±rÄ±lÄ±r.<br>
                    <strong>GeliÅŸmiÅŸ Mod:</strong> AynÄ± gram farkÄ± bile oransal olarak deÄŸerlendirilir. 20g'dan 3g eksik (%15) ile 40g'dan 3g eksik (%7.5) farklÄ± skorlar alÄ±r.
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ·ï¸ Rozet GÃ¶sterimi</h2>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
                    Hasta panelindeki yemek satÄ±rlarÄ±nda hangi bilgi rozetlerinin gÃ¶sterileceÄŸini seÃ§in.
                </p>
                
                <div class="criteria-grid">
                    <!-- Role Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeRoleVisible" checked>
                            <span class="criteria-label">ğŸ‘¨â€ğŸ³ Rol Rozeti (Ana yemek, Ekmek, vb.)</span>
                        </label>
                    </div>

                    <!-- DietType Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeDietTypeVisible" checked>
                            <span class="criteria-label">ğŸ¥‘ Diyet Tipi Rozeti (Keto, Lowcarb)</span>
                        </label>
                    </div>

                    <!-- Category Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeCategoryVisible">
                            <span class="criteria-label">ğŸ“‚ Kategori Rozeti (Ã–ÄLEN, AKÅAM, vb.)</span>
                        </label>
                    </div>

                    <!-- Season Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeSeasonVisible">
                            <span class="criteria-label">ğŸŒ± Mevsim Rozeti</span>
                        </label>
                    </div>

                    <!-- MealType Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeMealTypeVisible">
                            <span class="criteria-label">ğŸ½ï¸ Ã–ÄŸÃ¼n Tipi Rozeti (Sabah, Ã–ÄŸle, AkÅŸam)</span>
                        </label>
                    </div>

                    <!-- Tags Badge -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="badgeTagsVisible">
                            <span class="criteria-label">ğŸ·ï¸ Tag Rozeti (tavuk, yumurta, vb.)</span>
                        </label>
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>ğŸ’¡ Ä°pucu:</strong> 
                    SeÃ§ilen rozetler hasta panelindeki yemek satÄ±rlarÄ±nda gÃ¶rÃ¼nÃ¼r. Ã‡ok fazla rozet ekranÄ± karmaÅŸÄ±klaÅŸtÄ±rabilir.
                </div>
            </section>
            
            <!-- Ã–zellik GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ AyarlarÄ± -->
            <section class="settings-section">
                <h2 class="section-title">ğŸ›ï¸ Ã–zellik GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼</h2>
                <p class="section-description">Hasta panelindeki buton ve Ã¶zelliklerin gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ yÃ¶netin</p>
                
                <div class="criteria-grid">
                    <!-- PDF Export Butonu -->
                    <div class="criteria-item">
                        <label class="criteria-checkbox">
                            <input type="checkbox" id="pdfExportVisible" checked>
                            <span class="criteria-label">ğŸ“„ PDF Ä°ndir Butonu</span>
                        </label>
                    </div>
                </div>
                
                <div class="info-hint" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; font-size: 12px; color: #3b82f6;">
                    <strong>ğŸ’¡ Ä°pucu:</strong> 
                    PDF butonu haftalÄ±k beslenme planÄ±nÄ± indirmek iÃ§in kullanÄ±lÄ±r. VarsayÄ±lan olarak aÃ§Ä±ktÄ±r.
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ“‹ Åablon YÃ¼kleme</h2>
                <div class="settings-row">
                    <label for="templateFileInput">GÃ¼n ÅablonlarÄ± JSON DosyasÄ±</label>
                    <input type="file" id="templateFileInput" accept=".json" style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 13px;">
                </div>
                <div class="settings-row">
                    <button class="btn-primary" id="uploadTemplatesButton" type="button" style="width: fit-content;">ğŸ“¥ ÅablonlarÄ± YÃ¼kle ve BirleÅŸtir</button>
                </div>
                <div class="settings-row">
                    <p style="font-size: 12px; color: #64748b; margin: 0;">
                        <strong>Not:</strong> YÃ¼klenen ÅŸablonlar mevcut ÅŸablonlarla birleÅŸtirilecek. AynÄ± ID'ye sahip ÅŸablonlar atlanacak, yeni ÅŸablonlar eklenecek. TÃ¼rkÃ§e karakterler korunacak.
                    </p>
                </div>
            </section>

            <section class="settings-section">
                <h2>GitHub EriÅŸimi</h2>
                <div class="settings-row">
                    <label for="githubTokenInput">KiÅŸisel EriÅŸim Token'Ä±</label>
                    <input type="password" id="githubTokenInput" placeholder="ghp_...">
                </div>
            </section>
        </main>

        <footer class="actions-row">
            <p class="status-text" id="statusText"><strong>HazÄ±r.</strong></p>
            <div class="actions-right">
                <button class="btn-secondary" id="clearTokenButton" type="button">Token Temizle</button>
                <button class="btn-secondary" id="reloadButton" type="button">AyarlarÄ± YÃ¼kle</button>
                <button class="btn-primary" id="saveSettingsButton" type="button">Kaydet</button>
            </div>
        </footer>
    </div>

    <script>
        const REPO_OWNER = 'mustafasacar35';
    const REPO_NAME = 'lipodem-takip-paneli';
        const SETTINGS_PATH = 'settings/config.json';
        const SETTINGS_BRANCH = 'main';
        const LOCAL_STORAGE_TOKEN_KEY = 'lipodemSettingsGithubToken';

        const defaultSettings = {
            version: 1,
            updatedAt: new Date().toISOString(),
            defaultAlternativeCount: 3,
            enableTagFilter: true,
            calorieTolerancePercent: 5,
            templateReuseWeeks: 4,
            tagExclusions: [],
            tagExemptions: {
                roles: [],
                categories: []
            },
            rotation: {
                enabled: true,
                chunkSize: 3
            },
            filterCriteria: {
                role: {
                    visible: true,
                    mode: 'optional',
                    defaultState: 'active'
                },
                dietType: {
                    visible: true,
                    mode: 'optional',
                    defaultState: 'inactive'
                },
                category: {
                    visible: false,
                    mode: 'optional',
                    defaultState: 'inactive'
                },
                season: {
                    visible: false,
                    mode: 'optional',
                    defaultState: 'inactive'
                },
                mealType: {
                    visible: false,
                    mode: 'optional',
                    defaultState: 'inactive'
                }
            },
            badgeVisibility: {
                role: false,
                dietType: false,
                category: false,
                season: false,
                mealType: false,
                tags: false
            },
            featureVisibility: {
                pdfExportButton: true
            },
            scoreCriteria: {
                activeByDefault: ['protein', 'fat']
            },
            dietFormulas: {
                ketojenik: {
                    carb: 0.3,
                    protein: 0.8,
                    fat: 1.2
                },
                lowcarb: {
                    carb: 0.6,
                    protein: 0.8,
                    fat: 1.0
                },
                akdeniz: {
                    carb: 0.6,
                    protein: 0.8,
                    fat: 1.0
                },
                activityMultipliers: {
                    1: 0.8,
                    2: 0.9,
                    3: 1.0,
                    4: 1.1,
                    5: 1.2
                }
            }
        };

        let appSettings = { ...defaultSettings };
        let settingsSha = null;
        let settingsDraft = null;
        let isSaving = false;
        let isLoading = false;
        let availableRoles = new Set();
        let availableCategories = new Set();

        const statusText = document.getElementById('statusText');
        const defaultAlternativeCountInput = document.getElementById('defaultAlternativeCountInput');
        const enableTagFilterInput = document.getElementById('enableTagFilterInput');
        const calorieToleranceInput = document.getElementById('calorieToleranceInput');
        const tagExclusionInput = document.getElementById('tagExclusionInput');
        const roleExclusionInput = document.getElementById('roleExclusionInput');
        const categoryExclusionInput = document.getElementById('categoryExclusionInput');
        const rotationEnabledInput = document.getElementById('rotationEnabledInput');
        
        // Diyet FormÃ¼lÃ¼ Input Elementleri
        const ketoCarb = document.getElementById('ketoCarb');
        const ketoProtein = document.getElementById('ketoProtein');
        const ketoFat = document.getElementById('ketoFat');
        const lowcarbCarb = document.getElementById('lowcarbCarb');
        const lowcarbProtein = document.getElementById('lowcarbProtein');
        const lowcarbFat = document.getElementById('lowcarbFat');
        const akdenizCarb = document.getElementById('akdenizCarb');
        const akdenizProtein = document.getElementById('akdenizProtein');
        const akdenizFat = document.getElementById('akdenizFat');
        const activity1 = document.getElementById('activity1');
        const activity2 = document.getElementById('activity2');
        const activity3 = document.getElementById('activity3');
        const activity4 = document.getElementById('activity4');
        const activity5 = document.getElementById('activity5');
        const rotationChunkSizeInput = document.getElementById('rotationChunkSizeInput');
        const rotationResetDayInput = document.getElementById('rotationResetDayInput');
        const githubTokenInput = document.getElementById('githubTokenInput');
        const clearTokenButton = document.getElementById('clearTokenButton');
        const reloadButton = document.getElementById('reloadButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const tagExclusionList = document.getElementById('tagExclusionList');
        const roleExclusionList = document.getElementById('roleExclusionList');
        const categoryExclusionList = document.getElementById('categoryExclusionList');
        const rolesDatalist = document.getElementById('rolesDatalist');
        const categoriesDatalist = document.getElementById('categoriesDatalist');
        const suggestionsPanel = document.getElementById('suggestionsPanel');
        const roleSuggestions = document.getElementById('roleSuggestions');
        const categorySuggestions = document.getElementById('categorySuggestions');
        const templateFileInput = document.getElementById('templateFileInput');
        const uploadTemplatesButton = document.getElementById('uploadTemplatesButton');

    // Admins UI refs
    const adminsListDiv = document.getElementById('adminsList');
    const adminEditUsername = document.getElementById('adminEditUsername');
    const adminEditPassword = document.getElementById('adminEditPassword');
    const adminEditRoles = document.getElementById('adminEditRoles');
    const adminSaveBtn = document.getElementById('adminSaveBtn');
    const adminClearBtn = document.getElementById('adminClearBtn');
    const patientAdminInput = document.getElementById('patientAdminInput');
    const patientAdminAddBtn = document.getElementById('patientAdminAddBtn');
    const patientAdminsList = document.getElementById('patientAdminsList');
    const saveAdminsFileBtn = document.getElementById('saveAdminsFileBtn');
    const forceReloginBtn = document.getElementById('forceReloginBtn');

        // Filtreleme Kriterleri Input ReferanslarÄ±
        const criteriaRoleVisible = document.getElementById('criteriaRoleVisible');
        const criteriaRoleMode = document.getElementById('criteriaRoleMode');
        const criteriaRoleDefault = document.getElementById('criteriaRoleDefault');
        const criteriaDietTypeVisible = document.getElementById('criteriaDietTypeVisible');
        const criteriaDietTypeMode = document.getElementById('criteriaDietTypeMode');
        const criteriaDietTypeDefault = document.getElementById('criteriaDietTypeDefault');
        const criteriaCategoryVisible = document.getElementById('criteriaCategoryVisible');
        const criteriaCategoryMode = document.getElementById('criteriaCategoryMode');
        const criteriaCategoryDefault = document.getElementById('criteriaCategoryDefault');
        const criteriaSeasonVisible = document.getElementById('criteriaSeasonVisible');
        const criteriaSeasonMode = document.getElementById('criteriaSeasonMode');
        const criteriaSeasonDefault = document.getElementById('criteriaSeasonDefault');
        const criteriaMealTypeVisible = document.getElementById('criteriaMealTypeVisible');
        const criteriaMealTypeMode = document.getElementById('criteriaMealTypeMode');
        const criteriaMealTypeDefault = document.getElementById('criteriaMealTypeDefault');

        // Benzerlik Skoru Kriterleri Input ReferanslarÄ±
        const scoreCriteriaCalories = document.getElementById('scoreCriteriaCalories');
        const scoreCriteriaProtein = document.getElementById('scoreCriteriaProtein');
        const scoreCriteriaCarbs = document.getElementById('scoreCriteriaCarbs');
        const scoreCriteriaFat = document.getElementById('scoreCriteriaFat');

        function fixTurkishChars(text) {
            if (!text || typeof text !== 'string') return text;
            let fixed = text;
            for (let i = 0; i < 2; i++) {
                try {
                    const decoded = decodeURIComponent(escape(fixed));
                    if (decoded === fixed) break;
                    fixed = decoded;
                } catch (error) {
                    break;
                }
            }

            const charMap = {
                'Ã„Â±': 'Ä±', 'Ã¤Â±': 'Ä±', 'ÃƒÂ‡': 'Ã‡', 'ÃƒÂ§': 'Ã§', 'Ã£â€¡': 'Ã‡', 'Ã£Â§': 'Ã§', 'Ã…Å¸': 'ÅŸ', 'Ã¥Å¸': 'ÅŸ',
                'Ã…Å¾': 'Å', 'Ã¥Å¾': 'Å', 'Ã„Â°': 'Ä°', 'Ã¤Â°': 'Ä°', 'ÃƒÂ¶': 'Ã¶', 'Ã£Â¶': 'Ã¶', 'Ãƒâ€“': 'Ã–', 'Ã£â€“': 'Ã–',
                'ÃƒÂ¼': 'Ã¼', 'Ã£Â¼': 'Ã¼', 'ÃƒÅ“': 'Ãœ', 'Ã£Å“': 'Ãœ', 'Ã„Å¸': 'ÄŸ', 'Ã¤Å¸': 'ÄŸ', 'Ã„Å¾': 'Ä', 'Ã¤Å¾': 'Ä',
                'ÃƒÂ„Ã‚Â±': 'Ä±', 'ÃƒÂ„Ã‚Â°': 'Ä°', 'ÃƒÂ„Ã‚ÂŸ': 'ÄŸ', 'ÃƒÂ„Ã‚Â': 'Ä', 'ÃƒÂ…Ã‚Å¸': 'ÅŸ', 'ÃƒÂ…Ã‚Â': 'Å', 'ÃƒÂƒÃ‚Â§': 'Ã§',
                'ÃƒÂƒÃ‚Â‡': 'Ã‡', 'ÃƒÂƒÃ‚Â¶': 'Ã¶', 'ÃƒÂƒÃ‚Â–': 'Ã–', 'ÃƒÂƒÃ‚Â¼': 'Ã¼', 'ÃƒÂƒÃ‚Âœ': 'Ãœ', 'ÃƒÂƒÃ‚Â½': 'Ä±', 'ÃƒÂƒÃ‚Â': 'Ä°',
                'ÃƒÂƒÃ‚Â±': 'Ã±', 'ÃƒÂƒÃ‚ÂŸ': 'ÃŸ', 'ÃƒÂƒÃ‚Â¿': 'Ã¿', 'ÃƒÂ—': '', 'Ã—': '', 'Ã‚': ' '
            };

            let previous;
            do {
                previous = fixed;
                for (const [wrong, correct] of Object.entries(charMap)) {
                    fixed = fixed.replace(new RegExp(wrong, 'g'), correct);
                }
            } while (fixed !== previous);

            return fixed;
        }

        function normalizeText(str) {
            if (!str) return '';
            const cleaned = fixTurkishChars(str);
            return cleaned
                .toLowerCase()
                .replace(/Ã§/g, 'c')
                .replace(/ÄŸ/g, 'g')
                .replace(/Ä±/g, 'i')
                .replace(/iÌ‡/g, 'i')
                .replace(/Ã¶/g, 'o')
                .replace(/ÅŸ/g, 's')
                .replace(/Ã¼/g, 'u')
                .replace(/[^a-z0-9]/g, '');
        }

        function sanitizeString(value) {
            if (typeof value !== 'string') return '';
            return fixTurkishChars(value).trim();
        }

        function sanitizeStringList(values) {
            if (!Array.isArray(values)) return [];
            const unique = new Set();
            const result = [];
            values.forEach(item => {
                const cleaned = sanitizeString(item);
                const normalized = normalizeText(cleaned);
                if (!cleaned || !normalized || unique.has(normalized)) return;
                unique.add(normalized);
                result.push(cleaned);
            });
            return result;
        }

        function showStatus(message, tone = 'info') {
            const palette = {
                success: '#059669',
                error: '#dc2626',
                info: '#475569'
            };
            statusText.textContent = message;
            statusText.style.color = palette[tone] || palette.info;
        }
        // ---------- Admins helpers ----------
        function getActiveAdminName(){
            try { return (window.AdminAuth && AdminAuth.getSession && AdminAuth.getSession()) ? (AdminAuth.getSession().username) : ''; }
            catch(_) { return ''; }
        }
        function renderActiveAdmin(){
            const u = getActiveAdminName();
            const el = document.getElementById('activeAdminBadge');
            if (el) el.textContent = u ? `Admin: ${u}` : 'â€”';
        }

        // ---------- Admins state ----------
        const ADMINS_PATH = 'settings/admins.js';
        let ghAdmins = { admins: [], patientAdmins: [] };
        let adminsSha = null;
        let editingAdminIndex = -1; // -1 => create, >=0 => edit

        function clone(obj){ return JSON.parse(JSON.stringify(obj || {})); }
        function toRolesArray(val){
            if (Array.isArray(val)) return val.map(v=>sanitizeString(v)).filter(Boolean);
            if (typeof val === 'string') return val.split(',').map(v=>sanitizeString(v)).filter(Boolean);
            return [];
        }
        function usernamesEqual(a,b){ return normalizeText(a) === normalizeText(b); }
        function findAdminIndexByUsername(username){
            const n = normalizeText(username);
            return (ghAdmins.admins||[]).findIndex(a => normalizeText(a.username) === n);
        }
        function ensureGhAdminsShape(){
            if (!ghAdmins || typeof ghAdmins !== 'object') ghAdmins = { admins: [], patientAdmins: [] };
            if (!Array.isArray(ghAdmins.admins)) ghAdmins.admins = [];
            if (!Array.isArray(ghAdmins.patientAdmins)) ghAdmins.patientAdmins = [];
        }
        function loadAdminsRuntime(){
            try { ghAdmins = clone(window.GH_ADMINS || { admins: [], patientAdmins: [] }); }
            catch(_) { ghAdmins = { admins: [], patientAdmins: [] }; }
            ensureGhAdminsShape();
        }
        async function fetchAdminsSha(){
            try{
                const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${ADMINS_PATH}?ref=${SETTINGS_BRANCH}`;
                const res = await fetch(url);
                if (res.ok){ const data = await res.json(); adminsSha = data.sha || null; }
            } catch(_) { adminsSha = null; }
        }
        function parseAdminsFromRawText(text){
            try{
                const idx = text.indexOf('window.GH_ADMINS');
                if (idx === -1) return null;
                const eq = text.indexOf('=', idx);
                if (eq === -1) return null;
                const startObj = text.indexOf('{', eq);
                const endObj = text.lastIndexOf('}');
                if (startObj === -1 || endObj === -1 || endObj <= startObj) return null;
                const jsonStr = text.substring(startObj, endObj + 1);
                const obj = JSON.parse(jsonStr);
                if (!obj || !Array.isArray(obj.admins)) return null;
                return obj;
            }catch(_){ return null; }
        }
        async function fetchRemoteAdminsObject(){
            try{
                const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${SETTINGS_BRANCH}/${ADMINS_PATH}?t=${Date.now()}`, { cache: 'no-store' });
                if (!res.ok) return null;
                const txt = await res.text();
                return parseAdminsFromRawText(txt);
            }catch(_){ return null; }
        }
        function renderAdminsList(){
            adminsListDiv.innerHTML = '';
            ensureGhAdminsShape();
            const list = ghAdmins.admins;
            if (!list.length){
                adminsListDiv.innerHTML = '<span class="empty-hint">HenÃ¼z yÃ¶netici yok.</span>';
                return;
            }
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="text-align:left;padding:6px;">KullanÄ±cÄ±</th>
                        <th style="text-align:left;padding:6px;">Roller</th>
                        <th style="text-align:right;padding:6px;">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            list.forEach((a, idx)=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:6px;border-top:1px solid #e5e7eb;">${a.username}</td>
                    <td style="padding:6px;border-top:1px solid #e5e7eb;">${(a.roles||[]).join(', ')}</td>
                    <td style="padding:6px;border-top:1px solid #e5e7eb;text-align:right;">
                        <button type="button" class="btn-secondary" data-action="edit">DÃ¼zenle</button>
                        <button type="button" class="btn-secondary" data-action="delete">Sil</button>
                    </td>`;
                tr.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
                    editAdminAt(idx);
                });
                tr.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
                    if (confirm(`${a.username} silinsin mi?`)){
                        ghAdmins.admins.splice(idx,1);
                        renderAdminsList();
                    }
                });
                tbody.appendChild(tr);
            });
            adminsListDiv.appendChild(table);
        }
        function renderPatientAdmins(){
            ensureGhAdminsShape();
            renderChipList(patientAdminsList, ghAdmins.patientAdmins, (value)=>{
                ghAdmins.patientAdmins = ghAdmins.patientAdmins.filter(v => normalizeText(v) !== normalizeText(value));
                renderPatientAdmins();
            });
        }
        function clearAdminForm(){
            editingAdminIndex = -1;
            adminEditUsername.value = '';
            adminEditPassword.value = '';
            adminEditRoles.value = '';
        }
        function editAdminAt(index){
            ensureGhAdminsShape();
            const a = ghAdmins.admins[index];
            if (!a) return;
            editingAdminIndex = index;
            adminEditUsername.value = a.username || '';
            adminEditPassword.value = '';
            adminEditRoles.value = (a.roles||[]).join(', ');
        }
        async function computeSha256Hex(val){
            if (!val) return '';
            try{
                if (window.AdminAuth && typeof AdminAuth.sha256Hex === 'function'){
                    return await AdminAuth.sha256Hex(val);
                }
            }catch(_){/* ignore */}
            if (window.crypto && crypto.subtle && window.TextEncoder){
                const enc = new TextEncoder();
                const buf = await crypto.subtle.digest('SHA-256', enc.encode(val));
                return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
            }
            throw new Error('Åifre karmasÄ± iÃ§in uygun bir yÃ¶ntem bulunamadÄ±. LÃ¼tfen AdminAuth skripti yÃ¼klÃ¼ olsun.');
        }
        function upsertAdminFromForm(){
            ensureGhAdminsShape();
            const username = sanitizeString(adminEditUsername.value);
            const roles = toRolesArray(adminEditRoles.value);
            const newPassword = adminEditPassword.value;
            if (!username){ showStatus('KullanÄ±cÄ± adÄ± girin.', 'error'); return; }

            // Duplicate check (case/diacritics insensitive)
            const existingIdx = findAdminIndexByUsername(username);
            if (editingAdminIndex === -1 && existingIdx !== -1){
                showStatus('Bu kullanÄ±cÄ± zaten mevcut.', 'error');
                return;
            }
            if (editingAdminIndex >= 0){
                const otherIdx = existingIdx;
                if (otherIdx !== -1 && otherIdx !== editingAdminIndex){
                    showStatus('Bu kullanÄ±cÄ± adÄ± baÅŸka bir kayÄ±tta var.', 'error');
                    return;
                }
            }

            const apply = async ()=>{
                if (editingAdminIndex === -1){
                    const admin = { username, roles };
                    if (newPassword){ admin.passwordHash = await computeSha256Hex(newPassword); }
                    else { showStatus('Yeni admin iÃ§in ÅŸifre girilmeli.', 'error'); return; }
                    ghAdmins.admins.push(admin);
                } else {
                    const target = ghAdmins.admins[editingAdminIndex];
                    target.username = username;
                    target.roles = roles;
                    if (newPassword){ target.passwordHash = await computeSha256Hex(newPassword); }
                }
                clearAdminForm();
                renderAdminsList();
                showStatus('Admin kaydÄ± hazÄ±rlandÄ± (henÃ¼z kaydetmediniz).', 'success');
            };
            apply().catch(err=> showStatus(err.message || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z.', 'error'));
        }
        function addPatientAdmin(){
            ensureGhAdminsShape();
            const val = sanitizeString(patientAdminInput.value);
            if (!val) return;
            const exists = ghAdmins.patientAdmins.some(v => normalizeText(v) === normalizeText(val));
            if (!exists){ ghAdmins.patientAdmins.push(val); renderPatientAdmins(); showStatus('Hasta admin eklendi (henÃ¼z kaydetmediniz).', 'success'); }
            patientAdminInput.value = '';
        }
        function reloadRemoteAdminsConfig(){
            try{
                const s = document.createElement('script');
                s.src = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${SETTINGS_BRANCH}/${ADMINS_PATH}?t=${Date.now()}`;
                s.onload = ()=>{ try { loadAdminsRuntime(); renderAdminsList(); renderPatientAdmins(); showStatus('Uzaktan admins.js yeniden yÃ¼klendi.', 'info'); } catch(_){} };
                s.onerror = ()=>{};
                document.head.appendChild(s);
            }catch(_){/* noop */}
        }
        async function ensureAdminsSha(){
            if (!adminsSha){ await fetchAdminsSha(); }
        }
        async function saveAdminsToGitHub(){
            const token = githubTokenInput.value.trim();
            if (!token){ showStatus('Admins dosyasÄ±nÄ± kaydetmek iÃ§in GitHub token gerekli.', 'error'); return; }
            ensureGhAdminsShape();
            const contentJs = `window.GH_ADMINS = ${JSON.stringify(ghAdmins, null, 2)};\n`;
            const endpoint = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${ADMINS_PATH}`;
            const encoded = btoa(unescape(encodeURIComponent(contentJs)));
            const body = { message: 'Admin panelinden admins.js gÃ¼ncellemesi', content: encoded, branch: SETTINGS_BRANCH };
            await ensureAdminsSha();
            if (adminsSha) body.sha = adminsSha;
            try{
                saveAdminsFileBtn.disabled = true;
                saveAdminsFileBtn.textContent = 'Kaydediliyor...';
                showStatus('admins.js GitHub Ã¼zerinde gÃ¼ncelleniyor...', 'info');
                let res = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github+json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                if (!res.ok){
                    // OlasÄ± sha hatasÄ±nda bir kez daha dene
                    const firstErr = await res.json().catch(()=>({}));
                    if (res.status === 409 || String(firstErr?.message||'').toLowerCase().includes('sha')){
                        await fetchAdminsSha();
                        const retryBody = { ...body, sha: adminsSha };
                        res = await fetch(endpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github+json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(retryBody)
                        });
                    }
                }
                if (!res.ok){
                    const eb = await res.json().catch(()=>({}));
                    throw new Error(eb.message || `Hata: ${res.status}`);
                }
                const data = await res.json();
                adminsSha = data.content?.sha || adminsSha;
                showStatus('admins.js kaydedildi. DoÄŸrulanÄ±yor...', 'success');
                // DoÄŸrula ve gerekirse uzaktan konfigi yeniden yÃ¼kle
                try{
                    const verifyRes = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${SETTINGS_BRANCH}/${ADMINS_PATH}?t=${Date.now()}`);
                    if (verifyRes.ok){
                        const txt = await verifyRes.text();
                        const anyUser = (ghAdmins.admins[ghAdmins.admins.length-1]||{}).username || '';
                        if (anyUser && txt.includes(anyUser)){
                            showStatus('DeÄŸiÅŸiklik doÄŸrulandÄ± ve yansÄ±tÄ±ldÄ±.', 'success');
                        } else {
                            showStatus('Kaydedildi ancak tarayÄ±cÄ± Ã¶nbelleÄŸi olabilir. SayfayÄ± yenileyin.', 'info');
                        }
                    }
                }catch(_){/* ignore */}
                reloadRemoteAdminsConfig();
            }catch(err){
                showStatus(err.message || 'admins.js kaydedilemedi.', 'error');
            } finally {
                saveAdminsFileBtn.disabled = false;
                saveAdminsFileBtn.textContent = 'Admins DosyasÄ±nÄ± Kaydet';
            }
        }
        function attachAdminsUIHandlers(){
            if (adminSaveBtn) adminSaveBtn.addEventListener('click', upsertAdminFromForm);
            if (adminClearBtn) adminClearBtn.addEventListener('click', clearAdminForm);
            if (patientAdminAddBtn) patientAdminAddBtn.addEventListener('click', addPatientAdmin);
            if (patientAdminInput) patientAdminInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); addPatientAdmin(); } });
            if (saveAdminsFileBtn) saveAdminsFileBtn.addEventListener('click', saveAdminsToGitHub);
            if (forceReloginBtn) forceReloginBtn.addEventListener('click', ()=>{
                const u = new URL(location.href);
                u.searchParams.set('relogin','1');
                location.href = u.toString();
            });
        }

        function setLoadingState(active) {
            isLoading = active;
            const disabled = active || isSaving;
            [defaultAlternativeCountInput, enableTagFilterInput, tagExclusionInput,
                roleExclusionInput, categoryExclusionInput, rotationEnabledInput,
                rotationChunkSizeInput, rotationResetDayInput, githubTokenInput,
                saveSettingsButton, reloadButton, clearTokenButton]
                .forEach(element => {
                    element.disabled = !!disabled;
                    if (element.tagName === 'INPUT' && element.type !== 'checkbox') {
                        element.classList.toggle('disabled', !!disabled && element !== githubTokenInput);
                    }
                });
        }

        function setSavingState(active) {
            isSaving = active;
            const disabled = active || isLoading;
            saveSettingsButton.disabled = !!disabled;
            reloadButton.disabled = !!disabled;
        }

        function ensureSorted(values) {
            return values.sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
        }

        function renderChipList(container, values, onRemove) {
            container.innerHTML = '';
            if (!values || values.length === 0) {
                const hint = document.createElement('span');
                hint.className = 'empty-hint';
                hint.textContent = 'HenÃ¼z eklenmedi.';
                container.appendChild(hint);
                return;
            }
            const sanitized = sanitizeStringList(values);
            ensureSorted(sanitized);
            sanitized.forEach(value => {
                const chip = document.createElement('span');
                chip.className = 'settings-chip';
                chip.textContent = value;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Ã—';
                removeBtn.setAttribute('aria-label', `${value} kaydÄ±nÄ± sil`);
                removeBtn.addEventListener('click', () => onRemove(value));
                chip.appendChild(removeBtn);
                container.appendChild(chip);
            });
        }

        function addValueToList(list, rawValue) {
            if (!rawValue) return false;
            const trimmed = sanitizeString(rawValue);
            if (!trimmed) return false;
            const normalized = normalizeText(trimmed);
            if (!normalized) return false;
            const exists = list.some(item => normalizeText(item) === normalized);
            if (exists) return false;
            list.push(trimmed);
            return true;
        }

        function buildSettingsDraft() {
            const rotation = appSettings.rotation || {};
            const filterCriteria = appSettings.filterCriteria || {};
            
            return {
                defaultAlternativeCount: Number.isFinite(appSettings.defaultAlternativeCount) ? appSettings.defaultAlternativeCount : 3,
                enableTagFilter: !!appSettings.enableTagFilter,
                calorieTolerancePercent: Number.isFinite(appSettings.calorieTolerancePercent) ? appSettings.calorieTolerancePercent : 5,
                templateReuseWeeks: Number.isFinite(appSettings.templateReuseWeeks) ? appSettings.templateReuseWeeks : 4,
                tagExclusions: sanitizeStringList(Array.isArray(appSettings.tagExclusions) ? appSettings.tagExclusions : []),
                tagExemptions: {
                    roles: sanitizeStringList(Array.isArray(appSettings.tagExemptions?.roles) ? appSettings.tagExemptions.roles : []),
                    categories: sanitizeStringList(Array.isArray(appSettings.tagExemptions?.categories) ? appSettings.tagExemptions.categories : [])
                },
                rotation: {
                    enabled: rotation.enabled !== undefined ? !!rotation.enabled : true,
                    chunkSize: Number.isFinite(rotation.chunkSize) && rotation.chunkSize > 0 ? rotation.chunkSize : 3,
                    resetDay: Number.isFinite(rotation.resetDay) ? rotation.resetDay : ''
                },
                filterCriteria: {
                    role: {
                        visible: filterCriteria.role?.visible !== undefined ? !!filterCriteria.role.visible : true,
                        mode: filterCriteria.role?.mode || 'optional',
                        defaultState: filterCriteria.role?.defaultState || 'active'
                    },
                    dietType: {
                        visible: filterCriteria.dietType?.visible !== undefined ? !!filterCriteria.dietType.visible : true,
                        mode: filterCriteria.dietType?.mode || 'optional',
                        defaultState: filterCriteria.dietType?.defaultState || 'inactive'
                    },
                    category: {
                        visible: filterCriteria.category?.visible !== undefined ? !!filterCriteria.category.visible : false,
                        mode: filterCriteria.category?.mode || 'optional',
                        defaultState: filterCriteria.category?.defaultState || 'inactive'
                    },
                    season: {
                        visible: filterCriteria.season?.visible !== undefined ? !!filterCriteria.season.visible : false,
                        mode: filterCriteria.season?.mode || 'optional',
                        defaultState: filterCriteria.season?.defaultState || 'inactive'
                    },
                    mealType: {
                        visible: filterCriteria.mealType?.visible !== undefined ? !!filterCriteria.mealType.visible : false,
                        mode: filterCriteria.mealType?.mode || 'optional',
                        defaultState: filterCriteria.mealType?.defaultState || 'inactive'
                    }
                },
                badgeVisibility: {
                    role: appSettings.badgeVisibility?.role !== undefined ? appSettings.badgeVisibility.role : true,
                    dietType: appSettings.badgeVisibility?.dietType !== undefined ? appSettings.badgeVisibility.dietType : true,
                    category: appSettings.badgeVisibility?.category !== undefined ? appSettings.badgeVisibility.category : false,
                    season: appSettings.badgeVisibility?.season !== undefined ? appSettings.badgeVisibility.season : false,
                    mealType: appSettings.badgeVisibility?.mealType !== undefined ? appSettings.badgeVisibility.mealType : false,
                    tags: appSettings.badgeVisibility?.tags !== undefined ? appSettings.badgeVisibility.tags : false
                },
                featureVisibility: {
                    pdfExportButton: appSettings.featureVisibility?.pdfExportButton !== undefined ? appSettings.featureVisibility.pdfExportButton : true
                },
                scoreCriteria: {
                    activeByDefault: appSettings.scoreCriteria?.activeByDefault ?? ['protein', 'fat']
                },
                scoringMode: appSettings.scoringMode || 'simple',
                sensitivityDivider: appSettings.sensitivityDivider || 10,
                dietFormulas: {
                    ketojenik: {
                        carb: appSettings.dietFormulas?.ketojenik?.carb ?? 0.3,
                        protein: appSettings.dietFormulas?.ketojenik?.protein ?? 0.8,
                        fat: appSettings.dietFormulas?.ketojenik?.fat ?? 1.2
                    },
                    lowcarb: {
                        carb: appSettings.dietFormulas?.lowcarb?.carb ?? 0.6,
                        protein: appSettings.dietFormulas?.lowcarb?.protein ?? 0.8,
                        fat: appSettings.dietFormulas?.lowcarb?.fat ?? 1.0
                    },
                    activityMultipliers: {
                        1: appSettings.dietFormulas?.activityMultipliers?.[1] ?? 0.8,
                        2: appSettings.dietFormulas?.activityMultipliers?.[2] ?? 0.9,
                        3: appSettings.dietFormulas?.activityMultipliers?.[3] ?? 1.0,
                        4: appSettings.dietFormulas?.activityMultipliers?.[4] ?? 1.1,
                        5: appSettings.dietFormulas?.activityMultipliers?.[5] ?? 1.2
                    }
                }
            };
        }

        function populateSettingsForm() {
            // GitHub'dan yÃ¼klenen appSettings'i kullan
            console.log('ğŸ“¥ populateSettingsForm - appSettings:', appSettings);
            settingsDraft = buildSettingsDraft(); // appSettings'den oluÅŸtur
            
            console.log('âœ… settingsDraft oluÅŸturuldu:', {
                scoringMode: settingsDraft.scoringMode,
                badgeVisibility: settingsDraft.badgeVisibility,
                scoreCriteria: settingsDraft.scoreCriteria
            });
            
            defaultAlternativeCountInput.value = settingsDraft.defaultAlternativeCount;
            enableTagFilterInput.checked = settingsDraft.enableTagFilter;
            calorieToleranceInput.value = settingsDraft.calorieTolerancePercent;
            const templateReuseInput = document.getElementById('templateReuseWeeksInput');
            if (templateReuseInput) templateReuseInput.value = settingsDraft.templateReuseWeeks;
            rotationEnabledInput.checked = settingsDraft.rotation.enabled;
            rotationChunkSizeInput.value = settingsDraft.rotation.chunkSize;
            rotationResetDayInput.value = settingsDraft.rotation.resetDay === '' ? '' : settingsDraft.rotation.resetDay;
            githubTokenInput.value = getStoredToken();

            // Diyet FormÃ¼l AyarlarÄ±nÄ± Doldur
            if (settingsDraft.dietFormulas) {
                ketoCarb.value = settingsDraft.dietFormulas.ketojenik.carb;
                ketoProtein.value = settingsDraft.dietFormulas.ketojenik.protein;
                ketoFat.value = settingsDraft.dietFormulas.ketojenik.fat;
                lowcarbCarb.value = settingsDraft.dietFormulas.lowcarb.carb;
                lowcarbProtein.value = settingsDraft.dietFormulas.lowcarb.protein;
                lowcarbFat.value = settingsDraft.dietFormulas.lowcarb.fat;
                akdenizCarb.value = settingsDraft.dietFormulas.akdeniz?.carb ?? 0.6;
                akdenizProtein.value = settingsDraft.dietFormulas.akdeniz?.protein ?? 0.8;
                akdenizFat.value = settingsDraft.dietFormulas.akdeniz?.fat ?? 1.0;
                activity1.value = settingsDraft.dietFormulas.activityMultipliers[1];
                activity2.value = settingsDraft.dietFormulas.activityMultipliers[2];
                activity3.value = settingsDraft.dietFormulas.activityMultipliers[3];
                activity4.value = settingsDraft.dietFormulas.activityMultipliers[4];
                activity5.value = settingsDraft.dietFormulas.activityMultipliers[5];
            }

            // Filtreleme Kriterleri AyarlarÄ±nÄ± Doldur
            if (settingsDraft.filterCriteria) {
                criteriaRoleVisible.checked = settingsDraft.filterCriteria.role?.visible ?? true;
                criteriaRoleMode.value = settingsDraft.filterCriteria.role?.mode ?? 'optional';
                criteriaRoleDefault.value = settingsDraft.filterCriteria.role?.defaultState ?? 'active';
                
                criteriaDietTypeVisible.checked = settingsDraft.filterCriteria.dietType?.visible ?? true;
                criteriaDietTypeMode.value = settingsDraft.filterCriteria.dietType?.mode ?? 'optional';
                criteriaDietTypeDefault.value = settingsDraft.filterCriteria.dietType?.defaultState ?? 'inactive';
                
                criteriaCategoryVisible.checked = settingsDraft.filterCriteria.category?.visible ?? false;
                criteriaCategoryMode.value = settingsDraft.filterCriteria.category?.mode ?? 'optional';
                criteriaCategoryDefault.value = settingsDraft.filterCriteria.category?.defaultState ?? 'inactive';
                
                criteriaSeasonVisible.checked = settingsDraft.filterCriteria.season?.visible ?? false;
                criteriaSeasonMode.value = settingsDraft.filterCriteria.season?.mode ?? 'optional';
                criteriaSeasonDefault.value = settingsDraft.filterCriteria.season?.defaultState ?? 'inactive';
                
                criteriaMealTypeVisible.checked = settingsDraft.filterCriteria.mealType?.visible ?? false;
                criteriaMealTypeMode.value = settingsDraft.filterCriteria.mealType?.mode ?? 'optional';
                criteriaMealTypeDefault.value = settingsDraft.filterCriteria.mealType?.defaultState ?? 'inactive';
            }

            // Rozet GÃ¶sterimi AyarlarÄ±nÄ± Doldur - GitHub'dan gelen deÄŸerleri kullan
            if (settingsDraft.badgeVisibility) {
                // Nullish coalescing kullanma - GitHub'daki false deÄŸerleri korumak iÃ§in
                document.getElementById('badgeRoleVisible').checked = settingsDraft.badgeVisibility.role === true;
                document.getElementById('badgeDietTypeVisible').checked = settingsDraft.badgeVisibility.dietType === true;
                document.getElementById('badgeCategoryVisible').checked = settingsDraft.badgeVisibility.category === true;
                document.getElementById('badgeSeasonVisible').checked = settingsDraft.badgeVisibility.season === true;
                document.getElementById('badgeMealTypeVisible').checked = settingsDraft.badgeVisibility.mealType === true;
                document.getElementById('badgeTagsVisible').checked = settingsDraft.badgeVisibility.tags === true;
            } else {
                // badgeVisibility yoksa tÃ¼m rozetleri kapat
                document.getElementById('badgeRoleVisible').checked = false;
                document.getElementById('badgeDietTypeVisible').checked = false;
                document.getElementById('badgeCategoryVisible').checked = false;
                document.getElementById('badgeSeasonVisible').checked = false;
                document.getElementById('badgeMealTypeVisible').checked = false;
                document.getElementById('badgeTagsVisible').checked = false;
            }
            
            // Ã–zellik GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ AyarlarÄ±nÄ± Doldur
            if (settingsDraft.featureVisibility) {
                document.getElementById('pdfExportVisible').checked = settingsDraft.featureVisibility.pdfExportButton === true;
            } else {
                document.getElementById('pdfExportVisible').checked = true; // VarsayÄ±lan aÃ§Ä±k
            }

            // Benzerlik Skoru Kriterleri AyarlarÄ±nÄ± Doldur
            if (settingsDraft.scoreCriteria && Array.isArray(settingsDraft.scoreCriteria.activeByDefault)) {
                const activeScoreCriteria = settingsDraft.scoreCriteria.activeByDefault;
                scoreCriteriaCalories.checked = activeScoreCriteria.includes('calories');
                scoreCriteriaProtein.checked = activeScoreCriteria.includes('protein');
                scoreCriteriaCarbs.checked = activeScoreCriteria.includes('carbs');
                scoreCriteriaFat.checked = activeScoreCriteria.includes('fat');
            } else {
                // VarsayÄ±lan: protein ve fat aktif
                scoreCriteriaCalories.checked = false;
                scoreCriteriaProtein.checked = true;
                scoreCriteriaCarbs.checked = false;
                scoreCriteriaFat.checked = true;
            }
            
            // Benzerlik Hesaplama Modu AyarlarÄ±nÄ± Doldur
            const scoringModeSimple = document.getElementById('scoringModeSimple');
            const scoringModeAdvanced = document.getElementById('scoringModeAdvanced');
            const sensitivitySlider = document.getElementById('sensitivityDivider');
            const sensitivityValueSpan = document.getElementById('sensitivityValue');
            
            const mode = settingsDraft.scoringMode || 'simple';
            if (scoringModeSimple && scoringModeAdvanced) {
                if (mode === 'advanced') {
                    scoringModeAdvanced.checked = true;
                } else {
                    scoringModeSimple.checked = true;
                }
            }
            
            if (sensitivitySlider && sensitivityValueSpan) {
                const dividerValue = settingsDraft.sensitivityDivider || 10;
                sensitivitySlider.value = dividerValue;
                sensitivityValueSpan.textContent = dividerValue;
            }
            
            // Sensitivity container gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ gÃ¼ncelle
            const sensitivityContainer = document.getElementById('sensitivityContainer');
            if (sensitivityContainer) {
                sensitivityContainer.style.display = mode === 'advanced' ? 'block' : 'none';
            }

            renderChipList(tagExclusionList, settingsDraft.tagExclusions, removeTagExclusion);
            renderChipList(roleExclusionList, settingsDraft.tagExemptions.roles, removeRoleExclusion);
            renderChipList(categoryExclusionList, settingsDraft.tagExemptions.categories, removeCategoryExclusion);

            updateRotationFieldStates();
        }

        function removeTagExclusion(value) {
            if (!settingsDraft) return;
            settingsDraft.tagExclusions = settingsDraft.tagExclusions.filter(item => normalizeText(item) !== normalizeText(value));
            renderChipList(tagExclusionList, settingsDraft.tagExclusions, removeTagExclusion);
        }

        function removeRoleExclusion(value) {
            if (!settingsDraft) return;
            settingsDraft.tagExemptions.roles = settingsDraft.tagExemptions.roles.filter(item => normalizeText(item) !== normalizeText(value));
            renderChipList(roleExclusionList, settingsDraft.tagExemptions.roles, removeRoleExclusion);
        }

        function removeCategoryExclusion(value) {
            if (!settingsDraft) return;
            settingsDraft.tagExemptions.categories = settingsDraft.tagExemptions.categories.filter(item => normalizeText(item) !== normalizeText(value));
            renderChipList(categoryExclusionList, settingsDraft.tagExemptions.categories, removeCategoryExclusion);
        }

        function collectPayloadFromForm() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const parsedDefault = parseInt(defaultAlternativeCountInput.value, 10);
            const parsedChunk = parseInt(rotationChunkSizeInput.value, 10);
            const parsedReset = rotationResetDayInput.value === '' ? '' : parseInt(rotationResetDayInput.value, 10);
            const parsedTolerance = parseInt(calorieToleranceInput.value, 10);
            const templateReuseInput = document.getElementById('templateReuseWeeksInput');
            const parsedTemplateReuse = parseInt(templateReuseInput?.value, 10);

            settingsDraft.defaultAlternativeCount = Number.isFinite(parsedDefault) && parsedDefault > 0 ? parsedDefault : 3;
            settingsDraft.enableTagFilter = enableTagFilterInput.checked;
            settingsDraft.calorieTolerancePercent = Number.isFinite(parsedTolerance) && parsedTolerance >= 0 ? parsedTolerance : 5;
            settingsDraft.templateReuseWeeks = Number.isFinite(parsedTemplateReuse) && parsedTemplateReuse >= 1 ? parsedTemplateReuse : 4;
            settingsDraft.rotation.enabled = rotationEnabledInput.checked;
            settingsDraft.rotation.chunkSize = Number.isFinite(parsedChunk) && parsedChunk > 0 ? parsedChunk : settingsDraft.defaultAlternativeCount;
            settingsDraft.rotation.resetDay = Number.isFinite(parsedReset) && parsedReset >= 0 && parsedReset <= 6 ? parsedReset : '';

            // Filtreleme Kriterleri GÃ¼ncelle
            settingsDraft.filterCriteria.role.visible = criteriaRoleVisible.checked;
            settingsDraft.filterCriteria.role.mode = criteriaRoleMode.value;
            settingsDraft.filterCriteria.role.defaultState = criteriaRoleDefault.value;
            
            settingsDraft.filterCriteria.dietType.visible = criteriaDietTypeVisible.checked;
            settingsDraft.filterCriteria.dietType.mode = criteriaDietTypeMode.value;
            settingsDraft.filterCriteria.dietType.defaultState = criteriaDietTypeDefault.value;
            
            settingsDraft.filterCriteria.category.visible = criteriaCategoryVisible.checked;
            settingsDraft.filterCriteria.category.mode = criteriaCategoryMode.value;
            settingsDraft.filterCriteria.category.defaultState = criteriaCategoryDefault.value;
            
            settingsDraft.filterCriteria.season.visible = criteriaSeasonVisible.checked;
            settingsDraft.filterCriteria.season.mode = criteriaSeasonMode.value;
            settingsDraft.filterCriteria.season.defaultState = criteriaSeasonDefault.value;
            
            settingsDraft.filterCriteria.mealType.visible = criteriaMealTypeVisible.checked;
            settingsDraft.filterCriteria.mealType.mode = criteriaMealTypeMode.value;
            settingsDraft.filterCriteria.mealType.defaultState = criteriaMealTypeDefault.value;

            // Benzerlik Skoru Kriterleri GÃ¼ncelle
            const activeScoreCriteria = [];
            if (scoreCriteriaCalories.checked) activeScoreCriteria.push('calories');
            if (scoreCriteriaProtein.checked) activeScoreCriteria.push('protein');
            if (scoreCriteriaCarbs.checked) activeScoreCriteria.push('carbs');
            if (scoreCriteriaFat.checked) activeScoreCriteria.push('fat');
            settingsDraft.scoreCriteria = {
                activeByDefault: activeScoreCriteria
            };
            
            // Benzerlik Hesaplama Modu GÃ¼ncelle
            const scoringModeSimple = document.getElementById('scoringModeSimple');
            const scoringModeAdvanced = document.getElementById('scoringModeAdvanced');
            const sensitivitySlider = document.getElementById('sensitivityDivider');
            
            settingsDraft.scoringMode = scoringModeAdvanced && scoringModeAdvanced.checked ? 'advanced' : 'simple';
            settingsDraft.sensitivityDivider = sensitivitySlider ? parseInt(sensitivitySlider.value, 10) : 10;

            // Diyet FormÃ¼lleri GÃ¼ncelle
            settingsDraft.dietFormulas.ketojenik.carb = parseFloat(ketoCarb.value) || 0.3;
            settingsDraft.dietFormulas.ketojenik.protein = parseFloat(ketoProtein.value) || 0.8;
            settingsDraft.dietFormulas.ketojenik.fat = parseFloat(ketoFat.value) || 1.2;
            settingsDraft.dietFormulas.lowcarb.carb = parseFloat(lowcarbCarb.value) || 0.6;
            settingsDraft.dietFormulas.lowcarb.protein = parseFloat(lowcarbProtein.value) || 0.8;
            settingsDraft.dietFormulas.lowcarb.fat = parseFloat(lowcarbFat.value) || 1.0;
            settingsDraft.dietFormulas.akdeniz.carb = parseFloat(akdenizCarb.value) || 0.6;
            settingsDraft.dietFormulas.akdeniz.protein = parseFloat(akdenizProtein.value) || 0.8;
            settingsDraft.dietFormulas.akdeniz.fat = parseFloat(akdenizFat.value) || 1.0;
            settingsDraft.dietFormulas.activityMultipliers[1] = parseFloat(activity1.value) || 0.8;
            settingsDraft.dietFormulas.activityMultipliers[2] = parseFloat(activity2.value) || 0.9;
            settingsDraft.dietFormulas.activityMultipliers[3] = parseFloat(activity3.value) || 1.0;
            settingsDraft.dietFormulas.activityMultipliers[4] = parseFloat(activity4.value) || 1.1;
            settingsDraft.dietFormulas.activityMultipliers[5] = parseFloat(activity5.value) || 1.2;

            const rotationPayload = {
                enabled: settingsDraft.rotation.enabled,
                chunkSize: settingsDraft.rotation.chunkSize
            };
            if (settingsDraft.rotation.resetDay !== '') {
                rotationPayload.resetDay = settingsDraft.rotation.resetDay;
            }

            // Rozet GÃ¶rÃ¼nÃ¼rlÃ¼k AyarlarÄ±nÄ± Topla
            const badgeVisibilityPayload = {
                role: document.getElementById('badgeRoleVisible')?.checked ?? true,
                dietType: document.getElementById('badgeDietTypeVisible')?.checked ?? true,
                category: document.getElementById('badgeCategoryVisible')?.checked ?? false,
                season: document.getElementById('badgeSeasonVisible')?.checked ?? false,
                mealType: document.getElementById('badgeMealTypeVisible')?.checked ?? false,
                tags: document.getElementById('badgeTagsVisible')?.checked ?? false
            };

            return {
                ...appSettings,
                defaultAlternativeCount: settingsDraft.defaultAlternativeCount,
                enableTagFilter: settingsDraft.enableTagFilter,
                calorieTolerancePercent: settingsDraft.calorieTolerancePercent,
                templateReuseWeeks: settingsDraft.templateReuseWeeks,
                tagExclusions: sanitizeStringList(settingsDraft.tagExclusions),
                tagExemptions: {
                    roles: sanitizeStringList(settingsDraft.tagExemptions.roles),
                    categories: sanitizeStringList(settingsDraft.tagExemptions.categories)
                },
                rotation: rotationPayload,
                filterCriteria: settingsDraft.filterCriteria,
                scoreCriteria: settingsDraft.scoreCriteria,
                scoringMode: settingsDraft.scoringMode || 'simple',
                sensitivityDivider: settingsDraft.sensitivityDivider || 10,
                dietFormulas: settingsDraft.dietFormulas,
                badgeVisibility: badgeVisibilityPayload,
                updatedAt: new Date().toISOString()
            };
        }

        function getStoredToken() {
            try {
                return window.localStorage ? (window.localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY) || '') : '';
            } catch (error) {
                console.warn('âš ï¸ Token okunamadÄ±:', error);
                return '';
            }
        }

        function persistToken(token) {
            try {
                if (!window.localStorage) return;
                if (token) window.localStorage.setItem(LOCAL_STORAGE_TOKEN_KEY, token);
                else window.localStorage.removeItem(LOCAL_STORAGE_TOKEN_KEY);
            } catch (error) {
                console.warn('âš ï¸ Token kaydedilemedi:', error);
            }
        }

        function updateRotationFieldStates() {
            const isEnabled = rotationEnabledInput.checked;
            rotationChunkSizeInput.disabled = !isEnabled;
            rotationResetDayInput.disabled = !isEnabled;
            rotationChunkSizeInput.classList.toggle('disabled', !isEnabled);
            rotationResetDayInput.classList.toggle('disabled', !isEnabled);
        }

        function registerInputHandlers() {
            tagExclusionInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    tryAddTagExclusion();
                }
            });
            tagExclusionInput.addEventListener('blur', tryAddTagExclusion);

            roleExclusionInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    tryAddRoleExclusion();
                }
            });
            roleExclusionInput.addEventListener('blur', tryAddRoleExclusion);

            categoryExclusionInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    tryAddCategoryExclusion();
                }
            });
            categoryExclusionInput.addEventListener('blur', tryAddCategoryExclusion);

            rotationEnabledInput.addEventListener('change', updateRotationFieldStates);
            
            // Scoring Mode ve Sensitivity Event Listeners
            const scoringModeSimple = document.getElementById('scoringModeSimple');
            const scoringModeAdvanced = document.getElementById('scoringModeAdvanced');
            const sensitivityContainer = document.getElementById('sensitivityContainer');
            const sensitivitySlider = document.getElementById('sensitivityDivider');
            const sensitivityValueSpan = document.getElementById('sensitivityValue');
            
            // Mode deÄŸiÅŸince sensitivity container'Ä± gÃ¶ster/gizle
            function updateSensitivityVisibility() {
                if (scoringModeAdvanced && scoringModeAdvanced.checked) {
                    sensitivityContainer.style.display = 'block';
                } else {
                    sensitivityContainer.style.display = 'none';
                }
            }
            
            if (scoringModeSimple) {
                scoringModeSimple.addEventListener('change', updateSensitivityVisibility);
            }
            if (scoringModeAdvanced) {
                scoringModeAdvanced.addEventListener('change', updateSensitivityVisibility);
            }
            
            // Slider deÄŸeri deÄŸiÅŸince gÃ¶ster
            if (sensitivitySlider && sensitivityValueSpan) {
                sensitivitySlider.addEventListener('input', () => {
                    sensitivityValueSpan.textContent = sensitivitySlider.value;
                });
            }
            
            // Ä°lk yÃ¼kleme
            updateSensitivityVisibility();
        }

        function tryAddTagExclusion() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const added = addValueToList(settingsDraft.tagExclusions, tagExclusionInput.value);
            if (added) {
                renderChipList(tagExclusionList, settingsDraft.tagExclusions, removeTagExclusion);
                tagExclusionInput.value = '';
                showStatus('Tag listesine eklendi.', 'success');
            }
        }

        function tryAddRoleExclusion() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const added = addValueToList(settingsDraft.tagExemptions.roles, roleExclusionInput.value);
            if (added) {
                renderChipList(roleExclusionList, settingsDraft.tagExemptions.roles, removeRoleExclusion);
                roleExclusionInput.value = '';
                showStatus('Rol listesine eklendi.', 'success');
            }
        }

        function tryAddCategoryExclusion() {
            if (!settingsDraft) settingsDraft = buildSettingsDraft();
            const added = addValueToList(settingsDraft.tagExemptions.categories, categoryExclusionInput.value);
            if (added) {
                renderChipList(categoryExclusionList, settingsDraft.tagExemptions.categories, removeCategoryExclusion);
                categoryExclusionInput.value = '';
                showStatus('Kategori listesine eklendi.', 'success');
            }
        }

        async function loadSettingsFromGitHub() {
            setLoadingState(true);
            showStatus('Ayarlar yÃ¼kleniyor...', 'info');
            settingsSha = null;
            const token = githubTokenInput.value.trim();
            
            try {
                const headers = {
                    'Accept': 'application/vnd.github+json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${SETTINGS_PATH}?ref=${SETTINGS_BRANCH}`, {
                    headers: headers
                });
                if (!response.ok) throw new Error(`Ayarlar yÃ¼klenemedi: ${response.status}`);
                const data = await response.json();
                settingsSha = data.sha;
                const decoded = atob((data.content || '').replace(/\n/g, ''));
                appSettings = { ...defaultSettings, ...JSON.parse(decoded) };
                
                // ğŸ” DEBUG: GitHub'dan yÃ¼klenen ham veri
                console.log('ğŸ“¥ GitHub config.json RAW:', {
                    scoringMode: appSettings.scoringMode,
                    sensitivityDivider: appSettings.sensitivityDivider,
                    badgeVisibility: appSettings.badgeVisibility,
                    scoreCriteria: appSettings.scoreCriteria
                });
                
                appSettings.tagExclusions = sanitizeStringList(appSettings.tagExclusions);
                appSettings.tagExemptions = {
                    roles: sanitizeStringList(appSettings.tagExemptions?.roles),
                    categories: sanitizeStringList(appSettings.tagExemptions?.categories)
                };
                showStatus('Ayarlar GitHub Ã¼zerinden yÃ¼klendi.', 'success');
            } catch (error) {
                console.warn('âš ï¸ Ayarlar API ile alÄ±namadÄ±:', error.message);
                try {
                    const fallback = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${SETTINGS_BRANCH}/${SETTINGS_PATH}`);
                    if (fallback.ok) {
                        const fallbackSettings = await fallback.json();
                        appSettings = { ...defaultSettings, ...fallbackSettings };
                        appSettings.tagExclusions = sanitizeStringList(appSettings.tagExclusions);
                        appSettings.tagExemptions = {
                            roles: sanitizeStringList(appSettings.tagExemptions?.roles),
                            categories: sanitizeStringList(appSettings.tagExemptions?.categories)
                        };
                        showStatus('Ham dosyadan yÃ¼klendi (salt okunur).', 'info');
                    } else {
                        appSettings = { ...defaultSettings };
                        showStatus('Ayar dosyasÄ± bulunamadÄ±. VarsayÄ±lanlar kullanÄ±lacak.', 'error');
                    }
                } catch (fallbackError) {
                    console.warn('âš ï¸ AyarlarÄ±n ham dosyasÄ± da alÄ±namadÄ±:', fallbackError.message);
                    appSettings = { ...defaultSettings };
                    showStatus('Ayarlar yÃ¼klenemedi. VarsayÄ±lan deÄŸerler kullanÄ±lÄ±yor.', 'error');
                }
            } finally {
                setLoadingState(false);
                populateSettingsForm();
            }
        }

        async function saveSettingsToGitHub(payload, token) {
            const repo = 'mustafasacar35/lipodem-takip-paneli';
            const path = 'settings/config.json';
            const branch = 'main';
            
            // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al
            let sha = null;
            try {
                const checkUrl = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
                const checkResp = await fetch(checkUrl, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (checkResp.ok) {
                    const data = await checkResp.json();
                    sha = data.sha;
                }
            } catch (e) {
                console.warn('SHA alÄ±namadÄ±, yeni dosya oluÅŸturulacak');
            }

            const content = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));
            const updateUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
            
            const body = {
                message: `Ayarlar gÃ¼ncellendi (${new Date().toLocaleString('tr-TR')})`,
                content: content,
                branch: branch
            };
            
            if (sha) body.sha = sha;

            const response = await fetch(updateUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`GitHub gÃ¼ncellemesi baÅŸarÄ±sÄ±z: ${response.status}`);
            }
            
            return await response.json();
        }

        // Local dosyayÄ± gÃ¼ncelle (File System Access API - sadece modern tarayÄ±cÄ±larda Ã§alÄ±ÅŸÄ±r)
        async function saveSettingsLocally(payload) {
            // Not: Bu sadece kullanÄ±cÄ± dosya eriÅŸimi verirse Ã§alÄ±ÅŸÄ±r
            // Otomatik Ã§alÄ±ÅŸmaz, bu yÃ¼zden hata olursa JSON indirme yoluna geÃ§eriz
            
            const jsonString = JSON.stringify(payload, null, 4);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // DosyayÄ± kaydetmek iÃ§in handle oluÅŸtur
            if ('showSaveFilePicker' in window) {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'config.json',
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                console.log('âœ… Local dosya gÃ¼ncellendi');
            } else {
                throw new Error('File System Access API desteklenmiyor');
            }
        }

        // JSON dosyasÄ±nÄ± indir
        function downloadConfigJSON(payload) {
            const jsonString = JSON.stringify(payload, null, 4);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('ğŸ“¥ config.json indirildi - lÃ¼tfen settings/ klasÃ¶rÃ¼ne kopyalayÄ±n');
        }

        async function fetchSuggestions() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/food_list.json');
                if (!response.ok) return;
                const data = await response.json();
                availableRoles = new Set();
                availableCategories = new Set();
                if (Array.isArray(data.categories)) {
                    data.categories.forEach(category => {
                        if (Array.isArray(category.items)) {
                            category.items.forEach(item => {
                                const roleValue = sanitizeString(item.role);
                                const categoryValue = sanitizeString(item.category);
                                if (roleValue) availableRoles.add(roleValue);
                                if (categoryValue) availableCategories.add(categoryValue);
                            });
                        }
                    });
                }
                updateSuggestionPanels();
            } catch (error) {
                console.warn('âš ï¸ Rol/kategori Ã¶nerileri alÄ±namadÄ±:', error.message);
            }
        }

        function updateSuggestionPanels() {
            const roleValues = ensureSorted(Array.from(availableRoles));
            const categoryValues = ensureSorted(Array.from(availableCategories));

            rolesDatalist.innerHTML = roleValues.map(value => `<option value="${value}"></option>`).join('');
            categoriesDatalist.innerHTML = categoryValues.map(value => `<option value="${value}"></option>`).join('');

            if (roleValues.length || categoryValues.length) {
                suggestionsPanel.hidden = false;
                roleSuggestions.innerHTML = roleValues.slice(0, 40).map(value => `<span>${value}</span>`).join('');
                categorySuggestions.innerHTML = categoryValues.slice(0, 40).map(value => `<span>${value}</span>`).join('');
            }
        }

        function attachActionHandlers() {
            saveSettingsButton.addEventListener('click', async () => {
                if (isSaving) return;
                const token = githubTokenInput.value.trim();
                if (!token) {
                    showStatus('Kaydetmek iÃ§in bir GitHub token gerekli.', 'error');
                    return;
                }
                const payload = collectPayloadFromForm();
                console.log('ğŸ”µ AYARLAR KAYDEDÄ°LÄ°YOR:');
                console.log('   ğŸ“Š Badge Visibility:', payload.badgeVisibility);
                console.log('   ğŸ¯ Filter Criteria:', payload.filterCriteria);
                console.log('   ğŸ“ Tam Payload:', payload);
                try {
                    setSavingState(true);
                    saveSettingsButton.textContent = 'Kaydediliyor...';
                    showStatus('GitHub Ã¼zerinde gÃ¼ncelleniyor...', 'info');
                    
                    // 1. GitHub'a kaydet
                    const result = await saveSettingsToGitHub(payload, token);
                    console.log('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi!');
                    console.log('   ğŸ·ï¸ Rozet AyarlarÄ±:', payload.badgeVisibility);
                    
                    // Rozet ayarlarÄ±nÄ±n durumunu gÃ¶ster
                    const enabledBadges = Object.entries(payload.badgeVisibility)
                        .filter(([key, value]) => value)
                        .map(([key]) => key);
                    const disabledBadges = Object.entries(payload.badgeVisibility)
                        .filter(([key, value]) => !value)
                        .map(([key]) => key);
                    
                    console.log('   âœ… Aktif Rozetler:', enabledBadges);
                    console.log('   âŒ KapalÄ± Rozetler:', disabledBadges);
                    persistToken(token);
                    settingsSha = result.content?.sha || settingsSha;
                    appSettings = payload;
                    
                    // âœ… GitHub'a kaydedildi - local indirme yok
                    showStatus('Ayarlar GitHub\'a kaydedildi.', 'success');
                    
                } catch (error) {
                    console.error('âŒ Ayarlar kaydedilemedi:', error);
                    showStatus(error.message || 'Ayarlar kaydedilemedi.', 'error');
                } finally {
                    setSavingState(false);
                    saveSettingsButton.textContent = 'Kaydet';
                }
            });

            reloadButton.addEventListener('click', () => {
                if (isSaving) return;
                loadSettingsFromGitHub();
            });

            clearTokenButton.addEventListener('click', () => {
                persistToken('');
                githubTokenInput.value = '';
                showStatus('Token yerel depolamadan temizlendi.', 'info');
            });

            // Template Upload Functionality
            uploadTemplatesButton.addEventListener('click', async () => {
                const file = templateFileInput.files[0];
                if (!file) {
                    showStatus('âŒ LÃ¼tfen bir JSON dosyasÄ± seÃ§in.', 'error');
                    return;
                }

                if (!file.name.endsWith('.json')) {
                    showStatus('âŒ LÃ¼tfen sadece .json dosyasÄ± yÃ¼kleyin.', 'error');
                    return;
                }

                try {
                    uploadTemplatesButton.disabled = true;
                    uploadTemplatesButton.textContent = 'â³ Åablonlar yÃ¼kleniyor...';
                    showStatus('ğŸ“¥ Åablonlar okunuyor...', 'info');

                    // Read file as text with UTF-8 encoding
                    const fileContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => reject(new Error('Dosya okunamadÄ±'));
                        reader.readAsText(file, 'UTF-8');
                    });

                    // Parse JSON
                    const parsedData = JSON.parse(fileContent);
                    
                    // Handle different JSON structures
                    let newTemplates;
                    if (Array.isArray(parsedData)) {
                        // Direct array of templates
                        newTemplates = parsedData;
                    } else if (parsedData.templates && Array.isArray(parsedData.templates)) {
                        // Object with templates array (exported format)
                        newTemplates = parsedData.templates;
                    } else {
                        throw new Error('JSON dosyasÄ± bir ÅŸablon dizisi veya templates Ã¶zelliÄŸi iÃ§eren obje olmalÄ±dÄ±r');
                    }

                    showStatus('ğŸ”„ Mevcut ÅŸablonlar GitHub\'dan alÄ±nÄ±yor...', 'info');

                    // Get existing templates from GitHub (INDEX ONLY - NEW SYSTEM)
                    const token = githubTokenInput.value.trim();
                    if (!token) {
                        throw new Error('GitHub token bulunamadÄ±. LÃ¼tfen token girin.');
                    }

                    const templatesResponse = await fetch(
                        'https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli/contents/templates/index.json',
                        {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (!templatesResponse.ok) {
                        throw new Error('Mevcut ÅŸablon index\'i GitHub\'dan alÄ±namadÄ±');
                    }

                    const templatesData = await templatesResponse.json();
                    // Properly decode UTF-8 content to preserve Turkish characters
                    const existingContent = decodeURIComponent(escape(atob(templatesData.content)));
                    const existingData = JSON.parse(existingContent);
                    
                    // Handle different JSON structures for existing templates
                    let existingTemplates;
                    if (Array.isArray(existingData)) {
                        existingTemplates = existingData;
                    } else if (existingData && typeof existingData === 'object' && existingData.templates && Array.isArray(existingData.templates)) {
                        existingTemplates = existingData.templates;
                    } else {
                        console.warn('âš ï¸ GitHub\'dan alÄ±nan veri beklenmedik formatta, boÅŸ liste kullanÄ±lÄ±yor');
                        existingTemplates = [];
                    }

                    console.log(`ğŸ“Š Mevcut ÅŸablon sayÄ±sÄ±: ${existingTemplates.length}`);
                    
                    // Fix Turkish characters in existing templates if they are corrupted
                    function fixTurkishInObject(obj) {
                        if (typeof obj === 'string') {
                            return fixTurkishChars(obj);
                        } else if (Array.isArray(obj)) {
                            return obj.map(item => fixTurkishInObject(item));
                        } else if (obj && typeof obj === 'object') {
                            const fixed = {};
                            for (const [key, value] of Object.entries(obj)) {
                                fixed[fixTurkishChars(key)] = fixTurkishInObject(value);
                            }
                            return fixed;
                        }
                        return obj;
                    }
                    
                    // Check and fix existing templates for Turkish character corruption
                    let fixedExistingTemplates = false;
                    existingTemplates = existingTemplates.map(template => {
                        const originalName = template.name || '';
                        const fixedTemplate = fixTurkishInObject(template);
                        
                        // Check if template name contains corrupted Turkish characters
                        if (originalName.includes('Ãƒ') || originalName.includes('Ã„') || originalName.includes('Ã…')) {
                            console.log(`ğŸ”§ TÃ¼rkÃ§e karakter dÃ¼zeltmesi: "${originalName}" â†’ "${fixedTemplate.name}"`);
                            fixedExistingTemplates = true;
                        }
                        
                        return fixedTemplate;
                    });
                    
                    if (fixedExistingTemplates) {
                        console.log('âœ… Mevcut ÅŸablonlarda TÃ¼rkÃ§e karakter dÃ¼zeltmeleri yapÄ±ldÄ±');
                    }

                    // Helper function to normalize Turkish text for comparison
                    function normalizeTurkishText(text) {
                        if (!text || typeof text !== 'string') return '';
                        return fixTurkishChars(text)
                            .toLowerCase()
                            .replace(/\s+/g, ' ')
                            .trim();
                    }

                    // Helper function to generate detailed content hash for duplicate detection
                    function getTemplateContentHash(template) {
                        if (!template.ogunler || !Array.isArray(template.ogunler)) {
                            console.warn('âš ï¸ Åablon Ã¶ÄŸÃ¼n bilgisi eksik:', template.name || 'Ä°simsiz ÅŸablon');
                            return '';
                        }
                        
                        // Create detailed hash based on meal structure including all yemek properties
                        const contentData = template.ogunler.map(ogun => ({
                            ogunAdi: normalizeTurkishText(ogun.ogunAdi || ''),
                            yemekler: (ogun.yemekler || []).map(yemek => {
                                // Normalize food name for comparison - use multiple possible fields
                                const foodName = normalizeTurkishText(
                                    yemek.foodName || yemek.originalText || yemek.name || ''
                                );
                                
                                return {
                                    foodName: foodName,
                                    originalText: normalizeTurkishText(yemek.originalText || ''),
                                    calories: Math.round(parseFloat(yemek.calories) || 0),
                                    protein: Math.round(parseFloat(yemek.protein) || 0),
                                    carbs: Math.round(parseFloat(yemek.carbs) || 0),
                                    fat: Math.round(parseFloat(yemek.fat) || 0),
                                    // Include eÅŸleÅŸen yemek info if available
                                    eslesenYemekName: yemek.eslesenYemek ? 
                                        normalizeTurkishText(yemek.eslesenYemek.name || '') : '',
                                    // Include any additional identifying fields
                                    portion: yemek.portion || '',
                                    unit: normalizeTurkishText(yemek.unit || '')
                                };
                            }).sort((a, b) => a.foodName.localeCompare(b.foodName))
                        })).sort((a, b) => a.ogunAdi.localeCompare(b.ogunAdi));
                        
                        const hashString = JSON.stringify(contentData);
                        console.log(`ğŸ” "${template.name}" iÃ§in hash oluÅŸturuldu (${hashString.length} karakter)`);
                        return hashString;
                    }
                    
                    // Enhanced function to check if templates have identical meal content
                    function hasIdenticalMealContent(template1, template2) {
                        if (!template1 || !template2) return false;
                        
                        const hash1 = getTemplateContentHash(template1);
                        const hash2 = getTemplateContentHash(template2);
                        
                        // If either hash is empty, consider them different
                        if (!hash1 || !hash2) {
                            console.log(`âš ï¸ Hash boÅŸ: "${template1.name}" (${hash1 ? 'OK' : 'BOÅ'}) vs "${template2.name}" (${hash2 ? 'OK' : 'BOÅ'})`);
                            return false;
                        }
                        
                        // If hashes are identical, content is the same
                        if (hash1 === hash2) {
                            console.log(`ğŸ” Ä°Ã§erik eÅŸleÅŸmesi bulundu: "${template1.name}" ve "${template2.name}" aynÄ± yemek iÃ§eriÄŸine sahip`);
                            return true;
                        }
                        
                        return false;
                    }

                    // Function to check meal content difference (even one different line should allow addition)
                    function hasDifferentMealContent(newTemplate, existingTemplates) {
                        const newHash = getTemplateContentHash(newTemplate);
                        if (!newHash) return true; // If can't generate hash, assume different
                        
                        for (const existing of existingTemplates) {
                            const existingHash = getTemplateContentHash(existing);
                            if (existingHash && newHash === existingHash) {
                                console.log(`âŒ AynÄ± iÃ§erik tespit edildi: "${newTemplate.name}" = "${existing.name}"`);
                                return false; // Found identical content
                            }
                        }
                        
                        console.log(`âœ… Benzersiz iÃ§erik: "${newTemplate.name}" eklemeye uygun`);
                        return true; // No identical content found
                    }

                    // Ensure existingTemplates is properly initialized as array
                    if (!Array.isArray(existingTemplates)) {
                        console.error('âŒ existingTemplates array deÄŸil, boÅŸ array kullanÄ±lÄ±yor');
                        existingTemplates = [];
                    }

                    // Merge templates (skip duplicates by ID and content)
                    const existingIds = new Set();
                    const templatesAdded = [];
                    const templatesSkipped = [];
                    const templatesSkippedByContent = [];
                    
                    // Safely extract existing IDs
                    existingTemplates.forEach(t => {
                        if (t && t.id) {
                            existingIds.add(t.id);
                        }
                    });

                    console.log(`ğŸ“Š Ä°ÅŸlem Ã¶ncesi durum:`);
                    console.log(`   - Mevcut ÅŸablon sayÄ±sÄ±: ${existingTemplates.length}`);
                    console.log(`   - YÃ¼klenecek ÅŸablon sayÄ±sÄ±: ${newTemplates.length}`);
                    console.log(`   - Mevcut ID'ler: [${Array.from(existingIds).join(', ')}]`);

                    newTemplates.forEach((template, templateIndex) => {
                        if (!template || typeof template !== 'object') {
                            console.warn(`âš ï¸ ${templateIndex + 1}. ÅŸablon geÃ§ersiz:`, template);
                            return;
                        }

                        if (!template.id) {
                            console.warn(`âš ï¸ ${templateIndex + 1}. ÅŸablon ID olmadan atlandÄ±:`, template.name || 'Ä°simsiz');
                            return;
                        }
                        
                        console.log(`\nğŸ” ${templateIndex + 1}/${newTemplates.length} - Åablon kontrol ediliyor: "${template.name}" (ID: ${template.id})`);
                        
                        // First check: ID already exists
                        if (existingIds.has(template.id)) {
                            console.log(`âš ï¸ AynÄ± ID'li ÅŸablon zaten mevcut: ${template.id}`);
                            templatesSkipped.push({
                                id: template.id, 
                                name: template.name || 'Ä°simsiz', 
                                reason: 'ID zaten mevcut'
                            });
                            return;
                        }
                        
                        // Second check: Content already exists (even one different meal line should allow addition)
                        if (!hasDifferentMealContent(template, existingTemplates)) {
                            const duplicateTemplate = existingTemplates.find(t => 
                                getTemplateContentHash(t) === getTemplateContentHash(template)
                            );
                            console.log(`âš ï¸ AynÄ± yemek iÃ§eriÄŸi mevcut: "${template.name}"`);
                            if (duplicateTemplate) {
                                console.log(`   Mevcut ÅŸablon: "${duplicateTemplate.name}" (ID: ${duplicateTemplate.id})`);
                            }
                            templatesSkippedByContent.push({
                                id: template.id, 
                                name: template.name || 'Ä°simsiz', 
                                reason: 'AynÄ± yemek iÃ§eriÄŸi mevcut',
                                duplicateOf: duplicateTemplate?.name || 'Bilinmeyen'
                            });
                            return;
                        }
                        
                        // Template can be added - generate new menu number
                        console.log(`âœ… Yeni ÅŸablon ekleniyor: "${template.name}"`);
                        
                        const existingMenuNumbers = existingTemplates
                            .map(t => {
                                if (!t || !t.name) return 0;
                                const match = String(t.name).match(/^(\d+)\./);
                                return match ? parseInt(match[1]) : 0;
                            })
                            .filter(num => num > 0);
                        
                        const nextMenuNumber = existingMenuNumbers.length > 0 
                            ? Math.max(...existingMenuNumbers) + 1 
                            : existingTemplates.length + 1;
                        
                            // Generate clean menu name format
                            const templateName = template.name || `Åablon ${template.id}`;
                            
                            // Extract any existing menu number or create new one
                            let cleanMenuName;
                            const existingMenuMatch = templateName.match(/^(\d+)\./);
                            
                            if (existingMenuMatch) {
                                // Already has menu number, keep it but clean the name
                                cleanMenuName = `MenÃ¼ ${existingMenuMatch[1]}`;
                            } else {
                                // No menu number, create new clean name
                                cleanMenuName = `MenÃ¼ ${nextMenuNumber}`;
                            }
                            
                            const oldName = template.name;
                            template.name = cleanMenuName;
                            console.log(`ğŸ“ Åablon adÄ± dÃ¼zenlendi: "${oldName}" â†’ "${template.name}"`);
                            
                            // Also update the display name if it exists
                            if (template.displayName) {
                                template.displayName = cleanMenuName;
                            }                        // Deep clean template data and preserve Turkish characters
                        const cleanedTemplate = JSON.parse(JSON.stringify(template));
                        
                        // Recursively fix Turkish characters in the entire template
                        function fixTurkishInObject(obj) {
                            if (typeof obj === 'string') {
                                return fixTurkishChars(obj);
                            } else if (Array.isArray(obj)) {
                                return obj.map(item => fixTurkishInObject(item));
                            } else if (obj && typeof obj === 'object') {
                                const fixed = {};
                                for (const [key, value] of Object.entries(obj)) {
                                    fixed[fixTurkishChars(key)] = fixTurkishInObject(value);
                                }
                                return fixed;
                            }
                            return obj;
                        }
                        
                        const turkishFixedTemplate = fixTurkishInObject(cleanedTemplate);
                        
                        existingTemplates.push(turkishFixedTemplate);
                        templatesAdded.push({
                            id: turkishFixedTemplate.id, 
                            name: turkishFixedTemplate.name,
                            menuNumber: nextMenuNumber
                        });
                        existingIds.add(turkishFixedTemplate.id);
                    });

                    console.log(`\nğŸ“Š Ä°ÅŸlem sonucu Ã¶zeti:`);
                    console.log(`   - Toplam ÅŸablon sayÄ±sÄ±: ${existingTemplates.length}`);
                    console.log(`   - Eklenen: ${templatesAdded.length}`);
                    console.log(`   - ID'ye gÃ¶re atlanan: ${templatesSkipped.length}`);
                    console.log(`   - Ä°Ã§eriÄŸe gÃ¶re atlanan: ${templatesSkippedByContent.length}`);

                    showStatus('ğŸ’¾ BirleÅŸtirilmiÅŸ ÅŸablonlar GitHub\'a kaydediliyor...', 'info');

                    // Preserve original JSON structure with metadata - maintain Turkish character integrity
                    const mergedData = {
                        version: existingData.version || "1.0",
                        exportDate: new Date().toISOString(),
                        totalCount: existingTemplates.length,
                        templates: existingTemplates,
                        lastUpdate: {
                            date: new Date().toISOString(),
                            addedCount: templatesAdded.length,
                            skippedCount: templatesSkipped.length + templatesSkippedByContent.length,
                            description: `${templatesAdded.length} yeni ÅŸablon eklendi, ${templatesSkipped.length + templatesSkippedByContent.length} duplicate atlandÄ±`
                        }
                    };

                    // Ensure proper UTF-8 encoding for Turkish characters
                    const mergedContent = JSON.stringify(mergedData, null, 2);
                    
                    // Properly encode UTF-8 content for GitHub API to preserve Turkish characters
                    const encodedContent = btoa(unescape(encodeURIComponent(mergedContent)));
                    
                    console.log('ğŸ“ JSON iÃ§eriÄŸi UTF-8 ile kodlandÄ±, TÃ¼rkÃ§e karakterler korundu');

                    const updateResponse = await fetch(
                        'https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli/contents/templates/index.json',
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${token}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json'
                            },
                            body: JSON.stringify({
                                message: `ğŸ“¥ Åablon index gÃ¼ncelleme (TÃ¼rkÃ§e karakter korundu): ${templatesAdded.length} yeni menÃ¼, ${templatesSkipped.length + templatesSkippedByContent.length} duplicate atlandÄ±`,
                                content: encodedContent,
                                sha: templatesData.sha
                            })
                        }
                    );

                    if (!updateResponse.ok) {
                        throw new Error('Åablon index\'i GitHub\'a kaydedilemedi');
                    }

                    // Show detailed success message
                    let message = 'âœ… Åablon yÃ¼kleme iÅŸlemi baÅŸarÄ±yla tamamlandÄ±!\\n\\nğŸ“Š Ã–ZET:\\n';
                    message += `ï¿½ Toplam mevcut ÅŸablon sayÄ±sÄ±: ${existingTemplates.length}\n`;
                    message += `ï¿½ğŸ“¥ ${templatesAdded.length} yeni ÅŸablon eklendi\n`;
                    
                    if (templatesSkipped.length > 0) {
                        message += `â­ï¸ ${templatesSkipped.length} ÅŸablon (aynÄ± ID) atlandÄ±\n`;
                    }
                    
                    if (templatesSkippedByContent.length > 0) {
                        message += `ğŸ”„ ${templatesSkippedByContent.length} ÅŸablon (aynÄ± yemek iÃ§eriÄŸi) atlandÄ±\n`;
                    }
                    
                    message += `\nğŸ¯ KarÅŸÄ±laÅŸtÄ±rma kriteri: Ã–ÄŸÃ¼n adlarÄ± ve yemek satÄ±rlarÄ±nÄ±n tam eÅŸleÅŸmesi\n`;
                    message += `ğŸ“ Yeni ÅŸablonlar otomatik menÃ¼ numarasÄ± aldÄ±`;
                    
                    // Show details in console for debugging
                    if (templatesAdded.length > 0) {
                        console.log('ğŸ“¥ Eklenen ÅŸablonlar:', templatesAdded.map(t => t.name));
                    }
                    if (templatesSkipped.length > 0) {
                        console.log('â­ï¸ ID\'ye gÃ¶re atlanan ÅŸablonlar:', templatesSkipped.map(t => t.name));
                    }
                    if (templatesSkippedByContent.length > 0) {
                        console.log('ğŸ”„ Ä°Ã§erik benzerliÅŸine gÃ¶re atlanan ÅŸablonlar:', templatesSkippedByContent.map(t => t.name));
                    }

                    showStatus(message.replace(/\n/g, '<br>'), 'success');
                    
                    // Clear file input
                    templateFileInput.value = '';

                } catch (error) {
                    console.error('âŒ Åablon yÃ¼kleme hatasÄ±:', error);
                    showStatus(`âŒ Hata: ${error.message}`, 'error');
                } finally {
                    uploadTemplatesButton.disabled = false;
                    uploadTemplatesButton.textContent = 'ğŸ“¥ ÅablonlarÄ± YÃ¼kle ve BirleÅŸtir';
                }
            });
        }

        // init and addLogoutButton already defined in <head>

        // PWA Service Worker ve Manifest KaydÄ±
        if ('serviceWorker' in navigator) {
            const isSecureOrigin = ['https:', 'http:'].includes(window.location.protocol) || window.location.protocol === 'chrome-extension:';
            const isGitHubPages = /\.github\.io$/i.test(window.location.hostname);
            if (isSecureOrigin && !isGitHubPages) {
                const CACHE_NAME = 'admin-settings-v1';
                const manifest = {
                    "short_name": "YÃ¶netici AyarlarÄ±",
                    "name": "YÃ¶netici AyarlarÄ± Paneli",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#667eea",
                    "theme_color": "#764ba2",
                    "icons": [
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "192x192",
                            "type": "image/png",
                            "purpose": "any maskable"
                        },
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "512x512",
                            "type": "image/png",
                            "purpose": "any maskable"
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifestLink').setAttribute('href', manifestURL);

                const serviceWorkerContent = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const urlsToCache = ['.'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.open(CACHE_NAME).then(cache => {
                                return fetch(event.request)
                                    .then(response => {
                                        if (response.status === 200) {
                                            cache.put(event.request.url, response.clone());
                                        }
                                        return response;
                                    })
                                    .catch(() => cache.match(event.request));
                            })
                        );
                    });
                `;
                const swBlob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then(registration => console.log('ServiceWorker registered:', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed:', err));
            }
        }

        // Zoom ve dokunmatik engelleyici
        (function preventZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 350) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            document.addEventListener('gesturestart', function(event) {
                event.preventDefault();
            }, { passive: false });
        })();
    </script>
    
    <!-- Page initialization - runs after body is parsed -->
    <script>
        // Use setTimeout to ensure DOM is fully parsed
        setTimeout(async () => {
            console.info('[Settings] Script running at end of body (after timeout)');
            console.info('[Settings] .settings-wrapper check:', document.querySelector('.settings-wrapper'));
            const relogin = new URLSearchParams(location.search).get('relogin') === '1';
            
            if (window.AdminAuth && typeof AdminAuth.protectPage === 'function') {
                console.info('[Settings] Calling AdminAuth.protectPage');
                try {
                    await AdminAuth.protectPage({ 
                        forcePrompt: relogin,
                        afterLogin: () => {
                            console.info('[Settings] afterLogin callback fired');
                        }
                    });
                    console.info('[Settings] Auth successful, session:', AdminAuth.getSession());
                } catch(err) {
                    console.error('[Settings] protectPage error:', err);
                    return;
                }
            }
            
            console.info('[Settings] DOM is ready, .settings-wrapper:', document.querySelector('.settings-wrapper'));
            
            // Call page functions
            if (typeof window.addLogoutButton === 'function') {
                window.addLogoutButton();
            }
            
            if (typeof window.init === 'function') {
                window.init();
            }
        }, 10);
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('âœ… Service Worker kayÄ±tlÄ±:', reg.scope))
                .catch(err => console.error('âŒ Service Worker hatasÄ±:', err));
        }
    </script>
</body>
</html>
