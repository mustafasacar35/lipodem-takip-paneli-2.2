<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasta Migration - JSON to Supabase</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-success { color: #4caf50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
        .log-info { color: #2196F3; }
        .progress {
            background: #e0e0e0;
            border-radius: 10px;
            height: 25px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Hasta Migration AracÄ±</h1>
        <p class="subtitle">JSON dosyalarÄ±ndan Supabase'e hasta verilerini taÅŸÄ±</p>

        <div class="warning-box">
            <strong>âš ï¸ Ã–nemli:</strong> Bu iÅŸlem hastalar/index.json dosyasÄ±ndaki TÃœM hasta kayÄ±tlarÄ±nÄ± Supabase'e aktaracak. 
            Mevcut kayÄ±tlar varsa UPDATE edilecek, yoksa INSERT edilecek (UPSERT).
        </div>

        <div class="info-box">
            <strong>ğŸ“‹ Migration AdÄ±mlarÄ±:</strong>
            <ol>
                <li>hastalar/index.json dosyasÄ±nÄ± oku</li>
                <li>Her hasta kaydÄ±nÄ± Supabase patients tablosuna aktar</li>
                <li>Eksik alanlarÄ± varsayÄ±lan deÄŸerlerle doldur</li>
                <li>username ve password_hash alanlarÄ±nÄ± koru</li>
            </ol>
        </div>

        <button id="startMigration" onclick="startMigration()">
            ğŸš€ Migration'Ä± BaÅŸlat
        </button>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Toplam Hasta</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successCount">0</div>
                <div class="stat-label">BaÅŸarÄ±lÄ±</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">HatalÄ±</div>
            </div>
        </div>

        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <div id="log"></div>
    </div>

    <script src="config.local.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        let supabaseClient = null;
        let totalCount = 0;
        let successCount = 0;
        let errorCount = 0;

        // Initialize Supabase
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait for config to load
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (!window.supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                supabaseClient = window.supabase;
                log('âœ… Supabase baÄŸlantÄ±sÄ± hazÄ±r', 'success');
            } catch (error) {
                log(`âŒ Supabase initialization error: ${error.message}`, 'error');
            }
        });

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${current}/${total} (${percentage}%)`;
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        async function startMigration() {
            const button = document.getElementById('startMigration');
            button.disabled = true;
            button.textContent = 'â³ Migration devam ediyor...';

            document.getElementById('stats').style.display = 'grid';
            document.getElementById('progressContainer').style.display = 'block';

            totalCount = 0;
            successCount = 0;
            errorCount = 0;
            updateStats();

            try {
                log('ğŸ” hastalar/index.json dosyasÄ± okunuyor...', 'info');
                
                // Fetch index.json
                const response = await fetch('./hastalar/index.json');
                if (!response.ok) {
                    throw new Error(`Failed to fetch index.json: ${response.status}`);
                }

                const indexData = await response.json();
                const patients = indexData.patients || [];
                
                totalCount = patients.length;
                log(`ğŸ“Š Toplam ${totalCount} hasta bulundu`, 'info');
                updateStats();

                // Process each patient
                for (let i = 0; i < patients.length; i++) {
                    const patient = patients[i];
                    await migratePatient(patient, i + 1);
                    updateProgress(i + 1, totalCount);
                }

                log('', 'info');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
                log(`âœ… Migration tamamlandÄ±!`, 'success');
                log(`ğŸ“Š Toplam: ${totalCount} | BaÅŸarÄ±lÄ±: ${successCount} | HatalÄ±: ${errorCount}`, 'success');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');

                button.textContent = 'âœ… Migration TamamlandÄ±';

                // Show final result
                if (errorCount === 0) {
                    const resultBox = document.createElement('div');
                    resultBox.className = 'success-box';
                    resultBox.innerHTML = `
                        <strong>ğŸ‰ TÃ¼m hastalar baÅŸarÄ±yla Supabase'e aktarÄ±ldÄ±!</strong><br>
                        ArtÄ±k login sistemini test edebilirsiniz.
                    `;
                    document.querySelector('.container').insertBefore(resultBox, document.getElementById('log'));
                } else {
                    const resultBox = document.createElement('div');
                    resultBox.className = 'warning-box';
                    resultBox.innerHTML = `
                        <strong>âš ï¸ Migration tamamlandÄ± ancak bazÄ± hatalar oluÅŸtu.</strong><br>
                        LÃ¼tfen log kayÄ±tlarÄ±nÄ± kontrol edin.
                    `;
                    document.querySelector('.container').insertBefore(resultBox, document.getElementById('log'));
                }

            } catch (error) {
                log(`âŒ Migration hatasÄ±: ${error.message}`, 'error');
                console.error('Migration error:', error);
                button.textContent = 'âŒ Hata OluÅŸtu - Tekrar Dene';
                button.disabled = false;
            }
        }

        async function migratePatient(patient, index) {
            const patientId = patient.id;
            const username = patient.username;

            try {
                log(`[${index}/${totalCount}] ğŸ”„ ${username} (${patientId}) iÅŸleniyor...`, 'info');

                // Hasta detay dosyasÄ±nÄ± oku (weeks, personalInfo vs iÃ§in)
                let patientDetails = null;
                try {
                    const detailResponse = await fetch(`./hastalar/${patientId}.json`);
                    if (detailResponse.ok) {
                        patientDetails = await detailResponse.json();
                        log(`[${index}/${totalCount}] ğŸ“„ ${patientId}.json dosyasÄ± okundu`, 'info');
                    }
                } catch (detailError) {
                    log(`[${index}/${totalCount}] âš ï¸ ${patientId}.json bulunamadÄ±, temel bilgilerle devam ediliyor`, 'warning');
                }

                // Prepare patient data for Supabase
                const patientData = {
                    patient_id: patientId,
                    username: username,
                    password_hash: patient.passwordHash || null,
                    name: patient.name || (patientDetails?.personalInfo?.name) || 'Ä°simsiz',
                    surname: patient.surname || (patientDetails?.personalInfo?.surname) || '',
                    status: patient.status || 'active',
                    session_days: patient.sessionDays || 7,
                    max_devices: patient.maxDevices || 3,
                    role: patient.role || (patientDetails?.isAdmin ? 'admin' : 'patient'),
                    created_at: patient.createdAt || new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    // JSONB kolonu - detaylÄ± bilgiler
                    patient_data: patientDetails ? {
                        personalInfo: patientDetails.personalInfo || {},
                        weeks: patientDetails.weeks || [],
                        notes: patientDetails.notes || '',
                        progressLog: patientDetails.progressLog || [],
                        alternativeCount: patientDetails.alternativeCount || 10,
                        isAdmin: patientDetails.isAdmin || false
                    } : {}
                };

                // UPSERT to Supabase (update if exists, insert if not)
                const { data, error } = await supabaseClient
                    .from('patients')
                    .upsert(patientData, {
                        onConflict: 'patient_id',
                        ignoreDuplicates: false
                    })
                    .select();

                if (error) {
                    throw error;
                }

                successCount++;
                log(`[${index}/${totalCount}] âœ… ${username} baÅŸarÄ±yla eklendi/gÃ¼ncellendi`, 'success');

            } catch (error) {
                errorCount++;
                log(`[${index}/${totalCount}] âŒ ${username} hatasÄ±: ${error.message}`, 'error');
                console.error(`Error migrating ${patientId}:`, error);
            }

            updateStats();
        }
    </script>
</body>
</html>
