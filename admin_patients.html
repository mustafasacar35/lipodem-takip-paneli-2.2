<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Hasta Y√∂netimi">
    <meta name="application-name" content="Hasta Y√∂netimi">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest-admin-patients.json">
    <link rel="apple-touch-icon" href="/logo3.png">
    <!-- / PWA ve Mobil Uygulama Meta Etiketleri -->

    <title>Hasta Y√∂netimi - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .admin-nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
            padding-top: 15px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .admin-nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            border: 1px solid #667eea;
            border-radius: 8px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .admin-nav-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }
        
        .admin-nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }

        .filter-group select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .patient-list {
            margin-bottom: 30px;
        }

        .patient-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .patient-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .patient-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: #333;
        }

        .patient-table td:first-child {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
        }

        .patient-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-archived {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #333;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-group label .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group .hint {
            font-size: 12px;
            color: #999;
        }

        .progress-log-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .progress-log-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .progress-entry {
            display: grid;
            grid-template-columns: 150px 100px 1fr 100px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .progress-entry input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }

        .add-progress-btn {
            margin-top: 10px;
        }

        .alert {
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 15px;
            font-weight: 500;
            display: none;
            animation: slideInDown 0.4s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 2px solid #28a745;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 2px solid #dc3545;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .github-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .github-config h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .github-config input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .bmi-display {
            padding: 10px 15px;
            background: #e7f3ff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #0066cc;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .progress-entry {
                grid-template-columns: 1fr;
            }

            .patient-table {
                font-size: 11px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .patient-table thead {
                display: none;
            }

            .patient-table tbody {
                display: block;
            }

            .patient-table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 10px;
                background: white;
            }

            .patient-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 5px;
                border: none;
                border-bottom: 1px solid #f0f0f0;
            }

            .patient-table td:last-child {
                border-bottom: none;
            }

            .patient-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #666;
                font-size: 11px;
                flex-shrink: 0;
                margin-right: 10px;
            }

            .patient-table td {
                text-align: right;
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            .action-buttons button {
                width: 100%;
            }
        }
    </style>
    <!-- Admins config: local fallback first, then remote authoritative override -->
    <script src="settings/admins.js"></script>
    <script>
        // Remote admins.js with hard cache-busting, loaded synchronously to preserve order
        document.write('<script src="https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/settings/admins.js?t=' + Date.now() + '"><\\/scr' + 'ipt>');
    </script>
    <!-- Patient auth (for patientAdmins support when served over http/https) -->
    <script src="auth.js"></script>
    <script>
        // Expose PatientAuth on window for AdminAuth delegation (in case auth.js didn't attach it)
        console.info('[Shim] Checking PatientAuth. typeof PatientAuth:', typeof PatientAuth, 'window.PatientAuth:', !!window.PatientAuth);
        try {
            if (typeof PatientAuth !== 'undefined' && !window.PatientAuth) {
                window.PatientAuth = PatientAuth;
                console.info('[Shim] window.PatientAuth was assigned from global lexical binding');
            } else if (!window.PatientAuth) {
                console.warn('[Shim] PatientAuth not available in global scope, creating emergency shim');
                // Emergency shim for patientAdmins login when auth.js doesn't expose PatientAuth to window
                window.PatientAuth = {
                    async hashPassword(password) {
                        if (window.crypto && crypto.subtle) {
                            const encoder = new TextEncoder();
                            const data = encoder.encode(password);
                            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        }
                        throw new Error('Web Crypto API not available');
                    },
                    async loadPatientIndex() {
                        const ts = Date.now();
                        const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/hastalar/index.json?t=${ts}`, { cache: 'no-store' });
                        if (response.ok) return await response.json();
                        throw new Error('Patient index not found');
                    },
                    async loadPatientDetails(patientId) {
                        const ts = Date.now();
                        const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/hastalar/${patientId}.json?t=${ts}`, { cache: 'no-store' });
                        if (response.ok) return await response.json();
                        throw new Error('Patient details not found');
                    },
                    async login(username, password, rememberMe = false) {
                        try {
                            const index = await this.loadPatientIndex();
                            const norm = (v) => (v || '').toString().trim().toLowerCase();
                            const patient = index.patients.find(p => norm(p.username) === norm(username));
                            if (!patient) return { success: false, error: 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±' };
                            if (patient.status === 'archived') return { success: false, error: 'Bu hesap ar≈üivlenmi≈ütir' };
                            
                            const inputHash = await this.hashPassword(password);
                            let effectiveHash = patient.passwordHash || '';
                            
                            try {
                                const details = await this.loadPatientDetails(patient.id);
                                const detailsHash = details?.passwordHash || details?.personalInfo?.passwordHash;
                                if (detailsHash && typeof detailsHash === 'string') {
                                    effectiveHash = detailsHash;
                                }
                            } catch (e) {
                                console.warn('[Shim PatientAuth] Details not loaded, using index hash');
                            }
                            
                            if (inputHash !== effectiveHash) return { success: false, error: 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±' };
                            
                            return { success: true, patient: { username: patient.username, patientId: patient.id } };
                        } catch (error) {
                            console.error('[Shim PatientAuth] Login error:', error);
                            return { success: false, error: 'Giri≈ü sƒ±rasƒ±nda bir hata olu≈ütu' };
                        }
                    }
                };
                console.info('[Shim] Emergency PatientAuth created on window');
            }
        } catch(e) { 
            console.error('[Shim] Error:', e); 
        }
        console.info('[Shim] Final check - window.PatientAuth:', !!window.PatientAuth);
    </script>
    <!-- Page init moved to end of body -->
    <!-- Define page functions in head so they're available immediately -->
    <script>
        // Global variables
        let patients = [];
        let editingPatientId = null;
        let progressLogCounter = 0;

        // GitHub Configuration
        const CONFIG = {
            get token() { return document.getElementById('githubToken')?.value || ''; },
            get owner() { return document.getElementById('githubOwner')?.value || 'mustafasacar35'; },
            get repo() { return document.getElementById('githubRepo')?.value || 'lipodem-takip-paneli'; },
            branch: 'main'
        };

        function addLogoutButton(){
            console.info('[addLogoutButton] Starting...');
            try {
                const container = document.querySelector('.header-buttons');
                console.info('[addLogoutButton] container:', container);
                if (!container) {
                    console.warn('[addLogoutButton] .header-buttons not found!');
                    return;
                }
                if (document.getElementById('adminLogoutBtn')) {
                    console.info('[addLogoutButton] Logout button already exists');
                    return;
                }
                const btn = document.createElement('button');
                btn.className = 'btn btn-danger';
                btn.id = 'adminLogoutBtn';
                btn.textContent = 'üö™ √áƒ±kƒ±≈ü';
                btn.onclick = () => { if (window.AdminAuth) { AdminAuth.clearSession(); location.reload(); } };
                container.appendChild(btn);
                console.info('[addLogoutButton] Logout button added successfully');
            } catch(e) { console.error('addLogoutButton error:', e); }
        }
        window.addLogoutButton = addLogoutButton;

        async function loadPatients() {
            console.info('[loadPatients] Starting...');
            try {
                const response = await fetch(
                    `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/hastalar/index.json`
                );
                
                if (!response.ok) throw new Error('Hasta listesi y√ºklenemedi');
                
                const data = await response.json();
                patients = data.patients || [];
                
                const loadingEl = document.getElementById('loadingState');
                const tableEl = document.getElementById('patientTable');
                if (loadingEl) loadingEl.style.display = 'none';
                if (tableEl) tableEl.style.display = 'table';
                
                if (typeof applyFilters === 'function') applyFilters();
            } catch (error) {
                console.error('Error loading patients:', error);
                const errorMsg = 'Hasta listesi y√ºklenirken hata olu≈ütu: ' + error.message;
                if (typeof showError === 'function') {
                    showError(errorMsg);
                } else {
                    alert(errorMsg);
                }
                const loadingEl = document.getElementById('loadingState');
                if (loadingEl) loadingEl.innerHTML = '<p style="color: #dc3545;">‚ùå Y√ºkleme hatasƒ±</p>';
            }
        }
        window.loadPatients = loadPatients;
        
        console.info('[Head] Functions defined. addLogoutButton:', typeof addLogoutButton, 'loadPatients:', typeof loadPatients);
    </script>
    <!-- Admin auth gate (hard cache-busting, load after GH_ADMINS scripts) -->
    <script src="admin_auth.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äç‚öïÔ∏è Hasta Y√∂netimi</h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="openAddPatientModal()">
                    ‚ûï Yeni Hasta Ekle
                </button>
            </div>
            
            <!-- Admin Navigasyon Butonlarƒ± -->
            <div class="admin-nav-buttons">
                <a href="admin_settings.html" class="admin-nav-btn">
                    ‚öôÔ∏è Ayarlar
                </a>
                <a href="admin_patients.html" class="admin-nav-btn active">
                    üë• Hasta Listesi
                </a>
                <a href="admin_chat.html" class="admin-nav-btn">
                    üí¨ Sohbet Y√∂netimi
                </a>
            </div>
        </div>

        <!-- GitHub Configuration -->
        <div class="github-config">
            <h3>üîë GitHub API Yapƒ±landƒ±rmasƒ±</h3>
            <input 
                type="text" 
                id="githubToken" 
                placeholder="GitHub Personal Access Token" 
                value=""
            >
            <input 
                type="text" 
                id="githubOwner" 
                placeholder="Repo Sahibi (√∂rn: mustafasacar35)" 
                value="mustafasacar35"
            >
            <input 
                type="text" 
                id="githubRepo" 
                placeholder="Repo Adƒ± (√∂rn: lipodem-takip-paneli)" 
                value="lipodem-takip-paneli"
            >
        </div>

        <!-- Alert Messages -->
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-danger" id="errorAlert"></div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Durum:</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="all">T√ºm√º</option>
                    <option value="active" selected>Aktif</option>
                    <option value="archived">Ar≈üiv</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Arama:</label>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="ƒ∞sim, soyisim veya kullanƒ±cƒ± adƒ±..." 
                    style="padding: 8px 15px; border: 2px solid #e0e0e0; border-radius: 8px;"
                    oninput="applyFilters()"
                >
            </div>
        </div>

        <!-- Patient List -->
        <div class="patient-list">
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p>Hastalar y√ºkleniyor...</p>
            </div>
            
            <table class="patient-table" id="patientTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ad Soyad</th>
                        <th>Kullanƒ±cƒ± Adƒ±</th>
                        <th>Durum</th>
                        <th>Kayƒ±t Tarihi</th>
                        <th>ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody id="patientTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Patient Modal -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Yeni Hasta Ekle</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="patientForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ad <span class="required">*</span></label>
                        <input type="text" id="patientName" required>
                    </div>

                    <div class="form-group">
                        <label>Soyad <span class="required">*</span></label>
                        <input type="text" id="patientSurname" required>
                    </div>

                    <div class="form-group">
                        <label>Ya≈ü <span class="required">*</span></label>
                        <input type="number" id="patientAge" min="1" max="120" required>
                    </div>

                    <div class="form-group">
                        <label>Cinsiyet <span class="required">*</span></label>
                        <select id="patientGender" required>
                            <option value="">Se√ßiniz</option>
                            <option value="Kadƒ±n">Kadƒ±n</option>
                            <option value="Erkek">Erkek</option>
                            <option value="Diƒüer">Diƒüer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Kilo (kg) <span class="required">*</span></label>
                        <input type="number" id="patientWeight" step="0.1" min="1" required oninput="calculateBMI()">
                    </div>

                    <div class="form-group">
                        <label>Boy (cm) <span class="required">*</span></label>
                        <input type="number" id="patientHeight" min="1" required oninput="calculateBMI()">
                    </div>

                    <div class="form-group">
                        <label>BMI</label>
                        <div class="bmi-display" id="bmiDisplay">-</div>
                    </div>

                    <div class="form-group">
                        <label>Fiziksel Aktivite Seviyesi <span class="required">*</span></label>
                        <select id="patientActivity" required>
                            <option value="">Se√ßiniz</option>
                            <option value="1">1 - Hareketsiz (G√ºnl√ºk aktivite √ßok az)</option>
                            <option value="2">2 - Az Aktif (Haftada 1-2 g√ºn hafif egzersiz)</option>
                            <option value="3">3 - Orta Aktif (Haftada 3-5 g√ºn orta egzersiz)</option>
                            <option value="4">4 - √áok Aktif (Haftada 6-7 g√ºn yoƒüun egzersiz)</option>
                            <option value="5">5 - S√ºper Aktif (G√ºnde 2 kez egzersiz/fiziksel i≈ü)</option>
                        </select>
                        <span class="hint">Kalori hesaplamasƒ±nda kullanƒ±lƒ±r</span>
                    </div>

                    <div class="form-group">
                        <label>Kullanƒ±cƒ± Adƒ± <span class="required">*</span></label>
                        <input type="text" id="patientUsername" required>
                        <span class="hint">Hasta giri≈ü yaparken kullanacak</span>
                    </div>

                    <div class="form-group">
                        <label>≈ûifre <span class="required" id="passwordRequired">*</span></label>
                        <input type="password" id="patientPassword">
                        <span class="hint" id="passwordHint">En az 4 karakter</span>
                    </div>

                    <div class="form-group">
                        <label>Oturum S√ºresi (G√ºn) <span class="required">*</span></label>
                        <input type="number" id="patientSessionDays" min="1" max="365" value="7" required>
                        <span class="hint">Hasta ka√ß g√ºn giri≈ü yapabilir</span>
                    </div>

                    <div class="form-group">
                        <label>üñ•Ô∏è Cihaz Limiti <span class="required">*</span></label>
                        <input type="number" id="patientMaxDevices" min="1" max="10" value="1" required>
                        <span class="hint">Bu hastaya ka√ß farklƒ± cihazdan giri≈ü izni verilsin (Varsayƒ±lan: 1)</span>
                    </div>

                    <div class="form-group">
                        <label>Alternatif Yemek Sayƒ±sƒ±</label>
                        <input type="number" id="patientAlternativeCount" min="1" max="20" placeholder="Bo≈ü bƒ±rakƒ±lƒ±rsa admin ayarƒ± kullanƒ±lƒ±r">
                        <span class="hint">Bu hastaya g√∂sterilecek alternatif yemek sayƒ±sƒ± (bo≈ü bƒ±rakƒ±labilir)</span>
                    </div>

                    <div class="form-group">
                        <label>Durum <span class="required">*</span></label>
                        <select id="patientStatus" required>
                            <option value="active">Aktif</option>
                            <option value="archived">Ar≈üiv</option>
                        </select>
                    </div>

                    <div class="form-group" style="border: 2px solid #ff9800; border-radius: 8px; padding: 12px; background: #fff3e0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; color: #e65100;">
                            <input type="checkbox" id="patientIsAdmin" style="width: 18px; height: 18px; cursor: pointer;">
                            üîë Admin Yetkisi Ver
                        </label>
                        <span class="hint" style="color: #ef6c00; font-weight: 500;">
                            Bu kullanƒ±cƒ± patient_nutrition.html'de yemek e≈üle≈ütirmelerini d√ºzenleyebilir
                        </span>
                    </div>

                    <div class="form-group form-group-full">
                        <label>Notlar</label>
                        <textarea id="patientNotes" placeholder="Hasta hakkƒ±nda notlar..."></textarea>
                    </div>
                </div>

                <!-- Progress Log Section -->
                <div class="progress-log-section">
                    <h3>üìä ƒ∞lerleme Kaydƒ±</h3>
                    <div id="progressLogEntries">
                        <!-- Progress entries will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm add-progress-btn" onclick="addProgressEntry()">
                        ‚ûï Yeni Kayƒ±t Ekle
                    </button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        üíæ Kaydet
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        ‚ùå ƒ∞ptal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables and CONFIG already defined in <head>

        // DOMContentLoaded listener is now in <head> before admin_auth.js loads

        // addLogoutButton and loadPatients already defined in <head>

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = patients;
            
            // Status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(p => p.status === statusFilter);
            }
            
            // Search filter
            if (searchText) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchText) ||
                    p.surname.toLowerCase().includes(searchText) ||
                    p.username.toLowerCase().includes(searchText)
                );
            }
            
            renderPatientTable(filtered);
        }

        // Render patient table
        function renderPatientTable(patientList) {
            const tbody = document.getElementById('patientTableBody');
            tbody.innerHTML = '';
            
            if (patientList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Hasta bulunamadƒ±</td></tr>';
                return;
            }
            
            patientList.forEach(patient => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="ID">${patient.id}</td>
                    <td data-label="Ad Soyad">${patient.name} ${patient.surname}</td>
                    <td data-label="Kullanƒ±cƒ± Adƒ±">${patient.username}</td>
                    <td data-label="Durum">
                        <span class="status-badge ${patient.status === 'active' ? 'status-active' : 'status-archived'}">
                            ${patient.status === 'active' ? '‚úÖ Aktif' : 'üì¶ Ar≈üiv'}
                        </span>
                    </td>
                    <td data-label="Kayƒ±t Tarihi">${new Date(patient.createdAt).toLocaleDateString('tr-TR')}</td>
                    <td data-label="ƒ∞≈ülemler">
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editPatient('${patient.id}')">
                                ‚úèÔ∏è D√ºzenle
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showPatientProgress('${patient.id}', '${patient.name} ${patient.surname}')" title="Kilo ve √∂l√ß√ºm ilerlemesini g√∂r√ºnt√ºle">
                                üìä ƒ∞lerleme
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="resetDevices('${patient.id}', '${patient.name} ${patient.surname}')" title="Hastanƒ±n t√ºm cihaz kayƒ±tlarƒ±nƒ± sƒ±fƒ±rla">
                                üîÑ Cihaz Resetle
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePatient('${patient.id}')">
                                üóëÔ∏è Sil
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Open add patient modal
        function openAddPatientModal() {
            editingPatientId = null;
            document.getElementById('modalTitle').textContent = 'Yeni Hasta Ekle';
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('patientPassword').required = true;
            document.getElementById('passwordHint').textContent = 'En az 4 karakter';
            
            // Clear form
            document.getElementById('patientForm').reset();
            document.getElementById('bmiDisplay').textContent = '-';
            document.getElementById('progressLogEntries').innerHTML = '';
            progressLogCounter = 0;
            
            // Add one empty progress entry
            addProgressEntry();
            
            document.getElementById('patientModal').classList.add('show');
        }

        // Edit patient
        async function editPatient(patientId) {
            try {
                // Load patient details
                const response = await fetch(
                    `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/hastalar/${patientId}.json`
                );
                
                if (!response.ok) throw new Error('Hasta bilgileri y√ºklenemedi');
                
                const patient = await response.json();
                
                editingPatientId = patientId;
                document.getElementById('modalTitle').textContent = 'Hasta D√ºzenle';
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('patientPassword').required = false;
                document.getElementById('passwordHint').textContent = 'Bo≈ü bƒ±rakƒ±lƒ±rsa deƒüi≈ümez';
                
                // Fill form
                document.getElementById('patientName').value = patient.personalInfo.name;
                document.getElementById('patientSurname').value = patient.personalInfo.surname;
                document.getElementById('patientAge').value = patient.personalInfo.age;
                document.getElementById('patientGender').value = patient.personalInfo.gender;
                document.getElementById('patientWeight').value = patient.personalInfo.weight;
                document.getElementById('patientHeight').value = patient.personalInfo.height;
                document.getElementById('patientActivity').value = patient.personalInfo.activity || '3';
                document.getElementById('patientUsername').value = patient.username;
                document.getElementById('patientPassword').value = '';
                document.getElementById('patientSessionDays').value = patient.sessionDays;
                document.getElementById('patientMaxDevices').value = patient.maxDevices || 1; // Varsayƒ±lan 1
                document.getElementById('patientAlternativeCount').value = patient.alternativeCount || '';
                document.getElementById('patientStatus').value = patient.status;
                document.getElementById('patientIsAdmin').checked = patient.isAdmin || false;
                document.getElementById('patientNotes').value = patient.notes || '';
                
                calculateBMI();
                
                // Load progress log
                document.getElementById('progressLogEntries').innerHTML = '';
                progressLogCounter = 0;
                
                if (patient.progressLog && patient.progressLog.length > 0) {
                    patient.progressLog.forEach(entry => {
                        addProgressEntry(entry.date, entry.note, entry.weight);
                    });
                } else {
                    addProgressEntry();
                }
                
                document.getElementById('patientModal').classList.add('show');
            } catch (error) {
                console.error('Error loading patient:', error);
                showError('Hasta bilgileri y√ºklenirken hata olu≈ütu: ' + error.message);
            }
        }

        // Delete patient
        async function deletePatient(patientId) {
            if (!confirm('Bu hastayƒ± silmek istediƒüinizden emin misiniz?')) {
                return;
            }
            
            if (!CONFIG.token) {
                showError('GitHub token girilmedi!');
                return;
            }
            
            try {
                // Remove from index
                patients = patients.filter(p => p.id !== patientId);
                
                // Update index.json
                await saveToGitHub('hastalar/index.json', {
                    version: '1.0',
                    lastUpdated: new Date().toISOString(),
                    patients: patients
                });
                
                // Note: We don't delete the patient detail file, just remove from index
                
                showSuccess('Hasta ba≈üarƒ±yla silindi!');
                applyFilters();
            } catch (error) {
                console.error('Error deleting patient:', error);
                showError('Hasta silinirken hata olu≈ütu: ' + error.message);
            }
        }

        // Reset devices for a patient
        async function resetDevices(patientId, patientName) {
            if (!confirm(`${patientName} i√ßin t√ºm cihaz kayƒ±tlarƒ±nƒ± sƒ±fƒ±rlamak istediƒüinizden emin misiniz?\n\nBu i≈ülem sonrasƒ±nda:\n- Hasta sadece 1 yeni cihazdan giri≈ü yapabilecek\n- Eski cihazlarda otomatik logout olacak`)) {
                return;
            }

            try {
                showInfo('Cihaz bilgileri sƒ±fƒ±rlanƒ±yor...');

                const response = await fetch('/api/reset-devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patientId })
                });

                if (!response.ok) {
                    throw new Error('API yanƒ±t vermedi');
                }

                const result = await response.json();

                if (result.success) {
                    showSuccess(`‚úÖ Cihaz bilgileri sƒ±fƒ±rlandƒ±!\n${result.oldDeviceCount} cihaz kaydƒ± silindi.\nHasta artƒ±k yeni bir cihazdan giri≈ü yapabilir.`);
                } else {
                    throw new Error(result.message || 'Bilinmeyen hata');
                }
            } catch (error) {
                console.error('Reset devices error:', error);
                showError('Cihaz sƒ±fƒ±rlama hatasƒ±: ' + error.message);
            }
        }

        // Show patient progress (weight + measurements)
        async function showPatientProgress(patientId, patientName) {
            try {
                showInfo('ƒ∞lerleme verileri y√ºkleniyor...');
                
                // GitHub'dan hasta verisini √ßek
                const response = await fetch(`https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/main/hastalar/${patientId}.json`);
                
                if (!response.ok) {
                    throw new Error('Hasta verisi bulunamadƒ±');
                }
                
                const patientData = await response.json();
                
                // Modal a√ßƒ±klama
                document.getElementById('progressPatientName').textContent = patientName;
                document.getElementById('progressModal').style.display = 'flex';
                
                // Kilo grafiƒüini √ßiz
                drawWeightProgressChart(patientData);
                
                // √ñl√ß√ºm grafiƒüini √ßiz
                drawMeasurementsProgressChart(patientData);
                
                // Projeksiyon √∂zetini g√∂ster
                showProjectionSummary(patientData);
                
            } catch (error) {
                console.error('Progress error:', error);
                showError('ƒ∞lerleme verileri y√ºklenemedi: ' + error.message);
            }
        }

        // Close progress modal
        function closeProgressModal() {
            document.getElementById('progressModal').style.display = 'none';
        }

        // Draw weight progress chart
        function drawWeightProgressChart(patientData) {
            const canvas = document.getElementById('weightChart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Haftalƒ±k kilo verilerini topla (weekSettings'den)
            const weekData = [];
            
            if (patientData.weeks && patientData.weeks.length > 0) {
                patientData.weeks.forEach((week, index) => {
                    if (week.weekSettings && week.weekSettings.projection && week.weekSettings.projection.weeklyPlan) {
                        const plan = week.weekSettings.projection.weeklyPlan;
                        plan.forEach((weekPlan, weekOffset) => {
                            weekData.push({
                                weekNumber: index + 1 + weekOffset,
                                targetWeight: weekPlan.targetWeight,
                                actualWeight: null // Ger√ßek √∂l√ß√ºmlerden alƒ±nacak
                            });
                        });
                    }
                });
            }
            
            // Ger√ßek √∂l√ß√ºmleri ekle
            if (patientData.measurements && patientData.measurements.length > 0) {
                patientData.measurements.forEach(m => {
                    const weekMatch = m.hafta.match(/(\d+)\. Hafta/);
                    if (weekMatch && m.kilo) {
                        const weekNum = parseInt(weekMatch[1]);
                        const existing = weekData.find(w => w.weekNumber === weekNum);
                        if (existing) {
                            existing.actualWeight = parseFloat(m.kilo);
                        } else {
                            weekData.push({
                                weekNumber: weekNum,
                                targetWeight: null,
                                actualWeight: parseFloat(m.kilo)
                            });
                        }
                    }
                });
            }
            
            // Sƒ±rala
            weekData.sort((a, b) => a.weekNumber - b.weekNumber);
            
            if (weekData.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Hen√ºz kilo verisi yok', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 50;
            const graphWidth = canvas.width - (padding * 2);
            const graphHeight = canvas.height - (padding * 2);
            
            const allWeights = weekData.flatMap(w => [w.targetWeight, w.actualWeight]).filter(w => w !== null);
            const maxWeight = Math.max(...allWeights);
            const minWeight = Math.min(...allWeights);
            const range = maxWeight - minWeight || 1;
            
            // Hedef kilo √ßizgisi (kesikli)
            ctx.strokeStyle = '#dfe6e9';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            
            weekData.forEach((data, index) => {
                if (data.targetWeight) {
                    const x = padding + (index / (weekData.length - 1)) * graphWidth;
                    const y = padding + graphHeight - ((data.targetWeight - minWeight) / range) * graphHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Ger√ßek kilo √ßizgisi (kalƒ±n)
            ctx.strokeStyle = '#6c5ce7';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            let firstActual = true;
            weekData.forEach((data, index) => {
                if (data.actualWeight) {
                    const x = padding + (index / (weekData.length - 1)) * graphWidth;
                    const y = padding + graphHeight - ((data.actualWeight - minWeight) / range) * graphHeight;
                    
                    if (firstActual) {
                        ctx.moveTo(x, y);
                        firstActual = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            
            ctx.stroke();
            
            // Noktalar
            weekData.forEach((data, index) => {
                const x = padding + (index / (weekData.length - 1)) * graphWidth;
                
                if (data.actualWeight) {
                    const y = padding + graphHeight - ((data.actualWeight - minWeight) / range) * graphHeight;
                    ctx.fillStyle = '#6c5ce7';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Etiket
                    ctx.fillStyle = '#2d3436';
                    ctx.font = 'bold 11px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(data.actualWeight.toFixed(1) + 'kg', x, y - 12);
                }
            });
            
            // Eksen ba≈ülƒ±klarƒ±
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Hafta Numarasƒ± ‚Üí', canvas.width / 2, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('‚Üê Kilo (kg)', 0, 0);
            ctx.restore();
        }

        // Draw measurements progress chart
        function drawMeasurementsProgressChart(patientData) {
            const canvas = document.getElementById('measurementsChart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!patientData.measurements || patientData.measurements.length < 2) {
                ctx.fillStyle = '#999';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('En az 2 √∂l√ß√ºm gerekli', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const measurements = [...patientData.measurements].sort((a, b) => 
                new Date(a.tarih) - new Date(b.tarih)
            );
            
            const fields = [
                { key: 'bel', color: '#ff6b6b', label: 'Bel' },
                { key: 'kalca', color: '#4ecdc4', label: 'Kal√ßa' },
                { key: 'sagUyluk', color: '#45b7d1', label: 'Saƒü Uyluk' }
            ];
            
            const padding = 50;
            const graphWidth = canvas.width - (padding * 2);
            const graphHeight = canvas.height - (padding * 2);
            
            // Min/max deƒüerleri hesapla
            const allValues = measurements.flatMap(m => fields.map(f => parseFloat(m[f.key]) || 0)).filter(v => v > 0);
            const maxValue = Math.max(...allValues);
            const minValue = Math.min(...allValues);
            const range = maxValue - minValue || 1;
            
            // Her alan i√ßin √ßizgi √ßiz
            fields.forEach(field => {
                const values = measurements.map(m => parseFloat(m[field.key]) || 0).filter(v => v > 0);
                
                if (values.length === 0) return;
                
                ctx.strokeStyle = field.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                values.forEach((value, index) => {
                    const x = padding + (index / (values.length - 1)) * graphWidth;
                    const y = padding + graphHeight - ((value - minValue) / range) * graphHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Noktalar
                values.forEach((value, index) => {
                    const x = padding + (index / (values.length - 1)) * graphWidth;
                    const y = padding + graphHeight - ((value - minValue) / range) * graphHeight;
                    
                    ctx.fillStyle = field.color;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
            });
            
            // G√∂sterge
            let legendX = padding;
            fields.forEach(field => {
                ctx.fillStyle = field.color;
                ctx.fillRect(legendX, 20, 15, 15);
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(field.label, legendX + 20, 32);
                legendX += 100;
            });
        }

        // Show projection summary
        function showProjectionSummary(patientData) {
            const content = document.getElementById('projectionContent');
            
            if (!patientData.weeks || patientData.weeks.length === 0) {
                content.innerHTML = '<p>Hen√ºz haftalƒ±k plan olu≈üturulmamƒ±≈ü.</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 12px;">';
            
            let totalWeeksWithProjection = 0;
            let totalPlannedWeightLoss = 0;
            
            patientData.weeks.forEach((week, index) => {
                if (week.weekSettings && week.weekSettings.projection) {
                    const proj = week.weekSettings.projection;
                    totalWeeksWithProjection++;
                    
                    if (proj.totalWeightToLose) {
                        totalPlannedWeightLoss += proj.totalWeightToLose;
                    }
                    
                    html += `
                        <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #f093fb;">
                            <strong>${index + 1}. Hafta:</strong> 
                            ${proj.startWeight}kg ‚Üí ${proj.targetWeight}kg 
                            (${proj.totalWeightToLose}kg kayƒ±p, ${proj.estimatedWeeks} hafta)
                            <br>
                            <small style="color: #636e72;">
                                G√ºnl√ºk kalori: ${proj.dailyCalories} kcal | Hedef: ${proj.goalPct}
                            </small>
                        </div>
                    `;
                }
            });
            
            if (totalWeeksWithProjection === 0) {
                html += '<p>Hen√ºz projeksiyon olu≈üturulmamƒ±≈ü.</p>';
            } else {
                html = `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #fdcb6e;">
                        <h5 style="margin: 0 0 8px 0; color: #e17055;">üìä Genel √ñzet</h5>
                        <p style="margin: 4px 0;"><strong>Toplam planlƒ± hafta:</strong> ${totalWeeksWithProjection}</p>
                        <p style="margin: 4px 0;"><strong>Toplam hedeflenen kilo kaybƒ±:</strong> ${totalPlannedWeightLoss.toFixed(1)} kg</p>
                    </div>
                ` + html;
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Close modal
        function closeModal() {
            document.getElementById('patientModal').classList.remove('show');
        }

        // Calculate BMI
        function calculateBMI() {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const height = parseFloat(document.getElementById('patientHeight').value);
            
            if (weight > 0 && height > 0) {
                const heightM = height / 100;
                const bmi = weight / (heightM * heightM);
                document.getElementById('bmiDisplay').textContent = bmi.toFixed(2);
            } else {
                document.getElementById('bmiDisplay').textContent = '-';
            }
        }

        // Add progress entry
        function addProgressEntry(date = '', note = '', weight = '') {
            const container = document.getElementById('progressLogEntries');
            const entryId = progressLogCounter++;
            
            const today = new Date().toISOString().split('T')[0];
            
            const entry = document.createElement('div');
            entry.className = 'progress-entry';
            entry.id = `progress-${entryId}`;
            entry.innerHTML = `
                <input type="date" placeholder="Tarih" value="${date || today}" data-field="date">
                <input type="number" placeholder="Kilo" step="0.1" value="${weight}" data-field="weight">
                <input type="text" placeholder="Not" value="${note}" data-field="note">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeProgressEntry(${entryId})">
                    üóëÔ∏è
                </button>
            `;
            
            container.appendChild(entry);
        }

        // Remove progress entry
        function removeProgressEntry(entryId) {
            const entry = document.getElementById(`progress-${entryId}`);
            if (entry) {
                entry.remove();
            }
        }

        // Get progress log from form
        function getProgressLog() {
            const entries = document.querySelectorAll('#progressLogEntries .progress-entry');
            const log = [];
            
            entries.forEach(entry => {
                const date = entry.querySelector('[data-field="date"]').value;
                const note = entry.querySelector('[data-field="note"]').value;
                const weight = entry.querySelector('[data-field="weight"]').value;
                
                if (date && (note || weight)) {
                    log.push({
                        date: date,
                        note: note || '',
                        weight: weight ? parseFloat(weight) : null
                    });
                }
            });
            
            return log;
        }

        // Hash password (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Form submission
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!CONFIG.token) {
                showError('GitHub token girilmedi!');
                return;
            }
            
            // Get form data
            const name = document.getElementById('patientName').value.trim();
            const surname = document.getElementById('patientSurname').value.trim();
            const age = parseInt(document.getElementById('patientAge').value);
            const gender = document.getElementById('patientGender').value;
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const height = parseFloat(document.getElementById('patientHeight').value);
            const activity = parseInt(document.getElementById('patientActivity').value);
            const username = document.getElementById('patientUsername').value.trim();
            const password = document.getElementById('patientPassword').value;
            const sessionDays = parseInt(document.getElementById('patientSessionDays').value);
            const maxDevices = parseInt(document.getElementById('patientMaxDevices').value) || 1; // Varsayƒ±lan 1
            const alternativeCountInput = document.getElementById('patientAlternativeCount').value.trim();
            const alternativeCount = alternativeCountInput ? parseInt(alternativeCountInput) : null;
            const status = document.getElementById('patientStatus').value;
            const notes = document.getElementById('patientNotes').value.trim();
            const progressLog = getProgressLog();
            
            // Calculate BMI
            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);
            
            try {
                let patientId;
                let passwordHash;
                let existingPatientData = null;
                
                if (editingPatientId) {
                    // Editing existing patient - MEVCUT VERƒ∞LERƒ∞ Y√úKLE
                    patientId = editingPatientId;
                    
                    // üî• GitHub'dan mevcut hasta verisini √ßek (settings, weeks vs. korumak i√ßin)
                    try {
                        const patientFileUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/hastalar/${patientId}.json`;
                        const patientFileResp = await fetch(patientFileUrl, {
                            headers: {
                                'Authorization': `token ${CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (patientFileResp.ok) {
                            const patientFileData = await patientFileResp.json();
                            const decodedContent = decodeURIComponent(escape(atob(patientFileData.content)));
                            existingPatientData = JSON.parse(decodedContent);
                            console.log('‚úÖ Mevcut hasta verisi y√ºklendi:', existingPatientData);
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Mevcut hasta verisi y√ºklenemedi, yeni veri olu≈üturulacak:', err);
                    }
                    
                    // If password changed, hash it
                    if (password) {
                        passwordHash = await hashPassword(password);
                    } else {
                        // Keep existing password
                        const existingPatient = patients.find(p => p.id === patientId);
                        passwordHash = existingPatient.passwordHash;
                    }
                    
                    // Update in patients array
                    const index = patients.findIndex(p => p.id === patientId);
                    if (index !== -1) {
                        patients[index] = {
                            ...patients[index],
                            name: name,
                            surname: surname,
                            username: username,
                            passwordHash: passwordHash,
                            sessionDays: sessionDays,
                            maxDevices: maxDevices, // üñ•Ô∏è Cihaz limiti
                            status: status
                        };
                    }
                } else {
                    // Adding new patient
                    patientId = 'patient_' + Date.now();
                    passwordHash = await hashPassword(password);
                    
                    // Add to patients array
                    patients.push({
                        id: patientId,
                        username: username,
                        passwordHash: passwordHash,
                        sessionDays: sessionDays,
                        maxDevices: maxDevices, // üñ•Ô∏è Cihaz limiti
                        status: status,
                        name: name,
                        surname: surname,
                        createdAt: new Date().toISOString()
                    });
                }
                
                // üî• Create patient detail object - MEVCUT VERƒ∞LERƒ∞ KORU
                const patientDetail = {
                    // √ñnce mevcut verileri y√ºkle (settings, weeks vs.)
                    ...(existingPatientData || {}),
                    
                    // Sonra g√ºncellenenleri √ºzerine yaz
                    id: patientId,
                    username: username,
                    passwordHash: passwordHash,
                    sessionDays: sessionDays,
                    maxDevices: maxDevices, // üñ•Ô∏è Cihaz limiti
                    alternativeCount: alternativeCount,
                    status: status,
                    isAdmin: document.getElementById('patientIsAdmin').checked,
                    personalInfo: {
                        name: name,
                        surname: surname,
                        age: age,
                        gender: gender,
                        weight: weight,
                        height: height,
                        activity: activity,
                        bmi: parseFloat(bmi.toFixed(2))
                    },
                    notes: notes,
                    progressLog: progressLog,
                    
                    // üñ•Ô∏è Cihaz y√∂netimi (mevcut cihazlarƒ± koru)
                    devices: existingPatientData?.devices || [],
                    ipLogs: existingPatientData?.ipLogs || [],
                    securityAlerts: existingPatientData?.securityAlerts || [],
                    
                    createdAt: editingPatientId ?
                        (existingPatientData?.createdAt || patients.find(p => p.id === patientId)?.createdAt || new Date().toISOString()) :
                        new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // üî• √ñNEMLƒ∞: Eƒüer settings mevcut veride varsa, sadece personalInfo'yu g√ºncelle, diƒüer ayarlara dokunma
                if (existingPatientData?.settings) {
                    patientDetail.settings = {
                        ...existingPatientData.settings,
                        personalInfo: {
                            name: name,
                            surname: surname,
                            age: age,
                            gender: gender,
                            weight: weight,
                            height: height,
                            activity: activity
                        }
                    };
                }
                
                console.log('üíæ Kaydedilecek hasta verisi:', patientDetail);

                // Save to GitHub
                await saveToGitHub(`hastalar/${patientId}.json`, patientDetail);
                await saveToGitHub('hastalar/index.json', {
                    version: '1.0',
                    lastUpdated: new Date().toISOString(),
                    patients: patients
                });
                
                // Close modal first
                closeModal();
                
                // Then show success message
                const successMessage = editingPatientId ? 
                    'üéâ Hasta ba≈üarƒ±yla g√ºncellendi!' : 
                    'üéâ Yeni hasta ba≈üarƒ±yla eklendi!';
                showSuccess(successMessage);
                
                // Reload the patient list
                applyFilters();
            } catch (error) {
                console.error('Error saving patient:', error);
                showError('Hasta kaydedilirken hata olu≈ütu: ' + error.message);
            }
        });

        // Save to GitHub
        async function saveToGitHub(path, content) {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`;
            
            // Get current file SHA (for updates)
            let sha = null;
            try {
                const getResponse = await fetch(url, {
                    headers: {
                        'Authorization': `token ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                }
            } catch (e) {
                // File doesn't exist, that's ok
            }
            
            // Create or update file
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Update ${path}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                    branch: CONFIG.branch,
                    sha: sha
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'GitHub kaydetme hatasƒ±');
            }
            
            return response.json();
        }

        // Show success message
        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.innerHTML = `‚úÖ ${message}`;
            alert.classList.add('show');
            
            // Scroll to top to see the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 6000);
        }

        // Show error message
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.innerHTML = `‚ùå ${message}`;
            alert.classList.add('show');
            
            // Scroll to top to see the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 6000);
        }

        // Show info message
        function showInfo(message) {
            // errorAlert'i mavi bilgi mesajƒ± olarak kullan
            const alert = document.getElementById('errorAlert');
            alert.innerHTML = `‚ÑπÔ∏è ${message}`;
            alert.style.background = '#0dcaf0';
            alert.classList.add('show');
            
            // Scroll to top to see the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            setTimeout(() => {
                alert.classList.remove('show');
                // Rengi geri al
                setTimeout(() => {
                    alert.style.background = '';
                }, 300);
            }, 6000);
        }

        // PWA Service Worker ve Manifest Kaydƒ±
        if ('serviceWorker' in navigator) {
            const isSecureOrigin = ['https:', 'http:'].includes(window.location.protocol) || window.location.protocol === 'chrome-extension:';
            const isGitHubPages = /\.github\.io$/i.test(window.location.hostname);
            if (isSecureOrigin && !isGitHubPages) {
                const CACHE_NAME = 'admin-patients-v1';
                const manifest = {
                    "short_name": "Hasta Y√∂netimi",
                    "name": "Hasta Y√∂netimi Paneli",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#667eea",
                    "theme_color": "#764ba2",
                    "icons": [
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "192x192",
                            "type": "image/png",
                            "purpose": "any maskable"
                        },
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "512x512",
                            "type": "image/png",
                            "purpose": "any maskable"
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifestLink').setAttribute('href', manifestURL);

                const serviceWorkerContent = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const urlsToCache = ['.'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.open(CACHE_NAME).then(cache => {
                                return fetch(event.request)
                                    .then(response => {
                                        if (response.status === 200) {
                                            cache.put(event.request.url, response.clone());
                                        }
                                        return response;
                                    })
                                    .catch(() => cache.match(event.request));
                            })
                        );
                    });
                `;
                const swBlob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then(registration => console.log('ServiceWorker registered:', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed:', err));
            }
        }

        // Zoom ve dokunmatik engelleyici
        (function preventZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 350) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            document.addEventListener('gesturestart', function(event) {
                event.preventDefault();
            }, { passive: false });
        })();

        // PWA Install Prompt - Otomatik Y√ºkleme √ñnerisi
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                showInstallPrompt();
            }, 2000);
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const installBtn = confirm('üì± Hasta Y√∂netim Panelini telefonunuza y√ºklemek ister misiniz?\n\n‚úì Ana ekranƒ±nƒ±za eklenecek\n‚úì Uygulama gibi √ßalƒ±≈üacak\n‚úì Daha hƒ±zlƒ± eri≈üim');
            
            if (installBtn) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ Kullanƒ±cƒ± uygulamayƒ± y√ºkledi');
                    }
                    deferredPrompt = null;
                });
            }
        }

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Uygulama ba≈üarƒ±yla y√ºklendi!');
            deferredPrompt = null;
        });
    </script>
    
    <!-- Page initialization - runs after body is parsed -->
    <script>
        // Use setTimeout to ensure DOM is fully parsed
        setTimeout(async () => {
            console.info('[Patients] Script running at end of body (after timeout)');
            console.info('[Patients] .container check:', document.querySelector('.container'));
            const relogin = new URLSearchParams(location.search).get('relogin') === '1';
            
            if (window.AdminAuth && typeof AdminAuth.protectPage === 'function') {
                console.info('[Patients] Calling AdminAuth.protectPage');
                try {
                    await AdminAuth.protectPage({ 
                        forcePrompt: relogin,
                        afterLogin: () => {
                            console.info('[Patients] afterLogin callback fired');
                        }
                    });
                    console.info('[Patients] Auth successful, session:', AdminAuth.getSession());
                } catch(err) {
                    console.error('[Patients] protectPage error:', err);
                    return;
                }
            }
            
            console.info('[Patients] DOM is ready, .container:', document.querySelector('.container'));
            
            // Call page functions
            if (typeof window.addLogoutButton === 'function') {
                window.addLogoutButton();
            }
            
            if (typeof window.loadPatients === 'function') {
                window.loadPatients();
            }
        }, 10);
    </script>
    
    <!-- ƒ∞lerleme Modal -->
    <div id="progressModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 25px; border-radius: 12px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üìä</span> <span id="progressPatientName"></span> - ƒ∞lerleme Raporu
                </h3>
                <button onclick="closeProgressModal()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    ‚úñÔ∏è Kapat
                </button>
            </div>
            
            <!-- Kilo Grafiƒüi -->
            <div style="margin-bottom: 25px; background: #f8f9fa; border-left: 4px solid #3498db; padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">‚öñÔ∏è Kilo Deƒüi≈üim Grafiƒüi</h4>
                <canvas id="weightChart" style="width: 100%; height: 300px; background: white; border-radius: 6px; padding: 10px; border: 1px solid #e0e0e0;"></canvas>
            </div>
            
            <!-- √ñl√ß√ºmler Grafiƒüi -->
            <div style="margin-bottom: 25px; background: #f8f9fa; border-left: 4px solid #27ae60; padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">üìè V√ºcut √ñl√ß√ºmleri Grafiƒüi</h4>
                <canvas id="measurementsChart" style="width: 100%; height: 300px; background: white; border-radius: 6px; padding: 10px; border: 1px solid #e0e0e0;"></canvas>
            </div>
            
            <!-- Projeksiyon √ñzeti -->
            <div id="projectionSummary" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 16px; font-weight: 600;">üéØ Hedef Projeksiyon √ñzeti</h4>
                <div id="projectionContent" style="color: #856404; font-size: 14px; line-height: 1.8;"></div>
            </div>
        </div>
    </div>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('‚úÖ Service Worker kayƒ±tlƒ±:', reg.scope))
                .catch(err => console.error('‚ùå Service Worker hatasƒ±:', err));
        }
    </script>
</body>
</html>

